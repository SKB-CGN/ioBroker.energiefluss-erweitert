const urlParams=new URLSearchParams(window.location.search),instance=urlParams.get("instance")?urlParams.get("instance"):0;let adapterNameNamespace="energiefluss-erweitert."+instance;console.log("Using Instance: "+adapterNameNamespace);let objID=[adapterNameNamespace+".configuration",adapterNameNamespace+".data","system.adapter."+adapterNameNamespace+".alive"],configuration_default={line:{stroke_width:8,stroke:"#000000"},basic:{enable_grid:!0,enable_animation:!1,enable_area_catch:!0,enable_config_icon:!0,enable_last_id:!1,height:600,width:800,styles:"",font:{family:'"Arial", sans-serif',size:20},rect:{height:100,width:100,corners:10},circle:{radius:50},elm:{stroke_width:5},icon:{width:24,height:24}},animation:{stroke:"#ffce4a",stroke_dasharray:"4 12 4 12 4 100",stroke_width:6,animation_duration:2e3,stroke_linecap:"round",animation_timing_function:"linear"},animation_configuration:{dots:4,distance:12,length:6},animations:{},lines:{}},configuration=configuration_default,displayMode=!1,localMode=!1,globalConfigChanged=!1,basicConfig=!1,globalSelectedId,globalLastSteps={},globalAdapterOnline=!1;var url=window.location.pathname;"file:"==window.location.protocol&&(localMode=!0,console.log("Local Mode activated!"));var filename=url.substring(url.lastIndexOf("/")+1);filename.includes("index")||""==filename?displayMode=!0:jscolor.presets.default={format:"rgba",borderColor:"#538EA3",borderRadius:10,controlBorderColor:"#538EA3",previewSize:28,previewPosition:"right",required:!1,palette:["#00b5dd","#61687a","#ffce4a","#a1d343","#c5902e","#f20e40"]};let selectId,iobObjects;var iobPath=location.pathname,iobParts=iobPath.split("/");if(iobParts.splice(-3),location.pathname.match(/^\/admin\//)&&(iobParts=[]),localMode){var e=io.connect("http://192.168.2.19:8082/",{path:"/socket.io",reconnectionDelay:500,reconnectionAttempts:1/0});e.emit("getObjects",function(e,t){iobObjects=t})}else{var e=io.connect("/",{path:iobParts.join("/")+"/socket.io",reconnectionDelay:500,reconnectionAttempts:1/0});e.emit("getObjects",function(e,t){iobObjects=t})}function initSelectId(e){if(selectId)return e(selectId);selectId=$("#dialog-select-member").selectId("init",{noMultiselect:!0,objects:iobObjects,imgPath:"../../lib/css/fancytree/",filter:{type:"state"},name:"scenes-select-state",texts:{select:_("Select"),cancel:_("Cancel"),all:_("All"),id:_("ID"),name:_("Name"),role:_("Role"),room:_("Room"),value:_("Value"),selectid:_("Select ID"),from:_("From"),lc:_("Last changed"),ts:_("Time stamp"),wait:_("Processing..."),ack:_("Acknowledged"),selectAll:_("Select all"),unselectAll:_("Deselect all"),invertSelection:_("Invert selection")},columns:["image","name","role","room"]}),e(selectId)}let max_elm_id=0,restore={};function displayLoading(e){$("#loading_text").text(e),$("#loading, .loading-spinner, #loading_text").show()}function displayListener(){let t=new Date().toLocaleString();localMode||(e.emit("subscribe",objID),console.log("[Socket] subscribed to: "+objID.toString()+" at "+t),e.on("connect",function(){console.log("[Socket] connected! at "+t)}),e.on("reconnect",function(){console.log("[Socket] reconnected at "+t),$("#loading").fadeOut("fast")}),e.on("disconnect",function(){console.log("[Socket] disconnected "+t),displayLoading("Reconnecting to your Energiefluss - erweitert")}),e.on("objectChange",function(e,t){}),e.on("stateChange",function(e,a){setTimeout(function(){if(e==objID[0])try{displayLoading("Applying new configuration to your Energiefluss - erweitert"),configuration=JSON.parse(a.val),setLoadedConfig(!0),console.log("Applied new configuration at "+t)}catch(o){console.log("Error while parsing Config in JSON-Object!")}if(e==objID[1])try{refreshData(JSON.parse(a.val))}catch(i){console.log("Error while parsing Values in JSON-Object!")}if(e==objID[2]){if(!1==a.val)displayLoading("Waiting for instance "+instance+" of Energiefluss - erweitert to come up"),console.log("Adapter instance: "+instance+" is not started! "+t),globalAdapterOnline=!1;else if(a.val!=globalAdapterOnline&&!0==a.val){console.log("Adapter instance: "+instance+" started at "+t),globalAdapterOnline=!0;let r=(Math.random()+1).toString(36).substring(7);window.location.href="?instance="+instance+"&hash="+r}}},0)}),e.on("reauthenticate",function(){console.log("[Socket] reauthenticate "+t)}),e.on("error",function(e){console.error("[Socket] error: "+e+" "+t)}),e.on("connect_error",function(e){console.error("[Socket] connect error: "+e+" "+t)}),e.on("permissionError",function(e){console.error("[Socket] permission error: "+e+" "+t)}))}function addGradient(e,t){""==t&&(t="transparent");let a=document.createElementNS("http://www.w3.org/2000/svg","linearGradient");a.setAttribute("id","gradient_"+e),a.setAttribute("gradientTransform","rotate(90)");let o=document.createElementNS("http://www.w3.org/2000/svg","stop");o.setAttribute("id","gradient_transparent_"+e),o.setAttribute("offset","0%"),o.setAttribute("stop-color","transparent"),a.appendChild(o),(o=document.createElementNS("http://www.w3.org/2000/svg","stop")).setAttribute("id","gradient_color_"+e),o.setAttribute("offset","1%"),o.setAttribute("stop-color",t),a.appendChild(o),$(a).appendTo("#placeholder_defs")}function updateGradient(e,t,a){try{let o=$("#"+e).data("fill_max"),i;switch(a){case"percent":i=100-t;break;case"value":i=100-t/o*100}$("#gradient_transparent_"+e).attr("offset",i+"%"),$("#"+e).css("fill","url(#gradient_"+e+")")}catch(r){console.log("Error while updating gradient for ID: "+e)}}function refreshData(e){Object.entries(e.values).forEach(t=>{let[a,o]=t;$("#"+a).html(o+" "+e.unit[a])}),Object.entries(e.fillValues).forEach(e=>{let[t,a]=e,o=$("#"+t).data("fill_type");-1!=o&&($("#gradient_"+t).length>0||(addGradient(t,$("#"+t).data("fill_value")),console.log("Fill-Gradient added for: "+t)),updateGradient(t,a,o))}),Object.entries(e.animations).forEach(t=>{let[a,o]=t,i="",r="";displayMode&&(e.animationProperties.hasOwnProperty(a)&&("dots"==e.animationProperties[a].type&&(i=e.animationProperties[a].stroke),"duration"==e.animationProperties[a].type&&(r=e.animationProperties[a].duration)),$("#"+a).css({display:o?"inline":"none","stroke-dasharray":i,"animation-duration":r+"ms"}))})}function loadConfig(){if(console.log("Loading config for instance: "+instance),localMode){if(configuration=localTest)console.log("Loading Local Config!"),setLoadedConfig();else{let t;basicConfig=!0,failedMessage(t=displayMode?"The adapter is not yet configured! We are loading a basic configuration!<br>Please use the config wheel below!":"The adapter is not yet configured! We are loading a basic configuration!"),console.log(t)}}else e.emit("getStates",objID,function(e,t){if(e)console.log(e),failedMessage("An error occured, while receiving data!");else if(t){if(null!=t[objID[0]])try{configuration=JSON.parse(t[objID[0]].val),setLoadedConfig()}catch(a){let o;o=displayMode?"The adapter is not yet configured! We are loading a basic configuration!<br>Please use the config wheel below!":"The adapter is not yet configured! We are loading a basic configuration!",console.log("Error: "+a),basicConfig=!0,failedMessage(o),console.log("Applying basic configuration!"),$.getJSON("js/basic_config.json",function(e){(configuration=e)?setLoadedConfig():failedMessage("Failed to load the basic configuration!<br>Adapter may be corrupted!")})}else failedMessage("The Instance <b>"+instance+"</b>, you are trying to access does not exist!");if(null!=t[objID[1]])try{console.log("Loading initial Data."),refreshData(JSON.parse(t[objID[1]].val))}catch(i){console.log(i)}globalAdapterOnline=null!=t[objID[2]]&&t[objID[2]].val}else failedMessage("Could not receive any values! Something is wrong!")})}function getElements(e,t){$("#"+e).empty();let a={},o=[],i=[],r=[],s=[],l=[],n=[],c;$(".added_elements, .anim_element").each(function(){if($(this).hasClass("type_text")&&o.push({id:this.id,text:$(this).text()+" (ID: "+this.id+")"}),$(this).hasClass("type_datasource")){let e=$(this).data("source"),t=$('.data-table tbody tr[data-id="'+e+'"]').find("td:eq(0)",this).text();i.push({id:this.id,text:$(this).text()+" ("+t+")"})}if($(this).hasClass("type_circle")&&r.push({id:this.id,text:"ID "+this.id+" (X: "+$(this).attr("cx")+" Y: "+$(this).attr("cy")+")",y:$(this).attr("cy")}),$(this).hasClass("type_rect")&&s.push({id:this.id,text:"ID "+this.id+" (X: "+$(this).attr("x")+" Y: "+$(this).attr("y")+")",y:$(this).attr("y")}),$(this).hasClass("type_icon")&&l.push({id:this.id,text:"ID "+this.id+" (X: "+$(this).attr("x")+" Y: "+$(this).attr("y")+" - "+$(this).data("icon")+")",y:$(this).attr("y")}),$(this).hasClass("type_animation")){let a=$("#"+this.id.replace("anim_","")).attr("d");a=a.substring(1,a.indexOf(" ")),n.push({id:this.id,text:"ID "+this.id+" (X: "+a+")",y:$(this).attr("y"),d:a})}}),o.sort((e,t)=>e.text<t.text?-1:e.text>t.text?1:0),a={"Circles (from top to bottom)":r.sort((e,t)=>parseFloat(e.y)-parseFloat(t.y)),"Datasources (value or ID - incl. Source)":i.sort((e,t)=>parseFloat(e.id)-parseFloat(t.id)),"Icons (from top to bottom)":l.sort((e,t)=>parseFloat(e.y)-parseFloat(t.y)),"Lines (from left to right)":n.sort((e,t)=>parseFloat(e.d)-parseFloat(t.d)),"Rectangles (from top to bottom)":s.sort((e,t)=>parseFloat(e.y)-parseFloat(t.y)),"Texts (alphabetical)":o},$.each(a,function(a,o){let i=$('<optgroup label="'+a+'" />');$.each(o,function(){(c=new Option(this.text,this.id)).selected=this.id==t,$(i).append(c)}),$("#"+e).append(i)})}function getDataSources(e,t,a=!0){a?$("#"+e).empty().append(new Option("Please choose ...","-1")):$("#"+e).empty();let o;$(".data-table tbody tr").each(function(){if(-1==$(this).data("id"))(o=new Option("There are currently no sources added!","-1")).disabled=!0,o.title="Go to the tab Datasources and add some";else if(o=new Option($("td:eq(0)",this).text()+" ("+$("td:eq(1)",this).text()+")",$(this).data("id")),"object"==typeof t)for(var a in t)t[a]==$(this).data("id")&&(o.selected=!0);else o.selected=$(this).data("id")==t;$("#"+e).append(o)})}function setLoadedConfig(e=!1){if($("#svg_width_slider").val(configuration.basic.width),$("#svg_height_slider").val(configuration.basic.height),$("#svg_width_value").val(configuration.basic.width).trigger("change"),$("#svg_height_value").val(configuration.basic.height).trigger("change"),$("#enable_animation").prop("checked",configuration.basic.enable_animation).trigger("change"),$("#enable_grid").prop("checked",configuration.basic.enable_grid).trigger("change"),$("#enable_area_catch").prop("checked",configuration.basic.enable_area_catch).trigger("change"),$("#enable_config_icon").prop("checked",configuration.basic.enable_config_icon).trigger("change"),$("#enable_last_id").prop("checked",configuration.basic.enable_last_id).trigger("change"),$("#line_size").val(configuration.line.stroke_width),$("#animation_width").val(configuration.animation.stroke_width),$("#animation_duration").val(configuration.animation.animation_duration),$("#animation_type").val(configuration.animation.animation_timing_function),$("#animation_linecap").val(configuration.animation.stroke_linecap),$("#animation_dots").val(configuration.animation_configuration.dots),$("#animation_distance").val(configuration.animation_configuration.distance),$("#animation_length").val(configuration.animation_configuration.length),configuration.basic.rect?($("#basic_rect_height").val(configuration.basic.rect.height),$("#basic_rect_width").val(configuration.basic.rect.width),$("#basic_rect_corners").val(configuration.basic.rect.corners)):($("#basic_rect_height").val(100),$("#basic_rect_width").val(100),$("#basic_rect_corners").val(10),configuration.basic.rect={height:100,width:100,corners:10}),configuration.basic.font?($("#basic_font_family").val(configuration.basic.font.family),$("#basic_font_size").val(configuration.basic.font.size),displayMode||($("#basic_font_fill")[0].jscolor.fromString(configuration.basic.font.fill?configuration.basic.font.fill:""),$("#basic_font_color")[0].jscolor.fromString(configuration.basic.font.color?configuration.basic.font.color:"")),$("#basic_font_align").val(configuration.basic.font.align||"middle")):($("#basic_font_family").val('"Arial", sans-serif'),$("#basic_font_size").val(20),configuration.basic.font={family:'"Arial", sans-serif',size:20}),configuration.basic.circle?$("#basic_circle_radius").val(configuration.basic.circle.radius):($("#basic_circle_radius").val(50),configuration.basic.circle={radius:50}),configuration.basic.elm?($("#basic_stroke_width").val(configuration.basic.elm.stroke_width),displayMode||($("#basic_elm_fill")[0].jscolor.fromString(configuration.basic.elm.fill?configuration.basic.elm.fill:""),$("#basic_elm_color")[0].jscolor.fromString(configuration.basic.elm.color?configuration.basic.elm.color:""))):($("#basic_stroke_width").val(5),configuration.basic.elm={stroke_width:5}),configuration.basic.icon?($("#basic_icon_height").val(configuration.basic.icon.height),$("#basic_icon_width").val(configuration.basic.icon.width),displayMode||$("#basic_icon_color")[0].jscolor.fromString(configuration.basic.icon.color?configuration.basic.icon.color:"")):($("#basic_icon_height").val(24),$("#basic_icon_width").val(24),configuration.basic.icon={width:24,height:24}),updateLineAnimation(),$("#style_user").empty().append(configuration.basic.styles),$("#own_css").length>0&&$("#own_css").val(configuration.basic.styles),configuration.hasOwnProperty("datasources")){for(var t of Object.keys(configuration.datasources)){let a=configuration.datasources[t];a&&addDataSourceRow(t,a.source,a.alias)}$(".data-table th:eq(0)").click()}configuration.hasOwnProperty("calculation")&&(configuration.calculation.battery.charge&&getDataSources("calc_battery_charge",configuration.calculation.battery.charge,!0),configuration.calculation.battery.discharge&&getDataSources("calc_battery_discharge",configuration.calculation.battery.discharge,!0),configuration.calculation.battery.percent&&getDataSources("calc_battery_percent",configuration.calculation.battery.percent,!0),$("#calc_battery_dod").val(configuration.calculation.battery.dod),$("#calc_battery_capacity").val(configuration.calculation.battery.capacity),$("#calc_battery_discharge_kw").prop("checked",configuration.calculation.battery.discharge_kw),$("#calc_battery_discharge_prop").prop("checked",configuration.calculation.battery.discharge_prop),$("#calc_battery_charge_kw").prop("checked",configuration.calculation.battery.charge_kw),$("#calc_battery_charge_prop").prop("checked",configuration.calculation.battery.charge_prop)),configuration.hasOwnProperty("elements")?($(".placeholders").empty(),console.log("Loading User Config ..."),Object.entries(configuration.elements).forEach(e=>{let[t,a]=e,o=a.source>=0?a.source:-1;addElement({format:a.type,subType:a.subType,id:a.id,radius:a.radius,width:a.width,height:a.height,rx:a.rx,stroke:a.stroke,pos_x:a.pos_x,pos_y:a.pos_y,color:a.color,fill:a.fill,align:a.align||"middle",icon:a.icon,connPoint1:a.startSlot,connPoint2:a.endSlot,text:a.text,font_size:a.font_size,font_family:a.font_family,unit:a.unit,source:o,source_option:a.source_option||-1,source_display:a.source_display||"value",degree:a.degree,shadow:a.shadow,threshold:a.threshold||0,convert:a.convert||!1,calculate_kw:a.calculate_kw||!1,decimal_places:a.decimal_places||0,url:a.url||"",frame:a.frame||"_overlay",fill_value:a.fill_value||"",fill_type:a.fill_type||-1,fill_max:a.fill_max||"",subtract:a.subtract||"[-1]"})}),Object.entries(configuration.defs).forEach(e=>{let[t,a]=e;addElement({format:a.type,id:a.id,connPoint1:a.startSlot,connPoint2:a.endSlot,d:a.d})}),Object.entries(configuration.lines).forEach(e=>{let[t,a]=e;addElement({format:a.type,id:a.id,href:a.href,color:a.color,shadow:a.shadow})}),Object.entries(configuration.animations).forEach(e=>{let[t,a]=e;addElement({format:a.type,id:a.id,href:a.href,color:a.color,source:a.source,animation_properties:a.animation_properties||"positive",threshold:a.threshold||0,dots:a.dots||0,duration:a.duration||0,power:a.power||0,animation_type:a.animation_type||-1})}),displayMode&&($("#svg_display").attr({viewBox:"0 0 "+configuration.basic.width+" "+configuration.basic.height}),$(".all_elements").removeClass("draggable draggable-group anim_element no_animation"),$(".type_animation").addClass("animation"),$("#config_link > a").attr("href","configuration.html?instance="+instance),!1==configuration.basic.enable_config_icon?$("#config_link").hide():$("#config_link").show(),$(".type_datasource").html("").attr("title",""),$("#overlay_frame").on("load",function(){""!=$(this).attr("src")&&($(".loading-spinner, #loading_text").fadeOut("fast"),$("#display_container").fadeIn("middle").css("display","block"))}),$(".connector").each(function(){$(this).data("url")&&($(this).css({"pointer-events":"all",cursor:"pointer"}),$(this).click(function(){switch($(this).data("frame")){case"_blank":case"_self":var e=window.open($(this).data("url"),$(this).data("frame"));e?e.focus():failedMessage("You need to allow opening URL's for this Website!");break;case"_overlay":displayLoading("Loading site for element"),$("#overlay_frame").attr("src",$(this).data("url"))}console.log("URL found! "+$(this).data("url")+"Frame: "+$(this).data("frame"))}))}),e?console.log("Applying config without re-adding socket listener!"):displayListener()),basicConfig||displayMode||successMessage("Layout configuration was loaded successfully!"),$("#loading").fadeOut("fast")):(successMessage("Basic configuration was loaded successfully!"),$("#loading").fadeOut("fast"))}function updateLineAnimation(){$("#style_animation").empty().append(".line {stroke-width:"+configuration.line.stroke_width+"px; stroke:"+configuration.line.stroke+";}").append(".animation {stroke:"+configuration.animation.stroke+"; stroke-dasharray:"+configuration.animation.stroke_dasharray+";").append("stroke-width:"+configuration.animation.stroke_width+"px; animation-duration:"+configuration.animation.animation_duration+"ms;").append("stroke-linecap:"+configuration.animation.stroke_linecap+"; animation-timing-function:"+configuration.animation.animation_timing_function+";}"),displayMode&&$("#style_animation").append(".type_animation {display: none;}")}function linePreview(e){let t="",a=136,o=parseInt($("#animation_width").val()),i=parseInt($("#animation_dots").val()),r=parseInt($("#animation_distance").val()),s=parseInt($("#animation_length").val()),l=parseInt($("#line_size").val()),n=parseInt($("#animation_duration").val()),c=$("#animation_linecap").val(),d=$("#animation_type").val();for(let h=0;h<i;h++)r>0&&s>0&&(t+=s+" ",h!=i-1&&(t+=r+" ",a-=r),a-=s);i>0&&s>0&&r&&(t+=" "+a),a<0&&$("#"+e).val($("#"+e).val()-1),configuration.animation.stroke_dasharray=t,configuration.animation.stroke_width=o,configuration.animation.animation_duration=n,configuration.animation.stroke_linecap=c,configuration.animation.animation_timing_function=d,configuration.line.stroke_width=l,configuration.animation_configuration.dots=i,configuration.animation_configuration.distance=r,configuration.animation_configuration.length=s,updateLineAnimation()}function successMessage(e){$("#message_success").html(e),$("#message_success").fadeIn("middle").delay(2e3).fadeOut("middle")}function failedMessage(e){$("#message_failed").html(e),$("#message_failed").fadeIn("middle").delay(2e3).fadeOut("middle")}function getRotationDegrees(e){var t=e.css("-webkit-transform")||e.css("-moz-transform")||e.css("-ms-transform")||e.css("-o-transform")||e.css("transform");if("none"!==t)var a=t.split("(")[1].split(")")[0].split(","),o=a[0],i=Math.round(Math.atan2(a[1],o)*(180/Math.PI));else var i=0;return i}function resizeSVG(){$("#svg_config").attr({width:$("#svg_width_value").val(),height:$("#svg_height_value").val(),viewBox:"0 0 "+$("#svg_width_value").val()+" "+$("#svg_height_value").val()})}function getCoords(e){let t,a,o,i,r,s,l,n,c;return o=null!=$(e="#"+e).attr("r")?parseInt($(e).attr("r")):0,t=null!=$(e).attr("x")?parseInt($(e).attr("x")):parseInt($(e).attr("cx"))-o,a=null!=$(e).attr("y")?parseInt($(e).attr("y")):parseInt($(e).attr("cy"))-o,n=null!=$(e).attr("cx")?parseInt($(e).attr("cx")):0,c=null!=$(e).attr("cy")?parseInt($(e).attr("cy")):0,i=null!=$(e).attr("width")?parseInt($(e).attr("width")):2*o,r=null!=$(e).attr("height")?parseInt($(e).attr("height")):2*o,s=parseInt($(e).css("stroke-width")),"text"===$(e).prop("tagName")&&(i=Math.round(document.getElementById(e.replace("#","")).getComputedTextLength()),r=parseInt($(e).css("font-size")),t=Math.round(t-Math.floor(i/2)),a=Math.round(a-Math.floor(r/2))),{x:t,y:a,cx:n,cy:c,width:i,height:r,r:o,stroke:s,slot:l}}function showConnectionPoints(e=!0){e?($("#connection_points").empty(),$(".connector").each(function(){let e=$(this).attr("id"),t={};t[e]={};let a=$(this).prop("tagName"),o,i,r,s,l,n,c;switch(a){case"circle":o=parseInt(2*$(this).attr("r")),i=parseInt(2*$(this).attr("r")),r=parseInt($(this).attr("cx")-i/2),s=parseInt($(this).attr("cy")-o/2),l=parseInt($(this).attr("r")),n=parseInt($(this).attr("cx")),c=parseInt($(this).attr("cy")),t[e].top_left={x:n+l*Math.cos(connectorAngle(340)),y:c+l*Math.sin(connectorAngle(340))},t[e].top_right={x:n+l*Math.cos(connectorAngle(20)),y:c+l*Math.sin(connectorAngle(20))},t[e].right_top={x:n+l*Math.cos(connectorAngle(70)),y:c+l*Math.sin(connectorAngle(70))},t[e].right_bottom={x:n+l*Math.cos(connectorAngle(110)),y:c+l*Math.sin(connectorAngle(110))},t[e].bottom_left={x:n+l*Math.cos(connectorAngle(200)),y:c+l*Math.sin(connectorAngle(200))},t[e].bottom_right={x:n+l*Math.cos(connectorAngle(160)),y:c+l*Math.sin(connectorAngle(160))},t[e].left_bottom={x:n+l*Math.cos(connectorAngle(250)),y:c+l*Math.sin(connectorAngle(250))},t[e].left_top={x:n+l*Math.cos(connectorAngle(290)),y:c+l*Math.sin(connectorAngle(290))};break;case"rect":o=parseInt($(this).attr("height")),i=parseInt($(this).attr("width")),r=parseInt($(this).attr("x")),s=parseInt($(this).attr("y")),t[e].top_left={x:r+i/2-20,y:s},t[e].top_right={x:r+i/2+20,y:s},t[e].left_top={x:r,y:s+o/2-20},t[e].left_bottom={x:r,y:s+o/2+20},t[e].right_top={x:r+i,y:s+o/2-20},t[e].right_bottom={x:r+i,y:s+o/2+20},t[e].bottom_left={x:r+i/2-20,y:s+o},t[e].bottom_right={x:r+i/2+20,y:s+o}}t[e].top={x:r+i/2,y:s},t[e].left={x:r,y:s+o/2},t[e].right={x:r+i,y:s+o/2},t[e].bottom={x:r+i/2,y:s+o},Object.entries(t).forEach(t=>{let[a,o]=t;Object.entries(o).forEach(t=>{let[a,o]=t,i=document.createElementNS("http://www.w3.org/2000/svg","circle");i.setAttribute("class","tmp_conn_points"),i.setAttribute("cx",o.x),i.setAttribute("cy",o.y),i.setAttribute("r",5),i.setAttribute("class","connPoints clickable"),i.setAttribute("data-slot",a),i.setAttribute("data-element",e),$(i).appendTo("#connection_points")})})})):$("#connection_points").empty()}function getSlots(e){let t={},a={},o={},i={};return t.x=e.x+Math.floor(e.width/2),t.y=e.y-Math.floor(e.stroke/2),t.direction="vertical",a.x=e.x+e.width+Math.floor(e.stroke/2),a.y=e.y+Math.floor(e.height/2),a.direction="horizontal",o.x=e.x+e.width/2,o.y=e.y+e.height+Math.floor(e.stroke/2),o.direction="vertical",i.x=e.x-Math.floor(e.stroke/2),i.y=e.y+Math.floor(e.height/2),i.direction="horizontal",{top:t,right:a,bottom:o,left:i}}function connectorAngle(e){return(e-90)*Math.PI/180}function getSpecialSlots(e,t){let a=[];return a.top={x:e.x+e.width/2,y:e.y-e.stroke/2,direction:"vertical"},a.left={x:e.x-e.stroke/2,y:e.y+e.height/2,direction:"horizontal"},a.right={x:e.x+e.width+e.stroke/2,y:e.y+e.height/2,direction:"horizontal"},a.bottom={x:e.x+e.width/2,y:e.y+e.height+e.stroke/2,direction:"vertical"},e.r>0?(a.top_left={x:e.cx+e.r*Math.cos(connectorAngle(340)),y:e.cy+e.r*Math.sin(connectorAngle(340))-e.stroke/2,direction:"vertical"},a.top_right={x:e.cx+e.r*Math.cos(connectorAngle(20)),y:e.cy+e.r*Math.sin(connectorAngle(20))-e.stroke/2,direction:"vertical"},a.right_top={x:e.cx+e.r*Math.cos(connectorAngle(70))+e.stroke/2,y:e.cy+e.r*Math.sin(connectorAngle(70)),direction:"horizontal"},a.right_bottom={x:e.cx+e.r*Math.cos(connectorAngle(110))+e.stroke/2,y:e.cy+e.r*Math.sin(connectorAngle(110)),direction:"horizontal"},a.bottom_left={x:e.cx+e.r*Math.cos(connectorAngle(200)),y:e.cy+e.r*Math.sin(connectorAngle(200))+e.stroke/2,direction:"vertical"},a.bottom_right={x:e.cx+e.r*Math.cos(connectorAngle(160)),y:e.cy+e.r*Math.sin(connectorAngle(160))+e.stroke/2,direction:"vertical"},a.left_bottom={x:e.cx+e.r*Math.cos(connectorAngle(250))-e.stroke/2,y:e.cy+e.r*Math.sin(connectorAngle(250)),direction:"horizontal"},a.left_top={x:e.cx+e.r*Math.cos(connectorAngle(290))-e.stroke/2,y:e.cy+e.r*Math.sin(connectorAngle(290)),direction:"horizontal"}):(a.top_left={x:e.x+e.width/2-20,y:e.y-e.stroke/2,direction:"vertical"},a.top_right={x:e.x+e.width/2+20,y:e.y-e.stroke/2,direction:"vertical"},a.right_top={x:e.x+e.width+e.stroke/2,y:e.y+e.height/2-20,direction:"horizontal"},a.right_bottom={x:e.x+e.width+e.stroke/2,y:e.y+e.height/2+20,direction:"horizontal"},a.bottom_left={x:e.x+e.width/2-20,y:e.y+e.height+e.stroke/2,direction:"vertical"},a.bottom_right={x:e.x+e.width/2+20,y:e.y+e.height+e.stroke/2,direction:"vertical"},a.left_top={x:e.x-e.stroke/2,y:e.y+e.height/2-20,direction:"horizontal"},a.left_bottom={x:e.x-e.stroke/2,y:e.y+e.height/2+20,direction:"horizontal"}),{spec:a[t]}}function getDistance(e,t){let a=0,o=0;return a=t.x>e.x?t.x-e.x:e.x-t.x,a*=a,o=t.y>e.y?t.y-e.y:e.y-t.y,Math.sqrt(a+(o*=o))}function connectElements(e,t,a,o=!0){let i=getCoords(t),r=getCoords(a),s,l,n,c;s=$("#"+e).data("start-slot"),l=$("#"+e).data("end-slot");let d=[],h=[],f=[],u=[],m=[],g=[],p=[];for(var y of(n="undefined"!=s?getSpecialSlots(i,s):getSlots(i),c="undefined"!=l?getSpecialSlots(r,l):getSlots(r),Object.keys(n))){let b=n[y];for(var y of Object.keys(c)){let v=c[y];d.push(getDistance(b,v)),h.push(b.x),u.push(b.y),g.push(b.direction),f.push(v.x),m.push(v.y),p.push(v.direction)}}let x=d[0],w=0;for(var k=1;k<d.length;k++)d[k]<x&&(x=d[k],w=k);let A=h[w],C=u[w],S;drawPath(e,A,C,f[w],m[w],g[w],p[w],o)}function polarToCartesian(e,t,a,o){var i=(o-90)*Math.PI/180;return{x:e+a*Math.cos(i),y:t+a*Math.sin(i)}}function describeArc(e,t,a,o,i,r){var s=polarToCartesian(e,t,a,i);return polarToCartesian(e,t,a,o),["A",a,a,0,i-o<=180?"0":"1",r,s.x,s.y]}function drawPath(e,t,a,o,i,r,s,l){let n={x:0,y:0},c=[],d=t>o?t-o:o-t,h=a>i?a-i:i-a,f=15;d<2*f&&(f=Math.floor(d/2)),h<2*f&&(f=Math.floor(h/2));let u=o>t?parseInt(o-t):parseInt(t-o),m=parseInt(i-a);c[0]="M"+t+" "+a,n={x:t,y:a};let g;if(o>t){let p=t+.2*u;c[1]=" H "+p,n.x=p}if(o<t){let y=t-.2*u;c[1]=" H "+y,n.x=y}if(i==a&&(c[1]=" H "+o),o===t&&(c[1]=" V "+i),o!=t&&i!=a){if(i>a&&o>t){g=describeArc(n.x,n.y+f,f,0,90,1);let b=i-f;if(n={x:g[6],y:g[7]},c[2]=g.join(" "),c[3]=" V "+b,n.y=b,g=describeArc(n.x,n.y+f,f,0,90,0),c[4]=g.join(" "),c[5]=" H "+o,"vertical"==r&&"vertical"==s){n={x:t,y:a};let v=a+.2*m;c[1]=" V "+v,n.y=v,g=describeArc(n.x,n.y+f,f,0,90,0),v=o-f,n={x:g[6],y:g[7]},c[2]=g.join(" "),c[3]=" H "+v,n.x=v,n={x:(g=describeArc(n.x,n.y+f,f,0,90,1))[6],y:g[7]},c[4]=g.join(" "),c[5]=" V "+i}if("horizontal"==r&&"vertical"==s){n={x:t,y:a};let x=t+.2*u;c[1]=" H "+x,n.x=x,x=o-f,c[2]="",c[3]=" H "+x,n.x=x,n={x:(g=describeArc(n.x,n.y+f,f,0,90,1))[6],y:g[7]},c[4]=g.join(" "),c[5]=" V "+i}if("vertical"==r&&"horizontal"==s){let w=a+.2*m;n={x:t,y:w},c[1]=" V "+w,w=i-f,n.y=w,c[2]="",c[3]=" V "+w,g=describeArc(n.x,n.y+f,f,0,90,0),c[4]=g.join(" "),c[5]=" H "+o}}if(i>a&&o<t){g=describeArc(n.x,n.y+f,f,180,270,0);let k=i-f;if(n={x:g[6],y:k},c[2]=g.join(" "),c[3]=" V "+k,g=describeArc(n.x,n.y+f,f,180,270,1),c[4]=g.join(" "),c[5]=" H "+o,"vertical"==r&&"vertical"==s){let A=a+.2*m;n={x:t,y:A},c[1]=" V "+A,g=describeArc(n.x-f,n.y,f,90,180,1),n={x:A=o+f,y:g[7]},c[2]=g.join(" "),c[3]=" H "+A,g=describeArc(n.x,n.y+f,f,180,270,0),c[4]=g.join(" "),c[5]=" V "+i}if("vertical"==r&&"horizontal"==s){let C=a+.2*m;n={x:t,y:C},c[1]=" V "+C,C=i-f,n.y=C,c[2]="",c[3]=" V "+C,g=describeArc(n.x,n.y+f,f,180,270,1),c[4]=g.join(" "),c[5]=" H "+o}if("horizontal"==r&&"vertical"==s){n={x:t,y:a};let S=t-.2*u;c[1]=" H "+S,n.x=S,S=o+f,c[2]="",c[3]=" H "+S,n.x=S,n={x:(g=describeArc(n.x,n.y+f,f,180,270,0))[6],y:g[7]},c[4]=g.join(" "),c[5]=" V "+i}}if(i<a&&o>t){g=describeArc(n.x,n.y-f,f,0,90,0);let E=i+f;if(n={x:g[6],y:E},c[2]=g.join(" "),c[3]=" V "+E,g=describeArc(n.x+f,n.y,f,270,360,1),c[4]=g.join(" "),c[5]=" H "+o,"vertical"==r&&"horizontal"==s){let L=a+.2*m;n={x:t,y:L},c[1]=" V "+L,L=i+f,n.y=L,c[2]="",c[3]=" V "+L,g=describeArc(n.x,n.y-f,f,0,90,1),c[4]=g.join(" "),c[5]=" H "+o}if("vertical"==r&&"vertical"==s){let j=a+.2*m;n={x:t,y:j},c[1]=" V "+j,g=describeArc(n.x,n.y-f,f,0,90,1),n={x:j=o-f,y:g[7]},c[2]=g.join(" "),c[3]=" H "+j,g=describeArc(n.x,n.y-f,f,0,90,0),c[4]=g.join(" "),c[5]=" V "+i}if("horizontal"==r&&"vertical"==s){n={x:t,y:a};let z=t+.2*u;c[1]=" H "+z,n.x=z,z=o-f,c[2]="",c[3]=" H "+z,n.x=z,n={x:(g=describeArc(n.x,n.y-f,f,0,90,0))[6],y:g[7]},c[4]=g.join(" "),c[5]=" V "+i}}if(i<a&&o<t){g=describeArc(n.x,n.y-f,f,180,270,1);let D=i+f;if(n={x:g[6],y:D},c[2]=g.join(" "),c[3]=" V "+D,g=describeArc(n.x-2*f,n.y-f,f,0,90,0),c[4]=g.join(" "),c[5]=" H "+o,"vertical"==r&&"horizontal"==s){let I=a+.2*m;n={x:t,y:I},c[1]=" V "+I,c[2]="",I=i+f,n.y=I,g=describeArc(n.x-2*f,n.y-f,f,0,90,0),c[4]=g.join(" "),c[5]=" H "+o}if("vertical"==r&&"vertical"==s){let P=a+.2*m;n={x:t,y:P},c[1]=" V "+P,g=describeArc(n.x-2*f,n.y-f,f,0,90,0),n={x:P=o+f,y:g[7]},c[2]=g.join(" "),c[3]=" H "+P,g=describeArc(n.x,n.y-f,f,180,270,1),c[4]=g.join(" "),c[5]="  V "+i}if("horizontal"==r&&"vertical"==s){n={x:t,y:a};let N=t-.2*u;c[1]=" H "+N,n.x=N,N=o+f,c[2]="",c[3]=" H "+N,n.x=N,n={x:(g=describeArc(n.x,n.y-f,f,180,270,1))[6],y:g[7]},c[4]=g.join(" "),c[5]=" V "+i}}}$("#"+e).attr("d",c.join(" "))}function getShadowColor(e){let t=$("#"+e).css("filter").replace("drop-shadow(","").split(" ");return"none"!=t[0]?t[0]+t[1]+t[2]+t[3]:""}function showConfigBar(e,t){$("#tab1_config").prop("checked",!0);let a=$("#"+e).data("type")?$("#"+e).data("type"):"";getElements("elm_select",e),$("#description_elm").text(e),$("#description_type").text(t+" "+a);let o,i=getShadowColor(o="use"==t?e.replace("anim","line"):e);switch($("#elm_shadow").prop("checked",""!=i),$("#elm_calculation").prop("checked",!1),$("#elm_convert").prop("checked",!1),restore={},$(".elm_config").attr("style",""),$(".all_elements").addClass("faded_out"),$("#"+e).removeClass("faded_out"),$(".elm_config").prop("disabled",!1),restore.id=$("#"+e).attr("id"),$(".elm_config_circle, .elm_config_text, .elm_config_rect, .elm_config_use, .elm_config_datasource, .elm_config_svg, .anim_type_duration, .anim_type_dots, .fill_type").hide(),restore.shadow_color=i,$("#elm_shadow_color")[0].jscolor.fromString(restore.shadow_color),restore.color="none"==$("#"+e).css("stroke")?"":$("#"+e).css("stroke"),$("#elm_color")[0].jscolor.fromString(restore.color),t){case"rect":$(".elm_config_rect").show(),restore.width=$("#"+e).attr("width"),$("#elm_width").val(restore.width),restore.height=$("#"+e).attr("height"),$("#elm_height").val(restore.height),restore.pos_x=$("#"+e).attr("x"),$("#elm_pos_x").val(restore.pos_x),restore.pos_y=$("#"+e).attr("y"),$("#elm_pos_y").val(restore.pos_y),restore.rx=$("#"+e).attr("rx"),$("#elm_rx").val(restore.rx),restore.fill="none"==$("#"+e).css("fill")||$("#"+e).css("fill").includes("url")?"":$("#"+e).css("fill"),$("#elm_fill")[0].jscolor.fromString(restore.fill),restore.stroke=$("#"+e).css("stroke-width").replace("px",""),$("#elm_stroke").val(restore.stroke),restore.url=$("#"+e).data("url"),$("#elm_url").val(restore.url),restore.frame=$("#"+e).data("frame"),$("#elm_frame").val(restore.frame),restore.fill_value=""==$("#"+e).data("fill_value")?"":$("#"+e).data("fill_value"),$("#elm_fill_value")[0].jscolor.fromString(restore.fill_value),restore.fill_type=$("#"+e).data("fill_type"),$("#elm_fill_type").val(restore.fill_type),-1!=restore.fill_type&&$(".fill_type").show(),restore.fill_max=$("#"+e).data("fill_max"),$("#elm_fill_max").val(restore.fill_max),restore.source=$("#"+e).data("source"),getDataSources("elm_source",restore.source);break;case"circle":$(".elm_config_circle").show(),restore.radius=$("#"+e).attr("r"),$("#elm_radius").val(restore.radius),restore.pos_x=$("#"+e).attr("cx"),$("#elm_pos_x").val(restore.pos_x),restore.pos_y=$("#"+e).attr("cy"),$("#elm_pos_y").val(restore.pos_y),restore.fill="none"==$("#"+e).css("fill")||$("#"+e).css("fill").includes("url")?"":$("#"+e).css("fill"),$("#elm_fill")[0].jscolor.fromString(restore.fill),restore.stroke=$("#"+e).css("stroke-width").replace("px",""),$("#elm_stroke").val(restore.stroke),restore.url=$("#"+e).data("url"),$("#elm_url").val(restore.url),restore.frame=$("#"+e).data("frame"),$("#elm_frame").val(restore.frame),restore.fill_value=""==$("#"+e).data("fill_value")?"":$("#"+e).data("fill_value"),$("#elm_fill_value")[0].jscolor.fromString(restore.fill_value),restore.fill_type=$("#"+e).data("fill_type"),$("#elm_fill_type").val(restore.fill_type),-1!=restore.fill_type&&$(".fill_type").show(),restore.fill_max=$("#"+e).data("fill_max"),$("#elm_fill_max").val(restore.fill_max),restore.source=$("#"+e).data("source"),getDataSources("elm_source",restore.source,!0);break;case"text":$(".elm_config_text").show(),$(".elm_config_text_not_ds").show(),"datasource"==a&&(restore.unit=$("#"+e).data("unit"),$("#elm_unit").val(restore.unit),restore.source=$("#"+e).data("source"),getDataSources("elm_source",restore.source,!0),restore.source_option=$("#"+e).data("source_option"),$("#elm_source_option").val(restore.source_option),restore.source_display=$("#"+e).data("source_display"),$("#elm_source_display").val(restore.source_display),restore.calculate_kw=$("#"+e).data("calculate_kw"),$("#elm_calculation").prop("checked",!0===restore.calculate_kw),restore.convert=$("#"+e).data("convert"),$("#elm_convert").prop("checked",!0===restore.convert),restore.threshold=$("#"+e).data("threshold"),$("#elm_threshold").val(restore.threshold),restore.decimal_places=$("#"+e).data("decimal_places"),$("#elm_decimal_places").val(restore.decimal_places),$(".elm_config_datasource").show(),$(".elm_config_text_not_ds").hide(),restore.subtract=$("#"+e).data("subtract"),getDataSources("elm_subtract",restore.subtract,!1),$("#elm_subtract").multiselect("unload"),$("#elm_subtract").multiselect({columns:1,search:!0,minWidth:250,maxWidth:300,maxPlaceholderOpts:1,texts:{placeholder:"Select Source"}})),restore.pos_x=$("#"+e).attr("x"),$("#elm_pos_x").val(restore.pos_x),restore.pos_y=$("#"+e).attr("y"),$("#elm_pos_y").val(restore.pos_y),restore.fill="none"==$("#"+e).css("fill")?"":$("#"+e).css("fill"),$("#elm_fill")[0].jscolor.fromString(restore.fill),restore.text=$("#"+e).html(),$("#elm_text").val(restore.text),restore.align=$("#"+e).css("text-anchor"),$("#elm_align").val(restore.align),restore.font=$("#"+e).css("font-family"),$("#elm_font").val(restore.font),restore.degree=getRotationDegrees($("#"+e)),restore.font_size=$("#"+e).css("font-size").replace("px",""),$("#elm_font_size").val(restore.font_size);break;case"use":let r=e.replace("anim","line");restore.source=$("#"+e).data("source"),getDataSources("elm_animation",restore.source),restore.animation_properties=$("#"+e).data("animation_properties"),$("#elm_animation_properties").val(restore.animation_properties),restore.threshold=$("#"+e).data("threshold"),$("#elm_threshold").val(restore.threshold),$(".elm_config_use").show(),$("#"+r).removeClass("faded_out"),restore.line_color=$("#"+r).css("stroke"),$("#elm_line_color")[0].jscolor.fromString(restore.line_color),restore.startSlot=$("#"+e.replace("anim_","")).data("start-slot"),restore.endSlot=$("#"+e.replace("anim_","")).data("end-slot"),restore.elm_dots=$("#"+e).data("dots"),$("#elm_dots").val(restore.elm_dots),restore.elm_duration=$("#"+e).data("duration"),$("#elm_duration").val(restore.elm_duration),restore.elm_power=$("#"+e).data("power"),$("#elm_power").val(restore.elm_power),restore.elm_animation_type=$("#"+e).data("animation_type"),$("#elm_animation_type").val(restore.elm_animation_type),$(".anim_type_"+restore.elm_animation_type).show();break;case"svg":$(".elm_config_svg").show(),restore.width=$("#"+e).attr("width"),$("#elm_width").val(restore.width),restore.elm_height=$("#"+e).attr("height"),$("#elm_height").val(restore.elm_height),restore.pos_x=$("#"+e).attr("x"),$("#elm_pos_x").val(restore.pos_x),restore.pos_y=$("#"+e).attr("y"),$("#elm_pos_y").val(restore.pos_y),restore.icon=$("#"+e).data("icon"),$("#elm_icon").val(restore.icon),restore.color=$("#"+e).css("color"),$("#elm_color")[0].jscolor.fromString(restore.color),restore.fill="none"==$("#"+e).css("fill")?"":$("#"+e).css("fill"),$("#elm_fill")[0].jscolor.fromString(restore.fill)}function s(t){let a=document.createElementNS("http://www.w3.org/2000/svg","symbol");a.setAttribute("x",$("#"+e).attr("x")),a.setAttribute("y",$("#"+e).attr("y")),a.setAttribute("data-width",$("#"+e).attr("width")),a.setAttribute("data-height",$("#"+e).attr("height")),a.setAttribute("data-icon",t),a.setAttribute("class","iconify type_icon all_elements added_elements draggable draggable-group"),a.setAttribute("id",restore.id),a.setAttribute("style","color: "+restore.color+";"),$("#"+e).remove(),$(a).appendTo("#placeholder_icons")}$("#config_bar").addClass("show"),$(".elm_config").off().on("input change",function(a){globalConfigChanged=!0;let o=$("#elm_fill").val()?$("#elm_fill").val():"none";"elm_shadow"==a.target.id&&""==$("#elm_shadow_color").val()&&$("#elm_shadow_color")[0].jscolor.fromString("rgba(0, 0, 0, 0.7)"),"elm_shadow_color"==a.target.id&&$("#elm_shadow").prop("checked",!0),"elm_animation_type"==a.target.id&&("dots"==$(this).val()?($(".anim_type_duration").hide(),$(".anim_type_dots").show()):"duration"==$(this).val()?($(".anim_type_dots").hide(),$(".anim_type_duration").show()):$(".anim_type_duration, .anim_type_dots").hide()),"elm_fill_type"==a.target.id&&(-1==$(this).val()?$(".fill_type").hide():$(".fill_type").show());let i="drop-shadow(0px 3px 3px "+$("#elm_shadow_color").val()+")",r=$("path[id*="+restore.id+"]");r.length>0&&r.each(function(e){let t=r[e].id.split("_");connectElements(r[e].id,t[1],t[2],!0)});let s=parseInt($("#svg_config").attr("height")),l=parseInt($("#svg_config").attr("width")),n=parseInt($("#elm_radius").val()),c=parseInt($("#elm_stroke").val())/2,d=parseInt($("#elm_font_size").val()),h,f;switch(t){case"rect":h=l-$("#elm_width").val()-c,f=s-$("#elm_height").val()-c,$("#elm_pos_x").val()-c>=0&&$("#elm_pos_x").val()<=h&&$("#elm_pos_y").val()-c>=0&&$("#elm_pos_y").val()<=f?$("#"+e).attr({width:$("#elm_width").val(),height:$("#elm_height").val(),rx:$("#elm_rx").val(),x:$("#elm_pos_x").val(),y:$("#elm_pos_y").val()}):$(this).val()>c?$("#"+a.target.id).val($(this).val()-1):$("#"+a.target.id).val(c),$("#"+e).data({frame:$("#elm_frame").val(),url:$("#elm_url").val(),fill_value:$("#elm_fill_value").val(),fill_type:$("#elm_fill_type").val(),source:$("#elm_source").val(),fill_max:$("#elm_fill_max").val()}),$("#"+e).css({"stroke-width":$("#elm_stroke").val()+"px",stroke:$("#elm_color").val(),fill:o}),$("#elm_shadow").is(":checked")?$("#"+e).css({filter:i}):$("#"+e).css({filter:""});break;case"circle":h=l-n-c,f=s-n-c,$("#elm_pos_x").val()-c-n>=0&&$("#elm_pos_y").val()-c-n>=0&&$("#elm_pos_x").val()<=h&&$("#elm_pos_y").val()-c>=0&&$("#elm_pos_y").val()<=f?$("#"+e).attr({r:$("#elm_radius").val(),cx:$("#elm_pos_x").val(),cy:$("#elm_pos_y").val()}):$("#elm_pos_x").val()-c-n<0||$("#elm_pos_y").val()-c-n<0?$("#"+a.target.id).val(parseInt($(this).val())+1):$("#"+a.target.id).val(parseInt($(this).val())-1),$("#"+e).data({frame:$("#elm_frame").val(),url:$("#elm_url").val(),fill_value:$("#elm_fill_value").val(),fill_type:$("#elm_fill_type").val(),source:$("#elm_source").val(),fill_max:$("#elm_fill_max").val()}),$("#"+e).css({"stroke-width":$("#elm_stroke").val()+"px",stroke:$("#elm_color").val(),fill:o}),$("#elm_shadow").is(":checked")?$("#"+e).css({filter:i}):$("#"+e).css({filter:""});break;case"text":h=l-$("#elm_font_size").val(),f=s-$("#elm_font_size").val()/2,$("#elm_pos_x").val()-d>=0&&$("#elm_pos_x").val()<=h&&$("#elm_pos_y").val()-d/2>=0&&$("#elm_pos_y").val()<=f?$("#"+e).attr({x:$("#elm_pos_x").val(),y:$("#elm_pos_y").val()}):$("#elm_pos_x").val()-d<0||$("#elm_pos_y").val()-d/2<0?$("#"+a.target.id).val(parseInt($(this).val())+1):$("#"+a.target.id).val(parseInt($(this).val())-1),$("#"+e).html($("#elm_text").val()),$("#"+e).data({unit:$("#elm_unit").val(),source:$("#elm_source").val(),source_option:$("#elm_source_option").val(),source_display:$("#elm_source_display").val(),threshold:$("#elm_threshold").val(),decimal_places:$("#elm_decimal_places").val(),calculate_kw:$("#elm_calculation").prop("checked"),convert:$("#elm_convert").prop("checked"),subtract:$("#elm_subtract").val()}),$("#"+e).css({"font-family":$("#elm_font").val(),"font-size":$("#elm_font_size").val()+"px",stroke:$("#elm_color").val(),fill:o,"text-anchor":$("#elm_align").val()}),$("#elm_shadow").is(":checked")?$("#"+e).css({filter:i}):$("#"+e).css({filter:""});break;case"use":let u=e.replace("anim","line");$("#"+e).data({threshold:$("#elm_threshold").val(),source:$("#elm_animation").val(),animation_properties:$("#elm_animation_properties").val(),dots:$("#elm_dots").val(),duration:$("#elm_duration").val(),power:$("#elm_power").val(),animation_type:$("#elm_animation_type").val()}),$("#"+e).css({stroke:$("#elm_color").val()}),$("#"+u).css({stroke:$("#elm_line_color").val()}),$("#elm_shadow").is(":checked")?$("#"+u).css({filter:i}):$("#"+u).css({filter:""});break;case"svg":$("#"+e).attr({width:$("#elm_width").val(),height:$("#elm_height").val(),x:$("#elm_pos_x").val(),y:$("#elm_pos_y").val()}),$("#"+e).css("color",$("#elm_color").val()),$("#elm_shadow").is(":checked")?$("#"+e).css({filter:i}):$("#"+e).css({filter:""})}}),$("#elm_icon").on("input",function(){$(this).autocomplete({position:{my:"right top",at:"right bottom"},source:function(e,t){$.ajax({minLength:1,url:"https://api.iconify.design/search?",type:"GET",data:{query:e.term},success:function(e){t($.map(e.icons,function(e){return{label:e}}))}})},select:function(e,t){return s(t.item.value),t.item.value}}).autocomplete("instance")._renderItem=function(e,t){return $("<li class='ui-menu-item'>").append("<div class='ui-menu-item-wrapper'><span class='iconify' data-width='24' data-icon='"+t.label+"'></span><span style='font-weight: normal; padding-left:10px;'>"+t.label+"</span></div>").appendTo(e)}}),$("#restore_element").off().click(function(){if(0===$("#"+e).length){let o=$("#elm_fill").val()?$("#elm_fill").val():"none";addElement({format:t,subType:a,id:restore.id,radius:$("#elm_radius").val(),width:$("#elm_width").val(),height:$("#elm_height").val(),rx:$("#elm_rx").val(),stroke:$("#elm_stroke").val(),pos_x:$("#elm_pos_x").val(),pos_y:$("#elm_pos_y").val(),color:$("#elm_color").val(),line_color:$("#elm_line_color").val(),fill:o,icon:$("#elm_icon").val(),connPoint1:restore.startSlot,connPoint2:restore.endSlot,text:$("#elm_text").val(),align:$("#elm_align").val(),font_size:$("#elm_font_size").val(),font_family:$("#elm_font").val(),unit:$("#elm_unit").val(),source:$("#elm_source").val(),source_option:$("#elm_source_option").val(),source_display:$("#elm_source_display").val(),degree:restore.degree,shadow:$("#elm_shadow_color").val(),animation:$("#elm_animation").val(),animation_properties:$("#elm_animation_properties").val(),threshold:$("#elm_threshold").val(),calculate_kw:$("#elm_calculation").prop("checked"),convert:$("#elm_convert").prop("checked"),decimal_places:$("#elm_decimal_places").val(),url:$("#elm_url").val(),frame:$("#elm_frame").val(),fill_value:$("#elm_fill_value").val(),fill_type:$("#elm_fill_type").val(),fill_max:$("#elm_fill_max").val(),dots:$("#elm_dots").val(),duration:$("#elm_duration").val(),power:$("#elm_power").val(),animation_type:$("#elm_animation_type").val(),subtract:$("#elm_subtract").val()}),$("#"+e).length>0?(successMessage("Element restored!"),$(".elm_config").prop("disabled",!1)):(failedMessage("An Error occured, while restoring the Element!"),$(".elm_config").prop("disabled",!0))}else{Object.entries(restore).forEach(e=>{let[t,a]=e;$("#elm_"+t).val(a)});let i="none"==restore.fill||""==restore.fill||void 0==restore.fill?"none":restore.fill,r="";switch(restore.shadow_color?(r="drop-shadow(0px 3px 3px "+restore.shadow_color+")",$("#elm_shadow").prop("checked",!0)):$("#elm_shadow").prop("checked",!1),$("#elm_fill")[0].jscolor.fromString("none"==i?"":i),$("#elm_color")[0].jscolor.fromString(restore.color?restore.color:""),$("#elm_fill_value")[0].jscolor.fromString(restore.fill_value?restore.fill_value:""),$("#elm_line_color")[0].jscolor.fromString(restore.line_color?restore.line_color:""),$("#elm_shadow_color")[0].jscolor.fromString(restore.shadow_color?restore.shadow_color:""),t){case"rect":$("#"+e).attr({width:restore.width,height:restore.height,rx:restore.rx,x:restore.pos_x,y:restore.pos_y}),$("#"+e).data({url:restore.url,frame:restore.frame,fill_value:restore.fill_value,fill_type:restore.fill_type,fill_max:restore.fill_max,source:restore.source}),$("#"+restore.id).css({"stroke-width":restore.stroke+"px",stroke:restore.color,fill:i,filter:r});break;case"circle":$("#"+e).attr({r:restore.radius,cx:restore.pos_x,cy:restore.pos_y}),$("#"+e).data({url:restore.url,frame:restore.frame,fill_value:restore.fill_value,fill_type:restore.fill_type,fill_max:restore.fill_max,source:restore.source}),$("#"+restore.id).css({"stroke-width":restore.stroke+"px",stroke:restore.color,fill:i,filter:r});break;case"text":$("#"+e).attr({x:restore.pos_x,y:restore.pos_y,transform:"rotate("+restore.degree+","+restore.pos_x+","+restore.pos_y+")"}),$("#"+e).html(restore.text),$("#"+e).css({"font-family":restore.font,"font-size":restore.font_size+"px",stroke:restore.color,fill:i,filter:r,"text-anchor":restore.align}),"datasource"==a&&($("#elm_calculation").prop("checked",!0===restore.calculate_kw),$("#elm_convert").prop("checked",!0===restore.convert),$("#"+e).data({unit:restore.unit,source:restore.source,source_option:restore.source_option,source_display:restore.source_display,calculate_kw:restore.calculate_kw,convert:restore.convert,threshold:restore.threshold,decimal_places:restore.decimal_places,subtract:restore.subtract}));break;case"use":let l=e.replace("anim","line");$("#"+e).data({animation:restore.animation,animation_properties:restore.animation_properties,dots:restore.elm_dots,duration:restore.elm_duration,power:restore.elm_power,animation_type:restore.elm_animation_type}),$("#"+e).css({stroke:restore.color}),$("#"+l).css({stroke:restore.line_color,filter:r});break;case"svg":s(restore.icon),$("#"+e).attr({width:restore.width,height:restore.height,x:restore.pos_x,y:restore.pos_y}),$("#"+e).css({color:restore.color,filter:r})}let n=$("path[id*="+restore.id+"]");n.length>0&&n.each(function(e){let t=n[e].id.split("_");connectElements(n[e].id,t[1],t[2],!0)})}}),$("#delete_element").off().click(function(){if(this.blur(),$(".elm_config").prop("disabled",!0),"use"==t)$("#"+e.replace("anim","line")).remove(),$("#"+e.replace("anim_","")).remove(),$("#"+e).remove(),successMessage("Line deleted!");else{let a=$("[id^=line_path"),o=!0;a.each(function(){let e=this.id.split("_");if(restore.id==e[2]||restore.id==e[3])return o=!1,!1}),o?($("#"+e).remove(),successMessage("Element deleted!")):failedMessage("Element can not be deleted! Existing connection!")}}),$("#rotate_cw, #rotate_ccw").off().click(function(t){if($("#"+e).length>0){let a=!0==t.target.id?t.target.id:$(this).closest("a").attr("id"),o=getRotationDegrees($("#"+e));o+="rotate_cw"==a?45:-45,$("#"+e).css({"transform-box":"fill-box",transform:"rotate("+o+"deg)"})}else console.log("Element deleted! No degree possible!")})}function hideConfigBar(){$(".all_elements").removeClass("faded_out"),$("#config_bar").removeClass("show").scrollTop(0),$(".elm_config").off().val(""),$("#tab1_config").prop("checked",!0),$("#elm_icon").hasClass("ui-autocomplete-input")&&$("#elm_icon").autocomplete("destroy")}function hideIframe(){$("#loading").fadeOut("fast",function(){$("#overlay_frame").attr("src",""),$("#display_container").hide()})}function addElement(e){let t="",a="all_elements added_elements draggable";switch(e.shadow&&(t=" filter: drop-shadow(0px 3px 3px "+e.shadow+");"),e.format){case"rect":let o=document.createElementNS("http://www.w3.org/2000/svg","rect");o.setAttribute("x",e.pos_x),o.setAttribute("y",e.pos_y),o.setAttribute("width",e.width),o.setAttribute("height",e.height),o.setAttribute("rx",e.rx),o.setAttribute("class",a+" type_rect connector"),o.setAttribute("data-url",e.url),o.setAttribute("data-frame",e.frame),o.setAttribute("data-fill_value",e.fill_value),o.setAttribute("data-fill_type",e.fill_type),o.setAttribute("data-fill_max",e.fill_max),o.setAttribute("data-source",e.source),o.setAttribute("id",e.id),o.setAttribute("style","stroke: "+e.color+"; stroke-width: "+e.stroke+"px; fill:"+e.fill+";"+t),$(o).appendTo("#placeholder_elements");break;case"circle":let i=document.createElementNS("http://www.w3.org/2000/svg","circle");i.setAttribute("cx",e.pos_x),i.setAttribute("cy",e.pos_y),i.setAttribute("r",e.radius),i.setAttribute("class",a+" type_circle connector"),i.setAttribute("data-url",e.url),i.setAttribute("data-frame",e.frame),i.setAttribute("data-fill_value",e.fill_value),i.setAttribute("data-fill_type",e.fill_type),i.setAttribute("data-fill_max",e.fill_max),i.setAttribute("data-source",e.source),i.setAttribute("id",e.id),i.setAttribute("style","stroke: "+e.color+"; stroke-width: "+e.stroke+"px; fill:"+e.fill+";"+t),$(i).appendTo("#placeholder_elements");break;case"text":let r=document.createElementNS("http://www.w3.org/2000/svg","text"),s="";e.degree&&(s=" transform-box: fill-box; transform: rotate("+e.degree+"deg);"),r.setAttribute("x",e.pos_x),r.setAttribute("y",e.pos_y),r.setAttribute("id",e.id),r.setAttribute("dominant-baseline","central"),r.setAttribute("style","stroke: "+e.color+"; fill: "+e.fill+"; font-family: "+e.font_family+"; text-anchor: "+e.align+"; transform-origin:50% 50%; font-size: "+e.font_size+"px;"+s+t),"datasource"==e.subType?(r.setAttribute("data-unit",e.unit),r.setAttribute("data-type","datasource"),r.setAttribute("class",a+" type_datasource"),r.setAttribute("data-source",e.source),r.setAttribute("data-source_option",e.source_option),r.setAttribute("data-source_display",e.source_display),r.setAttribute("data-threshold",e.threshold),r.setAttribute("data-calculate_kw",e.calculate_kw),r.setAttribute("data-convert",e.convert),r.setAttribute("data-decimal_places",e.decimal_places),r.setAttribute("data-subtract",JSON.stringify(e.subtract))):(r.setAttribute("data-type","text"),r.setAttribute("class",a+" type_text")),r.innerHTML=e.text,$(r).appendTo("#placeholder_text");break;case"svg":case"icon":let l=document.createElementNS("http://www.w3.org/2000/svg","symbol");l.setAttribute("x",e.pos_x),l.setAttribute("y",e.pos_y),l.setAttribute("class",a+" type_icon draggable-group iconify"),l.setAttribute("id",e.id),l.setAttribute("data-icon",e.icon),l.setAttribute("data-width",e.width),l.setAttribute("data-height",e.height),l.setAttribute("data-type","icon"),l.setAttribute("style","color: "+e.color+";"+t),$(l).appendTo("#placeholder_icons");break;case"use":console.log("Coming: "),console.log(e);let n=e.id.replace("anim_",""),c=n.split("_");addElement({format:"def",id:n,connPoint1:e.connPoint1,connPoint2:e.connPoint2}),addElement({format:"line",id:"line_"+n,color:e.line_color,href:"#"+n,shadow:e.shadow}),addElement({format:"animation",id:"anim_"+n,color:e.color,href:"#"+n,source:e.animation,animation_properties:e.animation_properties,threshold:e.threshold,dots:e.dots,duration:e.duration,power:e.power,animation_type:e.animation_type}),connectElements(n,c[1],c[2],!0);break;case"def":let d=document.createElementNS("http://www.w3.org/2000/svg","path");d.setAttribute("id",e.id),d.setAttribute("class","type_def"),d.setAttribute("data-start-slot",e.connPoint1),d.setAttribute("data-end-slot",e.connPoint2),d.setAttribute("d",e.d),$(d).appendTo("#placeholder_defs");break;case"line":let h=document.createElementNS("http://www.w3.org/2000/svg","use");h.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",e.href),h.setAttribute("id",e.id),h.setAttribute("class","line type_line all_elements"),h.setAttribute("style","stroke: "+e.color+";"+t),$(h).appendTo("#placeholder_lines");break;case"animation":a="type_animation all_elements anim_element",$("#enable_animation").prop("checked")?a+=" animation":a+=" no_animation";let f=document.createElementNS("http://www.w3.org/2000/svg","use");f.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",e.href),f.setAttribute("id",e.id),f.setAttribute("class",a),f.setAttribute("style","stroke: "+e.color+";"),f.setAttribute("data-source",e.source),f.setAttribute("data-animation_properties",e.animation_properties),f.setAttribute("data-threshold",e.threshold),f.setAttribute("data-dots",e.dots),f.setAttribute("data-duration",e.duration),f.setAttribute("data-power",e.power),f.setAttribute("data-animation_type",e.animation_type),$(f).appendTo("#placeholder_animations"),displayMode||$(".anim_element").off().click(function(e){showConfigBar(e.target.id,e.target.tagName.toLowerCase())})}}function getRandomInt(e){return Math.floor(Math.random()*e)}function getRandomRGBA(){var e=Math.round,t=Math.random;return"rgba("+e(255*t())+","+e(255*t())+","+e(255*t())+",1)"}function addDataSourceRow(e,t,a){$(".btn-cancel").trigger("click");let o=!0;if($(".data-table tbody tr").each(function(){if($("td:eq(1)",this).text().toLowerCase()==t.toLowerCase())return $(this).effect("highlight",{color:"lightgreen"},3e3),o=!1,!1}),o){if(-1==e){console.log("Need new Key!");let i=-1;$(".data-table tbody tr").each(function(){i=Math.max($(this).data("id"),i)}),i++,console.log("Found: "+i),e=i}let r="<tr data-source='"+t+"' data-alias='"+a+"' data-id='"+e+"'><td>"+a+"</td><td>"+t+"</td><td><button class='all_datasource ds_buttons btn-edit'><span class='iconify' data-height='24' data-icon='mdi:pencil'>Edit</span></button><button class='all_datasource ds_buttons btn-delete'><span class='iconify red_icon' data-height='24' data-icon='mdi:delete'>Delete</span></button></td></tr>";$(".data-table tbody").append(r),$(".data-table tbody").find("tr:last-child").hide().fadeIn("slow"),$("#ds_tmp_line").remove()}}function getdataSourceCellValue(e,t){return $(e).children("td").eq(t).text()}function dataSourceComparer(e){return function(t,a){var o=getdataSourceCellValue(t,e),i=getdataSourceCellValue(a,e);return $.isNumeric(o)&&$.isNumeric(i)?o-i:o.toString().localeCompare(i)}}function makeDraggable(e){var t=e.target;function a(){$("#svg_preview").removeClass("noscroll")}function o(e){var a=t.getScreenCTM();return e.touches&&(e=e.touches[0]),{x:parseInt((e.clientX-a.e)/a.a),y:parseInt((e.clientY-a.f)/a.d)}}t.addEventListener("mousedown",f),t.addEventListener("touchstart",f),t.addEventListener("mousemove",u),t.addEventListener("touchmove",u),t.addEventListener("mouseup",m),t.addEventListener("touchend",m),t.addEventListener("touchleave",m),t.addEventListener("touchcancel",m),t.addEventListener("keydown",function e(t){$(".anim_element").removeClass("animation").addClass("no_animation"),hideConfigBar();let a=!1,o=!1;if(Object.keys(r).length>0)for(var i of(s=!0,globalConfigChanged=!0,$("#svg_preview").addClass("noscroll"),Object.keys(r))){let l=r[i],n=l.id,c=0,d=0;$("#"+n).addClass("dragging");let f={x:0,y:0};switch(t.keyCode){case 39:f.x=1;break;case 37:f.x=-1;break;case 38:f.y=-1;break;case 40:f.y=1}switch(l.type){case"circle":c=parseInt($("#"+n).attr("cx")),d=parseInt($("#"+n).attr("cy")),c+f.x-l.stroke_width>=l.circle_radius&&c+f.x<l.max.x&&!a?$("#"+n).attr("cx",c+f.x):a=!0,d+f.y-l.stroke_width>=l.circle_radius&&d+f.y<l.max.y&&!o?$("#"+n).attr("cy",d+f.y):o=!0;break;case"rect":c=parseInt($("#"+n).attr("x")),d=parseInt($("#"+n).attr("y")),c+f.x-l.stroke_width>=0&&c+f.x<l.max.x&&!a?$("#"+n).attr("x",c+f.x):a=!0,d+f.y-l.stroke_width>=0&&d+f.y<l.max.y&&!o?$("#"+n).attr("y",d+f.y):o=!0;break;case"text":c=parseInt($("#"+n).attr("x")),d=parseInt($("#"+n).attr("y")),c+f.x-l.font_size>0&&c+f.x<l.max.x&&!a?$("#"+n).attr("x",c+f.x):a=!0,d+f.y-l.font_size/2>0&&d+f.y<l.max.y&&!o?$("#"+n).attr("y",d+f.y):o=!0;break;case"svg":c=parseInt($("#"+n).attr("x")),d=parseInt($("#"+n).attr("y")),c+f.x>0&&c+f.x<l.max.x&&!a?$("#"+n).attr("x",c+f.x):a=!0,d+f.y>0&&d+f.y<l.max.y&&!o?$("#"+n).attr("y",d+f.y):o=!0}if(l.reconnect_elements)for(var u of l.reconnect_elements)connectElements(u.path,u.from,u.to,!0)}else $(".draggable-multi, .draggable-multi-group").each(function(){r[this.id]={id:this.id,type:this.tagName}}),h(t,r)}),t.addEventListener("keyup",a);let i={},r={},s=!1,l=!1,n=!1,c=!1,d;function h(e,t){let a={},i=parseInt($("#svg_config").attr("height")),r=parseInt($("#svg_config").attr("width")),s;for(var l of Object.keys(t)){let n=t[l].id;s=$("path[id*="+n+"]");let c=[];s.length>0&&s.each(function(e){let t=s[e].id.split("_");c.push({path:s[e].id,from:t[1],to:t[2]})});let d=parseInt($("#"+n).css("strokeWidth"))/2,h=parseInt($("#"+n).attr("r")),f=$("#"+n).css("font-size").replace("px",""),u=o(e);switch(t[l].type){case"circle":a.x=r-h-d,a.y=i-h-d,u.x-=parseInt($("#"+n).attr("cx")),u.y-=parseInt($("#"+n).attr("cy"));break;case"rect":a.x=r-parseInt($("#"+n).attr("width"))-d,a.y=i-parseInt($("#"+n).attr("height"))-d,u.x-=parseInt($("#"+n).attr("x")),u.y-=parseInt($("#"+n).attr("y"));break;case"text":a.x=r-f,a.y=i-f/2,u.x-=parseInt($("#"+n).attr("x")),u.y-=parseInt($("#"+n).attr("y"));break;case"svg":a.x=r-parseInt($("#"+n).attr("width")),a.y=i-parseInt($("#"+n).attr("height")),u.x-=parseInt($("#"+n).attr("x")),u.y-=parseInt($("#"+n).attr("y"))}t[l].stroke_width=d,t[l].font_size=f,t[l].circle_radius=h,t[l].offset=u,t[l].max=a,t[l].reconnect_elements=c}}function f(e){if(e.target.classList.contains("draggable")&&(i[e.target.id]={id:e.target.id,type:e.target.tagName}),e.target.parentNode.classList.contains("draggable-group")&&(i[e.target.parentNode.id]={id:e.target.parentNode.id,type:e.target.parentNode.tagName}),(e.target.classList.contains("draggable-multi")||e.target.parentNode.classList.contains("draggable-multi-group"))&&$(".draggable-multi, .draggable-multi-group").each(function(){i[this.id]={id:this.id,type:this.tagName}}),e.target.classList.contains("lasso")&&(n=!0,d=o(e),$(".draggable-multi").removeClass("draggable-multi").addClass("draggable"),$(".draggable-multi-group").removeClass("draggable-multi-group").addClass("draggable draggable-group")),Object.keys(i).length>0){var t;s=!1,h(t=e,i)}}function u(e){if(n){i={},r={},l=!0;var t=o(e);if(c)$("#lasso_rect").attr({x:Math.min(d.x,t.x),y:Math.min(d.y,t.y),width:Math.abs(d.x-t.x),height:Math.abs(d.y-t.y)});else{let a=document.createElementNS("http://www.w3.org/2000/svg","rect");a.setAttribute("x",d.x),a.setAttribute("y",d.y),a.setAttribute("width",0),a.setAttribute("height",0),a.setAttribute("rx",0),a.setAttribute("id","lasso_rect"),a.setAttribute("style","stroke: var(--secondary); stroke-width: 2px; fill: var(--secondary); fill-opacity:0.2;"),$(a).appendTo("#placeholder_lasso"),c=!0}}if(Object.keys(i).length>0){$("#svg_preview").addClass("noscroll"),$(".anim_element").removeClass("animation").addClass("no_animation"),hideConfigBar();let h=!1,f=!1;for(var u of(s=!0,globalConfigChanged=!0,Object.keys(i))){let m=i[u],g=m.id;var t=o(e);switch($("#"+g).addClass("dragging"),m.type){case"circle":t.x-m.offset.x-m.stroke_width>=m.circle_radius&&t.x-m.offset.x<=m.max.x&&!h?$("#"+g).attr("cx",t.x-m.offset.x):h=!0,t.y-m.offset.y-m.stroke_width>=m.circle_radius&&t.y-m.offset.y<=m.max.y&&!f?$("#"+g).attr("cy",t.y-m.offset.y):f=!0;break;case"rect":t.x-m.offset.x-m.stroke_width>=0&&t.x-m.offset.x<=m.max.x&&!h?$("#"+g).attr("x",t.x-m.offset.x):h=!0,t.y-m.offset.y-m.stroke_width>=0&&t.y-m.offset.y<=m.max.y&&!f?$("#"+g).attr("y",t.y-m.offset.y):f=!0;break;case"text":t.x-m.offset.x-m.font_size>=0&&t.x-m.offset.x<=m.max.x&&!h?$("#"+g).attr("x",t.x-m.offset.x):h=!0,t.y-m.offset.y-m.font_size/2>=0&&t.y-m.offset.y<=m.max.y&&!f?$("#"+g).attr("y",t.y-m.offset.y):f=!0;break;case"svg":t.x-m.offset.x>=0&&t.x-m.offset.x<=m.max.x&&!h&&$("#"+g).attr("x",t.x-m.offset.x),t.y-m.offset.y>=0&&t.y-m.offset.y<=m.max.y&&!f&&$("#"+g).attr("y",t.y-m.offset.y)}if(m.reconnect_elements)for(var p of m.reconnect_elements)connectElements(p.path,p.from,p.to,!0)}}}function m(e){let t=null;if(null!=n){if(n=null,c=!1,d=null,l){let o={start_x:parseInt($("#lasso_rect").attr("x")),start_y:parseInt($("#lasso_rect").attr("y")),end_x:parseInt($("#lasso_rect").attr("x"))+parseInt($("#lasso_rect").attr("width")),end_y:parseInt($("#lasso_rect").attr("y"))+parseInt($("#lasso_rect").attr("height"))};$(".added_elements").each(function(){let e=getCoords(this.id);e.x>o.start_x&&e.x+e.width<o.end_x&&e.y>o.start_y&&e.y+e.height<o.end_y&&($(this).closest("svg").hasClass("draggable-group")?$(this).closest("svg").removeClass("draggable-group draggable").addClass("draggable-multi-group"):$("#"+this.id).removeClass("draggable").addClass("draggable-multi"))}),a()}l=!1,$("#lasso_rect").remove()}if(Object.keys(i).length>0){if($(".added_elements").removeClass("dragging"),a(),t=setTimeout(function(){$("#enable_animation").prop("checked")&&$(".anim_element").removeClass("no_animation").addClass("animation")},1e3),!1===s){$(".draggable-multi").removeClass("draggable-multi").addClass("draggable"),$(".draggable-multi-group").removeClass("draggable-multi-group").addClass("draggable draggable-group");let h=Object.keys(i)[0];showConfigBar(h,i[h].type)}r=i,i={}}}}$(function(){$(document).tooltip({position:{my:"center bottom-20",at:"center top",collision:"flipfit"},content:function(){return $(this).attr("title")}}),$("input:radio[name=tabs]").click(function(){hideConfigBar()}),$("#tab4").click(function(){getDataSources("calc_battery_percent",$("#calc_battery_percent").val(),!0),getDataSources("calc_battery_charge",$("#calc_battery_charge").val(),!0),getDataSources("calc_battery_discharge",$("#calc_battery_discharge").val(),!0),getDataSources("calc_consumption_production",$("#calc_consumption_production").val(),!1),getDataSources("calc_consumption_grid",$("#calc_consumption_grid").val(),!1),$("#calc_consumption_production, #calc_consumption_grid").multiselect({columns:1,search:!0,minWidth:250,maxWidth:300,maxHeight:350,maxPlaceholderOpts:1,texts:{placeholder:"Select Source"}})}),$(".tt-element").click(function(){$(".ui-tooltip").fadeOut()}),$(".line_preview").change(function(){linePreview(this.id)}),$("#elm_select").on("change",function(){console.log("Changed to: "+$(this).val()+" Type: "+$("#"+$(this).val()).prop("tagName")),showConfigBar($(this).val(),$("#"+$(this).val()).prop("tagName"))}),$(".svg_size_value").on("input change",function(e){0>=$(this).val()&&""!=$(this).val()?$(this).val(1):($("#svg_width_slider").val($("#svg_width_value").val()),$("#svg_height_slider").val($("#svg_height_value").val()),resizeSVG())}),$(".svg_size_slider").on("input change",function(){$("#svg_height_value").val($("#svg_height_slider").val()),$("#svg_width_value").val($("#svg_width_slider").val()),resizeSVG()}),$(".align_elements").click(function(e){globalConfigChanged=!0,globalLastSteps={},$(".added_elements").removeClass("alignable").addClass("draggable"),$(".all_elements, .align_elements").removeClass("faded_out");let t=e.target.id,a,o;""==t&&(t=$(this).closest("a").attr("id")),$(".align_elements:not(#"+t+")").addClass("faded_out"),$("#align_elements, #undo_align_elements").show(),$("#all_undo_align_elements").css("display","inline-flex"),$("#connect_elements").prop("disabled",!0),hideConfigBar(),$(".all_elements").addClass("faded_out"),$(".added_elements").removeClass("draggable faded_out").addClass("alignable"),$(".type_icon").removeClass("draggable-group").addClass("alignable"),$("#ex_how_align").html("Now choose the reference element! <img src='img/icon_help.png' style='vertical-align: bottom;' title='You need to select a reference element for aligning. Afterwards, choose each element, which should be aligned the same.'>"),$(".alignable").off().click(function(e){let i=e.target.id;if(null==o)""==(i=e.target.id)&&(i=e.target.parentNode.id),a=getCoords(i),o=getSlots(a),$("#ex_how_align").html("Reference element selected. Choose each element now!");else{let r=e.target.tagName.toLowerCase();switch(""==(i=e.target.id)&&(i=e.target.parentNode.id,r=e.target.parentNode.tagName),globalLastSteps[i]={},t.replace("align_","")){case"center":switch(r){case"circle":globalLastSteps[i].cx=$("#"+i).attr("cx"),$("#"+i).attr("cx",o.top.x);break;case"rect":case"svg":globalLastSteps[i].x=$("#"+i).attr("x"),$("#"+i).attr("x",o.top.x-Math.floor(parseInt($(this).attr("width"))/2));break;case"text":globalLastSteps[i].x=$("#"+i).attr("x"),$("#"+i).attr("x",o.top.x)}break;case"left":switch(r){case"circle":globalLastSteps[i].cx=$("#"+i).attr("cx"),$("#"+i).attr("cx",o.left.x+parseInt($(this).attr("r"))+Math.floor(parseInt($(this).css("stroke-width"))/2));break;case"rect":case"svg":globalLastSteps[i].x=$("#"+i).attr("x"),$("#"+i).attr("x",o.left.x+Math.floor(parseInt($(this).css("stroke-width"))/2));break;case"text":globalLastSteps[i].x=$("#"+i).attr("x"),$("#"+i).attr("x",o.left.x+Math.floor(e.target.getComputedTextLength()/2))}break;case"right":switch(r){case"circle":globalLastSteps[i].cx=$("#"+i).attr("cx"),$("#"+i).attr("cx",o.right.x-parseInt($(this).attr("r"))-Math.floor(parseInt($(this).css("stroke-width"))/2));break;case"rect":case"svg":globalLastSteps[i].x=$("#"+i).attr("x"),$("#"+i).attr("x",o.right.x-Math.floor(parseInt($(this).attr("width")))-Math.floor(parseInt($(this).css("stroke-width"))/2));break;case"text":globalLastSteps[i].x=$("#"+i).attr("x"),$("#"+i).attr("x",o.right.x-Math.floor(e.target.getComputedTextLength()/2))}break;case"vcenter":switch(r){case"circle":globalLastSteps[i].cy=$("#"+i).attr("cy"),$("#"+i).attr("cy",o.right.y);break;case"rect":case"svg":globalLastSteps[i].y=$("#"+i).attr("y"),$("#"+i).attr("y",o.right.y-Math.floor(parseInt($(this).attr("height"))/2));break;case"text":globalLastSteps[i].y=$("#"+i).attr("y"),$("#"+i).attr("y",o.right.y)}break;case"top":switch(r){case"circle":globalLastSteps[i].cy=$("#"+i).attr("cy"),$("#"+i).attr("cy",o.top.y+parseInt($(this).attr("r"))+Math.floor(parseInt($(this).css("stroke-width"))/2));break;case"rect":case"svg":globalLastSteps[i].y=$("#"+i).attr("y"),$("#"+i).attr("y",o.top.y+Math.floor(parseInt($(this).css("stroke-width"))/2));break;case"text":globalLastSteps[i].y=$("#"+i).attr("y"),$("#"+i).attr("y",o.top.y+Math.floor(parseInt($(this).css("font-size"))/2))}break;case"bottom":switch(r){case"circle":globalLastSteps[i].y=$("#"+i).attr("y"),$("#"+i).attr("cy",o.bottom.y-parseInt($(this).attr("r"))-Math.floor(parseInt($(this).css("stroke-width"))/2));break;case"rect":case"svg":globalLastSteps[i].y=$("#"+i).attr("y"),$("#"+i).attr("y",o.bottom.y-Math.floor(parseInt($(this).attr("height")))-Math.floor(parseInt($(this).css("stroke-width"))/2));break;case"text":globalLastSteps[i].y=$("#"+i).attr("y"),$("#"+i).attr("y",o.bottom.y-Math.floor(parseInt($(this).css("font-size"))/2))}}let s=Object.keys(globalLastSteps).length;s>0?($("#undo_align_elements").prop("disabled",!1),$("#undo_steps").text("(Saved Steps: "+s+")")):$("#undo_align_elements").prop("disabled",!0);let l=$("path[id*="+i+"]");l.length>0&&l.each(function(e){let t=l[e].id.split("_");connectElements(l[e].id,t[1],t[2],!0)})}})}),$("#align_elements, #undo_align_elements").click(function(){let e=Object.keys(globalLastSteps).length;if("undo_align_elements"==this.id){let t=Object.keys(globalLastSteps)[e-1];e>0&&Object.entries(globalLastSteps[t]).forEach(a=>{let[o,i]=a;console.log("Restoring Element: "+t+" with "+o+" and Value: "+i),$("#"+t).attr(o,i);let r=$("path[id*="+t+"]");r.length>0&&r.each(function(e){let t=r[e].id.split("_");connectElements(r[e].id,t[1],t[2],!0)}),delete globalLastSteps[t],(e=Object.keys(globalLastSteps).length)>0?$("#undo_steps").text("(Saved Steps: "+e+")"):($("#undo_steps").text("(Saved Steps: -)"),$("#undo_align_elements").prop("disabled",!0))})}else $("#ex_how_align").html("Choose an alignment and select a reference element"),$("#connect_elements").prop("disabled",!1),$("#align_elements, #undo_align_elements").hide(),$("#all_undo_align_elements").css("display","none"),$("#undo_steps").text("(Saved Steps: -)"),$("#undo_align_elements").prop("disabled",!0),$(".alignable").off(),$(".added_elements").removeClass("alignable").addClass("draggable"),$(".type_icon").removeClass("alignable").addClass("draggable-group"),$(".all_elements, .align_elements").removeClass("faded_out")}),$(".add_element").click(function(e){globalConfigChanged=!0,0===$(".added_elements").length?max_elm_id=0:($(".added_elements").each(function(){max_elm_id=Math.max(this.id,max_elm_id)}),max_elm_id++);let t={id:max_elm_id,radius:configuration.basic.circle.radius||50,width:configuration.basic.rect.width||100,height:configuration.basic.rect.height||100,rx:configuration.basic.rect.corners||10,stroke:configuration.basic.elm.stroke_width||5,pos_x:50+getRandomInt(50),pos_y:50+getRandomInt(50),color:getRandomRGBA(),fill:"none",font_size:configuration.basic.font.size||20,font_family:configuration.basic.font.family||'"Arial", sans-serif',unit:"kW"},a=e.target.id;switch(""==a&&(a=$(this).closest("a").attr("id")),a){case"add_circle":t.format="circle",t.frame="_overlay",t.url="",t.fill_value="",t.fill_type=-1,t.fill_max=0,t.source=-1,t.fill=configuration.basic.elm.fill||"none",t.color=configuration.basic.elm.color||getRandomRGBA();break;case"add_rect":t.format="rect",t.frame="_overlay",t.url="",t.fill_value="",t.fill_type=-1,t.fill_max=0,t.source=-1,t.fill=configuration.basic.elm.fill||"none",t.color=configuration.basic.elm.color||getRandomRGBA();break;case"add_text":t.format="text",t.text="Text",t.fill=configuration.basic.font.fill||"none",t.color=configuration.basic.font.color||getRandomRGBA();break;case"add_datasource":t.threshold=0,t.calculate_kw=!1,t.convert=!1,t.decimal_places=0,t.format="text",t.subType="datasource",t.text="Datasource "+max_elm_id,t.source=-1,t.source_option=-1,t.source_display="value",t.subtract="[-1]";break;case"add_icon":t.format="icon",t.width=24,t.height=24,t.icon="mdi:omega",t.color=configuration.basic.icon.color||getRandomRGBA()}("text"==t.format||"datasource"==t.format)&&(t.fill=t.color,t.color=""),addElement(t)}),$("#enable_animation").on("click change",function(){$(this).is(":checked")?$(".anim_element").removeClass("no_animation").addClass("animation"):$(".anim_element").removeClass("animation").addClass("no_animation")}),$("#enable_grid").on("click change",function(){$(this).is(":checked")?$("#help_grid").fadeIn("fast"):$("#help_grid").fadeOut("fast")}),$("#enable_last_id").on("click",function(){configuration.basic.enable_last_id=$(this).is(":checked"),console.log("Showing last ID: "+$(this).is(":checked"))}),$("#config_close").click(function(){hideConfigBar()}),$("#iframe_close").click(function(){hideIframe()}),$("#enable_area_catch").on("click change",function(){$(this).is(":checked")?$("#svg_preview").addClass("svg_preview_catch"):$("#svg_preview").removeClass("svg_preview_catch")}),$(".connect_elements").click(function(){let e=$(".anim_element:not(.faded_out)"),t=event.target.id,a="#ex_how_reconnect";"connect_elements"==t?(a="#ex_how_connect",$("#reconnect_elements").prop("disabled",!0)):$("#connect_elements").prop("disabled",!0);let o,i,r,s;"Cancel"==$(this).val()?($(".clickable").off(),$(".added_elements").removeClass("clickable").addClass("draggable"),$(".all_elements").removeClass("faded_out no_click"),"connect_elements"==t?($(a).html("Click the button above to connect 2 elements"),$(this).val("Connect").removeClass("red")):($(a).html("Click the button above to reconnect the line"),$(this).val("Reconnect").removeClass("red")),$(".clickable").off(),showConnectionPoints(!1),$(".connect_elements").prop("disabled",!1)):$(".connector").length>=2?("connect_elements"==t&&hideConfigBar(),showConnectionPoints(),"connect_elements"==t?$(a).html("Now choose the first element! You can choose the Element or the ConnectionPoints! <img src='img/icon_help.png' style='vertical-align: bottom;' title='<b>Element:</b><br>If you choose the element itself (click in the middle), the line will always use the shortest distance to the element.<br><b>ConnectionPoint:</b><br>If you choose a connectionPoint, the connection will stay at that choosen one.'>"):$(a).html("Now choose the start element or ConnectionPoint!"),$(".all_elements").addClass("faded_out no_click"),"reconnect_elements"==t&&$("#"+e[0].id+", #"+e[0].id.replace("anim","line")).removeClass("faded_out"),$(".connector").removeClass("draggable faded_out no_click").addClass("clickable"),$(".clickable").off().click(function(){let l=$(this).attr("id");if(l||(l=$(this).data("element")),null==o)o=l,r=$(this).data("slot"),$(a).html("Start Element selected!<br>Please select the destination one!");else if(o==l)$(a).html("Do not select the same Element!"),i=null,s=null;else{i=l,s=$(this).data("slot");let n="path_"+o+"_"+i;if($("#"+n).length>0)failedMessage("This connection already exists!");else{if(addElement({format:"def",id:n,connPoint1:r,connPoint2:s,d:""}),connectElements(n,o,i,!0),"reconnect_elements"==t){if(1==e.length){let c=$("#"+e[0].id.replace("anim","line")),d=$("#"+e[0].id.replace("anim_","")),h=$("#"+e[0].id);addElement({format:"line",id:"line_"+n,color:c.css("stroke"),href:"#"+n,shadow:getShadowColor(c.attr("id"))}),addElement({format:"animation",id:"anim_"+n,color:h.css("stroke"),href:"#"+n,source:h.data("source"),animation_properties:h.data("animation_properties"),threshold:h.data("threshold"),dots:h.data("dots"),duration:h.data("duration"),power:h.data("power"),animation_type:h.data("animation_type")}),h.remove(),c.remove(),d.remove(),showConfigBar("anim_"+n,"use")}}else addElement({format:"line",id:"line_"+n,color:configuration.line.stroke,href:"#"+n}),addElement({format:"animation",id:"anim_"+n,color:configuration.animation.stroke,href:"#"+n,animation_type:-1});globalConfigChanged=!0}showConnectionPoints(!1),o=null,i=null,"connect_elements"==t?($(a).html("Click the button above to connect 2 elements"),$("#connect_elements").val("Connect").removeClass("red")):($(a).html("Click the button to reconnect the line"),$("#reconnect_elements").val("Reconnect").removeClass("red")),$(".connect_elements").prop("disabled",!1),$(".clickable").off(),$(".added_elements").removeClass("clickable").addClass("draggable"),$(".all_elements").removeClass("faded_out no_click")}}),$(this).val("Cancel").addClass("red")):failedMessage("There are no connectable elements on the surface!<br>Min. 2 rectangle or circles are required!")}),$("#save_workspace, #save_workspace_exit").click(function(){globalConfigChanged=!1;let t,a={},o={},i={},r={},s={},l={};a={basic:{enable_grid:!!$("#enable_grid").is(":checked"),enable_animation:!!$("#enable_animation").is(":checked"),enable_area_catch:!!$("#enable_area_catch").is(":checked"),enable_config_icon:!!$("#enable_config_icon").is(":checked"),enable_last_id:!!$("#enable_last_id").is(":checked"),height:parseInt($("#svg_config").attr("height")),width:parseInt($("#svg_config").attr("width")),styles:$("#own_css").val(),font:{family:$("#basic_font_family").val(),size:$("#basic_font_size").val(),color:$("#basic_font_color").val(),fill:$("#basic_font_fill").val(),align:$("#basic_font_align").val()},rect:{height:parseInt($("#basic_rect_height").val()),width:parseInt($("#basic_rect_width").val()),corners:parseInt($("#basic_rect_corners").val())},circle:{radius:parseInt($("#basic_circle_radius").val())},elm:{stroke_width:parseInt($("#basic_stroke_width").val()),color:$("#basic_elm_color").val(),fill:$("#basic_elm_fill").val()},icon:{height:parseInt($("#basic_icon_height").val()),width:parseInt($("#basic_icon_width").val()),color:$("#basic_icon_color").val()}},calculation:{battery:{dod:parseInt($("#calc_battery_dod").val())||0,capacity:parseInt($("#calc_battery_capacity").val())||0,percent:parseInt($("#calc_battery_percent").val()),charge:parseInt($("#calc_battery_charge").val()),charge_prop:!!$("#calc_battery_charge_prop").is(":checked"),charge_kw:!!$("#calc_battery_charge_kw").is(":checked"),discharge:parseInt($("#calc_battery_discharge").val()),discharge_prop:!!$("#calc_battery_discharge_prop").is(":checked"),discharge_kw:!!$("#calc_battery_discharge_kw").is(":checked")}},animation:{},animation_configuration:{},line:{},elements:{},defs:{},lines:{},animations:{},datasources:{}},$(".added_elements").length>0?($(".type_circle").each(function(){o[t=this.id]={type:"circle",id:parseInt(t),radius:parseInt($(this).attr("r")),pos_x:parseInt($(this).attr("cx")),pos_y:parseInt($(this).attr("cy")),fill:$(this).css("fill"),color:$(this).css("stroke"),stroke:parseInt($(this).css("stroke-width").replace("px","")),shadow:getShadowColor(t),frame:$(this).data("frame"),url:$(this).data("url"),fill_value:$(this).data("fill_value")||null,fill_type:$(this).data("fill_type")||-1,fill_max:$(this).data("fill_max")||null,source:$(this).data("source")||-1}}),$(".type_rect").each(function(){o[t=this.id]={type:"rect",id:parseInt(t),rx:parseInt($(this).attr("rx")),height:parseInt($(this).attr("height")),width:parseInt($(this).attr("width")),pos_x:parseInt($(this).attr("x")),pos_y:parseInt($(this).attr("y")),fill:$(this).css("fill"),color:$(this).css("stroke"),stroke:parseInt($(this).css("stroke-width").replace("px","")),shadow:getShadowColor(t),frame:$(this).data("frame"),url:$(this).data("url"),fill_value:$(this).data("fill_value")||null,fill_type:$(this).data("fill_type")||-1,fill_max:$(this).data("fill_max")||null,source:$(this).data("source")||-1}}),$(".type_text").each(function(){o[t=this.id]={type:"text",id:parseInt(t),pos_x:parseInt($(this).attr("x")),pos_y:parseInt($(this).attr("y")),color:$(this).css("stroke"),fill:$(this).css("fill"),font_family:$(this).css("font-family"),font_size:parseInt($(this).css("font-size").replace("px","")),degree:getRotationDegrees($(this)),align:$(this).css("text-anchor"),text:$(this).html(),shadow:getShadowColor(t)}}),$(".type_datasource").each(function(){t=this.id;let e=[];Array.isArray($(this).data("subtract"))?e=0==$(this).data("subtract").length?[-1]:$(this).data("subtract"):(console.log("No Array"),e=[-1]),e.map(e=>parseInt(e)),o[t]={type:"text",subType:"datasource",id:parseInt(t),pos_x:parseInt($(this).attr("x")),pos_y:parseInt($(this).attr("y")),color:$(this).css("stroke"),fill:$(this).css("fill"),font_family:$(this).css("font-family"),font_size:parseInt($(this).css("font-size").replace("px","")),degree:getRotationDegrees($(this)),align:$(this).css("text-anchor"),text:"ID "+t,unit:$(this).data("unit"),source:$(this).data("source"),source_option:$(this).data("source_option")||-1,source_display:$(this).data("source_display")||"value",shadow:getShadowColor(t),threshold:parseInt($(this).data("threshold"))||0,calculate_kw:$(this).data("calculate_kw")||!1,convert:$(this).data("convert")||!1,decimal_places:parseInt($(this).data("decimal_places"))||0,subtract:e}}),$(".type_icon").each(function(){o[t=this.id]={type:"icon",id:t,icon:$(this).data("icon"),width:$(this).data("width"),height:$(this).data("height"),color:$(this).css("color"),pos_x:$(this).attr("x"),pos_y:$(this).attr("y"),shadow:getShadowColor(t)}}),$(".type_def").each(function(){i[t=this.id]={type:"def",id:t,d:$(this).attr("d"),startSlot:$(this).data("start-slot"),endSlot:$(this).data("end-slot")}}),$(".type_line").each(function(){r[t=this.id]={type:"line",id:t,href:$(this).attr("xlink:href"),color:$(this).css("stroke"),shadow:getShadowColor(t)}}),$(".type_animation").each(function(){s[t=this.id]={type:"animation",id:t,href:$(this).attr("xlink:href"),color:$(this).css("stroke"),source:$(this).data("source"),threshold:$(this).data("threshold"),animation_properties:$(this).data("animation_properties"),dots:-1!=$(this).data("animation_type")?$(this).data("dots"):0,duration:-1!=$(this).data("animation_type")?$(this).data("duration"):0,power:-1!=$(this).data("animation_type")?$(this).data("power"):0,animation_type:$(this).data("animation_type")}}),$(".data-table tbody tr").each(function(){-1!=(t=$(this).data("id"))&&(l[t]={source:$(this).data("source"),alias:$(this).data("alias")})}),a.elements=o,a.animation=configuration.animation,a.animation_configuration=configuration.animation_configuration,a.line=configuration.line,a.defs=i,a.lines=r,a.animations=s,a.datasources=l,$("#save_output").val(JSON.stringify(a,void 0,4)),localMode?(successMessage("Local Output of Config!"),configuration.basic=a.basic):e.emit("setState",objID[0],{val:JSON.stringify(a),ack:!0},function(e){e?(console.log(e),failedMessage("An error occured while saving your workspace!")):(successMessage("Your workspace has been saved successfully"),configuration.basic=a.basic)})):failedMessage("You do not have any elements to save!"),"save_workspace_exit"==this.id&&(console.log("Forwarding to Live-View of instance: "+instance),window.location.replace("index.html?instance="+instance))}),$("#workspace_exit").click(function(){window.location.replace("index.html?instance="+instance)})}),$(document).ready(function(){$("body").on("click",function(){$(document).off("keydown")}),$(".input_button").on("click touchstart",function(){this.blur()}),$(window).on("beforeunload",function(){if(globalConfigChanged)return"There are unsaved changes. Are you sure to leave now?"}),$("#frm-addDataSource").submit(function(e){e.preventDefault(),globalConfigChanged=!0;let t=$("#elm_ds_source").val(),a=$("#elm_ds_alias").val()?$("#elm_ds_alias").val():"";addDataSourceRow(-1,t,a),$("#elm_ds_source, #elm_ds_alias").val("")}),$(".data-table").on("click",".btn-delete",function(){globalConfigChanged=!0;let e=!0,t=$(this).parents("tr").data("id");$(".all_elements").each(function(){if($(this).data("source")==t)return e=!1,!1}),e?$(this).parents("tr").fadeOut("fast",function(){$(this).remove(),0==$(".data-table tbody tr").length&&$(".data-table tbody").append("<tr id='ds_tmp_line' data-id='-1'><td>There are currently no Datasources added!</td><td></td><td></td>")}):failedMessage("This source cannot be deleted, as it is used by one or more element's")}),$(".data-table").on("click",".btn-edit",function(){let e=$(this).parents("tr").attr("data-alias"),t=$(this).parents("tr").attr("data-source");$(this).parents("tr").find("td:eq(0)").html('<div class="form_div no_margin"><input type="text" class="input_text" id="edit_ds_alias" name="edit_ds_alias" autocorrect="off" autocomplete="off" value="'+e+'"></div>'),$(this).parents("tr").find("td:eq(1)").html('<div class="form_div no_margin"><input type="text" class="input_text icon_in_input_pad" id="edit_ds_source" name="edit_ds_source" autocorrect="off" autocomplete="off" minlength="5" required="" value="'+t+'"><div class="icon_wrapper"><a class="datasource tt-element icon_in_input" title="Select Datasource"><span class="iconify" data-icon="mdi:database-search" data-height="24"></span></a></div></div>'),$(this).parents("tr").find("td:eq(2)").prepend("<button class='all_datasource ds_buttons btn-update'><span class='iconify' data-height='24' data-icon='mdi:check'>Update</span></button><button class='all_datasource ds_buttons btn-cancel'><span class='iconify' data-height='24' data-icon='mdi:close'>Close</span></button>"),$(this).hide()}),$(".data-table").on("click",".btn-cancel",function(){let e=$(this).parents("tr").attr("data-alias"),t=$(this).parents("tr").attr("data-source");$(this).parents("tr").find("td:eq(0)").text(e),$(this).parents("tr").find("td:eq(1)").text(t),$(this).parents("tr").find(".btn-edit").show(),$(this).parents("tr").find(".btn-update").remove(),$(this).parents("tr").find(".btn-cancel").remove()}),$(".data-table").on("click",".btn-update",function(){globalConfigChanged=!0;let e=$("#edit_ds_alias").val(),t=$("#edit_ds_source").val();$(this).parents("tr").find("td:eq(0)").text(e),$(this).parents("tr").find("td:eq(1)").text(t),$(this).parents("tr").attr("data-alias",e),$(this).parents("tr").attr("data-source",t),$(this).parents("tr").find(".btn-edit").show(),$(this).parents("tr").find(".btn-cancel").remove(),$(this).parents("tr").find(".btn-update").remove()}),$("body").on("click",".datasource",function(){let e=$(this).parent("div").parent("div").children("input").attr("id"),t=$("#"+e).val();!0==configuration.basic.enable_last_id&&""==$("#"+e).val()&&(t=globalSelectedId,console.log("Showing last ID: "+t)),initSelectId(function(a){a.selectId("show",t,function(t){t!=$("#"+e).val()&&($("#"+e).val(t).trigger("change"),$("#"+e).focus()),globalSelectedId=t})})}),$(".data-table").on("click","th",function(){$(".sort_icon").html("");var e=$(this).parents("table").eq(0),t=e.find("tr:gt(0)").toArray().sort(dataSourceComparer($(this).index()));this.asc=!this.asc,$(this).children("span").html('<span class="iconify" data-icon="mdi:sort-alphabetical-ascending" data-height="18">'),this.asc||(t=t.reverse(),$(this).children("span").html('<span class="iconify" data-icon="mdi:sort-alphabetical-descending" data-height="18">'));for(var a=0;a<t.length;a++)e.append(t[a])}),loadConfig()});