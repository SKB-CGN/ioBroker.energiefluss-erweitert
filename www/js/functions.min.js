"use strict";function hashCode(e){let t=0;if(0===e.length)return t;for(let o=0;o<e.length;o++){t=(t<<5)-t+e.charCodeAt(o),t&=t}return t>>>0}$.fn.countTo=function(e,t=1e3){const o=String(e).includes(".")?String(e).split(".")[1].length:0;var a=$(this),n=null;const i=parseFloat(a.text()),s=parseFloat(e);return requestAnimationFrame((function e(r){n||(n=r);var l=r-n,c=i+l/t*(s-i);l<t?(a.text(c.toFixed(o)),requestAnimationFrame(e)):a.text(s.toFixed(o))})),this},$.fn.scrollTo=function(e,t,o){return $(this).animate({scrollTop:$(this).scrollTop()-$(this).offset().top+$(e).offset().top+(o||0)},null==t?1e3:t),this},$.expr.pseudos.icontains=function(e,t,o){return e.textContent.toUpperCase().includes(o[3].toUpperCase())},$.fn.appendToWithIndex=function(e,t=0){!e instanceof jQuery&&(e=$(e));let o=e.children().last().index()||0;0===t?$(this).prependTo(e):t>o?$(this).appendTo(e):$(this).insertAfter(e.children().eq(t-1))};const jQueryDialog={open:function(){$(".ui-widget-overlay").hide().fadeIn(600),$(this).parent().focus();var e=$(this).parent(),t=parseInt(e.css("top"));e.css({top:t-60,opacity:0}),e.animate({opacity:1,top:t},{duration:600})},beforeClose:function(){$(".ui-widget-overlay").show().fadeOut(600);var e=$(this).parent();return e.animate({opacity:0,top:parseInt(e.css("top"))-60},{duration:600,queue:!1,complete:function(){$(".ui-dialog, .tmpDiv").remove()}}),!1},classes:{"ui-dialog":"no-close"}};let aceLog,aceCSS,aceOverride;const urlParams=new URLSearchParams(window.location.search),appProperties={instance:Number(urlParams.get("instance"))||0,lowPerformance:urlParams.get("lowPerformance")||!1,theme:urlParams.get("theme")||!1,updateCheck:"https://api.github.com/repos/SKB-CGN/ioBroker.energiefluss-erweitert/tags",updateURL:"https://github.com/SKB-CGN/ioBroker.energiefluss-erweitert/#changelog",namespace:`energiefluss-erweitert.${urlParams.get("instance")||0}`,hostname:window.location.hostname,localMode:!window.location.hostname,socketURL:window.location.hostname?"/":"https://192.168.2.19:8082/",socketPath:"/socket.io",devMode:"true"==urlParams.get("devMode"),colorScheme:window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light",userAgent:navigator.userAgent.indexOf("WebKit")>-1?"Chrome":"Firefox",isMobile:/iPhone|iPad|iPod|Android/i.test(navigator.userAgent),isApple:/Apple Computer/i.test(navigator.vendor),aceEditorTheme:{dark:"clouds_midnight",light:"textmate"}},socket=io.connect(appProperties.socketURL,{path:appProperties.socketPath,reconnectionDelay:500,reconnectionAttempts:1/0,upgrade:!0,transports:appProperties.hostname.match(/iobroker\.pro|iobroker\.net/)?void 0:["websocket","polling"]});socket.on("reauthenticate",(function(){let e=(new Date).toLocaleString();console.log(`[Socket] reauthenticate ${e}`)})),socket.on("error",(function(e){let t=(new Date).toLocaleString();console.error(`[Socket] error: ${e} ${t}`)})),socket.on("permissionError",(function(e){let t=(new Date).toLocaleString();console.error(`[Socket] permission error: ${e} ${t}`)})),socket.on("upgrade",(function(e){let t=(new Date).toLocaleString();console.log(`[Socket] connection upgrade at ${t}`)})),socket.on("connect_error",(function(e){let t=(new Date).toLocaleString();console.error("[Socket] connect error: "+e+" "+t),console.log(`Current connection set: ${socket.io.opts.transports}`),socket.io.opts.forceNew=!0,"polling"==socket.io.opts.transports[0]?(socket.io.opts.transports=["websocket","polling"],console.log("[Socket] Connection Error. Trying websocket first!")):(socket.io.opts.transports=["polling","websocket"],console.log("[Socket] Connection Error. Trying polling first!"))})),console.debug(appProperties),console.log("[Config] Using Instance: "+appProperties.namespace);const subscribeObjID=[appProperties.namespace+".configuration",appProperties.namespace+".data","system.adapter."+appProperties.namespace+".alive"];systemLang=navigator.language||navigator.userLanguage,console.log("[Language] Detected System-Languag: "+systemLang);let globalSelectedId,configuration={},displayMode=!1,globalConfigChanged=!1,basicConfig=!1,globalUndoStack=[],globalRedoStack=[],globalAdapterOnline=!1,globalIobObjectsLoaded=!1,globalGalleryLoaded=!1,globalClipboard=[],globalMoving=[],globalError=[],oldRefreshObj={};const clockIntervals={};var filename=location.pathname.substr(location.pathname.lastIndexOf("/")+1);filename.includes("index")||""==filename?displayMode=!0:(jscolor.presets.default={alphaChannel:"auto",format:"any",borderColor:"var(--primary)",borderRadius:10,controlBorderColor:"#538EA3",previewSize:28,previewPosition:"right",required:!1,backgroundColor:"var(--white)",palette:["#00b5dd","#61687a","#ffce4a","#a1d343","#c5902e","#f20e40"]},ace.require("ace/ext/language_tools"));const dataSourceAutocompleteOptions={position:{my:"left top",at:"left bottom",collision:"fit"},source:async function(e,t){globalIobObjectsLoaded||(iobObjects=await loadIobObjects());t($.ui.autocomplete.filter(iobArray,e.term).slice(0,200))},classes:{"ui-autocomplete":"select_overflow"},minLength:3,delay:500,search:function(){globalIobObjectsLoaded||$(this).siblings(".icon_wrapper").find(".ds_search_spinner").show()},response:function(){setTimeout((()=>{$(this).siblings(".icon_wrapper").find(".ds_search_spinner").hide()}),500)}};let iobObjects,iobArray=[],globalUserImages=[];const multiselect_options={columns:1,search:!0,minWidth:"250px",maxWidth:"auto",maxPlaceholderOpts:1,texts:{}};function loadIobObjects(){return console.log("iobObjects not present! Requesting!"),new Promise(((e,t)=>{const o=performance.now();socket.emit("getObjects",(function(t,a){globalIobObjectsLoaded=!0,console.log(`${Object.keys(a).length} Objects loaded in ${performance.now()-o} ms`);let n={};Object.keys(a).sort(((e,t)=>e.toLowerCase().localeCompare(t.toLowerCase()))).forEach((e=>n[e]=a[e])),iobArray=Object.keys(n).filter((e=>"state"==n[e].type)),e(n)}))}))}function sprintf(e){var t=Array.prototype.slice.call(arguments,1),o=0;return e.replace(/%s/g,(function(){return t[o++]}))}function displayLoading(e){$("#loading").fadeIn(600),$("#loading_text").html(e).show(),$(".loading-spinner").show(),$("#loading_text_error").hide()}function displayListener(){let e;const t=(new Date).toLocaleString();socket.emit("subscribe",subscribeObjID),console.log("[Socket] subscribed to: "+subscribeObjID.toString()+" at "+t),socket.on("reconnect",(function(){console.log("[Socket] reconnected at "+t),socket.emit("subscribe",subscribeObjID),$("#loading").fadeOut("fast")})),socket.on("disconnect",(function(){console.log("[Socket] disconnected "+t),displayLoading(translateWord("msg_reconnect"))})),socket.on("stateChange",(function(o,a){setTimeout((function(){if(o==subscribeObjID[0])try{Object.keys(clockIntervals).forEach((e=>{clearTimeout(clockIntervals[e]),console.log("Cleared Clock-Timout for "+e)})),$("#frameContainer").is(":visible")&&closeEditorContainer("frame"),$("#action_change_value").is(":visible")&&$(".ui-dialog-buttonset").children(".red").click(),$("#errorLogContainer").is(":visible")&&closeEditorContainer("errorLog"),displayLoading(translateWord("msg_loading_config")),configuration=JSON.parse(a.val),setLoadedConfig(!0),console.log("Applied new configuration at "+t)}catch(e){console.log("Error while parsing Config in JSON-Object!")}if(o==subscribeObjID[1])try{a.ts-e<1e3?e=a.ts:(e=a.ts,refreshData(JSON.parse(a.val)))}catch(e){console.log("Error while parsing Values in JSON-Object!")}if(o==subscribeObjID[2])if(0==a.val){displayLoading(sprintf(systemDictionary.msg_instance_loading[systemLang],appProperties.instance)),console.log("Adapter instance: "+appProperties.instance+" is not started! "+t),globalAdapterOnline=!1}else if(a.val!=globalAdapterOnline&&1==a.val){console.log("Adapter instance: "+appProperties.instance+" started at "+t),globalAdapterOnline=!0;let e=(Math.random()+1).toString(36).substring(7);window.location.href=`?instance=${appProperties.instance}&hash=${e}&lowPerformance=${appProperties.lowPerformance}&theme=${appProperties.theme}`}}),0)}))}function addBorderFill(e,t,o,a=-90){let n=$("#"+e),i=n.attr("r"),s=Math.PI*(2*i),r=Number(n.attr("height")),l=Number(n.attr("width")),c={id:`border_${e}`,class:"border_fill"};if("rect"==n.prop("tagName"))switch(s=2*n.attr("width")+2*n.attr("height"),a=Number(a)+90){case 90:case 270:if(r!=l){let e=Math.abs(r-l)/2;c.width=r,c.height=l,c.x=r>l?Number(n.attr("x"))-e:Number(n.attr("x"))+e,c.y=r>l?Number(n.attr("y"))+e:Number(n.attr("y"))-e}}let d=n.clone().attr(c).css({fill:"",filter:"",transform:"rotate("+a+"deg)",strokeDashoffset:s,strokeDasharray:s,strokeLinecap:o}).data("border_reverse_value_default",n.css("stroke"));$(d).insertAfter(n),n.css({stroke:t})}function updateBorderFill(e,t,o,a,n="cw"){try{let i,s,r=$("#border_"+e),l=r.attr("r"),c=Math.PI*(2*l);switch("rect"==r.prop("tagName")&&(c=2*r.attr("width")+2*r.attr("height")),a){case"percent":s=100-Math.abs(t);break;case"value":if(!o)throw new Error("No max value for element declared!");s=100-Math.abs(t)/o*100}s<0&&(s=0),s>100&&(s=100),r.data("border_reverse")&&(t<0?(n="cw"==n?"ccw":"cw",i=r.data("border_reverse_value")||r.data("border_reverse_value_default")):i=r.data("border_reverse_value_default")),c="cw"==n?c:-1*c;let d=(s/100*c).toFixed(0);r.css({strokeDashoffset:d,strokeDasharray:c,stroke:i})}catch(t){console.error("Error while updating border fill for ID: "+e+"! "+t)}}function animateGradient(e,t,o){const a="object"==typeof e?e:document.getElementById(e);let n=parseInt(t),i=parseInt(o),s=!1;a&&(s||function e(){s=!0,n<i?n=Math.min(n+1,i):n>i&&(n=Math.max(n-1,i));a.setAttribute("offset",`${n}%`),n!=i?requestAnimationFrame(e):s=!1}())}function updateMultiGradient(e,t,o,a){const n=document.getElementById(`gradient_${e}_fill`),i=n.childNodes,s=parseInt(n.getAttribute("data-value"));let r;try{switch(a){case"percent":r=t;break;case"value":if(!o)throw new Error(`No max value for element with ID ${e} declared!`);r=Math.abs(t)/o*100}}catch(t){console.error("Error while updating gradient for ID: "+e+"! "+t)}if(r=parseInt(r),s!=r){for(const e of i){const t=e.getAttribute("data-defaultOffset");if(null!=t){const o=parseInt(e.getAttribute("offset").replace("%",""));animateGradient(e,o,parseFloat(t)/100*r)}}n.setAttribute("data-value",r)}}function userClock(e,t,o=!1){const a=Object.keys(e).reduce(((t,o)=>("none"!==e[o]&&""!==e[o]&&(t[o]=e[o]),t)),{}),n=document.getElementById(t);let i;const s=new Date;try{i=new Intl.DateTimeFormat(systemLang,a).format(s)}catch(e){console.log("Not a valid date. Waiting for setting-up correctely!",e.message)}return n&&n.innerHTML!=i&&(n.innerHTML=i),o||(clockIntervals[t]=setTimeout(userClock,1e3,e,t)),i}function addErrorToLog(e){globalError.some((t=>JSON.stringify(e)===JSON.stringify(t)))||globalError.push(e),globalError.length>0&&$("#info_error_area").fadeIn("fast")}function openErrorLog(){$("#errorLog-table tbody").empty();globalError.forEach((e=>$("#errorLog-table tbody").append(`<tr><td>${e.id}</td><td>${e.for}</td><td>${e.error}</td><td>${e.function}</td></tr>`))),$("#loading").fadeIn(600),$(".loading-spinner, #loading_text").hide(),$("#errorLogContainer").css({top:"45%",opacity:0,display:"block"}),$("#errorLogContainer").animate({opacity:1,top:"50%"},{duration:600,queue:!1})}async function refreshData(e){function t(e,o){if(e===o)return!0;if("object"!=typeof e||"object"!=typeof o||null===e||null===o)return!1;const a=Object.keys(e),n=Object.keys(o);if(a.length!==n.length)return!1;for(let n of a)if(!t(e[n],o[n]))return!1;return!0}try{if(t(e.values,oldRefreshObj.values)?appProperties.devMode&&console.debug("[Debug] [Refresh] No changes for 'Values'!"):(appProperties.devMode&&console.debug("[Debug] [Refresh] Changes for 'Values'. Refreshing!",e.values,oldRefreshObj.values),Object.entries(e.values).forEach((t=>{const[o,a]=t;if(a){const t=configuration.elements[o];let n=a;if(e.hasOwnProperty("override")&&e.override.hasOwnProperty(o)&&e.override[o].hasOwnProperty("value")){const t=e.override[o].value;"object"==typeof t?addErrorToLog({id:o,for:`${translateWord("lbl_override")}: <b>value</b>`,error:t.error,function:t.function}):n=e.override[o].value}"value"==t.source_display||"auto"==t.source_display?t.counter_animation?isNaN(n)?$(`#${o}_value`).html(generateMultiLineText(`${o}_value`,n,t.pos_x)):($(`#${o}_value`).children().length>0||$(`#${o}_value`).html(generateMultiLineText(`${o}_value`,0,t.pos_x)),$(`#${o}_value_line_0`).countTo(n,configuration.basic.animation_timer)):($(`#${o}_value`).children().length>0||$(`#${o}_value`).html(generateMultiLineText(`${o}_value`,0,t.pos_x)),$(`#${o}_value_line_0`).html(n)):$(`#${o}_value`).html(generateMultiLineText(`${o}_value`,n,t.pos_x)),"auto"==t.calculate_kw&&$(`#${o}_unit`).html(generateMultiLineText(`${o}_unit`," "+e.unit[o],t.pos_x))}})),oldRefreshObj.values=JSON.parse(JSON.stringify(e.values))),displayMode){try{t(e.fillValues,oldRefreshObj.fillValues)?appProperties.devMode&&console.debug("[Debug] [Refresh] No changes for 'Fill-Values'!"):(appProperties.devMode&&console.debug("[Debug] [Refresh] Changes for 'Fill-Values'. Refreshing!",e.fillValues,oldRefreshObj.fillValues),Object.entries(e.fillValues).forEach((t=>{const[o,a]=t,n=configuration.elements[o];if(n&&-1!=n.fill_type&&n.fill_value){let t=n.fill_value;e.hasOwnProperty("override")&&e.override.hasOwnProperty(o)&&e.override[o].hasOwnProperty("fillcolor")&&(t=e.override[o].fillcolor),t=t.replace(/[+-]?(?:\d*\.?\d+)(deg|rad|grad|turn)\s*,\s*|to\s+(top|bottom|left|right)(\s+left|\s+right)?\s*,\s*/gi,"-90deg,").toLocaleLowerCase(),t=parseColorString(t);const i=t.includes("gradient")?"gradient":"color",s=document.getElementById(`gradient_${o}_fill`),r=s?s.getAttribute("data-type"):null,l=s?parseInt(s.getAttribute("data-colorHash")):null,c=hashCode(t);if(l==c)"color"==r&&updateSingleGradient(o,a,n.fill_max,n.fill_type),"gradient"==r&&updateMultiGradient(o,a,n.fill_max,n.fill_type);else if("color"==i&&("color"==r?(s.lastChild.setAttribute("stop-color",t),s.setAttribute("data-colorHash",c)):(s&&s.remove(),generateSingleGradient(o,t,n.fill,n.fill_direction),console.log("[Config] Single-Fill-Gradient added for: "+o)),updateSingleGradient(o,a,n.fill_max,n.fill_type)),"gradient"==i){if("gradient"==r){$(s).children(".gradientStop").remove();const e=generateSVGGradient("","",t,!0);$(e).insertBefore(`#gradient_${o}_fill_transparent`),s.setAttribute("data-colorHash",c)}else{generateStyleProperty(o,"fill",t,!0);const e=document.getElementById(`gradient_${o}_fill`),a=n.fill&&!n.fill.match(/(?=(gradient|none))/gi)?n.fill:"rgba(0,0,0,0)";let i=document.createElementNS("http://www.w3.org/2000/svg","stop");i.setAttribute("id",`gradient_${o}_fill_transparent`),i.setAttribute("offset","0%"),i.setAttribute("stop-color",a),e.appendChild(i),e.setAttribute("gradientTransform","rotate("+n.fill_direction+",0.5,0.5)"),console.log("[Config] Multi-Fill-Gradient added for: "+o)}updateMultiGradient(o,a,n.fill_max,n.fill_type)}}})),oldRefreshObj.fillValues=JSON.parse(JSON.stringify(e.fillValues)))}catch(e){console.error("Could not apply Fill-Values. The following error was thrown: "+e)}try{t(e.img_href,oldRefreshObj.img_href)?appProperties.devMode&&console.debug("[Debug] [Refresh] No changes for 'Images'!"):(appProperties.devMode&&console.debug("[Debug] [Refresh] Changes for 'Images'. Refreshing!",e.img_href,oldRefreshObj.img_href),Object.entries(e.img_href).forEach((e=>{const[t,o]=e;"#"==o?$(`#${t}`).fadeOut(600).attr("href","img/bg_trans.png"):$(`#${t}`).attr("href",o).fadeIn(600)})),oldRefreshObj.img_href=JSON.parse(JSON.stringify(e.img_href)))}catch(e){console.error("Could not apply Image-Sources. The following error was thrown: "+e)}try{t(e.borderValues,oldRefreshObj.borderValues)?appProperties.devMode&&console.debug("[Debug] [Refresh] No changes for 'BorderValues'!"):(appProperties.devMode&&console.debug("[Debug] [Refresh] Changes for 'BorderValues'. Refreshing!",e.borderValues,oldRefreshObj.borderValues),Object.entries(e.borderValues).forEach((t=>{const[o,a]=t,n=new RegExp(/[+-]?(?:\d*\.?\d+)(deg|rad|grad|turn)\s*,\s*|to\s+(top|bottom|left|right)(\s+left|\s+right)?\s*,\s*/gi),i=configuration.elements[o];if(-1!=i.border_type&&i.border_value){const t=(e,t)=>{const n=document.getElementById(e);if(n){if(n.style.stroke.includes("url")){const o=document.getElementById(`gradient_${e}_stroke`),a=o?parseInt(o.getAttribute("data-colorHash")):null,n=hashCode(t);"gradient"==l&&a!=n&&generateStyleProperty(e,"stroke",t,!0,"url"),"color"==l&&(o&&o.remove(),$(`#${e}`).css("stroke",t))}else"gradient"==l&&generateStyleProperty(e,"stroke",t,!0,"url"),"color"==l&&$(`#${e}`).css("stroke",t);updateBorderFill(o,a,i.border_max,i.border_type,i.border_direction)}};let s=i.border_value,r=i.color;e.hasOwnProperty("override")&&e.override.hasOwnProperty(o)&&(e.override[o].hasOwnProperty("borderfillcolor")&&(r=e.override[o].borderfillcolor),e.override[o].hasOwnProperty("bordercolor")&&(s=e.override[o].bordercolor)),s=s.replace(n,"-90deg,").toLocaleLowerCase(),r=r.replace(n,"-90deg,").toLocaleLowerCase(),s=parseColorString(s),r=parseColorString(r);const l=s.includes("gradient")?"gradient":"color";0==$(`#border_${o}`).length&&(addBorderFill(o,i.border_value,i.border_style,i.border_start),updateBorderFill(o,a,i.border_max,i.border_type,i.border_direction),console.log("[Config] Border-Fill added for: "+o)),t(`border_${o}`,r),t(o,s)}})),oldRefreshObj.borderValues=JSON.parse(JSON.stringify(e.borderValues)))}catch(e){console.error("Could not apply Border-Values. The following error was thrown: "+e)}try{t(e.animations,oldRefreshObj.animations)?appProperties.devMode&&console.debug("[Debug] [Refresh] No changes for 'Animations'!"):(appProperties.devMode&&console.debug("[Debug] [Refresh] Changes for 'Animations'. Refreshing!",e.animations,oldRefreshObj.animations),Object.entries(e.animations).forEach((([e,t])=>{let o="",a="",n="";const i=document.getElementById(e),s=document.getElementById(e.replace("anim","line")),r=configuration.animations[e]||{};if("dots"===t.type&&(o=t.stroke),"duration"===t.type&&(a=t.duration),"reverse"===t.option&&(n="reverse"),i.style.strokeDasharray=o,i.style.animationDirection=n,configuration.basic.enable_low_performance||"true"===appProperties.lowPerformance||(i.style.animationDuration=a+"ms"),configuration.basic.enable_line_animation)if(t.animation){const t=calculatePathAnimationTime(e);animatePath(e.replace("anim","line")),setTimeout((()=>{i.style.display="inline"}),t/330*1e3)}else i.style.display="none";else i.style.display=t.animation?"inline":"none",r.active_only&&(s.style.display=t.animation?"inline":"none");if(r.active_only&&!t.animation&&(i.style.display="none",configuration.basic.enable_line_animation)){const t=calculatePathAnimationTime(e);s.style.strokeDasharray="100%",s.style.animation=`eraseAnimatedLine ${t/340}s linear forwards`}})),oldRefreshObj.animations=JSON.parse(JSON.stringify(e.animations)))}catch(e){console.error("Could not apply Animations. The following error was thrown: "+e)}try{t(e.css,oldRefreshObj.css)?appProperties.devMode&&console.debug("[Debug] [Refresh] No changes for 'CSS'!"):(appProperties.devMode&&console.debug("[Debug] [Refresh] Changes for 'CSS'. Refreshing!",e.css,oldRefreshObj.css),Object.entries(e.css).forEach((e=>{const[t,o]=e;o.inactPos&&$("#"+t).removeClass(o.inactPos),o.inactNeg&&$("#"+t).removeClass(o.inactNeg),o.actPos&&$("#"+t).addClass(o.actPos),o.actNeg&&$("#"+t).addClass(o.actNeg)})),oldRefreshObj.css=JSON.parse(JSON.stringify(e.css)))}catch(e){console.error("Could not apply Own CSS-Values. The following error was thrown: "+e)}t(e.override,oldRefreshObj.override)?appProperties.devMode&&console.debug("[Debug] [Refresh] No changes for 'Override'!"):(appProperties.devMode&&console.debug("[Debug] [Refresh] Changes for 'Override'. Refreshing!",e.override,oldRefreshObj.override),applyElementOverrides(e.override),oldRefreshObj.override=JSON.parse(JSON.stringify(e.override)))}}catch(e){console.error("An error occured, while refreshing the data! The following Error was thrown: "+e)}}async function applyElementOverrides(e){try{Object.keys(e).length>0&&Object.entries(e).forEach((async e=>{const[t,o]=e;Object.keys(o).length>0&&Object.entries(o).forEach((e=>{const[o,a]=e,n=configuration.elements[t];switch(o.toLowerCase()){case"unit":!1===a.status?addErrorToLog({id:t,for:`${translateWord("lbl_override")}: <b>unit</b>`,error:a.error,function:a.function}):$(`#${t}_unit`).html(generateMultiLineText(`${t}_unit`,a,n.pos_x));break;case"append":$(`#${t}_append`).html(generateMultiLineText(`${t}_append`,a,n.pos_x));break;case"prepend":$(`#${t}_prepend`).html(generateMultiLineText(`${t}_prepend`,a,n.pos_x));break;case"value":case"bordercolor":case"borderfillcolor":case"fillcolor":break;case"img_url":let e=a;e.match(/\//)||(e=appProperties.socketURL+appProperties.namespace+"/userFiles/"+e),$(`#${t}`).attr("href",e);break;case"icon":iconHandler(t,a);break;case"pos_x":case"pos_y":if(n)if("text"==n.type){const e="pos_x"==o.toLocaleLowerCase()?"x":"y";$(`#${t}`).attr(e,a)}else addErrorToLog({id:t,for:`${translateWord("lbl_override")}: <b>pos_x/posy_y</b>`,error:"This property can only be used on text or datasource elements!",function:""});break;default:if(!1===a.status)addErrorToLog({id:t,for:`${translateWord("lbl_override")}: <b>CSS</b>`,error:a.error,function:a.function});else{let e=a;if(e.includes("gradient")){e=generateStyleProperty(t,o,a,!1,"url");const n=new RegExp(/(line_|anim_)/gi);t.match(n)&&gradientForStraightLine(t,t.replace(n,""))}$(`#${t}`).css(o,e)}}}))}))}catch(e){console.error("Could not apply override rules. The following error was thrown: "+e)}}async function translateGoogle(e,t){try{$.ajax({minLength:1,url:"http://translate.googleapis.com/translate_a/single?client=gtx&sl=en&dt=t",type:"GET",data:{tl:t,q:e},success:function(e){console.log(e[0][0][0])},error:function(){console.log("Error while translating into "+t)},timeout:3e3})}catch(e){console.log("Error!")}}function loadConfig(){const e=performance.now(),t=setTimeout((()=>{$("#loading_text_error").fadeIn("fast")}),4e3);console.log("[Config] Loading config for instance: "+appProperties.instance),loadAdditionalCSSFile(appProperties.theme),appProperties.isApple&&loadAdditionalCSSFile("webkit"),!appProperties.localMode||displayMode?socket.emit("getStates",subscribeObjID,(function(o,a){if(o)console.log(o),failedMessage(translateWord("failmsg_receiving_data"));else if(a){if(null!=a[subscribeObjID[0]]){console.log("[Config] Trying to load configuration from state!");try{if(configuration=JSON.parse(a[subscribeObjID[0]].val),0==Object.keys(configuration).length)throw new Error("No configuration found in state! Using basic configuration instead!");getBackups("backup_list"),setLoadedConfig()}catch(e){console.log("[Config] Error: No configuration in states found! Using basic configuration! "+e),basicConfig=!0,failedMessage(1==displayMode?translateWord("failmsg_no_config_display_mode"):translateWord("failmsg_no_config")),console.log("[Config] Loading Basic configuration from file!"),$.getJSON("js/basic_config.json",(function(e){configuration=e,configuration?(console.log("[Config] File loaded!"),console.debug(configuration),setLoadedConfig()):failedMessage(translateWord("failmsg_failed_config"))}))}clearTimeout(t)}else sprintf(systemDictionary.msg_instance_loading[systemLang],appProperties.instance),failedMessage(sprintf(systemDictionary.failmsg_instance[systemLang],appProperties.instance));if(null!=a[subscribeObjID[1]])try{if(console.log("[Config] Loading initial Data"),!a[subscribeObjID[1]].val)throw new Error("[Config] No data to display found! Please check, if layout is configured and saved properly!");refreshData(JSON.parse(a[subscribeObjID[1]].val))}catch(e){console.log("An error occured, while loading data! "+e)}globalAdapterOnline=null!=a[subscribeObjID[2]]&&a[subscribeObjID[2]].val}else failedMessage(translateWord("failmsg_no_values"));console.log(`[Config] Configuration loaded in ${performance.now()-e} ms`)})):(getBackups("backup_list"),configuration=localTest,configuration?(clearTimeout(t),console.log("[Config] Loading Local Config"),setLoadedConfig()):(basicConfig=!0,failedMessage(1==displayMode?translateWord("failmsg_no_config_display_mode"):translateWord("failmsg_no_config"))))}function generateStateTree(e,t){const o=performance.now();$(".title.folder, .title.state").off();let a=document,n=a.createElement("div"),i={};n.setAttribute("id","stateRoot"),$("#"+t).append(n);for(const t in e){let o=t.split("."),s="",r="";for(let l=0;l<o.length;l++)if(r=s,s=l>0?s+"."+o[l]:s+o[l],!a.getElementById(s)){let c=a.createElement("div");if(c.setAttribute("id",s),0==l)c.className="root",c.innerHTML=`<div class='title folder'><span class='type folderClosed'></span><span>${o[l]}</span></div>`,n.append(c);else if(c.className="sub","state"==e[t].type&&l==o.length-1)i[s]=e[t];else{let n="";l>1&&(n=e[t].hasOwnProperty("common")&&"state"!=e[t].type?e[t].common.name:""),c.innerHTML=`<div class='title folder'><span class='type folderClosed'></span><span>${o[l]}</span><span>${n}</span></div>`,a.getElementById(r)&&a.getElementById(r).append(c)}}}for(const t in i){let o=t,n=o.lastIndexOf("."),s=o.slice(0,n),r=o.slice(n+1,o.length);if(a.getElementById(s)){let n=a.createElement("div"),l="",c="";l=e[t].hasOwnProperty("common")?"object"==typeof e[t].common.name?e[t].common.name[systemLang]:e[t].common.name:"",c=i[t].hasOwnProperty("common")&&i[t].common.role||"",n.setAttribute("id",o),n.className="sub",n.innerHTML=`<div class='title state'><span class='type file'></span><span>${r}</span><span>${l}</span><span>${i[t].type}</span><span>${c}</span><span>${i[t].common.type}</span></div>`,a.getElementById(s).append(n)}}$(".title.folder").click((function(){$("#"+t).scrollTo($(this).parents(".root"),1e3),$(this).find(".type").first().toggleClass("folderOpen folderClosed"),$(this).siblings().not(".filter_hidden").slideToggle("fast")})),$(".title.state").click((function(){$(".state").removeClass("active"),$(".state").children(".type").removeClass("file-selected"),$(this).toggleClass("active"),$(this).children(".type").addClass("file-selected"),console.log("Active state: "+$(this).parent().attr("id")),$("#select_state").prop("disabled",!1)})),document.querySelector(".stateExplorerFilter").onkeyup=null,document.querySelector(".stateExplorerFilter").onkeyup=async function(){const e=performance.now();let t=$("#stateRoot"),o=new RegExp(this.value.trim().toLowerCase(),"gi");if($(".state").removeClass("active").children(".type").removeClass("file-selected"),$("#select_state").prop("disabled",!0),this.value)setTimeout((function(){t.find(".title").each((function(e,t){$(t).text().match(o)?$(t).parents(".root, .sub").removeClass("filter_hidden").addClass("filter green"):$(t).parent().removeClass("filter green").addClass("filter_hidden")})),t.find(".sub:visible").siblings().each((function(e,t){$(t).hasClass("filter_hidden")?$(t).slideUp():$(t).slideDown()})),console.debug(`Filtered elements in ${performance.now()-e} ms`)}),0);else{t.find(".root, .sub").removeClass("filter filter_hidden green");let e=t.find(".sub:visible").siblings();e.slideDown(),e.children(".folder").children("span.folderOpen").parent().siblings().slideDown()}},$("#stateExplorer_placeholder").hide(),console.log(`StateTree build up in ${performance.now()-o} ms`)}async function openStateTree(e,t=""){globalIobObjectsLoaded||(iobObjects=await loadIobObjects(),generateStateTree(iobObjects,"stateExplorer")),$("#select_state").prop("disabled",!0),$("#"+e).scrollTop(0);let o=$("[id^='"+t+"']").first();$("#"+e).show(),o.length&&(o.children(".title.state").addClass("active"),o.children(".title.state").children(".type").addClass("file-selected"),o.parents(".sub").show(),o.parents(".sub").children(".sub").show(),o.siblings().show(),o.parents(".sub, .root").children("div.title").children(".type").toggleClass("folderOpen folderClosed"),$("#"+e).animate({scrollTop:o.offset().top-$("#stateExplorerContainer").height()/2}),$("#select_state").prop("disabled",!1))}function getElements(e,t){function o(e,t){return e.length<=t?e:e.substr(0,t)+" â€¦"}let a={},n=[],i=[],s=[],r=[],l=[],c=[],d=[],u=[],g=[];Object.entries(configuration.elements).forEach((e=>{const[t,a]=e;switch(a.type){case"text":"datasource"==a.subType?i.push({id:a.id,text:`${o($(`#${t}`).text(),30)} (${-1!=a.source?configuration.datasources[a.source].alias:""} - ID:  ${a.id})`}):n.push({id:a.id,text:`${o($(`#${t}`).text(),30)} (ID: ${a.id})`});break;case"circle":s.push({id:a.id,text:`ID ${a.id} (X: ${a.pos_x} Y: ${a.pos_y})`,y:a.pos_y});break;case"rect":r.push({id:a.id,text:`ID ${a.id} (X: ${a.pos_x} Y: ${a.pos_y})`,y:a.pos_y});break;case"icon":l.push({id:a.id,text:`ID ${a.id} (X: ${a.pos_x} Y: ${a.pos_y} - ${a.icon})`,y:a.pos_y});break;case"svg":d.push({id:a.id,text:`ID ${a.id} (X: ${a.pos_x} Y: ${a.pos_y})`,y:a.pos_y});break;case"image":u.push({id:a.id,text:`ID ${a.id} (X: ${a.pos_x} Y: ${a.pos_y})`,y:a.pos_y});break;case"foreignObject":g.push({id:a.id,text:`ID ${a.id} (X: ${a.pos_x} Y: ${a.pos_y})`,y:a.pos_y})}})),Object.entries(configuration.defs).forEach((e=>{const[t,o]=e;let a=o.d.substring(1,o.d.indexOf(" "));c.push({id:`line_${o.id}`,text:`ID line_${o.id} (X: ${a})`,d:a})})),a={opt_elm_circle:s.sort(((e,t)=>parseFloat(e.y)-parseFloat(t.y))),opt_elm_ds:i.sort(((e,t)=>parseFloat(e.id)-parseFloat(t.id))),opt_elm_icons:l.sort(((e,t)=>parseFloat(e.y)-parseFloat(t.y))),opt_elm_svg:d.sort(((e,t)=>parseFloat(e.y)-parseFloat(t.y))),opt_elm_image:u.sort(((e,t)=>parseFloat(e.y)-parseFloat(t.y))),opt_elm_fObj:g.sort(((e,t)=>parseFloat(e.y)-parseFloat(t.y))),opt_elm_lines:c.sort(((e,t)=>parseFloat(e.d)-parseFloat(t.d))),opt_elm_rect:r.sort(((e,t)=>parseFloat(e.y)-parseFloat(t.y))),opt_elm_text:n.sort(((e,t)=>e.text<t.text?-1:e.text>t.text?1:0))};let p=document.createDocumentFragment();for(var f of Object.keys(a)){let e=document.createElement("optgroup");for(var h of(e.label=translateWord(f),Object.keys(a[f]))){let o=new Option(a[f][h].text,a[f][h].id);o.selected=a[f][h].id==t,e.append(o)}p.appendChild(e)}const m=document.getElementById(e);m&&(m.innerHTML="",m.append(p))}function getDataSources(e,t,o=!0){let a,n=document.createDocumentFragment();if(o&&n.append(new Option(translateWord("opt_please_choose"),"-1")),Object.keys(configuration.datasources).length>0){const e=Object.entries(configuration.datasources).sort((([,e],[,t])=>e.alias.toLowerCase()<t.alias.toLowerCase()?-1:e.alias.toLowerCase()>t.alias.toLowerCase()?1:0));for(var i of e){if(a=new Option(`${i[1].alias} (${i[1].source})`,i[0]),"object"==typeof t)for(var s in t)t[s]==i[0]&&(a.selected=!0);else a.selected=i[0]==t;n.appendChild(a)}}else a=new Option(translateWord("no_ds_added"),"-1"),a.disabled=!0,a.title=translateWord("ex_no_ds_added"),n.appendChild(a);const r=document.getElementById(e);r&&(r.innerHTML="",r.append(n))}function checkDatasourcesInUse(e){let t={},o=0;return Object.entries(configuration.elements).forEach((a=>{const[n,i]=a;Array.isArray(i.add)&&-1!==i.add.map((e=>parseInt(e))).indexOf(e)&&(t[o++]={id:i.id,type:translateWord(`lbl_${i.subType?i.subType:i.type}`),reason:translateWord("failmsg_delete_source_as_addition")}),Array.isArray(i.subtract)&&-1!==i.subtract.map((e=>parseInt(e))).indexOf(e)&&(t[o++]={id:i.id,type:translateWord(`lbl_${i.subType?i.subType:i.type}`),reason:translateWord("failmsg_delete_source_as_subtraction")}),i.source==e&&(t[o++]={id:i.id,type:translateWord(`lbl_${i.subType?i.subType:i.type}`),reason:translateWord("failmsg_delete_source_as_source")}),i.source_action==e&&(t[o++]={id:i.id,type:translateWord(`lbl_${i.subType?i.subType:i.type}`),reason:translateWord("failmsg_delete_source_as_source_action")})})),Object.entries(configuration.calculation.consumption).forEach((a=>{const[n,i]=a;"boolean"!=typeof i&&i===e&&(t[o++]={id:translateWord(`lbl_consumption_${n}`).replace("*",""),type:translateWord(`lbl_consumption_${n}`).replace("*",""),reason:translateWord("failmsg_delete_source_as_consumption")}),Array.isArray(i)&&"production"==n&&-1!=i.map((e=>parseInt(e))).indexOf(e)&&(t[o++]={id:translateWord(`lbl_consumption_${n}`).replace("*",""),type:translateWord(`lbl_consumption_${n}`).replace("*",""),reason:translateWord("failmsg_delete_source_as_production")})})),Object.entries(configuration.calculation.battery).forEach((a=>{const[n,i]=a;"boolean"!=typeof i&&i==e&&(t[o++]={id:translateWord(`lbl_battery_${n}`).replace("*",""),type:translateWord(`lbl_battery_${n}`).replace("*",""),reason:translateWord("failmsg_delete_source_as_calculation")})})),Object.entries(configuration.animations).forEach((a=>{const[n,i]=a;i.source==e&&(t[o++]={id:n.replace("anim","line"),type:translateWord("lbl_animation"),reason:translateWord("failmsg_delete_source_as_source")})})),t}function receiveImage(e){return new Promise(((t,o)=>{if(e){let o=new Image;if(e.startsWith("{")){console.debug("[Image] Loading image URL via ioBroker state: "+e);let a=e.substring(1,e.lastIndexOf("}"));socket.emit("getState",a,(function(e,a){a?(o.onload=()=>t(a.val),o.onerror=()=>t(""),null!=a.val&&""!=a.val?o.src=a.val:displayMode?(console.debug('[Image] State is empty! Returning "#"!'),t("#")):(console.debug('[Image] State is empty! Returning "Not found"!'),t("img/icon_not_found.png"))):console.log("[Image] A valid picture URL under the given source could not be found!")}))}else e.match(/\//)||(e=appProperties.socketURL+appProperties.namespace+"/userFiles/"+e,console.debug("Loading image from gallery: "+e)),o.onload=()=>t(e),o.onerror=()=>t("img/tmp_img.png"),o.src=e}else t("img/tmp_img.png");displayMode&&$(".type_image").removeClass("draggable")}))}function updateDataSources(){for(var e of(console.debug("Refreshing Datasources!"),Object.keys(configuration.calculation)))for(var t of Object.keys(configuration.calculation[e]))if("production"===t)getDataSources(`calculation.${e}.${t}`,configuration.calculation[e][t],!1),$(`#calculation\\.${e}\\.${t}`).multiselect(multiselect_options);else"boolean"!=typeof configuration.calculation[e][t]&&getDataSources(`calculation.${e}.${t}`,configuration.calculation[e][t],!0)}function calculatePathAnimationTime(e){const t=document.getElementById(e);if(!t)return 0;const o=t.getAttribute("xlink:href");return document.querySelector(o).getTotalLength()}function animatePath(e){const t=document.getElementById(e),o=calculatePathAnimationTime(e);t.style.display="inline",t.style.strokeDasharray=o,t.style.strokeDashoffset=o,t.style.animation=`drawAnimatedLine ${o/340}s linear forwards`}function setLoadedConfig(e=!1){let t=0;if(startIconObserver(),configuration.basic.enable_icon_proxy?appProperties.hostname.match(/iobroker\.pro|iobroker\.net/)?(console.log("[Config] Using direct load via iconify-API!"),loadAdditionalJSFile("js/iconify.min.js")):(console.log("[Config] Using Icon-Proxy for Icons"),$(".iconify").each((function(){loadIconViaProxy($(this).data("icon"),$(this))}))):(console.log("[Config] Using direct load via iconify-API!"),loadAdditionalJSFile("js/iconify.min.js")),e&&$("#style_user").empty(),$("#style_user").append(configuration.basic.styles),!displayMode){for(var o of(t=100,resizeSVG(),aceCSS=ace.edit("own_css"),aceCSS.session.setMode("ace/mode/css"),aceCSS.setTheme("ace/theme/"+appProperties.aceEditorTheme[appProperties.colorScheme]),aceCSS.setOptions({enableBasicAutocompletion:!0,enableSnippets:!0,enableLiveAutocompletion:!0,enableAutoIndent:!0}),aceCSS.on("change",(function(){configuration.basic.styles=aceCSS.getSession().getValue(),$("#style_user").empty().append(configuration.basic.styles)})),Object.entries(configuration.basic).forEach((e=>{const[t,o]=e;if(o)if("object"==typeof o)for(var a of Object.keys(configuration.basic[t]))$(`#basic\\.${t}\\.${a}`).hasClass("color")?$(`#basic\\.${t}\\.${a}`)[0].jscolor.fromString(configuration.basic[t][a]):$(`#basic\\.${t}\\.${a}`).val(configuration.basic[t][a]);else switch(t){default:switch(typeof o){case"boolean":$(`#basic\\.${t}`).prop("checked",o);break;case"number":case"string":$(`#basic\\.${t}`).val(o)}break;case"enable_grid":$(`#basic\\.${t}`).prop("checked",o),o&&$("#help_grid").fadeIn("fast");break;case"height":$("#basic\\.height\\.slider").val(o),$("#basic\\.height").val(o),resizeSVG();break;case"width":$("#basic\\.width").val(o),$("#basic\\.width\\.slider").val(o),resizeSVG();break;case"background_color":$("#basic\\.background_color")[0].jscolor.fromString(o);break;case"styles":aceCSS.setValue(configuration.basic.styles,-1),aceCSS.resize();break;case"animation_timer":$("#basic\\.animation_timer").val(configuration.basic.animation_timer?configuration.basic.animation_timer:1e3)}})),Object.keys(configuration.animation)))$(`#animation\\.${o}`).val(configuration.animation[o]);for(var o of Object.keys(configuration.animation_configuration))$(`#animation_configuration\\.${o}`).val(configuration.animation_configuration[o]);for(var o of Object.keys(configuration.line))$(`#line\\.${o}`).val(configuration.line[o]);for(var o of Object.keys(configuration.calculation))for(var a of Object.keys(configuration.calculation[o]))switch(a){default:getDataSources(`calculation.${o}.${a}`,configuration.calculation[o][a],!0);break;case"production":getDataSources(`calculation.${o}.${a}`,configuration.calculation[o][a],!1),$(`#calculation\\.${o}\\.${a}`).multiselect(multiselect_options);break;case"charge_prop":case"discharge_prop":case"gridFeed_prop":case"gridConsume_prop":case"batteryCharge_prop":case"batteryDischarge_prop":$(`#calculation\\.${o}\\.${a}`).prop("checked",configuration.calculation[o][a])}for(var o of(configuration.calculation.battery.dod>=0&&null!=configuration.calculation.battery.dod&&configuration.calculation.battery.capacity>=0&&null!=configuration.calculation.battery.capacity&&configuration.calculation.battery.percent>=0&&null!=configuration.calculation.battery.percent&&configuration.calculation.battery.charge>=0&&null!=configuration.calculation.battery.charge&&configuration.calculation.battery.discharge>=0&&null!=configuration.calculation.battery.discharge&&(console.debug("[Calculation] Battery configured!"),$("#calculation\\.battery\\.status").addClass("green").removeClass("red").text(translateWord("txt_calculation_succ"))),0!=configuration.calculation.consumption.production.indexOf(-1)&&configuration.calculation.consumption.production.length>0&&configuration.calculation.consumption.gridFeed>=0&&null!=configuration.calculation.consumption.gridFeed&&configuration.calculation.consumption.gridConsume>=0&&null!=configuration.calculation.consumption.gridConsume&&(console.debug("[Calculation] Consumption configured!"),$("#calculation\\.consumption\\.status").addClass("green").removeClass("red").text(translateWord("txt_calculation_succ"))),Object.keys(configuration.datasources)))addDataSourceRow(o,!0);configuration.basic.enable_ds_autocomplete&&$("#elm_ds_source").autocomplete(dataSourceAutocompleteOptions)}if(configuration.hasOwnProperty("elements")){$(".placeholders").empty();let i=[];for(var o in configuration.elements)i.push({key:o,position:configuration.elements[o].position||0});i.sort((function(e,t){return e.position-t.position}));for(var n=0;n<i.length;n++)svgElement(configuration.elements[i[n].key],!1);for(var o of Object.keys(configuration.defs))svgElement(configuration.defs[o],!1);for(var o of Object.keys(configuration.lines))svgElement(configuration.lines[o],!1);for(var o of Object.keys(configuration.animations))svgElement(configuration.animations[o],!1);if(updateLineAnimation(),displayMode){if(configuration.basic.background_color&&(console.debug("Setting background color!"),$("#style_user").append(`html,body { background-color: ${configuration.basic.background_color}; }`)),$("#svg_display").attr({viewBox:"0 0 "+configuration.basic.width+" "+configuration.basic.height}),$(".all_elements").removeClass("anim_element no_animation"),$("#config_link").on("click",(function(){window.location.replace("configuration.html?instance="+appProperties.instance)})),$("#info_error_area").hide(),globalError=[],$("#config_link").toggle(configuration.basic.enable_config_icon),configuration.basic.enable_low_performance||"true"===appProperties.lowPerformance){console.log("[Config] Low performance mode activated!");const s=document.querySelectorAll(".type_animation"),r=-136,l=Math.abs(r)/80,c=new Map;function d(){s.forEach((e=>{if("none"===getComputedStyle(e).display)return;const t="reverse"===e.style.animationDirection;let o=c.get(e);o=t?o>=0?r:o:o<=r?0:o,e.style.strokeDashoffset=o,c.set(e,o+(t?l:-l))})),setTimeout(d,20)}s.forEach((e=>{c.set(e,0)})),setTimeout(d,20)}else $(".type_animation").addClass("animation animation_cfg");e?console.log("Applying config without re-adding socket listener!"):displayListener()}basicConfig||displayMode||successMessage(translateWord("succ_msg_loading")),setTimeout((()=>{$("#loading").fadeOut("fast")}),t)}else successMessage(translateWord("succ_msg_loading_basic")),setTimeout((()=>{$("#loading").fadeOut("fast")}),t),$("#config_link > a").attr("href","configuration.html?instance="+appProperties.instance).show()}function updateLineAnimation(){$("#style_animation").empty().append(`.line {stroke-width:${configuration.line.stroke_width}px; stroke:${configuration.line.stroke}; }`).append(`.animation {stroke:${configuration.animation.stroke}; stroke-dasharray:${configuration.animation.stroke_dasharray};`).append(`stroke-width:${configuration.animation.stroke_width}px; stroke-linecap:${configuration.animation.stroke_linecap}; }`).append(`.animation_cfg {animation-duration:${configuration.animation.animation_duration}ms; animation-timing-function:${configuration.animation.animation_timing_function}; }`),displayMode&&$("#style_animation").append(".type_animation {display: none;}")}function linePreview(e){let t="",o=136,a=parseInt($("#animation\\.stroke_width").val()),n=parseInt($("#animation_configuration\\.dots").val()),i=parseInt($("#animation_configuration\\.distance").val()),s=parseInt($("#animation_configuration\\.length").val()),r=parseInt($("#line\\.stroke_width").val()),l=parseInt($("#animation\\.animation_duration").val()),c=$("#animation\\.stroke_linecap").val(),d=$("#animation\\.animation_timing_function").val();for(let e=0;e<n;e++)i>0&&s>0&&(t+=s+" ",e!=n-1&&(t+=i+" ",o-=i),o-=s);n>0&&s>0&&i&&(t+=" "+o),o<0&&$("#"+e).val($("#"+e).val()-1),configuration.animation={stroke_dasharray:t,stroke_width:a,animation_duration:l,stroke_linecap:c,animation_timing_function:d},configuration.animation_configuration={dots:n,distance:i,length:s},configuration.line={stroke_width:r,stroke:"#000000"},updateLineAnimation()}function successMessage(e){const t=2e3+20*e.length,o=$("#message_success");o.html(e),o.stop().fadeIn("middle",(function(){$(this).delay(t).fadeOut("middle",(function(){$(this).html("")}))}))}function failedMessage(e){const t=2e3+20*e.length,o=$("#message_failed");o.html(e),o.stop().fadeIn("middle",(function(){$(this).delay(t).fadeOut("middle",(function(){$(this).html("")}))}))}function resizeSVG(){const e=document.getElementById("svg_config");e.setAttribute("width",configuration.basic.width),e.setAttribute("height",configuration.basic.height),e.setAttribute("viewBox",`0 0 ${configuration.basic.width} ${configuration.basic.height}`)}function lineConnection(e){const t=[];for(const o in configuration.defs){const[,a,n]=o.split("_");a!=e&&n!=e||t.push({path:o,from:a,to:n})}return t}function checkSVGSize(e,t){function o(e,t){const o=getElementCoords(e.id),a=Number("width"===t?o.width:o.height);return("width"===t?o.x:o.y)+("circle"===o.type||"text"===o.type?a/2:a)+o.stroke}function a(e){return Object.values(configuration.elements).reduce(((t,a)=>o(a,e)>o(t,e)?a:t))}const n=a("width"),i=a("height");return{width:e>o(n,"width"),height:t>o(i,"height")}}function checkElementBounds(e,t){const o=configuration.basic,a=Number(e.stroke)/2,n="circle"==e.type||"text"==e.type?t.x-Number(e.width)/2-a:t.x-a,i=n+Number(e.width)+2*a,s="circle"==e.type||"text"==e.type?t.y-Number(e.height)/2-a:t.y-a,r=s+Number(e.height)+2*a;return{x:n>=0&&i<=o.width,y:s>=0&&r<=o.height}}function moveSVGElement(e,t){const o=configuration.elements[e.id],a="circle"==e.type?"cx":"x",n="circle"==e.type?"cy":"y",i=checkElementBounds(e,t).x,s=checkElementBounds(e,t).y;if(i&&($("#"+e.id).attr(a,t.x),o.pos_x=t.x,o.hasOwnProperty("text")&&o.text.match(/\n/gi)&&$("#"+e.id).children().attr("x",t.x),(o.hasOwnProperty("prepend")||o.hasOwnProperty("append")||o.hasOwnProperty("unit"))&&$(`#${e.id}_prepend, #${e.id}_append, #${e.id}_value, #${e.id}_unit`).children().each((function(){$(this).attr("x")&&$(this).attr("x",t.x)}))),s&&($("#"+e.id).attr(n,t.y),o.pos_y=t.y),appProperties.isApple&&o.degree&&$("#"+e.id).attr("transform",`rotate(${o.degree}, ${o.pos_x}, ${o.pos_y})`),e.connections.length>0)for(var r of e.connections)calculatePath(r.path,r.from,r.to);if(i&&s)return!0}function getMousePosition(e){var t=document.getElementById("svg_config").getScreenCTM();return e.touches&&(e=e.touches[0]),{x:parseInt((e.clientX-t.e)/t.a),y:parseInt((e.clientY-t.f)/t.d)}}function getElementCoords(e,t){const o=configuration.elements[e];let a=Number(o.width),n=Number(o.height),i=Number(o.pos_x),s=Number(o.pos_y),r=Number(o.radius)||0,l=Number(o.stroke)||0,c=0,d=0,u=t?getMousePosition(t):{x:0,y:0},g=n;switch(u.x-=i,u.y-=s,o.type){case"circle":a=2*r,n=a,c=i,d=s;break;case"text":const t=document.getElementById(e),l=t.getBoundingClientRect();let u=4;if(t.classList.contains("type_text")){const e=t.children;e.length>1&&(u+=e.length*o.font_size)}if(t.classList.contains("type_datasource")){const e=t.children[1].children;e.length>1&&(u+=e.length*o.font_size)}a=Math.round(l.width),n=Math.round(l.height)-u,g=n,c=i,d=s}return{id:Number(e),cx:c,cy:d,x:i,y:s,width:a,height:n,radius:r,stroke:l,coordHeight:g,connections:lineConnection(e),offset:u,type:o.type}}function connectorAngle(e){return(e-90)*(Math.PI/180)}function showConnectionPoints(e=!0){const t=$("#connection_points");e?(t.empty(),$(".connector").each((function(){const e=$(this).attr("id"),o={};o[e]={};const a=$(this).prop("tagName").toLowerCase();let n=function(e,t){if("circle"===t){const t=parseInt(e.attr("r"));return{r:t,cx:parseInt(e.attr("cx")),cy:parseInt(e.attr("cy")),width:2*t,height:2*t,x:parseInt(e.attr("cx"))-t,y:parseInt(e.attr("cy"))-t}}if("rect"===t)return{width:parseInt(e.attr("width")),height:parseInt(e.attr("height")),x:parseInt(e.attr("x")),y:parseInt(e.attr("y"))}}($(this),a);"circle"===a?function(e,{cx:t,cy:o,r:a}){const n=["top_left","top_right","right_top","right_bottom","bottom_left","bottom_right","left_bottom","left_top"];[340,20,70,110,200,160,250,290].forEach(((i,s)=>{e[n[s]]={x:t+a*Math.cos(connectorAngle(i)),y:o+a*Math.sin(connectorAngle(i))}}))}(o[e],n):"rect"===a&&function(e,{width:t,height:o,x:a,y:n}){e.top_left={x:a+t/2-20,y:n},e.top_right={x:a+t/2+20,y:n},e.left_top={x:a,y:n+o/2-20},e.left_bottom={x:a,y:n+o/2+20},e.right_top={x:a+t,y:n+o/2-20},e.right_bottom={x:a+t,y:n+o/2+20},e.bottom_left={x:a+t/2-20,y:n+o},e.bottom_right={x:a+t/2+20,y:n+o}}(o[e],n),function(e,{width:t,height:o,x:a,y:n}){e.top={x:a+t/2,y:n},e.left={x:a,y:n+o/2},e.right={x:a+t,y:n+o/2},e.bottom={x:a+t/2,y:n+o}}(o[e],n),function(e,t,o){Object.entries(e).forEach((([e,a])=>{const n=document.createElementNS("http://www.w3.org/2000/svg","circle");n.setAttribute("class","connPoints clickable"),n.setAttribute("cx",a.x),n.setAttribute("cy",a.y),n.setAttribute("r",5),n.setAttribute("data-slot",e),n.setAttribute("data-element",t),o.append(n)}))}(o[e],e,t)}))):t.empty()}function getSlots(e){const t=Math.floor(e.width/2),o=Math.floor(e.height/2),a=Math.floor(e.stroke/2);return{top:{x:e.cx?e.cx:e.x+t,y:e.cy?e.cy-t-a:e.y-a,direction:"vertical"},right:{x:e.cx?e.cx+t+a:e.x+e.width+a,y:e.cy?e.cy:e.y+o,direction:"horizontal"},bottom:{x:e.cx?e.cx:e.x+t,y:e.cy?e.cy+t+a:e.y+e.height+a,direction:"vertical"},left:{x:e.cx?e.cx-t-a:e.x-a,y:e.cy?e.cy:e.y+o,direction:"horizontal"}}}function getSpecialSlots(e,t){const o=Math.floor(e.width/2),a=Math.floor(e.height/2),n=Math.floor(e.stroke/2);let i=getSlots(e);return e.radius>0?(i.top_left={x:e.cx+e.radius*Math.cos(connectorAngle(340)),y:e.cy+e.radius*Math.sin(connectorAngle(340))-n,direction:"vertical"},i.top_right={x:e.cx+e.radius*Math.cos(connectorAngle(20)),y:e.cy+e.radius*Math.sin(connectorAngle(20))-n,direction:"vertical"},i.right_top={x:e.cx+e.radius*Math.cos(connectorAngle(70))+n,y:e.cy+e.radius*Math.sin(connectorAngle(70)),direction:"horizontal"},i.right_bottom={x:e.cx+e.radius*Math.cos(connectorAngle(110))+n,y:e.cy+e.radius*Math.sin(connectorAngle(110)),direction:"horizontal"},i.bottom_left={x:e.cx+e.radius*Math.cos(connectorAngle(200)),y:e.cy+e.radius*Math.sin(connectorAngle(200))+n,direction:"vertical"},i.bottom_right={x:e.cx+e.radius*Math.cos(connectorAngle(160)),y:e.cy+e.radius*Math.sin(connectorAngle(160))+n,direction:"vertical"},i.left_bottom={x:e.cx+e.radius*Math.cos(connectorAngle(250))-n,y:e.cy+e.radius*Math.sin(connectorAngle(250)),direction:"horizontal"},i.left_top={x:e.cx+e.radius*Math.cos(connectorAngle(290))-n,y:e.cy+e.radius*Math.sin(connectorAngle(290)),direction:"horizontal"}):(i.top_left={x:e.x+o-20,y:e.y-n,direction:"vertical"},i.top_right={x:e.x+o+20,y:e.y-n,direction:"vertical"},i.right_top={x:e.x+e.width+n,y:e.y+a-20,direction:"horizontal"},i.right_bottom={x:e.x+e.width+n,y:e.y+a+20,direction:"horizontal"},i.bottom_left={x:e.x+o-20,y:e.y+e.height+n,direction:"vertical"},i.bottom_right={x:e.x+o+20,y:e.y+e.height+n,direction:"vertical"},i.left_top={x:e.x-n,y:e.y+a-20,direction:"horizontal"},i.left_bottom={x:e.x-n,y:e.y+a+20,direction:"horizontal"}),{spec:i[t]}}async function connectElements(e){return new Promise(((t,o)=>{const a=$(".line:not(.faded_out, .preview)");let n,i,s,r;$(".connector").length>=2?($(`#${e}`).toggleClass("red"),$(`.connect_elements:not(#${e})`).prop("disabled",!0)):failedMessage(translateWord("failmsg_no_elements")),$(`#${e}`).hasClass("red")?($(`#${e}`).val(translateWord("value_cancel")),"connect_elements"==e&&hideConfigBar(),showConnectionPoints(),$(`#ex_${e}`).html("connect_elements"==e?translateWord("ex_connect_ref")+" <img src='img/icon_help.png' class='help' style='vertical-align: bottom;' placeholder='"+translateWord("help_connect")+"'>":translateWord("ex_reconnect_ref")),$(".all_elements").addClass("faded_out no_click"),"reconnect_elements"==e&&$("#"+a[0].id+", #"+a[0].id.replace("anim","line")).removeClass("faded_out"),$(".connector").removeClass("draggable draggable-multi faded_out no_click").addClass("clickable"),$(".clickable").off().click((function(o){let l=o.target.id?o.target.id:$(this).data("element"),c=$(this).data("slot")?$(this).data("slot"):"element";if(null==n)n=l,s=c,$(`#ex_${e}`).html(translateWord("ex_connect_start")),$(this).addClass("red");else if(n==l)$(`#ex_${e}`).html(translateWord("ex_connect_same")),i=null,r=null;else{i=l,r=c;let o=`path_${n}_${i}`;if(configuration.defs.hasOwnProperty(o))"connect_elements"==e?failedMessage(translateWord("failmsg_conn_exists")):(configuration.defs[o].startSlot=s,configuration.defs[o].endSlot=r,calculatePath(o,n,i),globalConfigChanged=!0);else{const t={type:"def",id:o,startSlot:s,endSlot:r,d:""};switch(configuration.defs[o]=t,svgElement(configuration.defs[o],!1),calculatePath(o,n,i),e){case"connect_elements":const e={type:"line",id:"line_"+o,color:configuration.line.stroke,href:"#"+o};configuration.lines["line_"+o]=e;const n={type:"animation",id:"anim_"+o,color:configuration.animation.stroke,href:"#"+o,source:-1,animation_properties:"positive",animation_option:!1,threshold:null,dots:null,duration:null,power:null,animation_type:-1,css_general:"",css_active_positive:"",css_inactive_positive:"",css_active_negative:"",css_inactive_negative:""};configuration.animations["anim_"+o]=n,saveUndoStep("add",{animation:n,def:t,line:e},"");break;case"reconnect_elements":if(1==a.length){let e=a[0].id,t=a[0].id.replace("line_",""),n=a[0].id.replace("line","anim");delete Object.assign(configuration.defs,{[o]:configuration.defs[t]})[t],delete Object.assign(configuration.lines,{["line_"+o]:configuration.lines[e]})[e],delete Object.assign(configuration.animations,{["anim_"+o]:configuration.animations[n]})[n],configuration.defs[o].id=o,configuration.lines["line_"+o].id="line_"+o,configuration.lines["line_"+o].href="#"+o,configuration.animations["anim_"+o].id="anim_"+o,configuration.animations["anim_"+o].href="#"+o,$(`#${n}, #${e}, #${t}`).remove()}}svgElement(configuration.lines["line_"+o],!1),svgElement(configuration.animations["anim_"+o],!1),globalConfigChanged=!0}t("line_"+o),showConnectionPoints(!1),n=null,i=null,$(`#${e}`).val("connect_elements"==e?translateWord("value_connect"):translateWord("value_reconnect")).removeClass("red"),$(`#ex_${e}`).html("connect_elements"==e?translateWord("ex_connect"):translateWord("ex_reconnect")),$(".connect_elements").prop("disabled",!1),$(".clickable").off(),$(".added_elements").removeClass("clickable").addClass("draggable"),$(".all_elements").removeClass("connect_elements"==e?"no_click faded_out":"no_click")}}))):($(".clickable").off(),$(".added_elements").removeClass("clickable").addClass("draggable"),$(".all_elements").removeClass("faded_out no_click"),$(`#${e}`).val("connect_elements"==e?translateWord("value_connect"):translateWord("value_reconnect")),$(`#ex_${e}`).html("connect_elements"==e?translateWord("ex_connect"):translateWord("ex_reconnect")),showConnectionPoints(!1),$(".connect_elements").prop("disabled",!1))}))}function copyToClipboard(e){navigator.clipboard.writeText(e).then((()=>{successMessage(translateWord("elm_copy_success")),console.debug("Text copied to clipboard via Clipboard API!")})).catch((e=>{console.error(e.message),alert(e.message),failedMessage(translateWord("elm_copy_failed"))}))}function exportElement(e){let t,o=Object.assign({},configuration.elements[e]);["id","source","source_action","pos_x","pos_y"].forEach((e=>delete o[e]));const a=getRandomInt(55);$(`<div id="tmpDiv_${a}" class="tmpDiv" />`).appendTo("body"),$(`#tmpDiv_${a}`).prop("title",translateWord("lbl_export_element")).dialog({resizable:!1,height:520,width:400,maxHeight:"100%",modal:!0,classes:jQueryDialog.classes,open:jQueryDialog.open,beforeClose:jQueryDialog.beforeClose,create:function(){t=ace.edit(`tmpDiv_${a}`),t.session.setMode("ace/mode/json"),t.setTheme("ace/theme/"+appProperties.aceEditorTheme[appProperties.colorScheme]),t.setReadOnly(!0),t.setValue(JSON.stringify(o,void 0,4),-1)},close:function(){t.destroy()},buttons:[{text:translateWord("btn_copy"),class:"input_button",click:function(){copyToClipboard(t.getValue())}},{text:translateWord("btn_close"),class:"input_button",click:function(){$(this).dialog("close")}}]})}function calculatePath(e,t,o){function a(e,t){let o=Math.abs(e.x-t.x),a=Math.abs(e.y-t.y);return Math.sqrt(o*o+a*a)}let n,i,s=getElementCoords(t),r=getElementCoords(o),l=configuration.defs[e].startSlot,c=configuration.defs[e].endSlot;n="element"!=l?getSpecialSlots(s,l):getSlots(s),i="element"!=c?getSpecialSlots(r,c):getSlots(r);let d=1/0,u={};for(var g of Object.keys(n))for(var p of Object.keys(i)){let e=a(n[g],i[p]);e<d&&(d=e,u={start:n[g],end:i[p]})}drawPath(e,u.start.x,u.start.y,u.end.x,u.end.y,u.start.direction,u.end.direction)}function polarToCartesian(e,t,o,a){const n=(a-90)*Math.PI/180;return{x:e+o*Math.cos(n),y:t+o*Math.sin(n)}}function describeArc(e,t,o,a,n,i){const s=polarToCartesian(e,t,o,n);return["A",o,o,0,n-a<=180?"0":"1",i,s.x,s.y]}function drawPath(e,t,o,a,n,i,s,r){let l={x:t,y:o},c=[`M${t} ${o}`];const d=Math.abs(a-t),u=Math.abs(n-o);let g=.2;configuration.defs[e].line_arc&&(g=parseFloat(configuration.defs[e].line_arc)/100);let p,f=15;function h(e){c.push(`H ${e}`),l.x=e}function m(e){c.push(`V ${e}`),l.y=e}configuration.defs[e].line_radius&&(f=parseFloat(configuration.defs[e].line_radius)),d<2*f&&(f=Math.floor(d/2)),u<2*f&&(f=Math.floor(u/2)),n==o&&h(a),a===t&&m(n),n>o&&a>t&&("horizontal"==i?"horizontal"==s?(h(t+d*g),p=describeArc(l.x,l.y+f,f,0,90,1),c.push(p.join(" ")),m(n-f),c.push(describeArc(p[6],l.y+f,f,0,90,0).join(" ")),h(a)):(h(a-f),c.push(describeArc(l.x,l.y+f,f,0,90,1).join(" ")),m(n)):"vertical"==s?(m(o+u*g),p=describeArc(l.x,l.y+f,f,0,90,0),c.push(p.join(" ")),h(a-f),c.push(describeArc(l.x,p[7]+f,f,0,90,1).join(" ")),m(n)):(m(n-f),p=describeArc(l.x,l.y+f,f,0,90,0),c.push(p.join(" ")),h(a))),n>o&&a<t&&("horizontal"==i?"horizontal"==s?(h(t-d*g),p=describeArc(l.x,l.y+f,f,180,270,0),c.push(p.join(" ")),m(n-f),c.push(describeArc(p[6],l.y+f,f,180,270,1).join(" ")),h(a)):(h(a+f),c.push(describeArc(l.x,l.y+f,f,180,270,0).join(" ")),m(n)):"vertical"==s?(m(o+u*g),p=describeArc(l.x-f,l.y,f,90,180,1),c.push(p.join(" ")),h(a+f),c.push(describeArc(l.x,p[7]+f,f,180,270,0).join(" ")),m(n)):(m(n-f),c.push(describeArc(l.x,l.y+f,f,180,270,1).join(" ")),h(a))),n<o&&a>t&&("horizontal"==i?"horizontal"==s?(h(t+d*g),p=describeArc(l.x,l.y-f,f,0,90,0),c.push(p.join(" ")),m(n+f),c.push(describeArc(p[6]+f,l.y,f,270,360,1).join(" ")),h(a)):(h(a-f),c.push(describeArc(l.x,l.y-f,f,0,90,0).join(" ")),m(n)):"vertical"==s?(m(o-u*g),p=describeArc(l.x,l.y-f,f,0,90,1),c.push(p.join(" ")),h(a-f),c.push(describeArc(l.x,p[7]-f,f,0,90,0).join(" ")),m(n)):(m(n+f),c.push(describeArc(l.x,l.y-f,f,0,90,1).join(" ")),h(a))),n<o&&a<t&&("horizontal"==i?"horizontal"==s?(h(t-d*g),p=describeArc(l.x,l.y-f,f,180,270,1),c.push(p.join(" ")),m(n+f),c.push(describeArc(p[6]-2*f,l.y-f,f,0,90,0).join(" ")),h(a)):(h(a+f),c.push(describeArc(l.x,l.y-f,f,180,270,1).join(" ")),m(n)):"vertical"==s?(m(o-u*g),p=describeArc(l.x-2*f,l.y-f,f,0,90,0),c.push(p.join(" ")),h(a+f),c.push(describeArc(l.x,p[7]-f,f,180,270,1).join(" ")),m(n)):(m(n+f),c.push(describeArc(l.x-2*f,l.y-f,f,0,90,0).join(" ")),h(a))),configuration.defs[e].d=c.join(" "),$("#"+e).attr("d",configuration.defs[e].d)}function showConfigBar(e,t,o="tab1"){$(".tab1_config").scrollTop(0),$(".tab2_config").scrollTop(0),$(`#${o}_config`).prop("checked",!0),$("#elm_counter_animation, #elm_convert").prop("checked",!1),$("#elm_select").selectmenu({open:function(){$($(this).selectmenu("instance").menu).children(".ui-menu-item").find("div.ui-state-active")[0].scrollIntoView({block:"center"})},position:{my:"right top+2",at:"right bottom",collision:"fit"}}).selectmenu("menuWidget").addClass("select_overflow"),getElements("elm_select",e),$("#elm_select").val(e).selectmenu("refresh").off().on("selectmenuchange",(function(){showConfigBar($(this).val(),$("#"+$(this).val()).prop("tagName"))})),$(".all_elements").removeClass("active_element").addClass("faded_out"),$(`#${e}`).removeClass("faded_out").addClass("active_element"),$(".elm_config, #reconnect_elements, #delete_element").prop("disabled",!1),$("#restore_element").prop("disabled",!0),$(".elm_config_box, .elm_config_box_sub, .enable_clock").hide(),$(".elm_config").val(""),$(".elm_config, #elm_frame_userDefined").prop("checked",!1),$("select.elm_config").each((function(){$(this)[0].selectedIndex=0})),$("#elm_degree, #elm_degree_slider").val(0),$(".elm_config.color").each((function(){$(this)[0].jscolor.fromString("")})),$(".elm_config.gradient").each((function(){u(this.id,"color","")})),$("#elm_icon").hasClass("ui-autocomplete-input")&&$("#elm_icon").autocomplete("destroy"),$("#elm_href").hasClass("ui-autocomplete-input")&&$("#elm_href").autocomplete("destroy");const a=configuration.elements[e];let n,i=null,s=Object.assign({},configuration.elements[e]),r={},l={},c={};switch(t){case"rect":$(".elm_config_box.rect").show();break;case"circle":$(".elm_config_box.circle").show();break;case"text":if($(".elm_config_box.text").show(),$(".text_not_ds").show(),"datasource"==s.subType)switch($(".elm_config_box.datasource").show(),$(".text_not_ds, .text_only").hide(),getDataSources("elm_subtract",s.subtract,!1),getDataSources("elm_add",s.add,!1),$("#elm_subtract").siblings(".ms-options-wrap").length>0?$("#elm_subtract").multiselect("reload"):$("#elm_subtract").multiselect(multiselect_options),$("#elm_add").siblings(".ms-options-wrap").length>0?$("#elm_add").multiselect("reload"):$("#elm_add").multiselect(multiselect_options),getDataSources("elm_source_action",s.source_action,!0),s.source_display){default:case"value":$(".text_not_ds").hide(),$(".linebreak_text").hide();break;case"own_text":$(".text_not_ds").show();break;case"text":$(".linebreak_text").show()}break;case"use":$(".elm_config_box.use").show(),c={animation:e.replace("line","anim"),def:e.replace("line_",""),line:e},console.debug(`Init: ${JSON.stringify(c)}`),s=Object.assign({},configuration.animations[c.animation]),r=Object.assign({},configuration.lines[c.line]),l=Object.assign({},configuration.defs[c.def]),getDataSources("elm_animation",s.source,!0),$("#elm_start_slot").val("element"==l.startSlot?translateWord("value_element"):translateWord("value_"+l.startSlot)),$("#elm_end_slot").val("element"==l.endSlot?translateWord("value_element"):translateWord("value_"+l.endSlot)),r.color&&r.color.includes("gradient")?u("elm_line_color","gradient",r.color):$("#elm_line_color")[0].jscolor.fromString(r.color),r.shadow&&r.shadow.includes("gradient")?u("elm_shadow","gradient",r.shadow):$("#elm_shadow")[0].jscolor.fromString(r.shadow||""),$("#elm_url").val(r.url),$("#elm_frame").val(r.frame||"_overlay"),$("#elm_line_arc").val(l.line_arc||20),$("#elm_line_radius").val(l.line_radius||15),$("#"+e).removeClass("faded_out");break;case"icon":case"svg":"svg"==s.subType?$(".elm_config_box.svg").show():$(".elm_config_box.icon").show();break;case"image":$(".elm_config_box.image").show();break;case"foreignObject":$(".elm_config_box.fObj").show()}switch(Object.entries(s).forEach((e=>{const[o,a]=e;if("object"==typeof a&&a&&"clock"===o)for(var n of Object.keys(s[o]))$(`#elm_${o}\\.${n}`).val(s[o][n]);switch(o){case"color":case"fill":case"fill_value":case"border_value":case"border_reverse_value":case"shadow":a&&(a.includes("gradient")?(u(`elm_${o}`,"gradient",a),"rect"!=t&&"circle"!=t||"color"!=o||(u("elm_border_value_fill","gradient",s.color,{background:parseColorString(s.color),color:"transparent"}),$("#elm_border_value_fill").prop("disabled",!0))):($(`#elm_${o}`)[0].jscolor.fromString("none"==a||""==a?"":a),"rect"!=t&&"circle"!=t||"color"!=o||$("#elm_border_value_fill").prop("disabled",!0)[0].jscolor.fromString(s.color)));break;default:$(`#elm_${o}`).val(a)}"degree"==o&&$("#elm_degree_slider").val(a||0),"boolean"==typeof a&&$(`#elm_${o}`).prop("checked",!0===a)})),-1!=s.fill_type&&s.fill_type&&($("#sub_FillType").show(),"value"==s.fill_type&&$("#sub_FillTypeValue").show()),s.border_type&&-1!=s.border_type&&($("#sub_BorderType").show(),"value"==s.border_type&&$("#sub_BorderTypeValue").show()),s.border_reverse&&$(".border_reverse_value").show(),s.enable_clock&&($(".enable_clock").show(),$("#elm_text").prop("disabled",!0)),s.animation_type&&-1!=s.animation_type&&($("#sub_AnimPower").show(),"dots"==s.animation_type?$("#sub_AnimDots").show():$("#sub_AnimDuration").show()),(s.frame_width||s.frame_height)&&($("#elm_frame_userDefined").prop("checked",!0),$("#sub_FrameUserDefinedSettings").show()),"_self"!=s.frame&&$("#sub_FrameUserDefined").show(),getDataSources("elm_source",s.source,!0),s.action){case"none":$("#sub_FrameDeactivated").hide();break;case"on":case"off":case"toggle":$("#sub_FrameDeactivated, #sub_ActionBox").show();break;case"change":$("#sub_FrameDeactivated, #sub_ActionBox, #sub_ActionShortcuts").show()}async function d(o){configuration.basic.enable_hide_configbar&&($("#config_bar").css("backgroundColor","transparent"),$(".detail_box").not($(this).parent().closest(".detail_box")).css("opacity",.1),clearTimeout(i),i=setTimeout((()=>{$(".detail_box").css("opacity",1),$("#config_bar").css("backgroundColor","var(--white)")}),600)),$("#restore_element").prop("disabled",!1),globalConfigChanged=!0;const r=o.target.id.replace("elm_","");let l,d="general";switch(($(this).hasClass("color")||$(this).hasClass("style"))&&(d="style"),$(this).hasClass("attribute")&&(d="attribute"),this.type){case"textarea":case"url":case"text":l=this.value;break;case"select-multiple":l=$(this).val().map((e=>parseInt(e)));break;case"select-one":l=isNaN(this.value)?this.value:parseInt(this.value);break;case"range":case"number":l=parseInt(this.value);break;case"checkbox":l=this.checked}switch(r){case"animation_type":"dots"==l?($("#sub_AnimDuration").hide(),$("#sub_AnimDots, #sub_AnimPower").slideDown("slow")):"duration"==l?($("#sub_AnimDots").hide(),$("#sub_AnimDuration, #sub_AnimPower").slideDown("slow")):$("#sub_AnimDuration, #sub_AnimDots, #sub_AnimPower").slideUp("slow");break;case"fill_type":-1==l?$("#sub_FillType, #sub_FillTypeValue").slideUp("slow"):($(".tab2_config").scrollTo($(this).parent().closest(".detail_box"),1e3,0),$("#sub_FillType").slideDown("slow"),$("#elm_fill_direction").val(s.fill_direction||90).trigger("change"),"value"==l?$("#sub_FillTypeValue").slideDown("slow"):$("#sub_FillTypeValue").slideUp("slow"));break;case"border_type":-1==l?$("#sub_BorderType, #sub_BorderTypeValue").slideUp("slow"):($(".tab2_config").scrollTo($(this).parent().closest(".detail_box"),1e3,0),$("#sub_BorderType").slideDown("slow"),$("#elm_border_start").val(s.border_start||180).trigger("change"),$("#elm_border_direction").val(s.border_direction||"cw").trigger("change"),$("#elm_border_style").val(s.border_style||"round").trigger("change"),$("#elm_border_reverse").prop("checked",s.border_reverse).trigger("change"),"value"==l?$("#sub_BorderTypeValue").slideDown("slow"):$("#sub_BorderTypeValue").slideUp("slow"));break;case"border_reverse":l?$(".border_reverse_value").slideDown("slow"):$(".border_reverse_value").slideUp("slow");break;case"source_display":switch(l){default:case"value":$(".text_not_ds").slideUp("slow"),$(".linebreak_text").slideUp("slow"),$("#elm_counter_animation").prop("disabled",!1);break;case"own_text":$("#elm_text").val(`ID ${e}`),$(".text_not_ds").slideDown("fast"),$(".tab1_config").scrollTo($("#elm_text").parent().closest(".detail_box"),1e3);break;case"text":$(".linebreak_text").slideDown("slow"),$("#elm_counter_animation").prop("disabled",!0)}break;case"action":switch(l){case"none":$("#sub_ActionShortcuts, #sub_FrameDeactivated, #sub_ActionBox").slideUp("slow");break;case"on":case"off":case"toggle":$("#sub_FrameDeactivated, #sub_ActionBox").slideDown("slow"),$("#sub_ActionShortcuts").slideUp("slow");break;case"change":$("#sub_FrameDeactivated").fadeIn("slow"),$("#sub_FrameDeactivated, #sub_ActionShortcuts, #sub_ActionBox").slideDown("slow"),$(".tab2_config").scrollTo($(this).parent().closest(".detail_box"),1e3,0),$("#elm_action_type").val(a.hasOwnProperty("action_type")?a.action_type:"number"),a.hasOwnProperty("action_type")||(a.action_type="number"),$("#elm_action_display").val(a.hasOwnProperty("action_display")?a.action_display:"button"),a.hasOwnProperty("action_display")||(a.action_display="button"),$("#elm_action_display_freeform").prop("checked",!a.hasOwnProperty("action_display_freeform")||a.action_display_freeform),a.hasOwnProperty("action_display_freeform")||(a.action_display_freeform=!0)}break;case"enable_clock":l?($("#elm_text").prop("disabled",!0),$(".enable_clock").slideDown("slow"),$(".tab1_config").scrollTo($(this).parent().closest(".detail_box"),1e3,0)):($("#elm_text").prop("disabled",!1),$(".enable_clock").slideUp("slow"));break;case"color":"rect"!=t&&"circle"!=t||(l.includes("gradient")?(console.log(l),u("elm_border_value_fill","gradient",l,{background:parseColorString(l),color:"transparent"}),$("#elm_border_value_fill").prop("disabled",!0)):(u("elm_border_value_fill","color",l),$("#elm_border_value_fill").prop("disabled",!0)[0].jscolor.fromString(l)));break;case"frame":$(".tab2_config").scrollTo($(this).parent().closest(".detail_box"),1e3,0),"_self"==l?($("#frame_userDefinedBox, #frame_userDefined").slideUp("slow"),$("#elm_frame_userDefined").prop("checked",!1)):$("#frame_userDefinedBox").slideDown("slow")}const p=(e,t,o)=>{console.debug(`Object ${o} property change! Source: ${e} Value: ${t} | Before: ${a[e]}`),a[e]=t,console.debug("Object after change",a)};switch(d){case"style":const i={color:{target:e,property:"stroke",value:l},shadow:{target:e,property:"filter",value:`drop-shadow(0px 3px 3px ${l})`},fill:{target:e,property:"fill",value:l||"none"}};let d,u,g;const h=({animation:{color:{target:c.animation,property:"stroke",value:l},line_color:{target:c.line,property:"stroke",value:l},shadow:{target:c.line,property:"filter",value:`drop-shadow(0px 3px 3px ${l})`}},text:{color:i.color,fill:i.fill,shadow:i.shadow,font_size:{target:e,property:"font-size",value:l+"px"},font_family:{target:e,property:"font-family",value:l},align:{target:e,property:"text-anchor",value:l}},rect:{color:i.color,shadow:i.shadow,fill:i.fill},circle:{color:i.color,shadow:i.shadow,fill:i.fill},icon:{shadow:i.shadow},svg:{shadow:i.shadow},foreignObject:{shadow:i.shadow},image:{shadow:i.shadow}}[s.type]||{})[r];if(h?(d=h.target,u=h.property,g=h.value):(d=e,u=r,g=l),l=generateStyleProperty(d,u,l,!0,"color"),$(`#${d}`).css(u,g),"shadow"==r&&appProperties.isApple){const e=shadowHandler(l);$(`#${d}`).css("filter",`url(#${e})`)}"animation"==s.type?("color"==r&&(console.debug(`Line-Animation color change! Value: ${l} | Before: ${configuration.animations[c.animation].color}`),configuration.animations[c.animation].color=l),"line_color"==r&&(console.debug(`Line-Color change! Value: ${l} | Before: ${configuration.lines[c.line].color}`),configuration.lines[c.line].color=l),"shadow"==r&&(console.debug(`Line-Shadow change! Value: ${l} | Before: ${configuration.lines[c.line].shadow}`),configuration.lines[c.line].shadow=l)):p(r,l,"CSS");break;case"attribute":const m={id:e,type:t,stroke:Number($("#elm_stroke").val())||0,width:getElementCoords(e).width,height:getElementCoords(e).height,connections:lineConnection(e),radius:$("#elm_radius").val()},_={x:$("#elm_pos_x").val(),y:$("#elm_pos_y").val()},b=checkElementBounds(m,_);if(b.x&&b.y){switch(r){case"pos_x":case"pos_y":moveSVGElement(m,_),$("#placeholder_coordinate_desc").children().fadeOut("fast",(function(){$(this).remove()}));break;case"radius":p(r,m.radius,"Attribute"),$("#"+e).attr("r",m.radius);break;case"stroke":p(r,m.stroke,"CSS"),$(`#${e}`).css("strokeWidth",m.stroke);break;case"fObj_content":case"svg_content":p(r,l,"Attribute"),$(`#${e}`).html(l);break;case"rx":case"height":case"width":case"preserveAspectRatio":case"viewBox":moveSVGElement(m,_),p(r,l,"Attribute"),$(`#${e}`).attr(r,l);break;case"href":p(r,l,"Attribute"),$(`#${e}`).attr("href",await receiveImage(l));break;case"append":case"unit":case"prepend":p(r,l,"Attribute"),$(`#${e}_${r}`).html(generateMultiLineText(`${e}_${r}`,l,_.x));break;case"text":p(r,l,"Attribute"),"own_text"==$("#elm_source_display").val()?$(`#${e}_value`).html(generateMultiLineText(`${e}_value`,l,_.x)):$(`#${e}`).html(generateMultiLineText(e,l,_.x));break;case"rotate":case"flip":p(r,l,"Attribute");break;case"degree_slider":case"degree":var f=Math.max(0,Math.min(l,360));p("degree",f,"Attribute"),appProperties.isApple?$("#"+e).attr("transform",`rotate(${f}, ${a.pos_x}, ${a.pos_y})`):$("#"+e).css({"transform-box":"fill-box",transform:`rotate(${f}deg)`}),"degree"==r?$("#elm_degree_slider").val(l):$("#elm_degree").val(l)}"icon"==s.type&&($(`#${e}`).attr("data-"+r,l),iconHandler(e,a.icon,!0))}else"input"==o.type&&(clearTimeout(n),n=setTimeout((()=>{$("#elm_"+r).val(a[r])}),500));break;case"general":if(r.match(/\./)){let t=r.split(".");a.hasOwnProperty(t[0])||(a[t[0]]={}),console.debug(`Sub-Object property change! Source: ${r} Value: ${l} | Before: ${a[t[0]][t[1]]}`),a[t[0]][t[1]]=l,r.match(/clock\./)&&userClock(a.clock,e,!0)}else if("animation"==s.type)switch(r){default:const e="animation"==r?"source":r;console.debug(`Line-Animation property change! Source: ${e} Value: ${l} | Before: ${configuration.animations[c.animation][e]}`),configuration.animations[c.animation][e]=l,console.debug(configuration.animations[c.animation]);break;case"line_radius":case"line_arc":console.debug(`Line-Definition Property changed! Source: ${r} Value: ${l} | Before: ${configuration.defs[c.def][r]}`),configuration.defs[c.def][r]=parseFloat(this.value),console.debug(configuration.defs[c.def]);let t=configuration.defs[c.def].id.split("_");console.debug(`Re-routing the line between Elments ${t[1]} and ${t[2]} with: Arc: ${configuration.defs[c.def].line_arc||20}% and Radius: ${configuration.defs[c.def].line_radius||15}`),calculatePath(configuration.defs[c.def].id,t[1],t[2]);break;case"frame":case"url":console.debug(`Line-Property change! Source: ${r} Value: ${l} | Before: ${configuration.lines[c.line][r]}`),configuration.lines[c.line][r]=l,console.debug(configuration.lines[c.line])}else p(r,l,"General")}$(this).hasClass("elm_config_update")&&g()}function u(e,t,o,a={}){let n=$(`<input type="text" class="input_text style elm_config" name="${e}" id="${e}" placeholder="" autocorrect="off" autocomplete="off" value="${o}" />`).off().on("input change",d);if("color"==t&&(n.attr("data-jscolor","{}").addClass("color").removeClass("style").data("current-color",o),$(`#${e}`).next(".icon_wrapper").remove()),"gradient"==t&&(n.addClass("icon_in_input_pad gradient"),0==$(`#${e}`).siblings(".icon_wrapper").length&&$(`<div class="icon_wrapper"><a class="preview_gradient icon_in_input" title="${translateWord("title_show_gradient")}"><span class="iconify" data-icon="material-symbols:preview-outline" data-height="24"></span></a></div>`).insertAfter(`#${e}`)),a&&n.css(a),$(`#${e}`).replaceWith(n),"color"==t){const t=document.querySelector(e);jscolor.install(t)}console.debug(`Setting ${e} to ${t}!`),$(`#${e}`).parent("div").next("div").children("input.color_change").val(translateWord(`value_color_change_${t}`))}function g(){if("datasource"==s.subType){const t=configuration.elements[e];if("own_text"!=t.source_display&&-1!=t.source){let o={id:e,source:configuration.datasources[t.source].source,source_option:t.source_option||-1,source_option_lc:t.source_option_lc||-1,source_display:t.source_display,linebreak:t.linebreak,type:t.type,threshold:t.threshold,calculate_kw:t.calculate_kw,decimal_places:t.decimal_places,override:t.override};console.debug("Requesting new Data with: ",o),socket.emit("sendTo",appProperties.namespace,"_updateElementInView",o,(function(t){t&&t.error?console.log("An error occured, while getting the updated value: ",t.error):(console.log(`Returned from ioBroker: ${JSON.stringify(t.data)}`),refreshData(t.data),""==$("#elm_unit").val()&&t.data.unit[e]&&$("#elm_unit").val(t.data.unit[e]).trigger("change"))}))}else console.log("Source option is own text! Not requesting!")}}$("#config_bar").addClass("show"),$("#delete_element").off().click((function(){if(this.blur(),"animation"===s.type)delete configuration.lines[c.line],delete configuration.defs[c.def],delete configuration.animations[c.animation],$(`#${c.def}, #${c.line}, #${c.animation}`).remove(),successMessage(translateWord("succ_msg_line_delete")),$("#restore_element").prop("disabled",!1),$(".elm_config, #reconnect_elements, #delete_element").prop("disabled",!0);else lineConnection(e).length>0?failedMessage(translateWord("failmsg_element_delete")):(delete configuration.elements[e],$(`#${e}`).remove(),successMessage(translateWord("succ_msg_delete")),$("#restore_element").prop("disabled",!1),$(".elm_config, #reconnect_elements, #delete_element").prop("disabled",!0),$("#placeholder_coordinate_desc").empty(),$("#mouse_contextmenu").fadeOut(200))})),$("#elm_frame_userDefined").off().click((function(){this.checked?$("#sub_FrameUserDefinedSettings").slideDown("slow"):($("#sub_FrameUserDefinedSettings").slideUp("slow"),$("#elm_frame_width, #elm_frame_height").val("").trigger("change")),$(".tab2_config").scrollTo($(this).parent().closest(".detail_box"),1e3,0)})),$(".changeOrder").off().click((function(){$("#restore_element").prop("disabled",!1);let t=$("#"+e).next(),o=$("#"+e).prev();switch($(this).attr("id")){case"changeOrder_foreground":t.length>0?$("#"+e).insertAfter(t):failedMessage(translateWord("failmsg_max_foreground"));break;case"changeOrder_background":o.length>0?$("#"+e).insertBefore(o):failedMessage(translateWord("failmsg_max_background"))}if("animation"===s.type)configuration.lines[e].position=$("#"+e).index();else a.position=$("#"+e).index()})),$(".elm_config").off().on("input change",d),$(".color_change").off().on("click",(function(){const e=$(this).parent("div").prev("div").children(".color, .style"),t=e.attr("id");t&&(u(t,e.data("jscolor")?"gradient":"color",e.val()),$("#restore_element").prop("disabled",!1))})),$("#reconnect_elements").off().on("click",(async function(){e=await connectElements(this.id),c={animation:e.replace("line","anim"),def:e.replace("line_",""),line:e},console.debug(`After reconnect: ${JSON.stringify(c)}`),getElements("elm_select",c.line),$("#elm_select").selectmenu("refresh"),$(`#${c.line}`).addClass("active_element"),$(".type_rect, .type_circle").addClass("faded_out"),$("#restore_element").prop("disabled",!1),$("#elm_start_slot").val("element"==configuration.defs[c.def].startSlot?translateWord("value_element"):translateWord("value_"+configuration.defs[c.def].startSlot)),$("#elm_end_slot").val("element"==configuration.defs[c.def].endSlot?translateWord("value_element"):translateWord("value_"+configuration.defs[c.def].endSlot))})),$("#elm_icon").off().on("input",(function(){$(this).autocomplete({position:{my:"right top",at:"right bottom",collision:"fit"},classes:{"ui-autocomplete":"ui-autocomplete-icon"},source:function(e,t){$.ajax({minLength:1,url:"https://api.iconify.design/search?",type:"GET",data:{query:e.term},success:function(e){t($.map(e.icons,(function(e){return{label:e}})))}})},select:function(t,o){return iconHandler(e,o.item.value,!0),a.icon=o.item.value,o.item.value}}).autocomplete("instance")._renderItem=function(e,t){return $("<li class='ui-menu-item'>").append(`<div class='ui-menu-item-wrapper'><span class='iconify' data-width='24' data-icon='${t.label}'></span><span style='font-weight: normal; padding-left:10px;'>${t.label}</span></div>`).appendTo(e)}})),$(".preview_element").off().on("click",(async function(t){const o=configuration.elements[e];if(o.source>=0){const e=await new Promise(((e,t)=>{socket.emit("getState",configuration.datasources[o.source].source,((a,n)=>{n?(console.debug(`Pulled value from ioBroker: ${n.val}`),e(n.val)):t(`(PreviewElement) The state could not be received! Please check the associated Datasource: ${configuration.datasources[o.source].source}`)}))})).catch((e=>{console.error(e),failedMessage(sprintf(systemDictionary.failmsg_invalid_ds[systemLang],configuration.datasources[o.source].source))}));if("value"==o.fill_type&&o.fill_max>0||"value"==o.border_type&&o.border_max>0||-1!=o.fill_type||-1!=o.border_type){const a=getRandomInt(55);$(`<div id="tmpDiv_${a}" class="tmpDiv" />`).appendTo("body");let n=o.type,i=o.stroke,s=i+("rect"==n?o.width:2*o.radius),r=i+("rect"==n?o.height:2*o.radius);null!=e&&$(`#tmpDiv_${a}`).prop("title",translateWord("lbl_preview_element")).dialog({resizable:!1,width:s+50,maxHeight:"100%",modal:!0,classes:jQueryDialog.classes,open:jQueryDialog.open,beforeClose:jQueryDialog.beforeClose,create:async function(){$(this).html($(`<svg id='preview_${a}' width='${s}' height='${r}' style='width:100%;height:100%;display:block;' />`));let l=Object.assign({},o);l.pos_x=4+i/2+("rect"==n?0:s/2-i/2),l.pos_y=4+i/2+("rect"==n?0:r/2-i/2),l.id=`p${a}`;let c=await svgElement(l,!1,!0);$(c).appendTo($(`#preview_${a}`));let d="preview_element_fill"==t.target.id?o.fill_value:o.border_value;const u=d&&d.includes("gradient")?"gradient":"color";switch(t.target.id){case"preview_element_fill":if("color"==u&&(generateSingleGradient(`p${a}`,d,o.fill,o.fill_direction),updateSingleGradient(`p${a}`,e||33,o.fill_max,o.fill_type)),"gradient"==u){d=d.replace(/[+-]?(?:\d*\.?\d+)(deg|rad|grad|turn)\s*,\s*|to\s+(top|bottom|left|right)(\s+left|\s+right)?\s*,\s*/gi,"-90deg,"),generateStyleProperty(`p${a}`,"fill",d,!0);const t=document.getElementById(`gradient_p${a}_fill`),n=o.fill&&!o.fill.match(/(?=(gradient|none))/gi)?o.fill:"transparent";let i=document.createElementNS("http://www.w3.org/2000/svg","stop");i.setAttribute("id",`gradient_p${a}_fill_transparent`),i.setAttribute("offset","0%"),i.setAttribute("stop-color",n),t.appendChild(i),t.setAttribute("gradientTransform","rotate("+o.fill_direction+",0.5,0.5)"),updateMultiGradient(`p${a}`,e||33,o.fill_max,o.fill_type),console.log(`[Config] Multi-Fill-Gradient added for: p${a}`)}break;case"preview_element_border":const t=generateStyleProperty(`p${a}`,"stroke",d,!1,"url");addBorderFill(`p${a}`,t,o.border_style,o.border_start),updateBorderFill(`p${a}`,e||33,o.border_max,o.border_type,o.border_direction)}},buttons:[{text:translateWord("btn_close"),class:"input_button",click:function(){$("#placeholder_gradients").children("[id^='gradient_p']").remove(),$(this).dialog("close")}}]})}else failedMessage(translateWord("failmsg_preview_element_not_all"))}else failedMessage(translateWord("failmsg_preview_element_no_ds"))})),$(".preview_action").off().on("click",(function(t){const o="animation"==s.type?configuration.lines[r.id]:configuration.elements[e];switch(t.target.id){case"preview_action_url":""!=o.url&&null!=o.url?actionForElement(e,t,"url"):failedMessage(translateWord("failmsg_preview_element_not_all"));break;case"preview_action_click":o.source>=0||o.source_action>=0?"none"==o.action||null==o.action?failedMessage(translateWord("failmsg_preview_element_no_action")):actionForElement(e,t,"click"):failedMessage(translateWord("failmsg_preview_element_no_ds"))}})),$("#manage_shortcuts").off().on("click",(function(){$("#shortcut-table").off();const e=(e,t)=>{let o=$(`<tr><td>${a.shortcuts[t].alias}</td><td>${a.shortcuts[t].value}</td><td><button class= 'all_datasource ds_buttons btn-update'><span class='iconify' data-height='24' data-icon='mdi:check'>Update</span></button><button class='all_datasource ds_buttons btn-cancel'><span class='iconify red_icon' data-height='24' data-icon='mdi:close'>Cancel</span></button><button class='all_datasource ds_buttons btn-edit'><span class='iconify' data-height='24' data-icon='mdi:pencil'>Edit</span></button><button class='all_datasource ds_buttons btn-delete'><span class='iconify red_icon' data-height='24' data-icon='mdi:delete'>Delete</span></button></td></tr>`).data({id:t,alias:a.shortcuts[t].alias,value:a.shortcuts[t].value});$("#shortcut-table tbody").append(o)};$("#frm-addQuickAccess").off().submit((function(t){t.preventDefault();let o=0;a.hasOwnProperty("shortcuts")?o=Object.keys(a.shortcuts).length>0?Math.max(...Object.keys(a.shortcuts).map((e=>e)))+1:0:a.shortcuts={},a.shortcuts[o]={alias:$("#shortcut_alias").val(),value:$("#shortcut_value").val()},$("#shortcut-table tbody").children().length>0&&$("#shortcut_tmp_line").hide(),e(0,o),$(this)[0].reset(),$(this)[0][0].focus(),globalConfigChanged=!0})),$("#shortcut-table").on("click",".btn-edit",(function(){let e=$(this).parents("tr"),t=`<div class="form_div no_margin"><input type="text" class="input_text" id="edit_shortcut_alias" name="edit_shortcut_alias" autocorrect="off" autocomplete="off" value="${e.data("alias")}"></div>`,o=`<div class="form_div no_margin"><input type="text" class="input_text" id="edit_shortcut_value" name="edit_shortcut_value" autocorrect="off" autocomplete="off" value="${e.data("value")}"></div>`;e.find("td:eq(0)").html(t),e.find("td:eq(1)").html(o),e.find(".btn-update, .btn-cancel").show(),e.find(".btn-delete, .btn-edit").hide()})),$("#shortcut-table").on("click",".btn-cancel",(function(){let e=$(this).parents("tr");e.find("td:eq(0)").text(e.data("alias")),e.find("td:eq(1)").text(e.data("value")),e.find(".btn-update, .btn-cancel").hide(),e.find(".btn-delete, .btn-edit").show()})),$("#shortcut-table").on("click",".btn-update",(function(){let e=$(this).parents("tr"),t=$("#edit_shortcut_alias").val(),o=$("#edit_shortcut_value").val();a.shortcuts[e.data("id")]={alias:t,value:o},e.find("td:eq(0)").text(t),e.find("td:eq(1)").text(o),e.find(".btn-update, .btn-cancel").hide(),e.find(".btn-delete, .btn-edit").show(),globalConfigChanged=!0})),$("#shortcut-table").on("click",".btn-delete",(function(){let e=$(this).parents("tr");delete a.shortcuts[e.data("id")],e.fadeOut("fast",(function(){$(this).remove();let e=$("#shortcut-table tbody").children();1==e.length&&"shortcut_tmp_line"==e[0].id&&$("#shortcut_tmp_line").fadeIn("fast")})),globalConfigChanged=!0})),$("#manage_shortcuts_section").dialog({resizable:!1,height:"auto",maxHeight:"100%",width:550,modal:!0,classes:jQueryDialog.classes,open:jQueryDialog.open,beforeClose:jQueryDialog.beforeClose,create:function(){if($("#shortcut-table tbody").children().not("#shortcut_tmp_line").remove(),$("#frm-addQuickAccess")[0].reset(),a.hasOwnProperty("shortcuts")){if(Object.keys(a.shortcuts).length>0){$("#shortcut_tmp_line").hide();const o=Object.entries(a.shortcuts).sort((([,e],[,t])=>e.alias.toLowerCase()<t.alias.toLowerCase()?-1:e.alias.toLowerCase()>t.alias.toLowerCase()?1:0));for(var t of o)e(0,t[0])}}else $("#shortcut_tmp_line").show()},buttons:[{text:translateWord("btn_close"),class:"input_button",click:function(){$(this).dialog("close")}}]})})),$(".override_settings").off().on("click",(function(e){let t;switch(e.target.id){case"override_settings":t="animation"==s.type?configuration.lines[c.line].override:a.override;break;case"override_settings_animation":t=configuration.animations[c.animation].override}aceOverride.setValue(JSON.stringify(t,void 0,4),-1),$("#loading").fadeIn(600),$(".loading-spinner, #loading_text").hide(),$("#codeEditorContainer").css({top:"45%",opacity:0,display:"block"}),$("#codeEditorContainer").animate({opacity:1,top:"50%"},{duration:600,queue:!1}),aceOverride.getSession().off("changeAnnotation"),aceOverride.getSession().on("changeAnnotation",(function(){let e=aceOverride.getSession().getAnnotations().filter((e=>"error"==e.type));$("#save_code").prop("disabled",e.length>0)})),$("#save_code").off().on("click",(function(){let t=aceOverride.getValue()?JSON.parse(aceOverride.getValue()):{};switch(e.target.id){case"override_settings":"animation"==s.type?configuration.lines[c.line].override=t:(a.override=t,g());break;case"override_settings_animation":configuration.animations[c.animation].override=t}closeEditorContainer("codeEditor"),$("#restore_element").prop("disabled",!1),globalConfigChanged=!0}))})),$("#export_element").off().on("click",(function(){exportElement(e)})),$("#overrideFormatCode").off().on("click",(function(e){try{aceOverride.setValue(JSON.stringify(JSON.parse(aceOverride.getValue()),void 0,4),-1)}catch(e){failedMessage(translateWord("msg_json_malformmated"))}})),$("#restore_element").off().click((async function(){let t=!1;$("#dialog_section").prop("title",translateWord("lbl_restore_element")).html(translateWord("msg_restore_element")).dialog({resizable:!1,height:"auto",maxHeight:"100%",width:400,modal:!0,classes:jQueryDialog.classes,open:jQueryDialog.open,beforeClose:jQueryDialog.beforeClose,buttons:[{text:translateWord("value_restore"),width:"auto",class:"input_button",click:async function(){if($(this).dialog("close"),"animation"===s.type)console.log("Opened Element: "+c.line+" Saved for restore: "+r.id),t=!!configuration.animations.hasOwnProperty(s.id),t||(console.debug(`Line was reconnected during configuration. Restoring previous one (${r.id}) and deleting new one (${e})!`),delete configuration.defs[c.def],delete configuration.lines[c.line],delete configuration.animations[c.animation],$(`#${c.def}, #${c.line}, #${c.animation}`).remove()),configuration.defs[l.id]=l,configuration.lines[r.id]=r,configuration.animations[s.id]=s,await svgElement(configuration.defs[l.id],t),await svgElement(configuration.lines[r.id],t),await svgElement(configuration.animations[s.id],t),showConfigBar(r.id,"use");else console.debug("Restore Obj: ",s),t=!!configuration.elements.hasOwnProperty(e),configuration.elements[e]=s,await svgElement(configuration.elements[e],t,!1,(function(){showConfigBar(e,s.type)}))}},{text:translateWord("value_cancel"),class:"input_button red",click:function(){$(this).dialog("close")}}]})})),$(".form_label").removeClass("form_label").addClass("form_label")}function parseColorString(e){if(!e)return;const t=(new Option).style;return t.background=e.trim().replace(/.+?(?=(linear-gradient|radial-gradient))|[;]/gi,""),t.background}function generateStyleProperty(e,t,o,a=!1,n="url"){if(!isNaN(o))return o;const i=parseColorString(o);if(i){if(!o.includes("gradient"))return i;return addGradientToSVG(e,t,generateSVGGradient(e,t,i),a),"url"==n?`url(#gradient_${e}_${t})`:i}return o}function hideConfigBar(){$(".all_elements").removeClass("faded_out active_element"),$("#config_bar").removeClass("show"),$(".elm_config").off().val(""),$("#tab1_config").prop("checked",!0),$("#elm_select").val(""),$(".ui-dialog").remove()}function closeEditorContainer(e){$("#loading").fadeOut(600),$(`#${e}Container`).animate({opacity:0,top:"45%"},{duration:600,queue:!1,complete:function(){$(this).hide(),"stateExplorer"==e&&($(".state").removeClass("active"),$(".state").children(".type").removeClass("file-selected"),$(".sub").hide(),$(".type.folderOpen").removeClass("folderOpen").addClass("folderClosed"),$(".stateExplorerFilter").val("").trigger("keyup")),"frame"==e&&$("#overlay_frame").remove()}}),$(`#${e}`).scrollTop(0)}function iconHandler(e,t,o=!1){let a=$("<symbol />");$.each($("#"+e).prop("attributes"),(function(){a.attr(this.name,this.value)}));let n=t.split("?");if(n[1]){t=n[0];const e=new URLSearchParams(n[1]);a.attr({"data-icon":t,"data-flip":e.get("flip"),"data-rotate":e.get("rotate")})}else a.attr({"data-icon":t,"data-flip":configuration.elements[e].flip,"data-rotate":configuration.elements[e].rotate});$("#"+e).data("icon")==t&&1!=o||$("#"+e).replaceWith(a)}function shadowHandler(e){const t=e.replace(/[\#rgba(,.) ]/g,""),o=document.getElementById("placeholder_filter");if(!document.getElementById(`shadow_${t}`)){let a=document.createElementNS("http://www.w3.org/2000/svg","filter");a.setAttribute("id",`shadow_${t}`),a.setAttribute("filterUnits","userSpaceOnUse");let n=document.createElementNS("http://www.w3.org/2000/svg","feDropShadow");n.setAttribute("dx",0),n.setAttribute("dy",3),n.setAttribute("stdDeviation",3),n.setAttribute("flood-color",e),a.appendChild(n),o.appendChild(a)}return`shadow_${t}`}function gradientForStraightLine(e,t){const o=configuration.defs[t.replace("#","")];o&&!o.d.includes("A")&&$(`#gradient_${e}_stroke`).attr("gradientUnits","userSpaceOnUse")}async function svgElement(e,t=!1,o=!1,a){let n=e.shadow?`filter: drop-shadow(0px 3px 3px ${e.shadow});`:"";if(e.shadow&&appProperties.isApple){n=`filter: url(#${shadowHandler(e.shadow)});`}let i=`all_elements added_elements ${e.css_general||""}`;displayMode?(e.url||e.action&&"none"!=e.action)&&(i+=" action_element"):i+=" draggable";const s=generateStyleProperty(e.id,"stroke",e.color,!1,"url")||"none",r=generateStyleProperty(e.id,"fill",e.fill,!1,"url")||"none";switch(e.type){case"rect":let a=document.createElementNS("http://www.w3.org/2000/svg","rect");if(a.setAttribute("x",e.pos_x),a.setAttribute("y",e.pos_y),a.setAttribute("width",e.width),a.setAttribute("height",e.height),a.setAttribute("rx",e.rx),a.setAttribute("class",i+" type_rect connector"),a.setAttribute("id",e.id),a.setAttribute("style",`stroke: ${s}; stroke-width:${e.stroke}px; fill:${r}; ${n}`),o)return a;t?$("#"+e.id).replaceWith(a):$(a).appendToWithIndex($("#placeholder_elements"),e.position);break;case"circle":let l=document.createElementNS("http://www.w3.org/2000/svg","circle");if(l.setAttribute("cx",e.pos_x),l.setAttribute("cy",e.pos_y),l.setAttribute("r",e.radius),l.setAttribute("class",i+" type_circle connector"),l.setAttribute("id",e.id),l.setAttribute("style",`stroke:${s}; stroke-width:${e.stroke}px; fill:${r}; ${n}`),o)return l;t?$("#"+e.id).replaceWith(l):$(l).appendToWithIndex($("#placeholder_elements"),e.position);break;case"text":let c=document.createElementNS("http://www.w3.org/2000/svg","text");const d=e.degree&&!appProperties.isApple?` transform-box: fill-box; transform: rotate(${e.degree}deg);`:"";if(c.setAttribute("x",e.pos_x),c.setAttribute("y",e.pos_y),c.setAttribute("id",e.id),c.setAttribute("dominant-baseline","central"),c.setAttribute("style",`stroke:${s}; fill:${r}; font-family:${e.font_family}; text-anchor:${e.align}; transform-origin:50% 50%; font-size:${e.font_size}px; ${d} ${n}`),appProperties.isApple&&e.degree&&c.setAttribute("transform",`rotate(${e.degree}, ${e.pos_x}, ${e.pos_y})`),"datasource"==e.subType){let t=-1!=e.source?Number(0).toFixed(e.decimal_places):e.text;c.setAttribute("class",i+" type_datasource"),"own_text"==e.source_display&&(t=e.text),c.innerHTML=`<tspan id='${e.id}_prepend'>${generateMultiLineText(e.id+"_prepend",e.prepend,e.pos_x)}</tspan><tspan id='${e.id}_value'>${generateMultiLineText(e.id+"_value",t,e.pos_x)}</tspan><tspan id='${e.id}_append'>${generateMultiLineText(e.id+"_append",e.append,e.pos_x)}</tspan><tspan id='${e.id}_unit'> ${generateMultiLineText(e.id+"_unit",e.unit,e.pos_x)}</tspan>`}else c.setAttribute("class",i+" type_text"),e.enable_clock?(c.innerHTML=userClock(e.clock,e.id,!0),displayMode&&(userClock(e.clock,e.id),console.log("[Config] Activating UserClock for "+e.id))):c.innerHTML=generateMultiLineText(e.id,e.text,e.pos_x);t?$("#"+e.id).replaceWith(c):$(c).appendToWithIndex($("#placeholder_text"),e.position);break;case"svg":case"icon":let u=document.createElementNS("http://www.w3.org/2000/svg","symbol");"svg"==e.subType?(u=document.createElementNS("http://www.w3.org/2000/svg","svg"),u.setAttribute("class",i+" type_svg"),u.setAttribute("viewBox",e.viewBox||`0 0 ${e.width} ${e.height}`),u.innerHTML=e.svg_content):(u.setAttribute("class",i+" type_icon iconify"),u.setAttribute("data-icon",e.icon),u.setAttribute("data-width",e.width),u.setAttribute("data-height",e.height),u.setAttribute("data-rotate",e.rotate||0),u.setAttribute("data-flip",e.flip||"")),u.setAttribute("x",e.pos_x),u.setAttribute("y",e.pos_y),u.setAttribute("id",e.id),u.setAttribute("width",e.width),u.setAttribute("height",e.height),u.setAttribute("style",`color: ${s}; ${n}`),s.includes("gradient")&&u.setAttribute("style",`fill: ${s}; ${n}`),"svg"==e.subType?t?$("#"+e.id).replaceWith(u):$(u).appendToWithIndex($("#placeholder_elements"),e.position):t?$("#"+e.id).replaceWith(u):$(u).appendToWithIndex($("#placeholder_icons"),e.position);break;case"image":const g=await receiveImage(e.href);let p=document.createElementNS("http://www.w3.org/2000/svg","image");p.setAttribute("class",i+" type_image"),p.setAttribute("x",e.pos_x),p.setAttribute("y",e.pos_y),p.setAttribute("id",e.id),p.setAttribute("preserveAspectRatio",e.preserveAspectRatio),p.setAttribute("width",e.width),p.setAttribute("height",e.height),p.setAttribute("href",g),p.setAttribute("style",`${n} ${"#"==g?"display: none;":""}`),t?$("#"+e.id).replaceWith(p):$(p).appendToWithIndex($("#placeholder_elements"),e.position);break;case"foreignObject":let f=document.createElementNS("http://www.w3.org/2000/svg","foreignObject");f.setAttribute("class",i+" type_fObj"),f.setAttribute("x",e.pos_x),f.setAttribute("y",e.pos_y),f.setAttribute("id",e.id),f.setAttribute("width",e.width),f.setAttribute("height",e.height),f.setAttribute("style",`color: ${e.color}; ${n}`),f.innerHTML=e.fObj_content,t?$("#"+e.id).replaceWith(f):$(f).appendToWithIndex($("#placeholder_elements"),e.position);break;case"def":let h=document.createElementNS("http://www.w3.org/2000/svg","path");h.setAttribute("id",e.id),h.setAttribute("class","type_def"),h.setAttribute("d",e.d),t?$("#"+e.id).replaceWith(h):$(h).appendTo("#placeholder_defs");break;case"line":i="line type_line all_elements",displayMode?(e.url||e.action&&"none"!=e.action)&&(i+=" action_element"):i+=" line_cfg";const m=configuration.animations[e.id.replace("line","anim")].active_only&&displayMode?"none":"inline";let _=document.createElementNS("http://www.w3.org/2000/svg","use");_.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",e.href),_.setAttribute("id",e.id),_.setAttribute("class",i),_.setAttribute("style",`stroke:${s}; display:${m}; ${n}`),gradientForStraightLine(e.id,e.href),t?$("#"+e.id).replaceWith(_):$(_).appendTo("#placeholder_lines"),configuration.basic.enable_line_animation&&displayMode&&"inline"==m&&animatePath(e.id);break;case"animation":i=`type_animation all_elements anim_element ${e.css_general||""}`,i+=1==configuration.basic.enable_animation?" animation animation_cfg":" animation no_animation";let b=document.createElementNS("http://www.w3.org/2000/svg","use");b.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",e.href),b.setAttribute("id",e.id),b.setAttribute("class",i),b.setAttribute("style",`stroke:${s};`),gradientForStraightLine(e.id,e.href),t?$("#"+e.id).replaceWith(b):$(b).appendTo("#placeholder_animations")}"function"==typeof a&&a(e.id,e.type)}function getMaxID(){return Object.keys(configuration.elements).length>0?Math.max(...Object.keys(configuration.elements).map((e=>e)))+1:0}function getRandomInt(e){return Math.floor(Math.random()*e)}function getRandomRGBA(){var e=Math.round,t=Math.random;return"rgba("+e(255*t())+","+e(255*t())+","+e(255*t())+",1)"}function addDataSourceRow(e,t=!1){let o=$(`<tr class="highlight-green" data-source="${configuration.datasources[e].source}" data-alias="${configuration.datasources[e].alias}" data-id="${e}" data-factor="${configuration.datasources[e].factor}"><td>${configuration.datasources[e].alias}</td><td>${configuration.datasources[e].source}</td><td>${configuration.datasources[e].factor}</td><td><button class='all_datasource ds_buttons btn-update'><span class='iconify' data-height='24' data-icon='mdi:check'>Update</span></button><button class='all_datasource ds_buttons btn-cancel'><span class='iconify red_icon' data-height='24' data-icon='mdi:close'>Cancel</span></button><button class='all_datasource ds_buttons btn-edit'><span class='iconify' data-height='24' data-icon='mdi:pencil'>Edit</span></button><button class='all_datasource ds_buttons btn-delete'><span class='iconify red_icon' data-height='24' data-icon='mdi:delete'>Delete</span></button></td></tr>`);if(t){let t=$("#datasource-table th").eq(0).children(".sort_icon").is(":not(:empty)")?0:1,a=$(`#datasource-table tr td:nth-child(${t+1})`).map((function(){return $(this).text().toLowerCase()})).get(),n=$("#datasource-table th").eq(t).prop("asc"),i=0===t?configuration.datasources[e].alias.toLowerCase():configuration.datasources[e].source.toLowerCase();a.push(i);let s=a.sort();!1===n&&(s=s.reverse());let r=s.indexOf(i);$("#datasource-table tbody tr").length>r?$(`#datasource-table tbody tr:nth-child(${r+1})`).before(o.hide()):$("#datasource-table tbody").append(o.hide()),o.fadeIn(2e3)}else $("#datasource-table tbody").append(o);setTimeout((()=>{$(o).removeClass("highlight-green")}),4e3),$("#ds_tmp_line").remove()}function checkDuplicateDatasource(e){return Object.keys(configuration.datasources).find((t=>configuration.datasources[t].source.toLowerCase()===e.toLowerCase()))}function getdataSourceCellValue(e,t){return $(e).children("td").eq(t).text()}function dataSourceComparer(e){return function(t,o){var a=getdataSourceCellValue(t,e),n=getdataSourceCellValue(o,e);return $.isNumeric(a)&&$.isNumeric(n)?a-n:a.toString().localeCompare(n)}}function loadAdditionalJSFile(e){var t=document.createElement("script");t.type="text/javascript",t.src=e,t.onload=function(){console.log("[Config] Loaded additional file: "+e)},t.onerror=function(){console.log("[Config] Failed to load additional file: "+e)},document.body.appendChild(t)}function loadAdditionalCSSFile(e){if("false"!=e&&""!=e){let t=document.createElement("link");t.rel="stylesheet",t.href=`style/${e}.css`,t.onload=function(){console.log(`[Config] Loaded theme: ${e}`)},document.head.appendChild(t)}}function generateMultiLineText(e,t,o){let a="";if(t)if(isNaN(t))if(t.includes("<br>")||t.includes("\n")){let n;t.includes("<br>")&&(n=t.split("<br>")),t.includes("\n")&&(n=t.split("\n")),n.length>0&&((e.toString().includes("append")||e.toString().includes("unit")||e.toString().includes("prepend"))&&(a+=`<tspan id="${e}_line_tmp" x="${o}" dy="1em"></tspan>`),n.forEach((function(t,n){t&&(a+=`<tspan id="${e}_line_${n}" x="${o}" dy="1em">${t}</tspan>`)})))}else a=` <tspan id="${e}_line_0">${t}</tspan >`;else a=` <tspan id="${e}_line_0">${t}</tspan >`;return a}async function saveWorkspace(){return new Promise(((e,t)=>{socket.emit("sendTo",appProperties.namespace,"_saveConfiguration",configuration,(function(o){o&&o.error?(console.log("An error occured, while saving the backup. The following error was provided: ",o.error),t("")):(console.log(o.data),getBackups("backup_list"),e(configuration))}))}))}function getBackups(e){socket.emit("sendTo",appProperties.namespace,"_getBackups",{},(function(t){if(t&&t.error)console.log("An error occured, while receiving the backups. The following error was provided: ",t.error);else{let o;t.data.sort(((e,t)=>-1*e.localeCompare(t))),$("#"+e).empty().append(new Option(translateWord("opt_please_choose"),"-1")),t.data.length>0?t.data.forEach((t=>{let a=new Date(parseInt(t)).toLocaleString("de-DE",{hour:"numeric",minute:"numeric",day:"2-digit",month:"2-digit",year:"numeric",second:"2-digit",hour12:!1});o=new Option(a,t),$("#"+e).append(o)})):($("#"+e).empty(),o=new Option(translateWord("opt_no_backups"),-1),$("#"+e).append(o))}}))}async function duplicateItems(e,t=!1){if(e.length>0){globalConfigChanged=!0;let o=[];for(let a=0;a<e.length;a++){const n=getMaxID();let i=JSON.parse(JSON.stringify(configuration.elements[e[a]]));i.id=n,i.pos_x=configuration.basic.width<parseInt(i.pos_x)+(i.width||2*i.radius)+15?parseInt(i.pos_x)-15:parseInt(i.pos_x)+15,i.pos_y=parseInt(i.pos_y)+15,configuration.elements[n]=i,saveUndoStep("add",i,""),1==e.length?svgElement(configuration.elements[n],!1,!1,(function(e,o){appProperties.isMobile||(showConfigBar(e,o),t&&successMessage(translateWord("succ_msg_duplicate")),globalMoving=[n])})):await svgElement(configuration.elements[n],!1,!1,(function(e,t){o.push(e)}))}if($(".draggable").removeClass("draggable-multi dragging"),o.length>0){globalMoving=o,t&&successMessage(translateWord("succ_msg_duplicate")),hideConfigBar();for(let e=0;e<o.length;e++)$(`#${o[e]}`).addClass("draggable-multi")}}}function saveUndoStep(e,t,o){globalRedoStack=[],$("#edit_redo").addClass("not_active"),globalUndoStack.push({action:e,oldProps:t,newProps:o}),$("#edit_undo").removeClass("not_active")}function undoStep(){if(globalUndoStack.length>0){hideConfigBar(),$(".draggable-multi").removeClass("draggable-multi");const e=globalUndoStack.pop();switch(globalRedoStack.push(e),$("#edit_redo").removeClass("not_active"),e.action){case"add":e.oldProps.id&&(delete configuration.elements[e.oldProps.id],$(`#${e.oldProps.id}`).remove()),3==Object.keys(e.oldProps).length&&(delete configuration.defs[e.oldProps.def.id],delete configuration.lines[e.oldProps.line.id],delete configuration.animations[e.oldProps.animation.id],$(`#${e.oldProps.def.id}, #${e.oldProps.line.id}, #${e.oldProps.animation.id}`).remove());break;case"move":moveSVGElement(e.oldProps,{x:e.oldProps.x,y:e.oldProps.y}),$("#placeholder_coordinate_desc").children().fadeOut("fast",(function(){$(this).remove()}));break;case"delete":e.oldProps.id&&(configuration.elements[e.oldProps.id]=e.oldProps,svgElement(e.oldProps)),3==Object.keys(e.oldProps).length&&(configuration.defs[e.oldProps.def.id]=e.oldProps.def,configuration.lines[e.oldProps.line.id]=e.oldProps.line,configuration.animations[e.oldProps.animation.id]=e.oldProps.animation,svgElement(configuration.defs[e.oldProps.def.id]),svgElement(configuration.lines[e.oldProps.line.id]),svgElement(configuration.animations[e.oldProps.animation.id]))}console.debug("Undo requested. Performing:",e.action),0===globalUndoStack.length&&$("#edit_undo").addClass("not_active")}}function redoStep(){if(globalRedoStack.length>0){hideConfigBar(),$(".draggable-multi").removeClass("draggable-multi");const e=globalRedoStack.pop();switch(globalUndoStack.push(e),$("#edit_undo").removeClass("not_active"),e.action){case"add":e.oldProps.id&&(configuration.elements[e.oldProps.id]=e.oldProps,svgElement(e.oldProps)),3==Object.keys(e.oldProps).length&&(configuration.defs[e.oldProps.def.id]=e.oldProps.def,configuration.lines[e.oldProps.line.id]=e.oldProps.line,configuration.animations[e.oldProps.animation.id]=e.oldProps.animation,svgElement(configuration.defs[e.oldProps.def.id]),svgElement(configuration.lines[e.oldProps.line.id]),svgElement(configuration.animations[e.oldProps.animation.id]));break;case"move":moveSVGElement(e.newProps,{x:e.newProps.x,y:e.newProps.y});break;case"delete":e.oldProps.id&&(delete configuration.elements[e.oldProps.id],$(`#${e.oldProps.id}`).remove()),3==Object.keys(e.oldProps).length&&(delete configuration.defs[e.oldProps.def.id],delete configuration.lines[e.oldProps.line.id],delete configuration.animations[e.oldProps.animation.id],$(`#${e.oldProps.def.id}, #${e.oldProps.line.id}, #${e.oldProps.animation.id}`).remove())}console.debug("Redo requested. Performing:",e.action),0===globalRedoStack.length&&$("#edit_redo").addClass("not_active")}}function generateSVGGradient(e,t,o,a=!1){function n(e){return e.map((e=>{let t=document.createElementNS("http://www.w3.org/2000/svg","stop");const o=e[1].replace("px","");return t.setAttribute("offset",o),t.setAttribute("data-defaultOffset",o),t.setAttribute("stop-color",e[0]),t}))}try{const i=function(e){let t=/.*gradient\s*\(((?:\([^)]*\)|[^)(]*)*)\)/.exec(e);const o=/#[0-9a-fA-F]{3,6}|(rgb|rgba|hsl|hsla) ?\([ 0-9.%,]+?\)|([Tt]ransparent|[Aa]lice[Bb]lue|[Aa]ntique[Ww]hite|[Aa]qua(marine)?|[Aa]zure|[Bb]eige|[Bb]isque|[Bb]lack|[Bb]lanched[Aa]lmond|[Bb]lue([Vv]iolet)?|[Bb]rown|[Bb]urly[Ww]ood|[Cc]adet[Bb]lue|[Cc]hartreuse|[Cc]hocolate|[Cc]oral|[Cc]ornflower[Bb]lue|[Cc]ornsilk|[Cc]rimson|[Cc]yan|[Dd]ark([Bb]lue|[Cc]yan|[Gg]olden[Rr]od|[Gg]ray|[Gg]rey|[Gg]reen|[Kk]haki|[Mm]agenta|[Oo]live[Gg]reen|[Oo]range|[Oo]rchid|[Rr]ed|[Ss]almon|[Ss]ea[Gg]reen|[Ss]late[Bb]lue|[Ss]late[Gg]ray|[Ss]late[Gg]rey|[Tt]urquoise|[Vv]iolet)?|[Dd]eep([Pp]ink|[Ss]ky[Bb]lue)?|[Dd]im([Gg]ray|[Gg]rey)?|[Dd]odger[Bb]lue|[Ff]ire[Bb]rick|[Ff]loral[Ww]hite|[Ff]orest[Gg]reen|[Ff]uchsia|[Gg]ainsboro|[Gg]host[Ww]hite|[Gg]old(en[Rr]od)?|[Gg]ray|[Gg]rey|[Gg]reen([Yy]ellow)?|[Hh]oney[Dd]ew|[Hh]ot[Pp]ink|[Ii]ndian[Rr]ed|[Ii]ndigo|[Ii]vory|[Kk]haki|[Ll]avender([Bb]lush)?|[Ll]awn[Gg]reen|[Ll]emon[Cc]hiffon|[Ll]ight([Bb]lue|[Cc]oral|[Cc]yan|[Gg]olden[Rr]od[Yy]ellow|[Gg]ray|[Gg]rey|[Gg]reen|[Pp]ink|[Ss]almon|[Ss]ea[Gg]reen|[Ss]ky[Bb]lue|[Ss]late[Gg]ray|[Ss]late[Gg]rey|[Ss]teel[Bb]lue|[Yy]ellow)?|[Ll]ime([Gg]reen)?|[Ll]inen|[Mm]agenta|[Mm]aroon|[Mm]edium([Aa]qua[Mm]arine|[Bb]lue|[Oo]rchid|[Pp]urple|[Ss]ea[Gg]reen|[Ss]late[Bb]lue|[Ss]pring[Gg]reen|[Tt]urquoise|[Vv]iolet[Rr]ed)?|[Mm]idnight[Bb]lue|[Mm]int[Cc]ream|[Mm]isty[Rr]ose|[Mm]occasin|[Nn]avajo[Ww]hite|[Nn]avy|[Oo]ld[Ll]ace|[Oo]live([Dd]rab)?|[Oo]range([Rr]ed)?|[Oo]rchid|[Pp]ale[Gg]olden[Rr]od|[Pp]ale([Gg]reen|[Tt]urquoise|[Vv]iolet[Rr]ed)?|[Pp]apaya[Ww]hip|[Pp]each[Pp]uff|[Pp]eru|[Pp]ink|[Pp]lum|[Pp]owder[Bb]lue|[Pp]urple|[Rr]ebecca[Pp]urple|[Rr]ed|[Rr]osy[Bb]rown|[Rr]oyal[Bb]lue|[Ss]addle[Bb]rown|[Ss]almon|[Ss]andy[Bb]rown|[Ss]ea([Gg]reen|[Ss]hell)?|[Ss]ienna|[Ss]ilver|[Ss]ky[Bb]lue|[Ss]late([Bb]lue|[Gg]ray|[Gg]rey)?|[Ss]now|[Ss]pring[Gg]reen|[Ss]teel[Bb]lue|[Tt]an|[Tt]eal|[Tt]histle|[Tt]omato|[Tt]urquoise|[Vv]iolet|[Ww]heat|[Ww]hite([Ss]moke)?|[Yy]ellow([Gg]reen)?)/,a=new RegExp(o.source,"g"),n=/(?:[+-]?\d*\.?\d+)(?:%|[a-z]+)?/g,i=new RegExp(`(${o.source})|${/((?:\d*\.)?\d+(px|%|em|deg|turn|rad|grad)?)/.source}`,"g");let s="N/A";const r=/(deg|turn|rad|grad)/g,l=/(to (left( top| bottom)|right( top| bottom)|top( right| left)?|bottom( right| left)?)?)/g,c=/(ellipse|circle)/g,d=/(farthest-(corner|side)?|closest-(corner|side)?)/g,u=e.match(/((repeating-)?conic-gradient|(repeating-)?linear-gradient|(repeating-)?radial-gradient)/g)[0],g=u.includes("conic");t=t[1].match(/(?:[^)(,]+|\([^)(]+\))+/g);for(let e=0;e<t.length;e++)t[e]=t[e].trim();const p=function(){return!!t[0].match(a)},f=p();p()||(s=t[0],t.shift());const h=function(e){return e.match(/rad/)?parseFloat(e)*(180/Math.PI):e.match(/turn/)?360*parseFloat(e):e.match(/grad/)?parseFloat(e)/400*360:e},m=g?"deg":"%",_=`0${m}`,b=g?"360deg":"100%";let $=[];for(let e=0;e<t.length;e++){const o=t[e].match(i);3===o.length?($.push(`${o[0]} ${o[1]}`),$.push(`${o[0]} ${o[2]}`)):$.push(t[e])}let y=[];for(let e=0;e<$.length;e++){const t=$[e].match(i),o=t[0],a=t[1];y[e]=a?[o,g?`${h(a)}deg`:a]:[o,0===e?_:e===$.length-1?b:null]}const v=[];let w=!1;for(let e=0;e<y.length;e++){const t=!y[e][1];t&&!w&&(v.push([e]),w=!0),!t&&w&&(v[v.length-1].push(e-1),w=!1)}for(let e=0;e<v.length;e++){const t=v[e][0],o=v[e][1],a=parseFloat(y[t-1][1]),n=o-t+2,i=(parseFloat(y[o+1][1])-a)/n;let s=a;for(let e=0;e<n;e++){s+=i;const o=+s.toFixed(2);y[t+e][1]=`${o}${m}`}}return{type:u,stops:y,gradientDefinition:s,firstParameterIsColor:f,position:function(e){let t,o,a=e,n=null;if(a.match(/(at)/g)){a=a.slice(a.indexOf("at"),a.length),a=a.replace("at ","");const e=a.split(" ");if(4===e.length)t="left"===e[0]?e[1]:`calc(100% - ${e[1]})`,o="top"===e[2]?e[3]:`calc(100% - ${e[3]})`;else if(1===e.length||2===e.length)switch(a){case"center":case"center center":t="50%",o="50%";break;case"right top":case"top right":t="100%",o="0%";break;case"left top":case"top left":t="0%",o="0%";break;case"right bottom":case"bottom right":t="100%",o="100%";break;case"left bottom":case"bottom left":t="0%",o="100%";break;case"top":case"center top":case"top center":t="50%",o="0%";break;case"left":case"center left":case"left center":t="0%",o="50%";break;case"right":case"center right":case"right center":t="100%",o="50%";break;case"bottom":case"center bottom":case"bottom center":t="50%",o="100%";break;default:n=a.split(" "),t=n[0],o=n[1]||"50%"}}else t="50%",o="50%";return{x:t,y:o}}(s),linearAngle:function(e){let t=0;if(!u.match(/(repeating-)?linear-gradient/))return t;if(e.match(r))t=parseInt(e,10);else switch(function(){const t=e.match(l);return t&&t[0]}()){case"to top":default:t=0;break;case"to bottom":t=180;break;case"to left":t=270;break;case"to right":t=90;break;case"to right top":case"to top right":t=45;break;case"to left top":case"to top left":t=315;break;case"to right bottom":case"to bottom right":t=135;break;case"to left bottom":case"to bottom left":t=225}return t}(s),shape:function(e){const t=e.match(c);return t?t[0]:"ellipse"}(s),size:function(e){if(!u.match(/(repeating-)?radial-gradient/))return"farthest-corner";if(e.match(/(at)/g)){if((e=(e=(e=e.split("at")[0]).replace(/ellipse |circle /g,"")).trim()).match(/ /g))return e.split(" ");if(e.match(n))return e;if(e.match(d))return e.match(d)[0]}else{if((e=(e=e.replace(/ellipse |circle /g,"")).trim()).match(/ /g))return e.split(" ");if(e.match(n))return e;if(e.match(d))return e.match(d)[0]}return"farthest-corner"}(s),conicAngle:function(e){let t=0;return e.match(/from (.*?) at/)?t=h(e.match(/from (.*?) at/)[1]):e.match(/from/)&&(t=h(e.match(/from (.*)/)[1])),t}(s)}}(o);if(a)return n(i.stops);if("linear-gradient"===i.type)return function(e,t,o,a){const i=o.linearAngle*(Math.PI/180)-Math.PI,s={x:(50+50*Math.sin(i)).toFixed(2),y:(50-50*Math.cos(i)).toFixed(2)},r={x:(50+50*Math.sin(i+Math.PI)).toFixed(2),y:(50-50*Math.cos(i+Math.PI)).toFixed(2)};let l=document.createElementNS("http://www.w3.org/2000/svg","linearGradient");return l.setAttribute("id",`gradient_${e}_${t}`),l.setAttribute("data-type","gradient"),l.setAttribute("data-colorHash",a),l.setAttribute("data-value",0),l.setAttribute("x1",`${s.x}%`),l.setAttribute("y1",`${s.y}%`),l.setAttribute("x2",`${r.x}%`),l.setAttribute("y2",`${r.y}%`),l.append(...n(o.stops)),l}(e,t,i,hashCode(o));if("radial-gradient"===i.type)return function(e,t,o,a){if(!o.position)return;let i=document.createElementNS("http://www.w3.org/2000/svg","radialGradient");return i.setAttribute("id",`gradient_${e}_${t}`),i.setAttribute("data-type","gradient"),i.setAttribute("data-colorHash",a),i.setAttribute("data-value",0),i.setAttribute("cx",o.position.x),i.setAttribute("cy",o.position.y),i.setAttribute("r","50%"),i.append(...n(o.stops)),i}(e,t,i,hashCode(o))}catch(t){return void console.error(`Failed to parse the provided CSS-String for ID ${e}! Error: ${t}`)}}function addGradientToSVG(e,t,o,a=!1){const n=document.getElementById("placeholder_gradients"),i=document.getElementById(`gradient_${e}_${t}`);i?i.replaceWith(o):n.appendChild(o),a&&$(`#${e}`).css(t,`url(#gradient_${e}_${t})`)}function generateSingleGradient(e,t,o,a=90){let n=document.createElementNS("http://www.w3.org/2000/svg","linearGradient");n.setAttribute("id",`gradient_${e}_fill`),n.setAttribute("data-type","color"),n.setAttribute("data-colorHash",hashCode(t)),n.setAttribute("gradientTransform","rotate("+a+",0.5,0.5)");let i=document.createElementNS("http://www.w3.org/2000/svg","stop");i.setAttribute("id",`gradient_${e}_fill_transparent`),i.setAttribute("class","stopAnimation"),i.setAttribute("offset","0%"),i.setAttribute("stop-color","none"==o||""==o?"transparent":o),n.appendChild(i),i=document.createElementNS("http://www.w3.org/2000/svg","stop"),i.setAttribute("id",`gradient_${e}_color_transparent`),i.setAttribute("stop-color","none"==t||""==t?"transparent":t),n.appendChild(i),$(n).appendTo("#placeholder_gradients"),$("#"+e).css("fill",`url(#gradient_${e}_fill)`)}function updateSingleGradient(e,t,o,a){const n=document.getElementById(`gradient_${e}_fill_transparent`),i=n?n.getAttribute("offset").replace("%",""):null;try{let n;switch(a){case"percent":n=100-t;break;case"value":if(!o)throw new Error(`No max value for element with ID ${e} declared!`);n=100-t/o*100}n=parseInt(n),null!=n&&i!=n&&animateGradient(`gradient_${e}_fill_transparent`,i,n)}catch(t){console.error("Error while updating gradient for ID: "+e+"! "+t)}}async function actionForElement(e,t,o=""){const a="string"==typeof e&&e.includes("line_")?configuration.lines[e]:configuration.elements[e];if("none"!=a.action&&!o||"click"==o){let i=a.source_action>=0?a.source_action:a.source;if(configuration.datasources.hasOwnProperty(i)){let s=configuration.datasources[i].source;switch(a.action){case"default":case"none":break;case"toggle":socket.emit("getState",s,(function(e,t){e?console.log("An error occured, while getting the state. The following error was provided: "+e):"boolean"==typeof t.val?socket.emit("setState",s,{val:!t.val,ack:!1},(function(e,t){e?console.log("An error occured, while toggling the state. The following error was provided: "+e):console.debug("The state was set successfully!")})):(failedMessage(translateWord("failmsg_action_not_bool")),console.error("This state can not be toggled, because it is not a boolean state!"))}));break;case"on":socket.emit("setState",s,{val:!0,ack:!1},(function(e){e?console.log(`An error occured, while setting the state. The following error was provided: ${e}`):console.debug("The state was set successfully!")}));break;case"off":socket.emit("setState",s,{val:!1,ack:!1},(function(e){e?console.log(`An error occured, while setting the state. The following error was provided: ${e}`):console.debug("The state was set successfully!")}));break;case"change":function r(e){socket.emit("setState",s,{val:e,ack:!1},(function(t,o){console.debug(`${e} submitted to host for state ${o}`),t?console.log(`An error occured, while setting the state. The following error was provided: ${t}`):console.debug("The state was set successfully!")}))}let l=await new Promise(((e,t)=>{socket.emit("getState",s,((o,a)=>{a?(console.debug(`(ClickAction) Pulled value from ioBroker: ${a.val}`),e(a.val)):t(`(ClickAction) The state could not be received! Please check the associated Datasource: ${s}`)}))})).catch((e=>{console.error(e),failedMessage(sprintf(systemDictionary.failmsg_invalid_ds[systemLang],s))})),c=[{text:translateWord("value_set_value"),class:"input_button",click:function(){r($("#shortcuts\\.action\\.value").val()),$(this).dialog("close")}},{text:translateWord("value_cancel"),class:"input_button red",click:function(){$(this).dialog("close")}}];if(a.hasOwnProperty("action_display_freeform")?($("#shortcuts\\.action").toggle(a.action_display_freeform),a.action_display_freeform||c.shift()):($("#shortcuts\\.action").toggle(!1),c.shift()),$("#shortcuts\\.action\\.value").attr("type",a.action_type).val(l),a.hasOwnProperty("shortcuts"))if(Object.keys(a.shortcuts).length>0){let d,u;const g=Object.entries(a.shortcuts).sort((([,e],[,t])=>e.alias.toLowerCase()<t.alias.toLowerCase()?-1:e.alias.toLowerCase()>t.alias.toLowerCase()?1:0));switch(a.action_display){default:case"button":for(var n of(d=$(`<span class="shortcuts_additional_buttons">${translateWord("shortcuts_additional_buttons")}</span>`),u=$("<div id='shortcuts_additional_buttons' />"),g)){let h;switch(typeof l){case"undefined":h="shortcut_inactive";break;case"string":h=n[1].value.toLowerCase()==l.toLowerCase()?"":"shortcut_inactive";break;case"number":h=parseInt(n[1].value)==l?"":"shortcut_inactive";break;case"boolean":h=n[1].value.toString().toLowerCase()==l.toString().toLowerCase()?"":"shortcut_inactive"}u.append($(`<input type="button" title="${n[1].alias}" class="input_button autowidth shortcuts.button ${h}" data-value="${n[1].value}" value="${n[1].alias||n[1].value}">`))}d.append(u);break;case"select":d=$('<div class="contentBox" />'),u=$('<div class="form_div select" />'),u.append($(`<label for="shortcuts.value.select" class="form_label">${translateWord("shortcuts_additional_buttons")}</label>`));let p=$('<div class="select-option" />'),f=$('<select class="input_select" id="shortcuts.select" />');for(var n of g)f.append($("<option>",{value:n[1].value,text:n[1].alias||n[1].value,selected:n[1].value.toString().toLowerCase()==l.toString().toLowerCase()}));p.append(f),u.append(p),d.append(u)}$("#shortcuts\\.elements").show().html(d)}else a.action_display_freeform?$("#shortcuts\\.elements").hide().html(""):($("#shortcuts\\.elements").show().text(translateWord("shortcuts_no_shortcuts")),addErrorToLog({id:e,for:translateWord("opt_action_change"),error:translateWord("shortcuts_no_shortcuts"),function:"-"}));else console.log("No Shortcuts defined"),a.action_display_freeform?$("#shortcuts\\.elements").hide().html(""):($("#shortcuts\\.elements").show().text(translateWord("shortcuts_no_shortcuts")),addErrorToLog({id:e,for:translateWord("opt_action_change"),error:translateWord("shortcuts_no_shortcuts"),function:"-"}));null!=l&&$("#action_change_value").dialog({title:configuration.datasources[i].alias||configuration.datasources[i].source,position:{my:"right-5 bottom-10",at:"left top",of:t,collision:"fit"},resizable:!1,height:"auto",maxHeight:"100%",width:"auto",modal:!0,classes:jQueryDialog.classes,open:jQueryDialog.open,beforeClose:jQueryDialog.beforeClose,create:function(){$("#shortcuts\\.action").is(":visible")&&$("#shortcuts\\.action\\.value").off().on("keypress",(function(e){13==(e.keyCode?e.keyCode:e.which)&&$(".ui-dialog-buttonset").children().first().click()})),$(".shortcuts\\.button").length>0&&$(".shortcuts\\.button").off().on("click",(function(){$("#shortcuts\\.action\\.value").val($(this).data("value")),$("#shortcuts\\.action").is(":hidden")&&(r($(this).data("value")),$(".ui-dialog-buttonset").children().first().click()),$(".shortcuts\\.button").addClass("shortcut_inactive"),$(this).toggleClass("shortcut_inactive"),$(this).blur()})),$("#shortcuts\\.select").length>0&&$("#shortcuts\\.select").off().on("change",(function(){$("#shortcuts\\.action\\.value").val($(this).val()),$("#shortcuts\\.action").is(":hidden")&&(r($(this).val()),$(".ui-dialog-buttonset").children().first().click())}))},buttons:c})}}else addErrorToLog({id:e,for:translateWord(`opt_action_${a.action}`),error:translateWord("failmsg_preview_element_no_ds"),function:"-"})}if(("none"==a.action||!a.hasOwnProperty("action"))&&""!=a.url&&null!=a.url&&!o||"url"==o){function m(e){try{return new URL(e),!0}catch(e){return!1}}if(m(a.url)){switch(a.frame){case"_blank":case"_self":if(o&&"_self"==a.frame)failedMessage(translateWord("failmsg_opening_frame_preview"));else{const y=a.frame_height&&a.frame_width?`width=${a.frame_width}, height=${a.frame_height}`:"",v=window.open(a.url,a.frame,y);v?v.focus():failedMessage(translateWord("failmsg_opening_frame"))}break;default:displayLoading(translateWord("msg_loading_url"));let _=null;const b=$(`<iframe id="overlay_frame" src="${a.url}" class="framed scrollbar" sandbox="allow-forms allow-modals allow-popups allow-same-origin allow-scripts allow-top-navigation" />`).on("load",(function(){""!=$(this).attr("src")&&($(".loading-spinner, #loading_text").fadeOut("fast"),$("#frameContainer").css({height:"",width:""}),(a.frame_height||a.frame_width)&&$("#frameContainer").css({height:a.frame_height||"",width:a.frame_width||""}),$("#frameContainer").css({top:"45%",opacity:0,display:"block"}),$("#frameContainer").animate({opacity:1,top:"50%"},{duration:600,queue:!1}),$(this).off()),clearTimeout(_)}));$("#frameContainer").append(b),_=setTimeout((()=>{closeEditorContainer("frame"),failedMessage(translateWord("failmsg_loading_url"))}),5e3)}console.log(`URL found! Opening: ${a.url} Frame: ${a.frame}`)}else failedMessage(sprintf(systemDictionary.failmsg_invalid_url[systemLang],a.url))}}function wrapUploadImage(e,t){let o=$(`<div class="imgContainer" id="${e}" />`),a=$('<div class="uploads_img" />'),n=$('<div class="uploads_name" />').attr("title",e).text(e),i=$('<div class="uploads_btn" />'),s=$("<input />",{type:"button",class:"input_button delete_upload",value:translateWord("value_delete"),"data-lang-value":"value_delete"});i.append(s);var r=$("<img />",{src:appProperties.socketURL+appProperties.namespace+"/userFiles"+t+e,alt:e});return a.append(r),o.append(a,n,i),o}function getUserImages(){if(!globalGalleryLoaded){console.debug("[Config] Loading User-Gallery!");var e=new XMLHttpRequest;e.onload=function(){if(200==this.status){let t=JSON.parse(e.responseText),o=t.files,a=t.path;if($("#userImages_placeholder").show(),o.length>0){$("#userImages_dummy").hide(),$("#userImages div.imgContainer").remove(),globalUserImages=o,console.debug(`[Config] Using ${a} for userFiles!`);for(let e=0;e<o.length;e++)$("#userImages").append(wrapUploadImage(o[e],a))}else $("#userImages_dummy").fadeIn("fast");$("#userImages_placeholder").fadeOut("fast"),globalGalleryLoaded=!0}},e.open("GET",appProperties.socketURL+appProperties.namespace+"/?serve=getUploads",!0),e.send()}}function deleteUserImage(e){var t=new XMLHttpRequest;t.onload=function(){if(200==this.status){let o=JSON.parse(t.responseText);if(o&&o.error)console.log("An error occured, while deleting the upload! The following error was provided: ",res.error);else{let t=o.filename.replaceAll(".","\\.");$(`#${t}`).fadeOut("fast",(function(){$(this).remove(),0==$("#userImages div").length&&$("#userImages_dummy").fadeIn("fast"),globalUserImages=globalUserImages.filter((t=>t!=e))}))}}},t.open("GET",appProperties.socketURL+appProperties.namespace+`/?serve=deleteUpload&image=${e}`,!0),t.send()}function startIconObserver(){new MutationObserver((e=>{const t=[];for(const{addedNodes:o}of e)for(const e of o)if(e.tagName){if("svg"!=e.tagName.toLowerCase())if(e.classList.contains("iconify"))t.push(e);else if(e.firstElementChild){const o=e.getElementsByClassName("iconify");o.length>0&&t.push(...o)}"svg"==e.tagName.toLowerCase()&&""!=e.style.fill&&e.style.fill.includes("gradient")&&e.firstChild.setAttribute("fill",e.style.fill)}configuration.basic.enable_icon_proxy&&t.map((e=>{const t=e.getAttribute("data-icon");t&&loadIconViaProxy(t,$(e))}))})).observe(document.body,{childList:!0,subtree:!0})}function loadIconViaProxy(e,t){if(e&&"svg"!=$(t).prop("tagName"))try{var o=new XMLHttpRequest;let a=`icon=${e}&width=${t.data("width")||24}&height=${t.data("height")||24}&flip=${t.data("flip")||""}&rotate=${t.data("rotate")||0}`;o.open("GET",appProperties.socketURL+appProperties.namespace+`/?serve=icon&${a}`,!0),o.onload=function(){if(200==this.status){let e=JSON.parse(o.responseText),a=$($.parseHTML(e.icon)),n=t.attr("title");"Icon not found!"==e.message&&(n=e.message),a.data(t.data()).attr({id:t.attr("id"),class:t.attr("class"),style:t.attr("style"),title:n,x:t.attr("x"),y:t.attr("y"),width:t.attr("width"),height:t.attr("height")}).data("icon_status",e.status),t.replaceWith(a)}},o.onerror=function(){console.error(`Error while receiving icon "${e}" Error: ${this.status}`)},o.send()}catch(e){console.log("Error! "+e)}}function makeDraggable(e){let t,o={},a="tab1",n=!1,i=!1,s=!1,r=!1,l=!1,c=e.target,d=null,u=!1,g=null,p=!1;function f(e){u=!0,e.preventDefault(),1===globalMoving.length?$("#ctx_export").removeClass("not_active"):$("#ctx_export").addClass("not_active"),globalMoving.length>0?$("#ctx_copy, #ctx_delete").removeClass("not_active"):$("#ctx_copy, #ctx_delete").addClass("not_active"),globalClipboard.length>0?$("#ctx_paste").removeClass("not_active"):$("#ctx_paste").addClass("not_active");const t=document.body;e.touches&&(e=e.touches[0]);const o={top:t.clientHeight<e.pageY+126?e.pageY-126:e.pageY,left:t.clientWidth<e.pageX+200?e.pageX-200:e.pageX};$("#mouse_contextmenu").css({top:o.top,left:o.left+15,display:"block"})}function h(){$("#svg_config_div").removeClass("noscroll")}function m(){$(".draggable-multi").removeClass("draggable-multi dragging"),$(".line").removeClass("not_selectable")}function _(){o={},d=null,g=null,l=!1,n=!1}function b(){(g||globalMoving.length>0)&&$("#dialog_section").prop("title",translateWord("lbl_delete_elements")).html(translateWord("msg_delete_elements")).dialog({resizable:!1,height:"auto",maxHeight:"100%",classes:jQueryDialog.classes,width:400,modal:!0,open:jQueryDialog.open,beforeClose:jQueryDialog.beforeClose,buttons:[{text:translateWord("value_delete"),class:"input_button red",click:async function(){globalConfigChanged=!0;let e=0,t=globalMoving.length;if(g){let e={animation:g.replace("line","anim"),def:g.replace("line_",""),line:g};saveUndoStep("delete",{animation:configuration.animations[e.animation],def:configuration.defs[e.def],line:configuration.lines[e.line]},""),delete configuration.defs[e.def],delete configuration.lines[e.line],delete configuration.animations[e.animation],$(`#${e.def}, #${e.line}, #${e.animation}`).remove(),g=null,t=0}else{[...globalMoving].forEach((t=>{if(0==lineConnection(t).length){saveUndoStep("delete",configuration.elements[t],""),delete configuration.elements[t],$(`#${t}`).remove();const o=globalMoving.indexOf(t);o>-1&&globalMoving.splice(o,1),e++}}))}e===t?successMessage(translateWord("succ_msg_selection_delete")):failedMessage(translateWord("failmsg_selection_delete")),$("#placeholder_coordinate_desc").empty(),$(this).dialog("close"),hideConfigBar()}},{text:translateWord("value_cancel"),class:"input_button",click:function(){$(this).dialog("close")}}]})}function y(e,t,o,a){$(`#coord_desc_div_${e.id}`).text(t);const n=Number(e.stroke)/2;let i="circle"==e.type||"text"==e.type?o-Number(e.width)/2-n:o-n,s="circle"==e.type||"text"==e.type?a-Number(e.coordHeight)/2-n:a-n;const r=$(`#coord_desc_div_${e.id}`),l=Math.round(r.width())+12,c=Math.round(r.height())+20;i=i+l>configuration.basic.width?i-l:Math.max(i,4),s=s<c?s+e.coordHeight+2*n+10:s-32,$(`#coord_desc_${e.id}`).attr({x:i,y:s})}function v(e){if(globalMoving.forEach((t=>{o[t]=getElementCoords(t,e)})),configuration.basic.enable_show_coordinates){const e=o[globalMoving[0]];if(0==$(`#coord_desc_${e.id}`).length){$("#placeholder_coordinate_desc").empty();let t=document.createElementNS("http://www.w3.org/2000/svg","foreignObject");t.setAttribute("id",`coord_desc_${e.id}`),t.setAttribute("width",1),t.setAttribute("height",1),t.setAttribute("class","coord_desc"),t.innerHTML=`<div id='coord_desc_div_${e.id}'>X: ${e.x} | Y: ${e.y}</div>`,$(t).hide().fadeIn("fast").appendTo("#placeholder_coordinate_desc")}y(e,`X: ${e.x} | Y: ${e.y}`,e.x,e.y)}n=!1}function w(e){if(u=2===e.button,u||$("#mouse_contextmenu").fadeOut(200),appProperties.isMobile&&(p||(p=setTimeout(f,500,e))),a=2===e.detail?"tab2":"tab1",$(e.target).hasClass("line")&&l?(e.stopPropagation(),failedMessage(translateWord("failmsg_drag_no_line"))):g=$(e.target).attr("id"),$(e.target).closest(".draggable-multi").length>0&&(1==$(e.target).closest(".draggable-multi").length&&(d=globalMoving[0]),v(e)),$(e.target).closest(".draggable:not(.draggable-multi)").attr("id")){const t=Number($(e.target).closest(".draggable").attr("id"));if(t>=0){if(l){$(".active_element").addClass("draggable-multi"),hideConfigBar();const e=globalMoving.indexOf(t);e>-1?(globalMoving.splice(e,1),$(`#${t}`).removeClass("draggable-multi")):(globalMoving.push(t),$(`#${t}`).addClass("draggable-multi"))}else _(),m(),globalMoving=[t],v(e),$(`#${t}`).addClass("draggable-multi");d=t}}e.target.classList.contains("lasso")&&(s=!0,t=getMousePosition(e),_(),m(),$("#placeholder_coordinate_desc").children().fadeOut("fast",(function(){$(this).remove()})),globalMoving=[],hideConfigBar())}function x(e){if(u)return;appProperties.isMobile&&($("#mouse_contextmenu").hide(),p&&(clearTimeout(p),p=!1));const a=getMousePosition(e);if(s)if(i=!0,r)$("#lasso_rect").attr({x:Math.min(t.x,a.x),y:Math.min(t.y,a.y),width:Math.abs(t.x-a.x),height:Math.abs(t.y-a.y)});else{let e=document.createElementNS("http://www.w3.org/2000/svg","rect");e.setAttribute("x",t.x),e.setAttribute("y",t.y),e.setAttribute("width",0),e.setAttribute("height",0),e.setAttribute("rx",0),e.setAttribute("id","lasso_rect"),e.setAttribute("style","stroke: var(--primary); stroke-width: 2px; fill: var(--secondary); fill-opacity:0.2;"),$(e).appendTo("#placeholder_lasso"),r=!0}else{if($("#align_elements").is(":visible"))return;if(l&&86==e.keyCode&&(globalClipboard.length>0?($(".draggable-multi").removeClass("draggable-multi"),duplicateItems(globalClipboard,!1)):failedMessage(translateWord("failmsg_no_elements_clipboard"))),46==e.keyCode&&b(),globalMoving.length>0&&(l?e.target.classList.contains("line")&&$(e.target).addClass("not_selectable"):$(e.target).removeClass("not_selectable"),e.keyCode&&(38==e.keyCode||40==e.keyCode||39==e.keyCode||37==e.keyCode?0==Object.keys(o).length&&v(e):l&&67==e.keyCode&&(Object.keys(o).some((e=>e.includes("line_")))?failedMessage(translateWord("failmsg_duplicate_no_line")):(successMessage(sprintf(systemDictionary.msg_copy_elements[systemLang],globalMoving.length)),globalClipboard=globalMoving,o={}))),Object.keys(o).length>0)){for(var c of($("#svg_config_div").addClass("noscroll"),$(".anim_element").removeClass("animation_cfg").addClass("no_animation"),hideConfigBar(),Object.keys(o))){let t=o[c],n=configuration.elements[c],i={x:a.x-t.offset.x,y:a.y-t.offset.y},s={x:"-",y:"-"};if($("#"+t.id).addClass("dragging"),isNaN(i.x)){let t={x:0,y:0};switch(e.keyCode){case 39:t.x=1;break;case 37:t.x=-1;break;case 38:t.y=-1;break;case 40:t.y=1}i={x:n.pos_x+t.x,y:n.pos_y+t.y}}const r=checkElementBounds(t,i);r.x&&(s.x=i.x),r.y&&(s.y=i.y),moveSVGElement(t,i),configuration.basic.enable_show_coordinates&&y(t,`X: ${s.x} | Y: ${s.y}`,i.x,i.y)}n=!0,globalConfigChanged=!0}}}function k(e){appProperties.isMobile&&p&&(clearTimeout(p),p=!1);let c=null;if(null!=s){if(s=null,r=!1,t=null,i){let e={start_x:parseInt($("#lasso_rect").attr("x")),start_y:parseInt($("#lasso_rect").attr("y")),end_x:parseInt($("#lasso_rect").attr("x"))+parseInt($("#lasso_rect").attr("width")),end_y:parseInt($("#lasso_rect").attr("y"))+parseInt($("#lasso_rect").attr("height"))};$(".added_elements").each((function(){let t=getElementCoords(this.id);const o="circle"==t.type||"text"==t.type?t.width/2:t.width,a="circle"==t.type||"text"==t.type?t.height/2:t.height;t.x>=e.start_x&&t.x+o<=e.end_x&&t.y>=e.start_y&&t.y+a<=e.end_y&&(globalMoving.push(t.id),$(`#${t.id}`).addClass("draggable-multi"))})),h()}i=!1,$("#lasso_rect").remove()}if(Object.keys(o).length>0){if(n)for(const e of Object.keys(o))saveUndoStep("move",o[e],getElementCoords(e));$(".added_elements").removeClass("dragging"),h(),c=setTimeout((function(){$("#basic\\.enable_animation").prop("checked")&&$(".anim_element").removeClass("no_animation").addClass("animation_cfg")}),1e3),!1!==n||u||(l||d>=0&&showConfigBar(d,o[d].type,a),$(".added_elements").removeClass("draggable-multi")),_()}}c.addEventListener("mousedown",w),c.addEventListener("touchstart",w,!1),c.addEventListener("mousemove",x),c.addEventListener("touchmove",x),c.addEventListener("mouseup",k),c.addEventListener("touchend",k,!1),c.addEventListener("touchleave",k,!1),c.addEventListener("touchcancel",k,!1),c.addEventListener("keydown",x),c.addEventListener("keyup",(function(){if(h(),Object.keys(o).length>0&&n){for(const e of Object.keys(o))saveUndoStep("move",o[e],getElementCoords(e));o={}}})),c.addEventListener("contextmenu",f),$("#ctx_copy").click((function(e){e.preventDefault(),globalMoving.length>0&&(successMessage(sprintf(systemDictionary.msg_copy_elements[systemLang],globalMoving.length)),globalClipboard=globalMoving,o={},$("#mouse_contextmenu").fadeOut(200))})),$("#ctx_paste").click((function(e){e.preventDefault(),globalClipboard.length>0&&($(".draggable-multi").removeClass("draggable-multi"),duplicateItems(globalClipboard,!1),$("#mouse_contextmenu").fadeOut(200))})),$("#ctx_delete").click((function(e){e.preventDefault(),b(),$("#mouse_contextmenu").fadeOut(200)})),$("#ctx_export").click((function(e){e.preventDefault(),globalMoving.length>0&&(exportElement(globalMoving[0]),$("#mouse_contextmenu").fadeOut(200))})),$("#svg_config").on("keydown",(function(e){17!=e.keyCode&&91!=e.keyCode||(l=!0,e.preventDefault())})).keyup((function(e){17!=e.keyCode&&91!=e.keyCode||(l=!1)}))}socket.on("connect",(async function(){let e=(new Date).toLocaleString();console.log(`[Socket] connected at ${e}`);const t=["system.config",`system.adapter.${appProperties.namespace}`];await new Promise((e=>{socket.emit("getObjects",t,(function(o,a){if(!o&&a){systemLang=a[t[0]].common.language,console.debug(`[Language] Got it from ioBroker! Translating Texts to locale ${systemLang}!`),multiselect_options.texts={placeholder:translateWord("opt_please_choose"),search:translateWord("lbl_search"),selectedOptions:" "+translateWord("lbl_selected")},translateAll(),e();const o=a[t[1]].common.version;console.log(`[Version] Installed Version: ${o}`),displayMode?console.log("[Version] Github Version: Skipping as in Display-Mode"):$.getJSON(appProperties.updateCheck).done((function(e){let t=e[0].name.replace("v","");console.log(`[Version] Github Version: ${t}`),$("#runningVersion").html(`<a href='https://github.com/SKB-CGN/ioBroker.energiefluss-erweitert/releases/tag/v${o}' target='_blank'>Version: ${o}</a>`),$("#newVersion").html(""+(t>o?"("+translateWord("lbl_new_version")+")":"")).click((function(){window.open(appProperties.updateURL)}))}))}}))})),loadConfig()})),$((function(){if($(document).tooltip({position:{my:"center bottom-5",at:"center top",collision:"flipfit"},content:function(){return $(this).attr("title")}}),$(".tt-element").click((function(){$(".ui-tooltip").fadeOut()})),!displayMode){let e;$(".basic_config").on("input change",(async function(t){globalConfigChanged=!0;let o=this.id.replace(".slider","").split(".");if(o.length>0){let a;switch(o.length){case 2:switch(this.id){default:configuration[o[0]][o[1]]="checkbox"==this.type?this.checked:"number"==this.type?Number(this.value):this.value;break;case"basic.enable_ds_autocomplete":this.checked?$("#elm_ds_source").autocomplete(dataSourceAutocompleteOptions):$("#elm_ds_source").hasClass("ui-autocomplete-input")&&$("#elm_ds_source").autocomplete("destroy"),configuration[o[0]][o[1]]=this.checked;break;case"basic.enable_show_coordinates":this.checked||$("#placeholder_coordinate_desc").empty(),configuration[o[0]][o[1]]=this.checked;break;case"basic.enable_animation":this.checked?$(".anim_element").removeClass("no_animation").addClass("animation_cfg"):$(".anim_element").removeClass("animation_cfg").addClass("no_animation"),configuration[o[0]][o[1]]=this.checked;break;case"basic.enable_grid":this.checked?$("#help_grid").fadeIn("fast"):$("#help_grid").fadeOut("fast"),configuration[o[0]][o[1]]=this.checked;break;case"basic.enable_area_catch":this.checked?$(".tabbed").removeClass("no_catch"):$(".tabbed").addClass("no_catch"),configuration[o[0]][o[1]]=this.checked;break;case"basic.height.slider":case"basic.width.slider":$(`#${o[0]}\\.${o[1]}`).val(this.value).trigger("input");break;case"basic.height":case"basic.width":checkSVGSize("basic.height"==this.id?configuration.basic.width:this.value,"basic.height"==this.id?this.value:configuration.basic.height)[o[1]]?(a=parseInt(this.value),$(`#${o[0]}\\.${o[1]}\\.slider`).val(a),clearTimeout(e)):(a="basic.height"==this.id?configuration.basic.height:configuration.basic.width,"input"==t.type&&(clearTimeout(e),e=setTimeout((()=>{$(`#${o[0]}\\.${o[1]}\\.slider`).val(a),$(`#${o[0]}\\.${o[1]}`).val(a)}),500))),configuration[o[0]][o[1]]=a,resizeSVG()}console.debug("Basic Config changed: "+this.id,"checkbox"==this.type?this.checked:this.value,configuration[o[0]]);break;case 3:switch(this.type){case"text":a=this.value;break;case"select-multiple":a=$(this).val().map((e=>parseInt(e)));break;case"select-one":a=isNaN(this.value)?this.value:parseInt(this.value);break;case"number":a=parseInt(this.value);break;case"checkbox":a=this.checked}configuration[o[0]][o[1]][o[2]]=a,console.debug("Detailed Config changed: "+this.id,a,configuration[o[0]][o[1]]),configuration.calculation.battery.dod>=0&&null!=configuration.calculation.battery.dod&&configuration.calculation.battery.capacity>=0&&null!=configuration.calculation.battery.capacity&&configuration.calculation.battery.percent>=0&&null!=configuration.calculation.battery.percent&&configuration.calculation.battery.charge>=0&&null!=configuration.calculation.battery.charge&&configuration.calculation.battery.discharge>=0&&null!=configuration.calculation.battery.discharge?(console.debug("[Calculation] Battery configured!"),$("#calculation\\.battery\\.status").addClass("green").removeClass("red").text(translateWord("txt_calculation_succ"))):$("#calculation\\.battery\\.status").addClass("red").removeClass("green").text(translateWord("txt_calculation_fail")),0!=configuration.calculation.consumption.production.indexOf(-1)&&configuration.calculation.consumption.production.length>0&&configuration.calculation.consumption.gridFeed>=0&&null!=configuration.calculation.consumption.gridFeed&&configuration.calculation.consumption.gridConsume>=0&&null!=configuration.calculation.consumption.gridConsume?(console.debug("[Calculation] Consumption configured!"),$("#calculation\\.consumption\\.status").addClass("green").removeClass("red").text(translateWord("txt_calculation_succ"))):$("#calculation\\.consumption\\.status").addClass("red").removeClass("green").text(translateWord("txt_calculation_fail"))}}})),$("input:radio[name=tabs]").click((function(){$(".ui-dialog").remove(),hideConfigBar(),$("#align_elements").click(),$("#connect_elements").hasClass("red")&&$("#connect_elements").click(),$("#mouse_contextmenu").hide(),$("#placeholder_coordinate_desc").empty(),"tab5"==this.id&&getUserImages()})),$("#show_hide_config").click((function(){$("#container_menu").toggleClass("hidden")})),$(".line_preview").on("change input",(function(){globalConfigChanged=!0,linePreview(this.id)})),$(".align_elements").click((function(e){$(".added_elements").removeClass("alignable").addClass("draggable"),$(".all_elements, .align_elements").removeClass("faded_out");let t,o=$(this).closest("a").data("align");$(".align_elements").not(this).addClass("faded_out"),$("#align_elements").show(),$("#connect_elements").prop("disabled",!0),hideConfigBar(),$(".line:not(.preview)").addClass("not_selectable faded_out"),$(".added_elements").removeClass("draggable draggable-multi faded_out").addClass("alignable"),$("#ex_how_align").html(translateWord("ex_align_ref")),$(".alignable").off().click((function(e){if(null==t){const o=$(e.target).closest(".alignable").attr("id");$("#"+o).addClass("active_element not_selectable").off(),t=getElementCoords(o),$("#ex_how_align").html(translateWord("ex_align_ref_selected"))}else{globalConfigChanged=!0;const a=$(e.target).closest(".alignable").attr("id"),n=getElementCoords(a),i={x:t.cx?t.cx-t.width/2:t.x,y:t.cy?t.cy-t.height/2:t.y},s=(e,t,o)=>{switch(o){case"center":return e.cx>0?i.x+t.width/2:i.x+t.width/2-e.width/2;case"left":return e.cx>0?i.x-t.stroke/2+e.width/2+e.stroke/2:i.x-t.stroke/2+e.stroke/2;case"right":return e.cx>0?i.x+t.width+t.stroke/2-e.width/2-e.stroke/2:i.x+t.stroke/2+t.width-e.width-e.stroke/2;case"vcenter":case"top":case"bottom":return e.cx>0?e.cx:e.x;default:return 0}},r=(e,t,o)=>{switch(o){case"center":case"left":case"right":return e.cy>0?e.cy:e.y;case"vcenter":return e.cy>0?i.y+t.height/2:i.y+t.height/2-e.height/2;case"top":return e.cy>0?i.y-t.stroke/2+e.height/2+e.stroke/2:i.y-t.stroke/2+e.stroke/2;case"bottom":return e.cy>0?i.y+t.height+t.stroke/2-e.height/2-e.stroke/2:i.y+t.stroke/2+t.height-e.height-e.stroke/2;default:return 0}};moveSVGElement(n,{center:{x:s(n,t,"center"),y:r(n,t,"center")},left:{x:s(n,t,"left"),y:r(n,t,"left")},right:{x:s(n,t,"right"),y:r(n,t,"right")},vcenter:{x:s(n,t,"vcenter"),y:r(n,t,"vcenter")},top:{x:s(n,t,"top"),y:r(n,t,"top")},bottom:{x:s(n,t,"bottom"),y:r(n,t,"bottom")}}[o])?saveUndoStep("move",n,getElementCoords(a)):failedMessage(translateWord("failmsg_align_impossible"))}}))})),$("#align_elements").click((function(){$("#ex_how_align").html(translateWord("ex_align")),$("#connect_elements").prop("disabled",!1),$("#align_elements").hide(),$(".alignable").off(),$(".added_elements").removeClass("alignable").addClass("draggable"),$(".all_elements, .align_elements").removeClass("faded_out not_selectable active_element"),$(".line").removeClass("not_selectable")})),$("#import_element").click((function(){let e;const t=getRandomInt(55);$(`<div id="tmpDiv_${t}" class="tmpDiv" />`).appendTo("body"),$(`#tmpDiv_${t}`).prop("title",translateWord("lbl_import_element")).dialog({resizable:!1,height:520,width:400,maxHeight:"100%",modal:!0,classes:jQueryDialog.classes,open:jQueryDialog.open,beforeClose:jQueryDialog.beforeClose,close:function(){e.destroy()},create:function(){e=ace.edit(`tmpDiv_${t}`),e.session.setMode("ace/mode/json"),e.setTheme("ace/theme/"+appProperties.aceEditorTheme[appProperties.colorScheme]),$(".ui-dialog-buttonset").children().first().prop("disabled",!0),e.getSession().off("changeAnnotation"),e.getSession().on("changeAnnotation",(function(){let t=e.getSession().getAnnotations().filter((e=>"error"==e.type));$(".ui-dialog-buttonset").children().first().prop("disabled",t.length>0||0==e.getSession().getValue().length)}))},buttons:[{text:translateWord("btn_import"),class:"input_button",click:function(){globalConfigChanged=!0;const t=JSON.parse(e.getValue());let o=0,a=0;const n=getMaxID();configuration.basic.enable_area_catch?(o=$("#svg_config_div").scrollLeft(),a=$("#svg_config_div").scrollTop()):(o=$(document).scrollLeft(),a=$(document).scrollTop()),t.id=n,t.source=-1,t.pos_x=o+(parseInt(configuration.basic.elm.pos_x)||50)+getRandomInt(50),t.pos_y=a+(parseInt(configuration.basic.elm.pos_y)||50)+getRandomInt(50),saveUndoStep("add",t,""),configuration.elements[n]=t,svgElement(configuration.elements[n]),console.debug(`Importing new Element with: ${t}`),$(this).dialog("close")}},{text:translateWord("value_cancel"),class:"input_button red",click:function(){$(this).dialog("close")}}]})})),$("#duplicate_elements").click((function(){let e=new Array;0==$(".draggable-multi").length?$("#elm_select").val()?$("#elm_select").val().includes("line")?failedMessage(translateWord("failmsg_duplicate_no_line")):e.push($("#elm_select").val()):failedMessage(translateWord("failmsg_duplicate_no_elm")):e=$(".draggable-multi").map((function(){return this.id})).get(),duplicateItems(e,!0)})),$(".undo_redo_element").click((function(){switch($(this).closest("a").attr("id")){case"edit_undo":undoStep();break;case"edit_redo":redoStep()}})),$(".add_element").click((function(e){globalConfigChanged=!0;let t=0,o=0;const a=getMaxID();configuration.basic.enable_area_catch?(t=$("#svg_config_div").scrollLeft(),o=$("#svg_config_div").scrollTop()):(t=$(document).scrollLeft(),o=$(document).scrollTop());let n={position:0,id:a,pos_x:t+(parseInt(configuration.basic.elm.pos_x)||50)+getRandomInt(50),pos_y:o+(parseInt(configuration.basic.elm.pos_y)||50)+getRandomInt(50),source:-1,threshold:0,frame:"_overlay",url:"",action:"none",shadow:""};switch($(this).closest("a").data("id")){case"circle":n.radius=parseInt(configuration.basic.circle.radius)||50,n.type="circle",n.fill_value="",n.fill_type=-1,n.fill_direction=90,n.fill_max=0,n.border_value="",n.border_type=-1,n.border_direction="cw",n.border_style="round",n.border_max=0,n.border_reverse_value="",n.border_reverse=!1,n.border_start=180,n.color=configuration.basic.elm.color||getRandomRGBA(),n.fill=configuration.basic.elm.fill||"none",n.stroke=parseInt(configuration.basic.elm.stroke_width)||5;break;case"rect":n.type="rect",n.width=parseInt(configuration.basic.rect.width)||100,n.height=parseInt(configuration.basic.rect.height)||100,n.rx=parseInt(configuration.basic.rect.corners)||10,n.fill_value="",n.fill_type=-1,n.fill_direction=90,n.fill_max=0,n.border_value="",n.border_type=-1,n.border_direction="cw",n.border_style="round",n.border_max=0,n.border_reverse_value="",n.border_reverse=!1,n.border_start=180,n.color=configuration.basic.elm.color||getRandomRGBA(),n.fill=configuration.basic.elm.fill||"none",n.stroke=parseInt(configuration.basic.elm.stroke_width)||5;break;case"text":n.type="text",n.text="Text",n.align=configuration.basic.font.align||"middle",n.color=configuration.basic.font.color||"none",n.fill=configuration.basic.font.fill||getRandomRGBA(),n.font_size=configuration.basic.font.size||20,n.font_family=configuration.basic.font.family||'"Arial", sans-serif';break;case"datasource":n.calculate_kw="none",n.counter_animation=!1,n.convert=!1,n.decimal_places=0,n.type="text",n.align=configuration.basic.font.align||"middle",n.subType="datasource",n.text="Datasource "+a,n.source_option=-1,n.source_option_lc=-1,n.source_display="auto",n.linebreak=0,n.subtract=[],n.add=[],n.unit="",n.action="none",n.source_action=-1,n.color=configuration.basic.font.color||"none",n.fill=configuration.basic.font.fill||getRandomRGBA(),n.font_size=configuration.basic.font.size||20,n.font_family=configuration.basic.font.family||'"Arial", sans-serif',n.pos_x+=25;break;case"icon":n.type="icon",n.width=24,n.height=24,n.icon="mdi:omega",n.color=configuration.basic.icon.color||getRandomRGBA();break;case"svg":n.svg_content='<path d="M19.564 4.42a.75.75 0 0 0-1.378-.59l-6.75 15.75a.75.75 0 0 0 1.378.59l6.75-15.75ZM7 18.5a1.5 1.5 0 1 1-3 0a1.5 1.5 0 0 1 3 0Z" fill="currentColor"></path>',n.subType="svg",n.type="svg",n.width=24,n.height=24,n.viewBox="0 0 24 24";break;case"image":n.href="img/tmp_img.png",n.width=100,n.height=100,n.type="image",n.preserveAspectRatio="xMidYMid meet";break;case"fObj":n.fObj_content=`<div xmlns="http://www.w3.org/1999/xhtml">${translateWord("help_fObj_tmp")}</div>`,n.width=60,n.height=100,n.type="foreignObject",n.color=getRandomRGBA()}configuration.elements[a]=n,svgElement(n,!1),saveUndoStep("add",n,"")})),$("#config_close").click((function(){hideConfigBar(),$("#placeholder_coordinate_desc").children().fadeOut("fast",(function(){$(this).remove()}))})),$("#config_swap").click((function(){$("#config_bar").toggleClass("left right")})),$(".connect_elements").click((async function(e){await connectElements(e.target.id)})),$("#save_workspace, #save_workspace_exit").click((async function(){if(globalConfigChanged=!1,appProperties.localMode)successMessage(translateWord("succ_msg_local_output"));else{await saveWorkspace()&&(successMessage(translateWord("succ_msg_save_workspace")),"save_workspace_exit"==this.id&&window.location.replace("index.html?instance="+appProperties.instance))}aceLog.setValue(JSON.stringify(configuration,void 0,4),-1)})),$("#workspace_exit").click((function(){window.location.replace("index.html?instance="+appProperties.instance)})),$(".check_datasources").click((function(e){Object.entries(configuration.datasources).forEach((async t=>{const[o,a]=t;let n,i=$(`#datasource-table tbody tr[data-id="${o}"`);switch(e.target.id){case"check_datasources":console.debug(`Checking ${a.source}`);let e=await new Promise((e=>{socket.emit("getState",a.source,((t,o)=>{e(o)}))}));n=e?"highlight-green":"highlight-red";break;case"check_datasources_in_use":console.debug(`Checking ${o}`),n=Object.keys(checkDatasourcesInUse(o)).length>0?"highlight-green":"highlight-red"}$(i).addClass(n),setTimeout((()=>{$(i).removeClass(n)}),4e3)}))})),$("#restore_backup").click((function(){let e=$("#backup_list").val();-1!=e&&""!=e&&null!=e?$("#dialog_section").prop("title",translateWord("lbl_backup_section")).html(translateWord("msg_backup_restore")).dialog({resizable:!1,height:"auto",maxHeight:"100%",width:400,modal:!0,classes:jQueryDialog.classes,open:jQueryDialog.open,beforeClose:jQueryDialog.beforeClose,buttons:[{text:translateWord("value_save_restore"),width:"auto",class:"input_button",click:function(){$(this).dialog("close"),socket.emit("sendTo",appProperties.namespace,"_restoreBackup",{filename:e},(function(e){e&&e.error?(console.log("An error occured, while restoring the backup. The following error was provided: ",e.error),failedMessage(translateWord("failmsg_backup"))):(configuration=e.data,console.log(e.data),setLoadedConfig(),successMessage(translateWord("succ_msg_backup")))}))}},{text:translateWord("value_cancel"),class:"input_button red",click:function(){$(this).dialog("close"),failedMessage(translateWord("failmsg_backup_cancel"))}}]}):failedMessage(translateWord("failmsg_backup_no_valid"))}))}})),$(document).ready((function(e){displayMode?(document.body.addEventListener("dblclick",(()=>{const e=document.querySelector("body");document.fullscreenElement?document.exitFullscreen():e.requestFullscreen().catch((e=>{failedMessage("Your browser does not support fullscreen!")}))})),$("body").on("click",".action_element",(function(e){let t=$(this).attr("id");console.debug(`Clicked on Action Element ${t}`),actionForElement(t,e)}))):($("#drop_zone").on("dragover",(function(e){e.preventDefault(),$(this).addClass("dragFile"),$("#upload_info").text(translateWord("txt_upload_status_drop"))})),$("#drop_zone").on("dragleave",(function(e){e.preventDefault(),$(this).removeClass("dragFile"),$("#upload_info").text(translateWord("txt_upload_status_init"))})),$("#drop_zone").on("drop",(function(e){e.preventDefault(),$("#uploadFile").prop("files",e.originalEvent.dataTransfer.files).trigger("change")})),$("#uploadFile").on("change",(async function(){function e(e){return e.trim().replace(/[^a-z0-9._\-]/gi,"_").replace(/_{2,}/g,"_").toLowerCase()}function t(e){return new Promise((function(t,o){const a=new FormData;a.append("uploadFile",e);const n=new XMLHttpRequest;n.open("POST",appProperties.socketURL+appProperties.namespace+"/upload",!0),n.onload=function(){t(JSON.parse(n.responseText))},n.send(a)}))}$("#upload_progress>div").css("width","0%");let o=this.files.length,a=[],n=!1;for(const e of this.files){if(!(e.type.includes("image")&&e.size<=5242880)){n=!1;break}n=!0}if($("#file_selector").blur().prop("disabled",!0),n){$("#upload_errors").slideUp();for(const n of this.files){$("#upload_info").text(sprintf(systemDictionary.txt_upload_uploading[systemLang],Object.keys(a).length||1,o));const i=e(n.name),s=i.replaceAll(".","\\.");if($(`#${s}`).length>0)a.push({filename:i,success:!1,reason:"exists"});else{const e=await t(n);a.push({filename:e.filename,success:!0,reason:"success"}),globalUserImages.push(e.filename);let i=globalUserImages.sort().indexOf(e.filename),s=wrapUploadImage(e.filename,e.path).hide();$("#userImages_dummy").fadeOut("fast"),$("#userImages div.imgContainer").length>i?$(`#userImages div.imgContainer:nth-child(${i+1})`).before(s):$("#userImages").append(s),s.fadeIn(2e3),$("#upload_progress>div").css("width",Object.keys(a).length/o*100+"%")}appProperties.isMobile&&getUserImages()}a.find((e=>!1===e.success))?($("#upload_errors-table tbody").empty(),a.forEach((function(e){$("#upload_errors-table tbody").append(`<tr><td>${e.filename}</td><td>${translateWord("txt_upload_error_"+e.reason)}</td></tr>`)})),$("#upload_info").html(`${translateWord("txt_upload_status_error")} <a href="javascript:;" onclick="$('#upload_errors').slideToggle();"><span class="iconify" data-icon="material-symbols:error-outline" data-width="24" height="24" style="color:var(--red);"></span></a>`)):$("#upload_info").text(translateWord("txt_upload_status_success"))}else $("#upload_info").text(translateWord("txt_upload_status_tooBig"));$("#uploadFile").val(null),$("#file_selector").prop("disabled",!1),$("#drop_zone").removeClass("dragFile")})),window.addEventListener("keydown",(function(e){(e.ctrlKey||e.metaKey)&&"z"===e.key&&undoStep(),(e.ctrlKey||e.metaKey)&&"y"===e.key&&redoStep(),(e.ctrlKey||e.metaKey)&&"d"===e.key&&(e.preventDefault(),$("#duplicate_elements").click())})),$("body").on("click",".line:not(.preview,.not_selectable)",(function(e){showConfigBar(e.target.id,e.target.tagName.toLowerCase(),2===e.detail?"tab2":"tab1")})),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",(e=>{appProperties.colorScheme=e.matches?"dark":"light",console.log("Color-Scheme-changed: "+appProperties.colorScheme),aceLog.setTheme("ace/theme/"+appProperties.aceEditorTheme[appProperties.colorScheme]),aceCSS.setTheme("ace/theme/"+appProperties.aceEditorTheme[appProperties.colorScheme]),aceOverride.setTheme("ace/theme/"+appProperties.aceEditorTheme[appProperties.colorScheme])})),aceLog=ace.edit("save_output"),aceLog.session.setMode("ace/mode/json"),aceLog.setTheme("ace/theme/"+appProperties.aceEditorTheme[appProperties.colorScheme]),aceLog.setReadOnly(!0),aceOverride=ace.edit("codeEditor"),aceOverride.session.setMode("ace/mode/json"),aceOverride.setTheme("ace/theme/"+appProperties.aceEditorTheme[appProperties.colorScheme]),$(window).on("beforeunload",(function(){if(globalConfigChanged)return translateWord("leave_unsaved")})),$("body").on("click",".help",(function(){let e=translateWord($(this).data("help"));e=e.replaceAll("< /","</"),$("#help_section").html(e).dialog({resizable:!1,maxHeight:"100%",classes:jQueryDialog.classes,width:400,modal:!1,open:function(e,t){$(this).parent().focus()},close:function(){$(this).dialog("destroy")},buttons:[{text:translateWord("btn_close"),class:"input_button",click:function(){$(this).dialog("close")}}]})})),$("body").on("click",".delete_upload",(function(){deleteUserImage($(this).parent().parent().attr("id"))})),$("body").on("keyup",".userImages_filter",(function(){let e=new RegExp($(this).val().trim().toLowerCase()),t=$(this).parent().parent().siblings(".userImages").children(".imgContainer");if(t.show(),e){let o=0;t.each((function(){(this.id||$(this).data("id")).match(e)||($(this).hide(),o++)})),t.length==o?$("#userImagesBrowseDialog").is(":visible")?$("#userImagesBrowse .userImages_noResults").fadeIn("fast"):$("#userImages .userImages_noResults").fadeIn("fast"):$("#userImagesBrowseDialog").is(":visible")?$("#userImagesBrowse .userImages_noResults").hide():$("#userImages .userImages_noResults").hide(),console.log("Hidden: "+o)}})),$("#frm-addDataSource").submit((function(e){e.preventDefault();let t=$("#elm_ds_source").val(),o=$("#elm_ds_alias").val()?$("#elm_ds_alias").val():"",a=Number($("#elm_ds_factor").val()),n=checkDuplicateDatasource(t);if(n){let e=$(`#datasource-table tbody tr[data-id="${n}"`);$(".tab2").scrollTo($(".ds-flex"),1e3,0),$(".ef-table-div").animate({scrollTop:$(e).offset().top-80},{complete:function(){$(e).addClass("highlight-red")}}),setTimeout((()=>{$(e).removeClass("highlight-red")}),4e3),failedMessage(translateWord("failmsg_ds_already_exists"))}else{globalConfigChanged=!0;let e=Object.keys(configuration.datasources).length>0?Math.max(...Object.keys(configuration.datasources).map((e=>e)))+1:0;console.debug(`New ID for added datasource: ${e}`),configuration.datasources[e]={source:t,alias:o,factor:a},addDataSourceRow(e,!0),successMessage(translateWord("succ_msg_ds_created")),$(this)[0].reset(),updateDataSources()}})),$("#datasource-table").on("click",".btn-delete",(function(){let e=$(this).parents("tr"),t=checkDatasourcesInUse(e.data("id"));if(Object.keys(t).length>0){let e,a=`<div class="ef-table-div"><table class='ef-table small'><thead><tr><th>${translateWord("lbl_config_element")}</th><th>${translateWord("lbl_type")}</th><th>${translateWord("lbl_used_as")}</th></thead><tbody>`,n="";for(var o in t)n+=`<tr><td>${t[o].id}</td><td>${t[o].type}</td><td>${t[o].reason}</td></tr>`;e=`${a}${n} </tbody></table></div>`,$("#dialog_section").prop("title",translateWord("lbl_ds_delete_section")).html(`<span class='dsInUseInfoTitle'> ${translateWord("failmsg_delete_source")}</span>`).append(e).dialog({resizable:!1,maxHeight:"98%",width:"auto",modal:!0,classes:jQueryDialog.classes,beforeClose:jQueryDialog.beforeClose,open:jQueryDialog.open,close:function(){$(this).dialog("close")},buttons:[{text:translateWord("btn_close"),class:"input_button",click:function(){$(this).dialog("close")}}]})}else globalConfigChanged=!0,e.fadeOut("fast",(function(){$(this).remove(),0==$("#datasource-table tbody tr").length&&$("#datasource-table tbody").append("<tr id='ds_tmp_line' data-id='-1'><td>"+translateWord("no_ds_added")+"</td><td></td><td></td>"),delete configuration.datasources[e.data("id")]}))})),$("#datasource-table").on("click",".btn-edit",(function(){$("#frm-addDataSource :input, #frm-addDataSource a, .tabbed>input, .ds_buttons.btn-edit, .ds_buttons.btn-delete").prop("disabled",!0),$("#frm-addDataSource a, .tabbed nav label").attr("disabled",!0),$("#datasource-table .sortable .filter").removeClass("filter").addClass("no_filter");let e=$(this).parents("tr"),t=e.data("alias"),o=e.data("source"),a=e.data("factor"),n=`<div class="form_div no_margin"><input type="text" class="input_text" id="edit_ds_alias" name="edit_ds_alias" autocorrect="off" autocomplete="off" value="${t}"></div>`,i=`<div class="form_div no_margin"><input type="text" class="input_text icon_in_input_pad datasource_autocomplete" id="edit_ds_source" name="edit_ds_source" autocorrect="off" autocomplete="off" minlength="3" value="${o}" required><div class="icon_wrapper"><a class="frm-datasource icon_in_input"><span class="iconify" data-icon="mdi:database-search" data-height="24"></span></a><div class="ds_search_spinner"><span class="spinner"></span></div></div></div>`,s=`<div class="form_div no_margin"><div class="select-option"><select class="input_select elm_config" name="edit_ds_factor" id="edit_ds_factor"><option value="1">${translateWord("opt_ds_factor_1")}</option><option value="1000">${translateWord("opt_ds_factor_1000")}</option></select></div></div>`;e.find("td:eq(0)").html(n),e.find("td:eq(1)").html(i),e.find("td:eq(2)").html(s),e.find(".btn-update, .btn-cancel").show(),e.find(".btn-delete, .btn-edit").hide(),$("#edit_ds_factor").val(a),configuration.basic.enable_ds_autocomplete&&$("#edit_ds_source").autocomplete(dataSourceAutocompleteOptions)})),$("#datasource-table").on("click",".btn-cancel",(function(){$("#frm-addDataSource :input, #frm-addDataSource a, .tabbed>input, .ds_buttons.btn-edit, .ds_buttons.btn-delete").prop("disabled",!1),$("#frm-addDataSource a, .tabbed nav label").attr("disabled",!1),$("#datasource-table .sortable .no_filter").removeClass("no_filter").addClass("filter");let e=$(this).parents("tr");e.find("td:eq(0)").text(e.data("alias")),e.find("td:eq(1)").text(e.data("source")),e.find("td:eq(2)").text(e.data("factor")),e.find(".btn-edit, .btn-delete").show(),e.find(".btn-cancel, .btn-update").hide()})),$("#datasource-table").on("click",".btn-update",(function(){$("#frm-addDataSource :input, #frm-addDataSource a, .tabbed>input, .ds_buttons.btn-edit, .ds_buttons.btn-delete").prop("disabled",!1),$("#frm-addDataSource a, .tabbed nav label").attr("disabled",!1),$("#datasource-table .sortable .no_filter").removeClass("no_filter").addClass("filter");let e=$(this).parents("tr"),t=$("#edit_ds_alias").val(),o=$("#edit_ds_source").val(),a=Number($("#edit_ds_factor").val());if(o.length>=3){let n=checkDuplicateDatasource(o);null!=n&&n!=e.data("id")?($("#edit_ds_source").focus(),failedMessage(translateWord("failmsg_ds_already_exists"))):(configuration.datasources[e.data("id")]={source:o,alias:t,factor:a},console.debug(`Datasource updated: New values: ${JSON.stringify(configuration.datasources[e.data("id")])}`),$("#frm-addDataSource :input, #frm-addDataSource a").prop("disabled",!1),$("#frm-addDataSource a").attr("disabled",!1),globalConfigChanged=!0,e.find("td:eq(0)").text(t),e.find("td:eq(1)").text(o),e.find("td:eq(2)").text(a),e.data({alias:t,source:o,factor:a}),e.find(".btn-edit, .btn-delete").show(),e.find(".btn-cancel, .btn-update").hide(),updateDataSources())}else $("#edit_ds_source").focus(),failedMessage(translateWord("msg_ds_not_empty"))})),$("body").on("click",".frm-datasource",(function(){const e=new RegExp("{([^)]+)}"),t=$(this).parent("div").parent("div").children("input").attr("id");let o=configuration.basic.enable_last_id&&""==$("#"+t).val()?globalSelectedId:$("#"+t).val();if("elm_href"==t&&o.length>0){const t=o.match(e);t&&t.length>0&&(o=t[1])}$("#loading").fadeIn(600),$(".loading-spinner, #loading_text").hide(),$("#stateExplorerContainer").css({top:"45%",opacity:0,display:"block"}),$("#stateExplorerContainer").animate({opacity:1,top:"50%"},{duration:600,queue:!1,complete:function(){openStateTree("stateExplorer",o)}}),$("#select_state").off().on("click",(function(){let e=$(".state.active").parent().attr("id");"elm_href"==t?$("#"+t).val(`{${e}}`).focus().trigger("change"):$("#"+t).val(e).focus(),globalSelectedId=e,closeEditorContainer("stateExplorer"),$(".state").removeClass("active").children(".type").removeClass("file-selected")})),$("#reloadStateExplorer").off().on("click",(async function(){$("#select_state").prop("disabled",!0),$("#stateRoot").empty().remove(),$("#stateExplorer_placeholder").show(),iobObjects=await loadIobObjects(),generateStateTree(iobObjects,"stateExplorer"),$(".stateExplorerFilter").trigger("keyup")}))})),$("#datasource-table").on("click","th.filter",(function(){$(".sort_icon").html("");var e=$(this).parents("table").eq(0),t=e.find("tr:gt(0)").toArray().sort(dataSourceComparer($(this).index()));$(this).find(".sort_icon").html('<span class="iconify" data-icon="mdi:sort-alphabetical-ascending" data-height="18">'),this.asc||(t=t.reverse(),$(this).find(".sort_icon").html('<span class="iconify" data-icon="mdi:sort-alphabetical-descending" data-height="18">'));for(var o=0;o<t.length;o++)e.append(t[o]);this.asc=!this.asc})),$("#image_href_gallery").click((function(){let e=$(this).parent("div").parent("div").children("input").attr("id");$("#userImagesBrowseDialog").prop("title",translateWord("lbl_gallery")).dialog({resizable:!1,maxHeight:500,height:"auto",width:640,modal:!0,classes:jQueryDialog.classes,beforeClose:jQueryDialog.beforeClose,close:function(){$(this).dialog("close")},create:function(){let t=$("#userImages").children().clone();t.each((function(e,t){$("#userImagesBrowseFilter").val(""),$(t).hasClass("imgContainer")&&($(t).data("id",this.id).attr("id","").show(),$(t).children(".uploads_btn").children().val(translateWord("value_select")).removeClass("delete_upload").addClass("select_upload")),$(t).hasClass("userImages_noResults")&&$(t).hide()})),$("#userImagesBrowse").empty().append(t),$(".select_upload").off().on("click",(function(){let t=$(this).parent().parent().data("id");$("#"+e).val(t).trigger("change"),$(".ui-dialog-buttonset").children().first().click()}))},open:jQueryDialog.open,buttons:[{text:translateWord("btn_close"),class:"input_button",click:function(){$(this).dialog("close")}}]})})),$("body").on("click",".preview_gradient",(function(){const e=getRandomInt(55),t=$(this).parent("div").prev(".color, .style").val();if(t){const o=parseColorString(t);if(o){const t=generateSVGGradient(e,"test",o);t?($(`<div id="tmpDiv_${e}" class="tmpDiv" />`).appendTo("body"),$(`#tmpDiv_${e}`).prop("title",translateWord("title_show_gradient")).dialog({resizable:!1,width:"50%",maxHeight:"100%",modal:!0,classes:jQueryDialog.classes,open:jQueryDialog.open,beforeClose:jQueryDialog.beforeClose,create:function(){let o=document.createElementNS("http://www.w3.org/2000/svg","svg");o.setAttribute("preserveAspectRatio","none"),o.setAttribute("width","100%"),o.setAttribute("height",200);let a=document.createElementNS("http://www.w3.org/2000/svg","defs");a.appendChild(t);let n=document.createElementNS("http://www.w3.org/2000/svg","rect");n.setAttribute("x",0),n.setAttribute("y",0),n.setAttribute("width","100%"),n.setAttribute("height",200),n.setAttribute("fill",`url(#gradient_${e}_test)`),o.append(a,n),$(this).append(o)},buttons:[{text:translateWord("btn_close"),class:"input_button",click:function(){$(this).dialog("close")}}]})):failedMessage(translateWord("failmsg_parse_gradient"))}else failedMessage(translateWord("failmsg_parse_gradient"))}})))}));