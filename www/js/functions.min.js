"use strict";$.fn.countTo=function(e,t=1e3){const o=String(e).includes(".")?String(e).split(".")[1].length:0;var a=$(this),n=null;const i=parseFloat(a.text()),s=parseFloat(e);return requestAnimationFrame((function e(r){n||(n=r);var l=r-n,c=i+l/t*(s-i);l<t?(a.text(c.toFixed(o)),requestAnimationFrame(e)):a.text(s.toFixed(o))})),this},$.fn.scrollTo=function(e,t,o){return $(this).animate({scrollTop:$(this).scrollTop()-$(this).offset().top+$(e).offset().top+(o||0)},null==t?1e3:t),this},$.expr.pseudos.icontains=function(e,t,o){return e.textContent.toUpperCase().includes(o[3].toUpperCase())},$.fn.appendToWithIndex=function(e,t=0){!e instanceof jQuery&&(e=$(e));let o=e.children().last().index()||0;0===t?$(this).prependTo(e):t>o?$(this).appendTo(e):$(this).insertAfter(e.children().eq(t-1))};const jQueryDialog={open:function(){$(".ui-widget-overlay").hide().fadeIn(600),$(this).parent().focus();var e=$(this).parent(),t=parseInt(e.css("top"));e.css({top:t-60,opacity:0}),e.animate({opacity:1,top:t},{duration:600})},beforeClose:function(){$(".ui-widget-overlay").show().fadeOut(600);var e=$(this).parent();return e.animate({opacity:0,top:parseInt(e.css("top"))-60},{duration:600,queue:!1,complete:function(){$(".ui-dialog, .tmpDiv").remove()}}),!1},classes:{"ui-dialog":"no-close"}};let aceLog,aceCSS,aceOverride;const urlParams=new URLSearchParams(window.location.search);var iobPath=location.pathname,iobParts=iobPath.split("/");iobParts.splice(-3);const appProperties={instance:Number(urlParams.get("instance"))||0,lowPerformance:urlParams.get("lowPerformance")||!1,theme:urlParams.get("theme")||!1,updateCheck:"https://api.github.com/repos/SKB-CGN/ioBroker.energiefluss-erweitert/tags",updateURL:"https://github.com/SKB-CGN/ioBroker.energiefluss-erweitert/#changelog",namespace:`energiefluss-erweitert.${urlParams.get("instance")||0}`,hostname:window.location.hostname,localMode:!window.location.hostname,socketURL:window.location.hostname?"/":"https://192.168.2.19:8082/",socketPath:window.location.hostname?iobParts.join("/")+"/socket.io":"/socket.io",colorScheme:window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light",userAgent:navigator.userAgent.indexOf("Chrome")>-1?"Chrome":"Firefox",isMobile:/iPhone|iPad|iPod|Android/i.test(navigator.userAgent),aceEditorTheme:{dark:"clouds_midnight",light:"textmate"}},socket=io.connect(appProperties.socketURL,{path:appProperties.socketPath,reconnectionDelay:500,reconnectionAttempts:1/0,upgrade:!0,transports:appProperties.hostname.match(/iobroker\.pro|iobroker\.net/)?void 0:["websocket","polling"]});socket.on("reauthenticate",(function(){let e=(new Date).toLocaleString();console.log(`[Socket] reauthenticate ${e}`)})),socket.on("error",(function(e){let t=(new Date).toLocaleString();console.error(`[Socket] error: ${e} ${t}`)})),socket.on("permissionError",(function(e){let t=(new Date).toLocaleString();console.error(`[Socket] permission error: ${e} ${t}`)})),socket.on("upgrade",(function(e){let t=(new Date).toLocaleString();console.log(`[Socket] connection upgrade at ${t}`)})),socket.on("connect_error",(function(e){let t=(new Date).toLocaleString();console.error("[Socket] connect error: "+e+" "+t),console.log(`Current connection set: ${socket.io.opts.transports}`),socket.io.opts.forceNew=!0,"polling"==socket.io.opts.transports[0]?(socket.io.opts.transports=["websocket","polling"],console.log("[Socket] Connection Error. Trying websocket first!")):(socket.io.opts.transports=["polling","websocket"],console.log("[Socket] Connection Error. Trying polling first!"))})),console.debug(appProperties),console.log("[Config] Using Instance: "+appProperties.namespace);const subscribeObjID=[appProperties.namespace+".configuration",appProperties.namespace+".data","system.adapter."+appProperties.namespace+".alive"];systemLang=navigator.language||navigator.userLanguage,console.log("[Language] Detected System-Languag: "+systemLang);let globalSelectedId,globalTmpCSS,configuration={},displayMode=!1,globalConfigChanged=!1,basicConfig=!1,globalUndoStack=[],globalRedoStack=[],globalAdapterOnline=!1,globalIobObjectsLoaded=!1,globalClipboard=[],globalMoving=[];const clockIntervals={};var filename=location.pathname.substr(location.pathname.lastIndexOf("/")+1);filename.includes("index")||""==filename?displayMode=!0:(jscolor.presets.default={alphaChannel:"auto",format:"any",borderColor:"var(--primary)",borderRadius:10,controlBorderColor:"#538EA3",previewSize:28,previewPosition:"right",required:!1,backgroundColor:"var(--white)",palette:["#00b5dd","#61687a","#ffce4a","#a1d343","#c5902e","#f20e40"]},ace.require("ace/ext/language_tools"));const dataSourceAutocompleteOptions={position:{my:"left top",at:"left bottom",collision:"fit"},source:async function(e,t){globalIobObjectsLoaded||(iobObjects=await loadIobObjects());t($.ui.autocomplete.filter(iobArray,e.term).slice(0,200))},classes:{"ui-autocomplete":"select_overflow"},minLength:3,delay:500,search:function(){globalIobObjectsLoaded||$(this).siblings(".icon_wrapper").find(".ds_search_spinner").show()},response:function(){setTimeout((()=>{$(this).siblings(".icon_wrapper").find(".ds_search_spinner").hide()}),500)}};let iobObjects,iobArray=[],globalUserImages=[];const multiselect_options={columns:1,search:!0,minWidth:"250px",maxWidth:"auto",maxPlaceholderOpts:1,texts:{}};function loadIobObjects(){return console.log("iobObjects not present! Requesting!"),new Promise(((e,t)=>{let o=performance.now();socket.emit("getObjects",(function(t,a){let n=performance.now();globalIobObjectsLoaded=!0,console.log(`${Object.keys(a).length} Objects loaded in ${n-o} ms`);let i={};Object.keys(a).sort(((e,t)=>e.toLowerCase().localeCompare(t.toLowerCase()))).forEach((e=>i[e]=a[e])),iobArray=Object.keys(i).filter((e=>"state"==i[e].type)),e(i)}))}))}function sprintf(e){var t=Array.prototype.slice.call(arguments,1),o=0;return e.replace(/%s/g,(function(){return t[o++]}))}function displayLoading(e){$("#loading").fadeIn(600),$("#loading_text").html(e).show(),$(".loading-spinner").show(),$("#loading_text_error").hide()}function displayListener(){const e=(new Date).toLocaleString();socket.emit("subscribe",subscribeObjID),console.log("[Socket] subscribed to: "+subscribeObjID.toString()+" at "+e),socket.on("reconnect",(function(){console.log("[Socket] reconnected at "+e),socket.emit("subscribe",subscribeObjID),$("#loading").fadeOut("fast")})),socket.on("disconnect",(function(){console.log("[Socket] disconnected "+e),displayLoading(translateWord("msg_reconnect"))})),socket.on("stateChange",(function(t,o){setTimeout((function(){if(t==subscribeObjID[0])try{Object.keys(clockIntervals).forEach((e=>{clearTimeout(clockIntervals[e]),console.log("Cleared Clock-Timout for "+e)})),displayLoading(translateWord("msg_loading_config")),configuration=JSON.parse(o.val),setLoadedConfig(!0),console.log("Applied new configuration at "+e)}catch(e){console.log("Error while parsing Config in JSON-Object!")}if(t==subscribeObjID[1])try{refreshData(JSON.parse(o.val))}catch(e){console.log("Error while parsing Values in JSON-Object!")}if(t==subscribeObjID[2])if(0==o.val){displayLoading(sprintf(systemDictionary.msg_instance_loading[systemLang],appProperties.instance)),console.log("Adapter instance: "+appProperties.instance+" is not started! "+e),globalAdapterOnline=!1}else if(o.val!=globalAdapterOnline&&1==o.val){console.log("Adapter instance: "+appProperties.instance+" started at "+e),globalAdapterOnline=!0;let t=(Math.random()+1).toString(36).substring(7);window.location.href=`?instance=${appProperties.instance}&hash=${t}&lowPerformance=${appProperties.lowPerformance}&theme=${appProperties.theme}`}}),0)}))}function addGradient(e,t,o,a=90){t=t||"transparent",o="none"==o?"transparent":o;let n=document.createElementNS("http://www.w3.org/2000/svg","linearGradient");n.setAttribute("id","gradient_"+e),n.setAttribute("gradientTransform","rotate("+a+",0.5,0.5)");let i=document.createElementNS("http://www.w3.org/2000/svg","stop");i.setAttribute("id","gradient_transparent_"+e),i.setAttribute("offset","0%"),i.setAttribute("stop-color",o),n.appendChild(i),i=document.createElementNS("http://www.w3.org/2000/svg","stop"),i.setAttribute("id","gradient_color_"+e),i.setAttribute("stop-color",t),n.appendChild(i),$(n).appendTo("#placeholder_defs"),$("#"+e).css("fill","url(#gradient_"+e+")")}function updateGradient(e,t,o,a){try{let n;switch(a){case"percent":n=100-t;break;case"value":if(!o)throw new Error("No max value for element declared!");n=100-t/o*100}null!=n&&$("#gradient_transparent_"+e).attr("offset",n+"%")}catch(t){console.error("Error while updating gradient for ID: "+e+"! "+t)}}function addBorderFill(e,t,o,a=-90){let n=$("#"+e),i=n.attr("r"),s=Math.PI*(2*i),r=Number(n.attr("height")),l=Number(n.attr("width")),c={id:`border_${e}`};if("rect"==n.prop("tagName"))switch(s=2*n.attr("width")+2*n.attr("height"),a=Number(a)+90){case 90:case 270:if(r!=l){let e=Math.abs(r-l)/2;c.width=r,c.height=l,c.x=r>l?Number(n.attr("x"))-e:Number(n.attr("x"))+e,c.y=r>l?Number(n.attr("y"))+e:Number(n.attr("y"))-e}}let d=n.clone().attr(c).css({fill:"transparent",filter:"none","transform-box":"fill-box",transform:"rotate("+a+"deg)","transform-origin":"50% 50%",transition:"stroke-dashoffset 1s ease-in-out",strokeDashoffset:s,strokeDasharray:s,strokeLinecap:o,"pointer-events":"none"}).data("border_reverse_value_default",n.css("stroke"));$(d).insertAfter(n),n.css({stroke:t})}function updateBorderFill(e,t,o,a,n="cw"){try{let i,s,r=$("#border_"+e),l=r.attr("r"),c=Math.PI*(2*l);switch("rect"==r.prop("tagName")&&(c=2*r.attr("width")+2*r.attr("height")),a){case"percent":s=100-Math.abs(t);break;case"value":if(!o)throw new Error("No max value for element declared!");s=100-Math.abs(t)/o*100}s<0&&(s=0),s>100&&(s=100),r.data("border_reverse")&&(t<0?(n="cw"==n?"ccw":"cw",i=r.data("border_reverse_value")||r.data("border_reverse_value_default")):i=r.data("border_reverse_value_default")),c="cw"==n?c:-1*c;let d=s/100*c;r.css({strokeDashoffset:d,strokeDasharray:c,stroke:i})}catch(t){console.error("Error while updating border fill for ID: "+e+"! "+t)}}function userClock(e,t,o=!1){const a=Object.keys(e).reduce(((t,o)=>("none"!==e[o]&&""!==e[o]&&(t[o]=e[o]),t)),{});let n;const i=new Date;try{n=new Intl.DateTimeFormat(systemLang,a).format(i)}catch(e){console.log("Not a valid date. Waiting for setting-up correctely!",e.message)}return $("#"+t).text(n),o||(clockIntervals[t]=setTimeout(userClock,1e3,e,t)),n}function refreshData(e){try{if(Object.entries(e.values).forEach((t=>{const[o,a]=t;if(a){const t=configuration.elements[o];"value"==t.source_display?t.counter_animation?isNaN(a)?$(`#${o}_value`).html(generateMultiLineText(`${o}_value`,a,t.pos_x)):($(`#${o}_value`).children().length>0||$(`#${o}_value`).html(generateMultiLineText(`${o}_value`,0,t.pos_x)),$(`#${o}_value_line_0`).countTo(a,configuration.basic.animation_timer)):($(`#${o}_value`).children().length>0||$(`#${o}_value`).html(generateMultiLineText(`${o}_value`,0,t.pos_x)),$(`#${o}_value_line_0`).html(a)):$(`#${o}_value`).html(generateMultiLineText(`${o}_value`,a,t.pos_x)),"auto"==t.calculate_kw&&$(`#${o}_unit`).html(generateMultiLineText(`${o}_unit`," "+e.unit[o],t.pos_x))}})),displayMode){try{Object.entries(e.fillValues).forEach((e=>{const[t,o]=e,a=configuration.elements[t];a&&-1!=a.fill_type&&($("#gradient_"+t).length>0||(addGradient(t,a.fill_value,a.fill,a.fill_direction),console.log("[Config] Fill-Gradient added for: "+t)),updateGradient(t,o,a.fill_max,a.fill_type))}))}catch(e){console.error("Could not apply Fill-Values. The following error was thrown: "+e)}try{Object.entries(e.img_href).forEach((e=>{const[t,o]=e;"#"==o?$(`#${t}`).fadeOut(600).attr("href","img/bg_trans.png"):$(`#${t}`).attr("href",o).fadeIn(600)}))}catch(e){console.error("Could not apply Image-Sources. The following error was thrown: "+e)}try{Object.entries(e.borderValues).forEach((e=>{const[t,o]=e,a=configuration.elements[t];-1!=a.border_type&&($("#border_"+t).length>0||(addBorderFill(t,a.border_value,a.border_style,a.border_start),console.log("[Config] Border-Fill added for: "+t)),updateBorderFill(t,o,a.border_max,a.border_type,a.border_direction))}))}catch(e){console.error("Could not apply Border-Values. The following error was thrown: "+e)}try{Object.entries(e.animations).forEach((t=>{const[o,a]=t;let n="",i="",s="";e.animationProperties.hasOwnProperty(o)&&("dots"==e.animationProperties[o].type&&(n=e.animationProperties[o].stroke),"duration"==e.animationProperties[o].type&&(i=e.animationProperties[o].duration),"reverse"==e.animationProperties[o].option&&(s="reverse")),configuration.basic.enable_low_performance||"true"===appProperties.lowPerformance?$("#"+o).css({display:a?"inline":"none","stroke-dasharray":n,"animation-direction":s}):$("#"+o).css({display:a?"inline":"none","stroke-dasharray":n,"animation-duration":i+"ms","animation-direction":s})}))}catch(e){console.error("Could not apply Animations. The following error was thrown: "+e)}try{e.hasOwnProperty("css")&&JSON.stringify(e.css)!=JSON.stringify(globalTmpCSS)&&(Object.entries(e.css).forEach((e=>{const[t,o]=e;o.inactPos&&$("#"+t).removeClass(o.inactPos),o.inactNeg&&$("#"+t).removeClass(o.inactNeg),o.actPos&&$("#"+t).addClass(o.actPos),o.actNeg&&$("#"+t).addClass(o.actNeg)})),globalTmpCSS=e.css)}catch(e){console.error("Could not apply Own CSS-Values. The following error was thrown: "+e)}e.hasOwnProperty("override")&&applyElementOverrides(e.override)}}catch(e){console.error("An error occured, while refreshing the data! The following Error was thrown: "+e)}}async function applyElementOverrides(e){try{Object.keys(e).length>0&&Object.entries(e).forEach((async e=>{const[t,o]=e;Object.keys(o).length>0&&Object.entries(o).forEach((e=>{const[o,a]=e,n=configuration.elements[t];switch(o.toLowerCase()){case"value":!1===a.status?console.warn(`Value-Overrides for element ${t} can not be processed, as they are not correctly formatted! Error: ${a.error} Supplied function: ${a.function}`):$(`#${t}_value`).html(generateMultiLineText(`${t}_value`,a,n.pos_x));break;case"unit":!1===a.status?console.warn(`Unit-Overrides for element ${t} can not be processed, as they are not correctly formatted! Error: ${a.error} Supplied function: ${a.function}`):$(`#${t}_unit`).html(generateMultiLineText(`${t}_unit`,a,n.pos_x));break;case"append":$(`#${t}_append`).html(generateMultiLineText(`${t}_append`,a,n.pos_x));break;case"prepend":$(`#${t}_prepend`).html(generateMultiLineText(`${t}_prepend`,a,n.pos_x));break;case"borderfillcolor":$(`#border_${t}`).css("stroke",a);break;case"fillcolor":$(`#gradient_color_${t}`).attr("stop-color",a);break;case"bordercolor":$(`#${t}`).css("stroke",a);break;case"img_url":let e=a;e.match(/\//)||(e=appProperties.socketURL+appProperties.namespace+"/userFiles/"+e),$(`#${t}`).attr("href",e);break;case"icon":iconHandler(t,a);break;case"pos_x":case"pos_y":if(n)if("text"==n.type){const e="pos_x"==o.toLocaleLowerCase()?"x":"y";$(`#${t}`).attr(e,a)}else console.warn(`Pos X or Pos Y can not be applied to Element ${t}! This property can only be used on text or datasource elements!`);break;default:!1===a.status?console.warn(`Overrides for element ${t} can not be processed, as they are not correctly formatted! Error: ${a.error} Supplied function: ${a.function}`):$(`#${t}`).css(o,a)}}))}))}catch(e){console.error("Could not apply override rules. The following error was thrown: "+e)}}async function translateGoogle(e,t){try{$.ajax({minLength:1,url:"http://translate.googleapis.com/translate_a/single?client=gtx&sl=en&dt=t",type:"GET",data:{tl:t,q:e},success:function(e){console.log(e[0][0][0])},error:function(){console.log("Error while translating into "+t)},timeout:3e3})}catch(e){console.log("Error!")}}function loadConfig(){const e=setTimeout((()=>{$("#loading_text_error").fadeIn("fast")}),4e3);console.log("[Config] Loading config for instance: "+appProperties.instance),setTheme(appProperties.theme),!appProperties.localMode||displayMode?socket.emit("getStates",subscribeObjID,(function(t,o){if(t)console.log(t),failedMessage(translateWord("failmsg_receiving_data"));else if(o){if(null!=o[subscribeObjID[0]]){console.log("[Config] Trying to load configuration from state!");try{if(configuration=JSON.parse(o[subscribeObjID[0]].val),0==Object.keys(configuration).length)throw new Error("No configuration found in state! Using basic configuration instead!");getBackups("backup_list"),setLoadedConfig()}catch(e){console.log("[Config] Error: No configuration in states found! Using basic configuration! "+e),basicConfig=!0,failedMessage(1==displayMode?translateWord("failmsg_no_config_display_mode"):translateWord("failmsg_no_config")),console.log("[Config] Loading Basic configuration from file!"),$.getJSON("js/basic_config.json",(function(e){configuration=e,configuration?(console.log("[Config] File loaded!"),console.debug(configuration),setLoadedConfig()):failedMessage(translateWord("failmsg_failed_config"))}))}clearTimeout(e)}else sprintf(systemDictionary.msg_instance_loading[systemLang],appProperties.instance),failedMessage(sprintf(systemDictionary.failmsg_instance[systemLang],appProperties.instance));if(null!=o[subscribeObjID[1]])try{if(console.log("[Config] Loading initial Data"),!o[subscribeObjID[1]].val)throw new Error("[Config] No data to display found! Please check, if layout is configured and saved properly!");refreshData(JSON.parse(o[subscribeObjID[1]].val))}catch(e){console.log("An error occured, while loading data! "+e)}globalAdapterOnline=null!=o[subscribeObjID[2]]&&o[subscribeObjID[2]].val}else failedMessage(translateWord("failmsg_no_values"))})):(getBackups("backup_list"),configuration=localTest,configuration?(console.log("Loading Local Config"),setLoadedConfig()):(basicConfig=!0,failedMessage(1==displayMode?translateWord("failmsg_no_config_display_mode"):translateWord("failmsg_no_config"))))}function generateStateTree(e,t){var o=performance.now();$(".title.folder, .title.state").off();let a=document,n=a.createElement("div"),i={};n.setAttribute("id","stateRoot"),$("#"+t).append(n);for(const t in e){let o=t.split("."),s="",r="";for(let l=0;l<o.length;l++)if(r=s,s=l>0?s+"."+o[l]:s+o[l],!a.getElementById(s)){let c=a.createElement("div");if(c.setAttribute("id",s),0==l)c.className="root",c.innerHTML=`<div class='title folder'><span class='type folderClosed'></span><span>${o[l]}</span></div>`,n.append(c);else if(c.className="sub","state"==e[t].type&&l==o.length-1)i[s]=e[t];else{let n="";l>1&&(n=e[t].hasOwnProperty("common")&&"state"!=e[t].type?e[t].common.name:""),c.innerHTML=`<div class='title folder'><span class='type folderClosed'></span><span>${o[l]}</span><span>${n}</span></div>`,a.getElementById(r)&&a.getElementById(r).append(c)}}}for(const t in i){let o=t,n=o.lastIndexOf("."),s=o.slice(0,n),r=o.slice(n+1,o.length);if(a.getElementById(s)){let n=a.createElement("div"),l="",c="";l=e[t].hasOwnProperty("common")?"object"==typeof e[t].common.name?e[t].common.name[systemLang]:e[t].common.name:"",c=i[t].hasOwnProperty("common")&&i[t].common.role||"",n.setAttribute("id",o),n.className="sub",n.innerHTML=`<div class='title state'><span class='type file'></span><span>${r}</span><span>${l}</span><span>${i[t].type}</span><span>${c}</span><span>${i[t].common.type}</span></div>`,a.getElementById(s).append(n)}}$(".title.folder").click((function(){$("#"+t).scrollTo($(this).parents(".root"),1e3),$(this).find(".type").first().toggleClass("folderOpen folderClosed"),$(this).siblings().not(".filter_hidden").slideToggle("fast")})),$(".title.state").click((function(){$(".state").removeClass("active"),$(".state").children(".type").removeClass("file-selected"),$(this).toggleClass("active"),$(this).children(".type").addClass("file-selected"),console.log("Active state: "+$(this).parent().attr("id")),$("#select_state").prop("disabled",!1)})),document.querySelector(".stateExplorerFilter").onkeyup=null,document.querySelector(".stateExplorerFilter").onkeyup=async function(){let e=performance.now(),t=$("#stateRoot"),o=new RegExp(this.value.trim().toLowerCase(),"gi");if($(".state").removeClass("active").children(".type").removeClass("file-selected"),$("#select_state").prop("disabled",!0),this.value)setTimeout((function(){t.find(".title").each((function(e,t){$(t).text().match(o)?$(t).parents(".root, .sub").removeClass("filter_hidden").addClass("filter green"):$(t).parent().removeClass("filter green").addClass("filter_hidden")})),t.find(".sub:visible").siblings().each((function(e,t){$(t).hasClass("filter_hidden")?$(t).slideUp():$(t).slideDown()}));let a=performance.now();console.debug(`Filtered elements in ${a-e} ms`)}),0);else{t.find(".root, .sub").removeClass("filter filter_hidden green");let e=t.find(".sub:visible").siblings();e.slideDown(),e.children(".folder").children("span.folderOpen").parent().siblings().slideDown()}},$("#stateExplorer_placeholder").hide();var s=performance.now();console.log(`StateTree build up in ${s-o} ms`)}async function openStateTree(e,t=""){globalIobObjectsLoaded||(iobObjects=await loadIobObjects(),generateStateTree(iobObjects,"stateExplorer")),$("#select_state").prop("disabled",!0),$("#"+e).scrollTop(0);let o=$("[id^='"+t+"']").first();$("#"+e).show(),o.length&&(o.children(".title.state").addClass("active"),o.children(".title.state").children(".type").addClass("file-selected"),o.parents(".sub").show(),o.parents(".sub").children(".sub").show(),o.siblings().show(),o.parents(".sub, .root").children("div.title").children(".type").toggleClass("folderOpen folderClosed"),$("#"+e).animate({scrollTop:o.offset().top-$("#stateExplorerContainer").height()/2}),$("#select_state").prop("disabled",!1))}function getElements(e,t){let o={},a=[],n=[],i=[],s=[],r=[],l=[],c=[],d=[],u=[];Object.entries(configuration.elements).forEach((e=>{const[t,o]=e;switch(o.type){case"text":"datasource"==o.subType?n.push({id:o.id,text:`${$(`#${t}`).text()} (${-1!=o.source?configuration.datasources[o.source].alias:""} - ID:  ${o.id})`}):a.push({id:o.id,text:`${$(`#${t}`).text()} (ID: ${o.id})`});break;case"circle":i.push({id:o.id,text:`ID ${o.id} (X: ${o.pos_x} Y: ${o.pos_y})`,y:o.pos_y});break;case"rect":s.push({id:o.id,text:`ID ${o.id} (X: ${o.pos_x} Y: ${o.pos_y})`,y:o.pos_y});break;case"icon":r.push({id:o.id,text:`ID ${o.id} (X: ${o.pos_x} Y: ${o.pos_y} - ${o.icon})`,y:o.pos_y});break;case"svg":c.push({id:o.id,text:`ID ${o.id} (X: ${o.pos_x} Y: ${o.pos_y})`,y:o.pos_y});break;case"image":d.push({id:o.id,text:`ID ${o.id} (X: ${o.pos_x} Y: ${o.pos_y})`,y:o.pos_y});break;case"foreignObject":u.push({id:o.id,text:`ID ${o.id} (X: ${o.pos_x} Y: ${o.pos_y})`,y:o.pos_y})}})),Object.entries(configuration.defs).forEach((e=>{const[t,o]=e;let a=o.d.substring(1,o.d.indexOf(" "));l.push({id:`line_${o.id}`,text:`ID line_${o.id} (X: ${a})`,d:a})})),o={opt_elm_circle:i.sort(((e,t)=>parseFloat(e.y)-parseFloat(t.y))),opt_elm_ds:n.sort(((e,t)=>parseFloat(e.id)-parseFloat(t.id))),opt_elm_icons:r.sort(((e,t)=>parseFloat(e.y)-parseFloat(t.y))),opt_elm_svg:c.sort(((e,t)=>parseFloat(e.y)-parseFloat(t.y))),opt_elm_image:d.sort(((e,t)=>parseFloat(e.y)-parseFloat(t.y))),opt_elm_fObj:u.sort(((e,t)=>parseFloat(e.y)-parseFloat(t.y))),opt_elm_lines:l.sort(((e,t)=>parseFloat(e.d)-parseFloat(t.d))),opt_elm_rect:s.sort(((e,t)=>parseFloat(e.y)-parseFloat(t.y))),opt_elm_text:a.sort(((e,t)=>e.text<t.text?-1:e.text>t.text?1:0))};let p=document.createDocumentFragment();for(var g of Object.keys(o)){let e=document.createElement("optgroup");for(var f of(e.label=translateWord(g),Object.keys(o[g]))){let a=new Option(o[g][f].text,o[g][f].id);a.selected=o[g][f].id==t,e.append(a)}p.appendChild(e)}const m=document.getElementById(e);m&&(m.innerHTML="",m.append(p))}function getDataSources(e,t,o=!0){let a,n=document.createDocumentFragment();if(o&&n.append(new Option(translateWord("opt_please_choose"),"-1")),Object.keys(configuration.datasources).length>0){const e=Object.entries(configuration.datasources).sort((([,e],[,t])=>e.alias.toLowerCase()<t.alias.toLowerCase()?-1:e.alias.toLowerCase()>t.alias.toLowerCase()?1:0));for(var i of e){if(a=new Option(`${i[1].alias} (${i[1].source})`,i[0]),"object"==typeof t)for(var s in t)t[s]==i[0]&&(a.selected=!0);else a.selected=i[0]==t;n.appendChild(a)}}else a=new Option(translateWord("no_ds_added"),"-1"),a.disabled=!0,a.title=translateWord("ex_no_ds_added"),n.appendChild(a);const r=document.getElementById(e);r&&(r.innerHTML="",r.append(n))}function checkDatasourcesInUse(e){let t={},o=0;return Object.entries(configuration.elements).forEach((a=>{const[n,i]=a;Array.isArray(i.add)&&-1!==i.add.map((e=>parseInt(e))).indexOf(e)&&(t[o++]={id:i.id,type:translateWord(`lbl_${i.subType?i.subType:i.type}`),reason:translateWord("failmsg_delete_source_as_addition")}),Array.isArray(i.subtract)&&-1!==i.subtract.map((e=>parseInt(e))).indexOf(e)&&(t[o++]={id:i.id,type:translateWord(`lbl_${i.subType?i.subType:i.type}`),reason:translateWord("failmsg_delete_source_as_subtraction")}),i.source==e&&(t[o++]={id:i.id,type:translateWord(`lbl_${i.subType?i.subType:i.type}`),reason:translateWord("failmsg_delete_source_as_source")}),i.source_action==e&&(t[o++]={id:i.id,type:translateWord(`lbl_${i.subType?i.subType:i.type}`),reason:translateWord("failmsg_delete_source_as_source_action")})})),Object.entries(configuration.calculation.consumption).forEach((a=>{const[n,i]=a;"boolean"!=typeof i&&i===e&&(t[o++]={id:translateWord(`lbl_consumption_${n}`).replace("*",""),type:translateWord(`lbl_consumption_${n}`).replace("*",""),reason:translateWord("failmsg_delete_source_as_consumption")}),Array.isArray(i)&&"production"==n&&-1!=i.map((e=>parseInt(e))).indexOf(e)&&(t[o++]={id:translateWord(`lbl_consumption_${n}`).replace("*",""),type:translateWord(`lbl_consumption_${n}`).replace("*",""),reason:translateWord("failmsg_delete_source_as_production")})})),Object.entries(configuration.calculation.battery).forEach((a=>{const[n,i]=a;"boolean"!=typeof i&&i==e&&(t[o++]={id:translateWord(`lbl_battery_${n}`).replace("*",""),type:translateWord(`lbl_battery_${n}`).replace("*",""),reason:translateWord("failmsg_delete_source_as_calculation")})})),Object.entries(configuration.animations).forEach((a=>{const[n,i]=a;i.source==e&&(t[o++]={id:n.replace("anim","line"),type:translateWord("lbl_animation"),reason:translateWord("failmsg_delete_source_as_source")})})),t}function receiveImage(e){return new Promise(((t,o)=>{if(e){let o=new Image;if(e.startsWith("{")){console.debug("[Image] Loading image URL via ioBroker state: "+e);let a=e.substring(1,e.lastIndexOf("}"));socket.emit("getState",a,(function(e,a){a?(o.onload=()=>t(a.val),o.onerror=()=>t(""),null!=a.val&&""!=a.val?o.src=a.val:displayMode?(console.debug('[Image] State is empty! Returning "#"!'),t("#")):(console.debug('[Image] State is empty! Returning "Not found"!'),t("img/icon_not_found.png"))):console.log("[Image] A valid picture URL under the given source could not be found!")}))}else e.match(/\//)||(e=appProperties.socketURL+appProperties.namespace+"/userFiles/"+e,console.debug("Loading image from gallery: "+e)),o.onload=()=>t(e),o.onerror=()=>t("img/tmp_img.png"),o.src=e}else t("img/tmp_img.png");displayMode&&$(".type_image").removeClass("draggable")}))}function updateDataSources(){for(var e of(console.debug("Refreshing Datasources!"),Object.keys(configuration.calculation)))for(var t of Object.keys(configuration.calculation[e]))if("production"===t)getDataSources(`calculation.${e}.${t}`,configuration.calculation[e][t],!1),$(`#calculation\\.${e}\\.${t}`).multiselect(multiselect_options);else"boolean"!=typeof configuration.calculation[e][t]&&getDataSources(`calculation.${e}.${t}`,configuration.calculation[e][t],!0)}function setLoadedConfig(e=!1){let t=0;if(configuration.basic.enable_icon_proxy?appProperties.hostname.match(/iobroker\.pro|iobroker\.net/)?(console.log("[Config] Using direct load via iconify-API!"),loadAdditionalJSFile("js/iconify.min.js")):(console.log("[Config] Using Icon-Proxy for Icons"),startIconObserver(),$(".iconify").each((async function(){loadIconViaProxy($(this).data("icon"),$(this))}))):(console.log("[Config] Using direct load via iconify-API!"),loadAdditionalJSFile("js/iconify.min.js")),e&&$("#style_user").empty(),$("#style_user").append(configuration.basic.styles),!displayMode){for(var o of(t=100,resizeSVG(),Object.entries(configuration.basic).forEach((e=>{const[t,o]=e;if(o)if("object"==typeof o)for(var a of Object.keys(configuration.basic[t]))$(`#basic\\.${t}\\.${a}`).hasClass("color")?$(`#basic\\.${t}\\.${a}`)[0].jscolor.fromString(configuration.basic[t][a]):$(`#basic\\.${t}\\.${a}`).val(configuration.basic[t][a]);else switch(t){default:switch(typeof o){case"boolean":$(`#basic\\.${t}`).prop("checked",o);break;case"number":case"string":$(`#basic\\.${t}`).val(o)}break;case"enable_grid":$(`#basic\\.${t}`).prop("checked",o),o&&$("#help_grid").fadeIn("fast");break;case"height":$("#basic\\.height\\.slider").val(o),$("#basic\\.height").val(o),resizeSVG();break;case"width":$("#basic\\.width").val(o),$("#basic\\.width\\.slider").val(o),resizeSVG();break;case"background_color":$("#basic\\.background_color")[0].jscolor.fromString(o);break;case"styles":$("#own_css").length>0&&(aceCSS=ace.edit("own_css"),aceCSS.session.setMode("ace/mode/css"),aceCSS.setTheme("ace/theme/"+appProperties.aceEditorTheme[appProperties.colorScheme]),aceCSS.setOptions({enableBasicAutocompletion:!0,enableSnippets:!0,enableLiveAutocompletion:!0,enableAutoIndent:!0}),aceCSS.setValue(configuration.basic.styles,-1),aceCSS.resize(),aceCSS.on("change",(function(){configuration.basic.styles=aceCSS.getSession().getValue(),$("#style_user").empty().append(configuration.basic.styles)})));break;case"animation_timer":$("#basic\\.animation_timer").val(configuration.basic.animation_timer?configuration.basic.animation_timer:1e3)}})),Object.keys(configuration.animation)))$(`#animation\\.${o}`).val(configuration.animation[o]);for(var o of Object.keys(configuration.animation_configuration))$(`#animation_configuration\\.${o}`).val(configuration.animation_configuration[o]);for(var o of Object.keys(configuration.line))$(`#line\\.${o}`).val(configuration.line[o]);for(var o of Object.keys(configuration.calculation))for(var a of Object.keys(configuration.calculation[o]))switch(a){default:getDataSources(`calculation.${o}.${a}`,configuration.calculation[o][a],!0);break;case"production":getDataSources(`calculation.${o}.${a}`,configuration.calculation[o][a],!1),$(`#calculation\\.${o}\\.${a}`).multiselect(multiselect_options);break;case"charge_prop":case"discharge_prop":case"gridFeed_prop":case"gridConsume_prop":case"batteryCharge_prop":case"batteryDischarge_prop":$(`#calculation\\.${o}\\.${a}`).prop("checked",configuration.calculation[o][a])}for(var o of(configuration.calculation.battery.dod>=0&&null!=configuration.calculation.battery.dod&&configuration.calculation.battery.capacity>=0&&null!=configuration.calculation.battery.capacity&&configuration.calculation.battery.percent>=0&&null!=configuration.calculation.battery.percent&&configuration.calculation.battery.charge>=0&&null!=configuration.calculation.battery.charge&&configuration.calculation.battery.discharge>=0&&null!=configuration.calculation.battery.discharge&&(console.debug("[Calculation] Battery configured!"),$("#calculation\\.battery\\.status").addClass("green").removeClass("red").text(translateWord("txt_calculation_succ"))),0!=configuration.calculation.consumption.production.indexOf(-1)&&configuration.calculation.consumption.production.length>0&&configuration.calculation.consumption.gridFeed>=0&&null!=configuration.calculation.consumption.gridFeed&&configuration.calculation.consumption.gridConsume>=0&&null!=configuration.calculation.consumption.gridConsume&&(console.debug("[Calculation] Consumption configured!"),$("#calculation\\.consumption\\.status").addClass("green").removeClass("red").text(translateWord("txt_calculation_succ"))),Object.keys(configuration.datasources)))addDataSourceRow(o,!0);configuration.basic.enable_ds_autocomplete&&$("#elm_ds_source").autocomplete(dataSourceAutocompleteOptions)}if(configuration.hasOwnProperty("elements")){$(".placeholders").empty();let a=[];for(var o in configuration.elements)a.push({key:o,position:configuration.elements[o].position||0});a.sort((function(e,t){return e.position-t.position}));for(var n=0;n<a.length;n++)svgElement(configuration.elements[a[n].key],!1);for(var o of Object.keys(configuration.defs))svgElement(configuration.defs[o],!1);for(var o of Object.keys(configuration.lines))svgElement(configuration.lines[o],!1);for(var o of Object.keys(configuration.animations))svgElement(configuration.animations[o],!1);if(updateLineAnimation(),displayMode){if(configuration.basic.background_color&&(console.debug("Setting background color!"),$("#style_user").append(`html,body { background-color: ${configuration.basic.background_color}; }`)),$("#svg_display").attr({viewBox:"0 0 "+configuration.basic.width+" "+configuration.basic.height}),$(".all_elements").removeClass("anim_element no_animation"),$("#config_link > a").attr("href","configuration.html?instance="+appProperties.instance),$("#config_link").toggle(configuration.basic.enable_config_icon),configuration.basic.enable_low_performance||"true"===appProperties.lowPerformance){console.log("Low performance mode activated!"),$(".type_animation").addClass("animation");const e=$(".animation");let t=0;setInterval((function(){t=t<=-136?0:t,e.css("stroke-dashoffset",t),t-=1}),20)}else $(".type_animation").addClass("animation animation_cfg");e?console.log("Applying config without re-adding socket listener!"):displayListener()}basicConfig||displayMode||successMessage(translateWord("succ_msg_loading")),setTimeout((()=>{$("#loading").fadeOut("fast")}),t)}else successMessage(translateWord("succ_msg_loading_basic")),setTimeout((()=>{$("#loading").fadeOut("fast")}),t),$("#config_link > a").attr("href","configuration.html?instance="+appProperties.instance).show()}function updateLineAnimation(){$("#style_animation").empty().append(`.line {stroke-width:${configuration.line.stroke_width}px; stroke:${configuration.line.stroke}; }`).append(`.animation {stroke:${configuration.animation.stroke}; stroke-dasharray:${configuration.animation.stroke_dasharray};`).append(`stroke-width:${configuration.animation.stroke_width}px; stroke-linecap:${configuration.animation.stroke_linecap}; }`).append(`.animation_cfg {animation-duration:${configuration.animation.animation_duration}ms; animation-timing-function:${configuration.animation.animation_timing_function}; }`),displayMode&&$("#style_animation").append(".type_animation {display: none;}")}function linePreview(e){let t="",o=136,a=parseInt($("#animation\\.stroke_width").val()),n=parseInt($("#animation_configuration\\.dots").val()),i=parseInt($("#animation_configuration\\.distance").val()),s=parseInt($("#animation_configuration\\.length").val()),r=parseInt($("#line\\.stroke_width").val()),l=parseInt($("#animation\\.animation_duration").val()),c=$("#animation\\.stroke_linecap").val(),d=$("#animation\\.animation_timing_function").val();for(let e=0;e<n;e++)i>0&&s>0&&(t+=s+" ",e!=n-1&&(t+=i+" ",o-=i),o-=s);n>0&&s>0&&i&&(t+=" "+o),o<0&&$("#"+e).val($("#"+e).val()-1),configuration.animation={stroke_dasharray:t,stroke_width:a,animation_duration:l,stroke_linecap:c,animation_timing_function:d},configuration.animation_configuration={dots:n,distance:i,length:s},configuration.line={stroke_width:r,stroke:"#000000"},updateLineAnimation()}function successMessage(e){const t=$("#message_success");t.html(e),t.stop().fadeIn("middle",(function(){$(this).delay(2e3).fadeOut("middle",(function(){$(this).html("")}))}))}function failedMessage(e){const t=$("#message_failed");t.html(e),t.stop().fadeIn("middle",(function(){$(this).delay(2e3).fadeOut("middle",(function(){$(this).html("")}))}))}function resizeSVG(){const e=document.getElementById("svg_config");e.setAttribute("width",configuration.basic.width),e.setAttribute("height",configuration.basic.height),e.setAttribute("viewBox",`0 0 ${configuration.basic.width} ${configuration.basic.height}`)}function lineConnection(e){const t=[];for(const o in configuration.defs){const[,a,n]=o.split("_");a!=e&&n!=e||t.push({path:o,from:a,to:n})}return t}function checkSVGSize(e,t){function o(e,t){const o=getElementCoords(e.id),a=Number("width"===t?o.width:o.height);return("width"===t?o.x:o.y)+("circle"===o.type||"text"===o.type?a/2:a)+o.stroke}function a(e){return Object.values(configuration.elements).reduce(((t,a)=>o(a,e)>o(t,e)?a:t))}const n=a("width"),i=a("height");return{width:e>o(n,"width"),height:t>o(i,"height")}}function checkElementBounds(e,t){const o=configuration.basic,a=Number(e.stroke)/2,n="circle"==e.type||"text"==e.type?t.x-Number(e.width)/2-a:t.x-a,i=n+Number(e.width)+2*a,s="circle"==e.type||"text"==e.type?t.y-Number(e.height)/2-a:t.y-a,r=s+Number(e.height)+2*a;return{x:n>=0&&i<=o.width,y:s>=0&&r<=o.height}}function moveSVGElement(e,t){const o=configuration.elements[e.id],a="circle"==e.type?"cx":"x",n="circle"==e.type?"cy":"y",i=checkElementBounds(e,t).x,s=checkElementBounds(e,t).y;if(i&&($("#"+e.id).attr(a,t.x),o.pos_x=t.x,o.hasOwnProperty("text")&&o.text.match(/\n/gi)&&$("#"+e.id).children().attr("x",t.x),(o.hasOwnProperty("prepend")||o.hasOwnProperty("append")||o.hasOwnProperty("unit"))&&$(`#${e.id}_prepend, #${e.id}_append, #${e.id}_value, #${e.id}_unit`).children().each((function(){$(this).attr("x")&&$(this).attr("x",t.x)}))),s&&($("#"+e.id).attr(n,t.y),o.pos_y=t.y),e.connections.length>0)for(var r of e.connections)calculatePath(r.path,r.from,r.to);if(i&&s)return!0}function getMousePosition(e){var t=document.getElementById("svg_config").getScreenCTM();return e.touches&&(e=e.touches[0]),{x:parseInt((e.clientX-t.e)/t.a),y:parseInt((e.clientY-t.f)/t.d)}}function getElementCoords(e,t){const o=configuration.elements[e];let a=Number(o.width),n=Number(o.height),i=Number(o.pos_x),s=Number(o.pos_y),r=Number(o.radius)||0,l=Number(o.stroke)||0,c=0,d=0,u=t?getMousePosition(t):{x:0,y:0};switch(u.x-=i,u.y-=s,o.type){case"circle":a=2*r,n=a,c=i,d=s;break;case"text":let t=document.getElementById(e).getBoundingClientRect();a=Math.round(t.width),n=Math.round(t.height),c=i,d=s}return{id:Number(e),cx:c,cy:d,x:i,y:s,width:a,height:n,radius:r,stroke:l,connections:lineConnection(e),offset:u,type:o.type}}function connectorAngle(e){return(e-90)*(Math.PI/180)}function showConnectionPoints(e=!0){const t=$("#connection_points");e?(t.empty(),$(".connector").each((function(){const e=$(this).attr("id"),o={};o[e]={};const a=$(this).prop("tagName").toLowerCase();let n=function(e,t){if("circle"===t){const t=parseInt(e.attr("r"));return{r:t,cx:parseInt(e.attr("cx")),cy:parseInt(e.attr("cy")),width:2*t,height:2*t,x:parseInt(e.attr("cx"))-t,y:parseInt(e.attr("cy"))-t}}if("rect"===t)return{width:parseInt(e.attr("width")),height:parseInt(e.attr("height")),x:parseInt(e.attr("x")),y:parseInt(e.attr("y"))}}($(this),a);"circle"===a?function(e,{cx:t,cy:o,r:a}){const n=["top_left","top_right","right_top","right_bottom","bottom_left","bottom_right","left_bottom","left_top"];[340,20,70,110,200,160,250,290].forEach(((i,s)=>{e[n[s]]={x:t+a*Math.cos(connectorAngle(i)),y:o+a*Math.sin(connectorAngle(i))}}))}(o[e],n):"rect"===a&&function(e,{width:t,height:o,x:a,y:n}){e.top_left={x:a+t/2-20,y:n},e.top_right={x:a+t/2+20,y:n},e.left_top={x:a,y:n+o/2-20},e.left_bottom={x:a,y:n+o/2+20},e.right_top={x:a+t,y:n+o/2-20},e.right_bottom={x:a+t,y:n+o/2+20},e.bottom_left={x:a+t/2-20,y:n+o},e.bottom_right={x:a+t/2+20,y:n+o}}(o[e],n),function(e,{width:t,height:o,x:a,y:n}){e.top={x:a+t/2,y:n},e.left={x:a,y:n+o/2},e.right={x:a+t,y:n+o/2},e.bottom={x:a+t/2,y:n+o}}(o[e],n),function(e,t,o){Object.entries(e).forEach((([e,a])=>{const n=document.createElementNS("http://www.w3.org/2000/svg","circle");n.setAttribute("class","connPoints clickable"),n.setAttribute("cx",a.x),n.setAttribute("cy",a.y),n.setAttribute("r",5),n.setAttribute("data-slot",e),n.setAttribute("data-element",t),o.append(n)}))}(o[e],e,t)}))):t.empty()}function getSlots(e){const t=Math.floor(e.width/2),o=Math.floor(e.height/2),a=Math.floor(e.stroke/2);return{top:{x:e.cx?e.cx:e.x+t,y:e.cy?e.cy-t-a:e.y-a,direction:"vertical"},right:{x:e.cx?e.cx+t+a:e.x+e.width+a,y:e.cy?e.cy:e.y+o,direction:"horizontal"},bottom:{x:e.cx?e.cx:e.x+t,y:e.cy?e.cy+t+a:e.y+e.height+a,direction:"vertical"},left:{x:e.cx?e.cx-t-a:e.x-a,y:e.cy?e.cy:e.y+o,direction:"horizontal"}}}function getSpecialSlots(e,t){const o=Math.floor(e.width/2),a=Math.floor(e.height/2),n=Math.floor(e.stroke/2);let i=getSlots(e);return e.radius>0?(i.top_left={x:e.cx+e.radius*Math.cos(connectorAngle(340)),y:e.cy+e.radius*Math.sin(connectorAngle(340))-n,direction:"vertical"},i.top_right={x:e.cx+e.radius*Math.cos(connectorAngle(20)),y:e.cy+e.radius*Math.sin(connectorAngle(20))-n,direction:"vertical"},i.right_top={x:e.cx+e.radius*Math.cos(connectorAngle(70))+n,y:e.cy+e.radius*Math.sin(connectorAngle(70)),direction:"horizontal"},i.right_bottom={x:e.cx+e.radius*Math.cos(connectorAngle(110))+n,y:e.cy+e.radius*Math.sin(connectorAngle(110)),direction:"horizontal"},i.bottom_left={x:e.cx+e.radius*Math.cos(connectorAngle(200)),y:e.cy+e.radius*Math.sin(connectorAngle(200))+n,direction:"vertical"},i.bottom_right={x:e.cx+e.radius*Math.cos(connectorAngle(160)),y:e.cy+e.radius*Math.sin(connectorAngle(160))+n,direction:"vertical"},i.left_bottom={x:e.cx+e.radius*Math.cos(connectorAngle(250))-n,y:e.cy+e.radius*Math.sin(connectorAngle(250)),direction:"horizontal"},i.left_top={x:e.cx+e.radius*Math.cos(connectorAngle(290))-n,y:e.cy+e.radius*Math.sin(connectorAngle(290)),direction:"horizontal"}):(i.top_left={x:e.x+o-20,y:e.y-n,direction:"vertical"},i.top_right={x:e.x+o+20,y:e.y-n,direction:"vertical"},i.right_top={x:e.x+e.width+n,y:e.y+a-20,direction:"horizontal"},i.right_bottom={x:e.x+e.width+n,y:e.y+a+20,direction:"horizontal"},i.bottom_left={x:e.x+o-20,y:e.y+e.height+n,direction:"vertical"},i.bottom_right={x:e.x+o+20,y:e.y+e.height+n,direction:"vertical"},i.left_top={x:e.x-n,y:e.y+a-20,direction:"horizontal"},i.left_bottom={x:e.x-n,y:e.y+a+20,direction:"horizontal"}),{spec:i[t]}}async function connectElements(e){return new Promise(((t,o)=>{const a=$(".line:not(.faded_out, .preview)");let n,i,s,r;$(".connector").length>=2?($(`#${e}`).toggleClass("red"),$(`.connect_elements:not(#${e})`).prop("disabled",!0)):failedMessage(translateWord("failmsg_no_elements")),$(`#${e}`).hasClass("red")?($(`#${e}`).val(translateWord("value_cancel")),"connect_elements"==e&&hideConfigBar(),showConnectionPoints(),$(`#ex_${e}`).html("connect_elements"==e?translateWord("ex_connect_ref")+" <img src='img/icon_help.png' class='help' style='vertical-align: bottom;' placeholder='"+translateWord("help_connect")+"'>":translateWord("ex_reconnect_ref")),$(".all_elements").addClass("faded_out no_click"),"reconnect_elements"==e&&$("#"+a[0].id+", #"+a[0].id.replace("anim","line")).removeClass("faded_out"),$(".connector").removeClass("draggable draggable-multi faded_out no_click").addClass("clickable"),$(".clickable").off().click((function(o){let l=o.target.id?o.target.id:$(this).data("element"),c=$(this).data("slot")?$(this).data("slot"):"element";if(null==n)n=l,s=c,$(`#ex_${e}`).html(translateWord("ex_connect_start")),$(this).addClass("red");else if(n==l)$(`#ex_${e}`).html(translateWord("ex_connect_same")),i=null,r=null;else{i=l,r=c;let o=`path_${n}_${i}`;if(configuration.defs.hasOwnProperty(o))"connect_elements"==e?failedMessage(translateWord("failmsg_conn_exists")):(configuration.defs[o].startSlot=s,configuration.defs[o].endSlot=r,calculatePath(o,n,i),globalConfigChanged=!0);else{const t={type:"def",id:o,startSlot:s,endSlot:r,d:""};switch(configuration.defs[o]=t,svgElement(configuration.defs[o],!1),calculatePath(o,n,i),e){case"connect_elements":const e={type:"line",id:"line_"+o,color:configuration.line.stroke,href:"#"+o};configuration.lines["line_"+o]=e;const n={type:"animation",id:"anim_"+o,color:configuration.animation.stroke,href:"#"+o,source:-1,animation_properties:"positive",animation_option:!1,threshold:null,dots:null,duration:null,power:null,animation_type:-1,css_general:"",css_active_positive:"",css_inactive_positive:"",css_active_negative:"",css_inactive_negative:""};configuration.animations["anim_"+o]=n,saveUndoStep("add",{animation:n,def:t,line:e},"");break;case"reconnect_elements":if(1==a.length){let e=a[0].id,t=a[0].id.replace("line_",""),n=a[0].id.replace("line","anim");delete Object.assign(configuration.defs,{[o]:configuration.defs[t]})[t],delete Object.assign(configuration.lines,{["line_"+o]:configuration.lines[e]})[e],delete Object.assign(configuration.animations,{["anim_"+o]:configuration.animations[n]})[n],configuration.defs[o].id=o,configuration.lines["line_"+o].id="line_"+o,configuration.lines["line_"+o].href="#"+o,configuration.animations["anim_"+o].id="anim_"+o,configuration.animations["anim_"+o].href="#"+o,$(`#${n}, #${e}, #${t}`).remove()}}svgElement(configuration.lines["line_"+o],!1),svgElement(configuration.animations["anim_"+o],!1),globalConfigChanged=!0}t("line_"+o),showConnectionPoints(!1),n=null,i=null,$(`#${e}`).val("connect_elements"==e?translateWord("value_connect"):translateWord("value_reconnect")).removeClass("red"),$(`#ex_${e}`).html("connect_elements"==e?translateWord("ex_connect"):translateWord("ex_reconnect")),$(".connect_elements").prop("disabled",!1),$(".clickable").off(),$(".added_elements").removeClass("clickable").addClass("draggable"),$(".all_elements").removeClass("connect_elements"==e?"no_click faded_out":"no_click")}}))):($(".clickable").off(),$(".added_elements").removeClass("clickable").addClass("draggable"),$(".all_elements").removeClass("faded_out no_click"),$(`#${e}`).val("connect_elements"==e?translateWord("value_connect"):translateWord("value_reconnect")),$(`#ex_${e}`).html("connect_elements"==e?translateWord("ex_connect"):translateWord("ex_reconnect")),showConnectionPoints(!1),$(".connect_elements").prop("disabled",!1))}))}function exportElement(e){let t,o=Object.assign({},configuration.elements[e]);["id","source","source_action","pos_x","pos_y"].forEach((e=>delete o[e]));let a=getRandomInt(55);$(`<div id="tmpDiv_${a}" class="tmpDiv" />`).appendTo("body"),$(`#tmpDiv_${a}`).prop("title",translateWord("lbl_export_element")).dialog({resizable:!1,height:520,width:400,maxHeight:"100%",modal:!0,classes:jQueryDialog.classes,open:jQueryDialog.open,beforeClose:jQueryDialog.beforeClose,create:function(){t=ace.edit(`tmpDiv_${a}`),t.session.setMode("ace/mode/json"),t.setTheme("ace/theme/"+appProperties.aceEditorTheme[appProperties.colorScheme]),t.setReadOnly(!0),t.setValue(JSON.stringify(o,void 0,4),-1)},close:function(){t.destroy()},buttons:[{text:translateWord("btn_copy"),class:"input_button",click:function(){if(void 0!==navigator.clipboard&&"undefined"!==navigator.permissions)navigator.clipboard.writeText(t.getValue()).then((()=>{successMessage(translateWord("elm_copy_success")),console.debug("Text copied to clipboard via Clipboard API!")})).catch((e=>{console.error(e.message),alert(e.message),failedMessage(translateWord("elm_copy_failed"))}));else{t.selectAll(),t.focus();try{document.execCommand("copy"),successMessage(translateWord("elm_copy_success")),console.debug("Text copied to clipboard via exec-copy!")}catch(e){failedMessage(translateWord("elm_copy_failed"))}}}},{text:translateWord("btn_close"),class:"input_button",click:function(){$(this).dialog("close")}}]})}function calculatePath(e,t,o){function a(e,t){let o=Math.abs(e.x-t.x),a=Math.abs(e.y-t.y);return Math.sqrt(o*o+a*a)}let n,i,s=getElementCoords(t),r=getElementCoords(o),l=configuration.defs[e].startSlot,c=configuration.defs[e].endSlot;n="element"!=l?getSpecialSlots(s,l):getSlots(s),i="element"!=c?getSpecialSlots(r,c):getSlots(r);let d=1/0,u={};for(var p of Object.keys(n))for(var g of Object.keys(i)){let e=a(n[p],i[g]);e<d&&(d=e,u={start:n[p],end:i[g]})}drawPath(e,u.start.x,u.start.y,u.end.x,u.end.y,u.start.direction,u.end.direction)}function polarToCartesian(e,t,o,a){const n=(a-90)*Math.PI/180;return{x:e+o*Math.cos(n),y:t+o*Math.sin(n)}}function describeArc(e,t,o,a,n,i){const s=polarToCartesian(e,t,o,n);return["A",o,o,0,n-a<=180?"0":"1",i,s.x,s.y]}function drawPath(e,t,o,a,n,i,s,r){let l={x:t,y:o},c=[`M${t} ${o}`];const d=Math.abs(a-t),u=Math.abs(n-o);let p=.2;configuration.defs[e].line_arc&&(p=parseFloat(configuration.defs[e].line_arc)/100);let g,f=15;function m(e){c.push(`H ${e}`),l.x=e}function h(e){c.push(`V ${e}`),l.y=e}configuration.defs[e].line_radius&&(f=parseFloat(configuration.defs[e].line_radius)),d<2*f&&(f=Math.floor(d/2)),u<2*f&&(f=Math.floor(u/2)),n==o&&m(a),a===t&&h(n),n>o&&a>t&&("horizontal"==i?"horizontal"==s?(m(t+d*p),g=describeArc(l.x,l.y+f,f,0,90,1),c.push(g.join(" ")),h(n-f),c.push(describeArc(g[6],l.y+f,f,0,90,0).join(" ")),m(a)):(m(a-f),c.push(describeArc(l.x,l.y+f,f,0,90,1).join(" ")),h(n)):"vertical"==s?(h(o+u*p),g=describeArc(l.x,l.y+f,f,0,90,0),c.push(g.join(" ")),m(a-f),c.push(describeArc(l.x,g[7]+f,f,0,90,1).join(" ")),h(n)):(h(n-f),g=describeArc(l.x,l.y+f,f,0,90,0),c.push(g.join(" ")),m(a))),n>o&&a<t&&("horizontal"==i?"horizontal"==s?(m(t-d*p),g=describeArc(l.x,l.y+f,f,180,270,0),c.push(g.join(" ")),h(n-f),c.push(describeArc(g[6],l.y+f,f,180,270,1).join(" ")),m(a)):(m(a+f),c.push(describeArc(l.x,l.y+f,f,180,270,0).join(" ")),h(n)):"vertical"==s?(h(o+u*p),g=describeArc(l.x-f,l.y,f,90,180,1),c.push(g.join(" ")),m(a+f),c.push(describeArc(l.x,g[7]+f,f,180,270,0).join(" ")),h(n)):(h(n-f),c.push(describeArc(l.x,l.y+f,f,180,270,1).join(" ")),m(a))),n<o&&a>t&&("horizontal"==i?"horizontal"==s?(m(t+d*p),g=describeArc(l.x,l.y-f,f,0,90,0),c.push(g.join(" ")),h(n+f),c.push(describeArc(g[6]+f,l.y,f,270,360,1).join(" ")),m(a)):(m(a-f),c.push(describeArc(l.x,l.y-f,f,0,90,0).join(" ")),h(n)):"vertical"==s?(h(o-u*p),g=describeArc(l.x,l.y-f,f,0,90,1),c.push(g.join(" ")),m(a-f),c.push(describeArc(l.x,g[7]-f,f,0,90,0).join(" ")),h(n)):(h(n+f),c.push(describeArc(l.x,l.y-f,f,0,90,1).join(" ")),m(a))),n<o&&a<t&&("horizontal"==i?"horizontal"==s?(m(t-d*p),g=describeArc(l.x,l.y-f,f,180,270,1),c.push(g.join(" ")),h(n+f),c.push(describeArc(g[6]-2*f,l.y-f,f,0,90,0).join(" ")),m(a)):(m(a+f),c.push(describeArc(l.x,l.y-f,f,180,270,1).join(" ")),h(n)):"vertical"==s?(h(o-u*p),g=describeArc(l.x-2*f,l.y-f,f,0,90,0),c.push(g.join(" ")),m(a+f),c.push(describeArc(l.x,g[7]-f,f,180,270,1).join(" ")),h(n)):(h(n+f),c.push(describeArc(l.x-2*f,l.y-f,f,0,90,0).join(" ")),m(a))),configuration.defs[e].d=c.join(" "),$("#"+e).attr("d",configuration.defs[e].d)}function showConfigBar(e,t,o="tab1"){$(".tab1_config").scrollTop(0),$(".tab2_config").scrollTop(0),$(`#${o}_config`).prop("checked",!0),$("#elm_counter_animation, #elm_convert").prop("checked",!1),$("#elm_select").selectmenu({open:function(){$($(this).selectmenu("instance").menu).children(".ui-menu-item").find("div.ui-state-active")[0].scrollIntoView({block:"center"})},position:{my:"right top+2",at:"right bottom",collision:"fit"}}).selectmenu("menuWidget").addClass("select_overflow"),getElements("elm_select",e),$("#elm_select").val(e).selectmenu("refresh").off().on("selectmenuchange",(function(){showConfigBar($(this).val(),$("#"+$(this).val()).prop("tagName"))})),$(".all_elements").removeClass("active_element").addClass("faded_out"),$(`#${e}`).removeClass("faded_out").addClass("active_element"),$(".elm_config, #reconnect_elements, #delete_element").prop("disabled",!1),$("#restore_element").prop("disabled",!0),$(".elm_config_box, .elm_config_box_sub, .frame_deactivated, .enable_clock").hide(),$(".elm_config").val(""),$(".elm_config").prop("checked",!1),$("select.elm_config").each((function(){$(this)[0].selectedIndex=0})),$(".elm_config.color").each((function(){$(this)[0].jscolor.fromString("")})),$("#elm_icon").hasClass("ui-autocomplete-input")&&$("#elm_icon").autocomplete("destroy"),$("#elm_href").hasClass("ui-autocomplete-input")&&$("#elm_href").autocomplete("destroy");const a=configuration.elements[e];let n,i=Object.assign({},configuration.elements[e]),s={},r={},l={};switch(t){case"rect":$(".elm_config_box.rect").show();break;case"circle":$(".elm_config_box.circle").show();break;case"text":if($(".elm_config_box.text").show(),$(".text_not_ds").show(),"datasource"==i.subType)switch($(".elm_config_box.datasource").show(),$(".text_not_ds, .text_only").hide(),getDataSources("elm_subtract",i.subtract,!1),getDataSources("elm_add",i.add,!1),$("#elm_subtract").siblings(".ms-options-wrap").length>0?$("#elm_subtract").multiselect("reload"):$("#elm_subtract").multiselect(multiselect_options),$("#elm_add").siblings(".ms-options-wrap").length>0?$("#elm_add").multiselect("reload"):$("#elm_add").multiselect(multiselect_options),getDataSources("elm_source_action",i.source_action,!0),i.source_display){default:case"value":$(".text_not_ds").hide(),$(".linebreak_text").hide();break;case"own_text":$(".text_not_ds").show();break;case"text":$(".linebreak_text").show()}break;case"use":$(".elm_config_box.use").show(),l={animation:e.replace("line","anim"),def:e.replace("line_",""),line:e},console.debug(`Init: ${JSON.stringify(l)}`),i=Object.assign({},configuration.animations[l.animation]),s=Object.assign({},configuration.lines[l.line]),r=Object.assign({},configuration.defs[l.def]),getDataSources("elm_animation",i.source,!0),$("#elm_start_slot").val("element"==r.startSlot?translateWord("value_element"):translateWord("value_"+r.startSlot)),$("#elm_end_slot").val("element"==r.endSlot?translateWord("value_element"):translateWord("value_"+r.endSlot)),$("#elm_line_color")[0].jscolor.fromString(s.color),$("#elm_url").val(s.url),$("#elm_frame").val(s.frame||"_overlay"),$("#elm_line_arc").val(r.line_arc||20),$("#elm_line_radius").val(r.line_radius||15),$("#"+e).removeClass("faded_out");break;case"icon":case"svg":"svg"==i.subType?$(".elm_config_box.svg").show():$(".elm_config_box.icon").show();break;case"image":$(".elm_config_box.image").show();break;case"foreignObject":$(".elm_config_box.fObj").show()}switch(Object.entries(i).forEach((e=>{const[t,o]=e;if("object"==typeof o&&o&&"clock"===t)for(var a of Object.keys(i[t]))$(`#elm_${t}\\.${a}`).val(i[t][a]);$(`#elm_${t}`).val(o),$(`#elm_${t}`).data("jscolor")&&(o?($(`#elm_${t}`)[0].jscolor.fromString("none"==o||""==o?"":o),"color"==t&&$("#elm_border_value_fill").prop("disabled",!0)[0].jscolor.fromString(i.color)):$(`#elm_${t}`).val("")),"boolean"==typeof o&&$(`#elm_${t}`).prop("checked",!0===o)})),-1!=i.fill_type&&i.fill_type?($(".fill_type").show(),"value"==i.fill_type?$(".fill_type_value").show():$(".fill_type_value").hide()):($(".fill_type,.fill_type_value").hide(),$("#elm_fill_type").val("-1")),i.border_type&&-1!=i.border_type?($(".border_type").show(),"value"==i.border_type?$(".border_type_value").show():$(".border_type_value").hide()):($(".border_type, .border_type_value").hide(),$("#elm_border_type").val("-1")),i.border_reverse&&$(".border_reverse_value").show(),i.enable_clock&&($(".enable_clock").show(),$("#elm_text").prop("disabled",!0)),i.animation_type&&-1!=i.animation_type&&($(".anim_type_power").show(),"dots"==i.animation_type?$(".anim_type_dots").show():$(".anim_type_duration").show()),getDataSources("elm_source",i.source,!0),i.action){case"none":$(".action_shortcuts, .frame_deactivated").hide();break;case"on":case"off":case"toggle":$(".frame_deactivated").show(),$(".action_shortcuts").hide();break;case"change":$(".frame_deactivated, .action_shortcuts").show()}function c(){if("datasource"==i.subType){const t=configuration.elements[e];if("own_text"!=t.source_display&&-1!=t.source){let o={id:e,source:configuration.datasources[t.source].source,source_option:t.source_option,source_display:t.source_display,linebreak:t.linebreak,type:t.type,threshold:t.threshold,calculate_kw:t.calculate_kw,decimal_places:t.decimal_places,override:t.override};console.debug("Requesting new Data with: ",o),socket.emit("sendTo",appProperties.namespace,"_updateElementInView",o,(function(t){t&&t.error?console.log("An error occured, while getting the updated value: ",t.error):($(`#${t.data.id}_value`).html(generateMultiLineText(`${t.data.id}_value`,t.data.value,$("#"+e).attr("x"))),Object.keys(t.data.override).length>0&&applyElementOverrides(t.data.override))}))}else console.log("Source option is own text! Not requesting!")}}$("#config_bar").addClass("show"),$(".degree").off().on("click",(function(){globalConfigChanged=!0,$("#restore_element").prop("disabled",!1);let t=a.degree||0;t="rotate_cw"==$(this).attr("id")?t+45:t-45,t=t<=315&&t>=-315?t:0,a.degree=t,$("#"+e).css({"transform-box":"fill-box",transform:`rotate(${t}deg)`})})),$("#delete_element").off().click((function(){if(this.blur(),"animation"===i.type)delete configuration.lines[l.line],delete configuration.defs[l.def],delete configuration.animations[l.animation],$(`#${l.def}, #${l.line}, #${l.animation}`).remove(),successMessage(translateWord("succ_msg_line_delete")),$("#restore_element").prop("disabled",!1),$(".elm_config, #reconnect_elements, #delete_element").prop("disabled",!0);else lineConnection(e).length>0?failedMessage(translateWord("failmsg_element_delete")):(delete configuration.elements[e],$(`#${e}`).remove(),successMessage(translateWord("succ_msg_delete")),$("#restore_element").prop("disabled",!1),$(".elm_config, #reconnect_elements, #delete_element").prop("disabled",!0))})),$(".changeOrder").off().click((function(){$("#restore_element").prop("disabled",!1);let t=$("#"+e).next(),o=$("#"+e).prev();switch($(this).attr("id")){case"changeOrder_foreground":t.length>0?$("#"+e).insertAfter(t):failedMessage(translateWord("failmsg_max_foreground"));break;case"changeOrder_background":o.length>0?$("#"+e).insertBefore(o):failedMessage(translateWord("failmsg_max_background"))}if("animation"===i.type)configuration.lines[e].position=$("#"+e).index();else a.position=$("#"+e).index()})),$(".elm_config").off().on("input change",(async function(o){$("#restore_element").prop("disabled",!1),globalConfigChanged=!0;const s=o.target.id.replace("elm_","");let r,d="general";switch(($(this).hasClass("color")||$(this).hasClass("style"))&&(d="style"),$(this).hasClass("attribute")&&(d="attribute"),this.type){case"textarea":case"url":case"text":r=this.value;break;case"select-multiple":r=$(this).val().map((e=>parseInt(e)));break;case"select-one":r=isNaN(this.value)?this.value:parseInt(this.value);break;case"number":r=parseInt(this.value);break;case"checkbox":r=this.checked}switch(s){case"animation_type":"dots"==r?($(".anim_type_duration").hide(),$(".anim_type_dots, .anim_type_power").slideDown("slow")):"duration"==r?($(".anim_type_dots").hide(),$(".anim_type_duration, .anim_type_power").slideDown("slow")):$(".anim_type_duration, .anim_type_dots, .anim_type_power").slideUp("slow");break;case"fill_type":-1==r?$(".fill_type,.fill_type_value").slideUp("slow"):($(".fill_type").slideDown("slow"),$("#elm_fill_direction").val(i.fill_direction||90).trigger("change"),"value"==r?$(".fill_type_value").slideDown("slow"):$(".fill_type_value").slideUp("slow"));break;case"border_type":-1==r?$(".border_type, .border_type_value").slideUp("slow"):($(".border_type").slideDown("slow"),$("#elm_border_start").val(i.border_start||180).trigger("change"),$("#elm_border_direction").val(i.border_direction||"cw").trigger("change"),$("#elm_border_style").val(i.border_style||"round").trigger("change"),$("#elm_border_reverse").prop("checked",i.border_reverse).trigger("change"),"value"==r?$(".border_type_value").slideDown("slow"):$(".border_type_value").slideUp("slow"));break;case"border_reverse":r?$(".border_reverse_value").slideDown("slow"):($("#elm_border_reverse_value")[0].jscolor.fromString(""),$(".border_reverse_value").slideUp("slow"));break;case"source_display":switch(r){default:case"value":$(".text_not_ds").slideUp("slow"),$(".linebreak_text").slideUp("slow"),$("#elm_counter_animation").prop("disabled",!1);break;case"own_text":$("#elm_text").val(`ID ${e}`),$(".text_not_ds").slideDown("fast"),$(".tab1_config").scrollTo($("#elm_text").parent().closest(".detail_box"),1e3);break;case"text":$(".linebreak_text").slideDown("slow"),$("#elm_counter_animation").prop("disabled",!0)}break;case"action":switch(r){case"none":$(".action_shortcuts, .frame_deactivated").slideUp("slow");break;case"on":case"off":case"toggle":$(".frame_deactivated").slideDown("slow"),$(".action_shortcuts").slideUp("slow");break;case"change":$(".frame_deactivated").fadeIn("slow"),$(".frame_deactivated, .action_shortcuts").slideDown("slow"),$(".tab2_config").scrollTo($(this).parent().closest(".detail_box"),1e3,0),$("#elm_action_type").val(a.hasOwnProperty("action_type")?a.action_type:"number"),a.hasOwnProperty("action_type")||(a.action_type="number"),$("#elm_action_display").val(a.hasOwnProperty("action_display")?a.action_display:"button"),a.hasOwnProperty("action_display")||(a.action_display="button"),$("#elm_action_display_freeform").prop("checked",!a.hasOwnProperty("action_display_freeform")||a.action_display_freeform),a.hasOwnProperty("action_display_freeform")||(a.action_display_freeform=!0)}break;case"enable_clock":r?($("#elm_text").prop("disabled",!0),$(".enable_clock").slideDown("slow"),$(".tab1_config").scrollTo($(this).parent().closest(".detail_box"),1e3,0)):($("#elm_text").prop("disabled",!1),$(".enable_clock").slideUp("slow"));break;case"color":$("#elm_border_value_fill").prop("disabled",!0)[0].jscolor.fromString(r)}const u=(e,t,o,n)=>{console.debug(`Object ${n} property change! Source: ${t} Value: ${o} | Before: ${a[t]}`),a[t]=o,console.debug("Object after change",a)};switch(d){case"style":const c={color:{target:e,property:"stroke",value:r},shadow:{target:e,property:"filter",value:`drop-shadow(0px 3px 3px ${r})`}};let d,p,g;const f=({animation:{color:{target:l.animation,property:"stroke",value:r},line_color:{target:l.line,property:"stroke",value:r},shadow:{target:l.line,property:"filter",value:`drop-shadow(0px 3px 3px ${r})`}},text:{color:c.color,shadow:c.shadow,font_size:{target:e,property:"font-size",value:r+"px"},font_family:{target:e,property:"font-family",value:r},align:{target:e,property:"text-anchor",value:r}},rect:{color:c.color,shadow:c.shadow},circle:{color:c.color,shadow:c.shadow},icon:{shadow:c.shadow},svg:{shadow:c.shadow},foreignObject:{shadow:c.shadow},image:{shadow:c.shadow}}[i.type]||{})[s];f?(d=f.target,p=f.property,g=f.value):(d=e,p=s,g=r),$(`#${d}`).css(p,g),"animation"==i.type?("color"==s&&(console.debug(`Animation color change! Value: ${r} | Before: ${configuration.animations[l.animation].color}`),configuration.animations[l.animation].color=r),"line_color"==s&&(console.debug(`Line color change! Value: ${r} | Before: ${configuration.lines[l.line].color}`),configuration.lines[l.line].color=r)):u(0,s,r,"CSS");case"attribute":const m={circle:{width:2*$("#elm_radius").val(),height:2*$("#elm_radius").val()},text:{width:"text"==t?document.getElementById(e).getBBox().width:$("#elm_width").val(),height:"text"==t?document.getElementById(e).getBBox().height:$("#elm_height").val()}},h={id:e,type:t,stroke:Number($("#elm_stroke").val())||0,width:t in m?m[t].width:$("#elm_width").val(),height:t in m?m[t].height:$("#elm_height").val(),connections:lineConnection(e),radius:$("#elm_radius").val()},_={x:$("#elm_pos_x").val(),y:$("#elm_pos_y").val()},b=checkElementBounds(h,_);if(b.x&&b.y){switch(s){case"pos_x":case"pos_y":moveSVGElement(h,_),$("#placeholder_coordinate_desc").children().fadeOut("fast",(function(){$(this).remove()}));break;case"radius":u(0,s,h.radius,"Attribute"),$("#"+e).attr("r",h.radius);break;case"stroke":u(0,s,h.stroke,"CSS"),$(`#${e}`).css("strokeWidth",h.stroke);break;case"fObj_content":case"svg_content":u(0,s,r,"Attribute"),$(`#${e}`).html(r);break;case"rx":case"height":case"width":case"preserveAspectRatio":case"viewBox":u(0,s,r,"Attribute"),$(`#${e}`).attr(s,r);break;case"href":u(0,s,r,"Attribute"),$(`#${e}`).attr("href",await receiveImage(r));break;case"append":case"unit":case"prepend":u(0,s,r,"Attribute"),$(`#${e}_${s}`).html(generateMultiLineText(`${e}_${s}`,r,_.x));break;case"text":u(0,s,r,"Attribute"),"own_text"==$("#elm_source_display").val()?$(`#${e}_value`).html(generateMultiLineText(`${e}_value`,r,_.x)):$(`#${e}`).html(generateMultiLineText(e,r,_.x));break;case"rotate":case"flip":u(0,s,r,"Attribute")}"icon"==i.type&&($(`#${e}`).attr("data-"+s,r),iconHandler(e,a.icon,!0))}else"input"==o.type&&(clearTimeout(n),n=setTimeout((()=>{$("#elm_"+s).val(a[s])}),500));break;case"general":if(s.match(/\./)){let t=s.split(".");a.hasOwnProperty(t[0])||(a[t[0]]={}),console.debug(`Sub-Object property change! Source: ${s} Value: ${r} | Before: ${a[t[0]][t[1]]}`),a[t[0]][t[1]]=r,s.match(/clock\./)&&userClock(a.clock,e,!0)}else if("animation"==i.type)switch(s){default:const e="animation"==s?"source":s;console.debug(`Animation property change! Source: ${e} Value: ${r} | Before: ${configuration.animations[l.animation][e]}`),configuration.animations[l.animation][e]=r,console.debug(configuration.animations[l.animation]);break;case"line_radius":case"line_arc":console.debug(`Def Property changed! Source: ${s} Value: ${r} | Before: ${configuration.defs[l.def][s]}`),configuration.defs[l.def][s]=parseFloat(this.value),console.debug(configuration.defs[l.def]);let t=configuration.defs[l.def].id.split("_");console.debug(`Re-routing the line between Elments ${t[1]} and ${t[2]} with: Arc: ${configuration.defs[l.def].line_arc||20}% and Radius: ${configuration.defs[l.def].line_radius||15}`),calculatePath(configuration.defs[l.def].id,t[1],t[2]);break;case"frame":case"url":console.debug(`Line property change! Source: ${s} Value: ${r} | Before: ${configuration.lines[l.line][s]}`),configuration.lines[l.line][s]=r,console.debug(configuration.lines[l.line])}else u(0,s,r,"General")}$(this).hasClass("elm_config_update")&&c()})),$("#reconnect_elements").off().on("click",(async function(){e=await connectElements(this.id),l={animation:e.replace("line","anim"),def:e.replace("line_",""),line:e},console.debug(`After reconnect: ${JSON.stringify(l)}`),getElements("elm_select",l.line),$("#elm_select").selectmenu("refresh"),$(`#${l.line}`).addClass("active_element"),$(".type_rect, .type_circle").addClass("faded_out"),$("#restore_element").prop("disabled",!1),$("#elm_start_slot").val("element"==configuration.defs[l.def].startSlot?translateWord("value_element"):translateWord("value_"+configuration.defs[l.def].startSlot)),$("#elm_end_slot").val("element"==configuration.defs[l.def].endSlot?translateWord("value_element"):translateWord("value_"+configuration.defs[l.def].endSlot))})),$("#elm_icon").off().on("input",(function(){$(this).autocomplete({position:{my:"right top",at:"right bottom",collision:"fit"},classes:{"ui-autocomplete":"ui-autocomplete-icon"},source:function(e,t){$.ajax({minLength:1,url:"https://api.iconify.design/search?",type:"GET",data:{query:e.term},success:function(e){t($.map(e.icons,(function(e){return{label:e}})))}})},select:function(t,o){return iconHandler(e,o.item.value,!0),a.icon=o.item.value,o.item.value}}).autocomplete("instance")._renderItem=function(e,t){return $("<li class='ui-menu-item'>").append(`<div class='ui-menu-item-wrapper'><span class='iconify' data-width='24' data-icon='${t.label}'></span><span style='font-weight: normal; padding-left:10px;'>${t.label}</span></div>`).appendTo(e)}})),$(".preview_element").off().on("click",(async function(t){const o=configuration.elements[e];if(o.source>=0){let e=await new Promise(((e,t)=>{socket.emit("getState",configuration.datasources[o.source].source,((a,n)=>{n?(console.debug(`Pulled value from ioBroker: ${n.val}`),e(n.val)):t(`(PreviewElement) The state could not be received! Please check the associated Datasource: ${configuration.datasources[o.source].source}`)}))})).catch((e=>{console.error(e),failedMessage(sprintf(systemDictionary.failmsg_invalid_ds[systemLang],configuration.datasources[o.source].source))}));if("value"==o.fill_type&&o.fill_max>0||"value"==o.border_type&&o.border_max>0||-1!=o.fill_type||-1!=o.border_type){let a=getRandomInt(55);$(`<div id="tmpDiv_${a}" class="tmpDiv" />`).appendTo("body");let n=o.type,i=o.stroke,s=i+("rect"==n?o.width:2*o.radius),r=i+("rect"==n?o.height:2*o.radius);null!=e&&$(`#tmpDiv_${a}`).prop("title",translateWord("lbl_preview_element")).dialog({resizable:!1,width:s+50,maxHeight:"100%",modal:!0,classes:jQueryDialog.classes,open:jQueryDialog.open,beforeClose:jQueryDialog.beforeClose,create:async function(){$(this).html($(`<svg id='preview_${a}' width='${s}' height='${r}' style='width:100%;height:100%;display:block;' />`));let l=Object.assign({},o);l.pos_x=4+i/2+("rect"==n?0:s/2-i/2),l.pos_y=4+i/2+("rect"==n?0:r/2-i/2),l.id=`preview_elm_${a}`;let c=await svgElement(l,!1,!0);switch($(c).appendTo($(`#preview_${a}`)),t.target.id){case"preview_element_fill":addGradient(`preview_elm_${a}`,o.fill_value,o.fill,o.fill_direction),updateGradient(`preview_elm_${a}`,e,o.fill_max,o.fill_type);break;case"preview_element_border":addBorderFill(`preview_elm_${a}`,o.border_value,o.border_style,o.border_start),updateBorderFill(`preview_elm_${a}`,e,o.border_max,o.border_type,o.border_direction)}},buttons:[{text:translateWord("btn_close"),class:"input_button",click:function(){$(this).dialog("close")}}]})}else failedMessage(translateWord("failmsg_preview_element_not_all"))}else failedMessage(translateWord("failmsg_preview_element_no_ds"))})),$(".preview_action").off().on("click",(function(t){const o="animation"==i.type?configuration.lines[s.id]:configuration.elements[e];switch(t.target.id){case"preview_action_url":""!=o.url&&null!=o.url?actionForElement(e,t,"url"):failedMessage(translateWord("failmsg_preview_element_not_all"));break;case"preview_action_click":o.source>=0||o.source_action>=0?"none"==o.action||null==o.action?failedMessage(translateWord("failmsg_preview_element_no_action")):actionForElement(e,t,"click"):failedMessage(translateWord("failmsg_preview_element_no_ds"))}})),$("#manage_shortcuts").off().on("click",(function(){$("#shortcut-table").off();const e=(e,t)=>{let o=$(`<tr><td>${a.shortcuts[t].alias}</td><td>${a.shortcuts[t].value}</td><td><button class= 'all_datasource ds_buttons btn-update'><span class='iconify' data-height='24' data-icon='mdi:check'>Update</span></button><button class='all_datasource ds_buttons btn-cancel'><span class='iconify red_icon' data-height='24' data-icon='mdi:close'>Cancel</span></button><button class='all_datasource ds_buttons btn-edit'><span class='iconify' data-height='24' data-icon='mdi:pencil'>Edit</span></button><button class='all_datasource ds_buttons btn-delete'><span class='iconify red_icon' data-height='24' data-icon='mdi:delete'>Delete</span></button></td></tr>`).data({id:t,alias:a.shortcuts[t].alias,value:a.shortcuts[t].value});$("#shortcut-table tbody").append(o)};$("#frm-addQuickAccess").off().submit((function(t){t.preventDefault();let o=0;a.hasOwnProperty("shortcuts")?o=Object.keys(a.shortcuts).length>0?Math.max(...Object.keys(a.shortcuts).map((e=>e)))+1:0:a.shortcuts={},a.shortcuts[o]={alias:$("#shortcut_alias").val(),value:$("#shortcut_value").val()},$("#shortcut-table tbody").children().length>0&&$("#shortcut_tmp_line").hide(),e(0,o),$(this)[0].reset(),$(this)[0][0].focus(),globalConfigChanged=!0})),$("#shortcut-table").on("click",".btn-edit",(function(){let e=$(this).parents("tr"),t=`<div class="form_div no_margin"><input type="text" class="input_text" id="edit_shortcut_alias" name="edit_shortcut_alias" autocorrect="off" autocomplete="off" value="${e.data("alias")}"></div>`,o=`<div class="form_div no_margin"><input type="text" class="input_text" id="edit_shortcut_value" name="edit_shortcut_value" autocorrect="off" autocomplete="off" value="${e.data("value")}"></div>`;e.find("td:eq(0)").html(t),e.find("td:eq(1)").html(o),e.find(".btn-update, .btn-cancel").show(),e.find(".btn-delete, .btn-edit").hide()})),$("#shortcut-table").on("click",".btn-cancel",(function(){let e=$(this).parents("tr");e.find("td:eq(0)").text(e.data("alias")),e.find("td:eq(1)").text(e.data("value")),e.find(".btn-update, .btn-cancel").hide(),e.find(".btn-delete, .btn-edit").show()})),$("#shortcut-table").on("click",".btn-update",(function(){let e=$(this).parents("tr"),t=$("#edit_shortcut_alias").val(),o=$("#edit_shortcut_value").val();a.shortcuts[e.data("id")]={alias:t,value:o},e.find("td:eq(0)").text(t),e.find("td:eq(1)").text(o),e.find(".btn-update, .btn-cancel").hide(),e.find(".btn-delete, .btn-edit").show(),globalConfigChanged=!0})),$("#shortcut-table").on("click",".btn-delete",(function(){let e=$(this).parents("tr");delete a.shortcuts[e.data("id")],e.fadeOut("fast",(function(){$(this).remove();let e=$("#shortcut-table tbody").children();1==e.length&&"shortcut_tmp_line"==e[0].id&&$("#shortcut_tmp_line").fadeIn("fast")})),globalConfigChanged=!0})),$("#manage_shortcuts_section").dialog({resizable:!1,height:"auto",maxHeight:"100%",width:550,modal:!0,classes:jQueryDialog.classes,open:jQueryDialog.open,beforeClose:jQueryDialog.beforeClose,create:function(){if($("#shortcut-table tbody").children().not("#shortcut_tmp_line").remove(),$("#frm-addQuickAccess")[0].reset(),a.hasOwnProperty("shortcuts")){if(Object.keys(a.shortcuts).length>0){$("#shortcut_tmp_line").hide();const o=Object.entries(a.shortcuts).sort((([,e],[,t])=>e.alias.toLowerCase()<t.alias.toLowerCase()?-1:e.alias.toLowerCase()>t.alias.toLowerCase()?1:0));for(var t of o)e(0,t[0])}}else $("#shortcut_tmp_line").show()},buttons:[{text:translateWord("btn_close"),class:"input_button",click:function(){$(this).dialog("close")}}]})})),$(".override_settings").off().on("click",(function(e){let t;switch(e.target.id){case"override_settings":t="animation"==i.type?configuration.lines[l.line].override:a.override;break;case"override_settings_animation":t=configuration.animations[l.animation].override}aceOverride.setValue(JSON.stringify(t,void 0,4),-1),$("#loading").fadeIn(600),$(".loading-spinner, #loading_text").hide(),$("#codeEditorContainer").css({top:-60,opacity:0,display:"block"}),$("#codeEditorContainer").animate({opacity:1,top:25},{duration:600,queue:!1}),aceOverride.getSession().off("changeAnnotation"),aceOverride.getSession().on("changeAnnotation",(function(){let e=aceOverride.getSession().getAnnotations().filter((e=>"error"==e.type));$("#save_code").prop("disabled",e.length>0)})),aceOverride.focus(),$("#save_code").off().on("click",(function(){let t=aceOverride.getValue()?JSON.parse(aceOverride.getValue()):{};switch(e.target.id){case"override_settings":"animation"==i.type?configuration.lines[l.line].override=t:(a.override=t,c());break;case"override_settings_animation":configuration.animations[l.animation].override=t}hideCodeEditor(),$("#restore_element").prop("disabled",!1),globalConfigChanged=!0}))})),$("#export_element").off().on("click",(function(){exportElement(e)})),$("#overrideFormatCode").off().on("click",(function(e){try{aceOverride.setValue(JSON.stringify(JSON.parse(aceOverride.getValue()),void 0,4),-1)}catch(e){failedMessage(translateWord("msg_json_malformmated"))}})),$("#restore_element").off().click((async function(){let t=!1;$("#dialog_section").prop("title",translateWord("lbl_restore_element")).html(translateWord("msg_restore_element")).dialog({resizable:!1,height:"auto",maxHeight:"100%",width:400,modal:!0,classes:jQueryDialog.classes,open:jQueryDialog.open,beforeClose:jQueryDialog.beforeClose,buttons:[{text:translateWord("value_restore"),width:"auto",class:"input_button",click:async function(){if($(this).dialog("close"),"animation"===i.type)console.log("Opened Element: "+l.line+" Saved for restore: "+s.id),t=!!configuration.animations.hasOwnProperty(i.id),t||(console.debug(`Line was reconnected during configuration. Restoring previous one (${s.id}) and deleting new one (${e})!`),delete configuration.defs[l.def],delete configuration.lines[l.line],delete configuration.animations[l.animation],$(`#${l.def}, #${l.line}, #${l.animation}`).remove()),configuration.defs[r.id]=r,configuration.lines[s.id]=s,configuration.animations[i.id]=i,await svgElement(configuration.defs[r.id],t),await svgElement(configuration.lines[s.id],t),await svgElement(configuration.animations[i.id],t),showConfigBar(s.id,"use");else console.debug("Restore Obj: ",i),t=!!configuration.elements.hasOwnProperty(e),configuration.elements[e]=i,await svgElement(configuration.elements[e],t,!1,(function(){showConfigBar(e,i.type)}))}},{text:translateWord("value_cancel"),class:"input_button red",click:function(){$(this).dialog("close")}}]})})),$(".form_label").removeClass("form_label").addClass("form_label")}function hideConfigBar(){$(".all_elements").removeClass("faded_out active_element"),$("#config_bar").removeClass("show"),$(".elm_config").off().val(""),$("#tab1_config").prop("checked",!0),$("#elm_select").val(""),$(".ui-dialog").remove()}function closeEditorContainer(e){$("#loading").fadeOut(600),$(`#${e}Container`).animate({opacity:0,top:-60},{duration:600,queue:!1,complete:function(){$(this).hide(),"stateExplorer"==e&&($(".state").removeClass("active"),$(".state").children(".type").removeClass("file-selected"),$(".sub").hide(),$(".type.folderOpen").removeClass("folderOpen").addClass("folderClosed"),$(".stateExplorerFilter").val("").trigger("keyup")),"frame"==e&&$("#overlay_frame").remove()}}),$(`#${e}`).scrollTop(0)}function hideStateExplorer(){$("#loading").fadeOut(600),$("#stateExplorerContainer").animate({opacity:0,top:-60},{duration:600,queue:!1,complete:function(){$(this).hide()}}),$("#stateExplorer").scrollTop(0),$(".state").removeClass("active"),$(".state").children(".type").removeClass("file-selected")}function hideCodeEditor(){$("#loading").fadeOut(600),$("#codeEditorContainer").animate({opacity:0,top:-60},{duration:600,queue:!1,complete:function(){$(this).hide()}}),$("#codeEditor").scrollTop(0)}function iconHandler(e,t,o=!1){let a=$("<symbol />");$.each($("#"+e).prop("attributes"),(function(){a.attr(this.name,this.value)}));let n=t.split("?");if(n[1]){t=n[0];const e=new URLSearchParams(n[1]);a.attr({"data-icon":t,"data-flip":e.get("flip"),"data-rotate":e.get("rotate")})}else a.attr({"data-icon":t,"data-flip":configuration.elements[e].flip,"data-rotate":configuration.elements[e].rotate});$("#"+e).data("icon")==t&&1!=o||$("#"+e).replaceWith(a)}async function svgElement(e,t=!1,o=!1,a){let n=e.shadow?`filter: drop-shadow(0px 3px 3px ${e.shadow});`:"",i=`all_elements added_elements ${e.css_general||""}`;switch(displayMode?(e.url||e.action&&"none"!=e.action)&&(i+=" action_element"):i+=" draggable",e.type){case"rect":let a=document.createElementNS("http://www.w3.org/2000/svg","rect");if(a.setAttribute("x",e.pos_x),a.setAttribute("y",e.pos_y),a.setAttribute("width",e.width),a.setAttribute("height",e.height),a.setAttribute("rx",e.rx),a.setAttribute("class",i+" type_rect connector"),a.setAttribute("id",e.id),a.setAttribute("style",`stroke: ${e.color}; stroke-width:${e.stroke}px; fill:${e.fill}; ${n}`),o)return a;t?$("#"+e.id).replaceWith(a):$(a).appendToWithIndex($("#placeholder_elements"),e.position);break;case"circle":let s=document.createElementNS("http://www.w3.org/2000/svg","circle");if(s.setAttribute("cx",e.pos_x),s.setAttribute("cy",e.pos_y),s.setAttribute("r",e.radius),s.setAttribute("class",i+" type_circle connector"),s.setAttribute("id",e.id),s.setAttribute("style",`stroke:${e.color}; stroke-width:${e.stroke}px; fill:${e.fill}; ${n}`),o)return s;t?$("#"+e.id).replaceWith(s):$(s).appendToWithIndex($("#placeholder_elements"),e.position);break;case"text":let r=document.createElementNS("http://www.w3.org/2000/svg","text");const l=e.degree?` transform-box: fill-box; transform: rotate(${e.degree}deg);`:"";if(r.setAttribute("x",e.pos_x),r.setAttribute("y",e.pos_y),r.setAttribute("id",e.id),r.setAttribute("dominant-baseline","central"),r.setAttribute("style",`stroke:${e.color}; fill:${e.fill}; font-family:${e.font_family}; text-anchor:${e.align}; transform-origin:50% 50%; font-size:${e.font_size}px; ${l} ${n}`),"datasource"==e.subType){let t=-1!=e.source?Number(0).toFixed(e.decimal_places):e.text;r.setAttribute("class",i+" type_datasource"),"own_text"==e.source_display&&(t=e.text),r.innerHTML=`<tspan id='${e.id}_prepend'>${generateMultiLineText(e.id+"_prepend",e.prepend,e.pos_x)}</tspan><tspan id='${e.id}_value'>${generateMultiLineText(e.id+"_value",t,e.pos_x)}</tspan><tspan id='${e.id}_append'>${generateMultiLineText(e.id+"_append",e.append,e.pos_x)}</tspan><tspan id='${e.id}_unit'> ${generateMultiLineText(e.id+"_unit",e.unit,e.pos_x)}</tspan>`}else r.setAttribute("class",i+" type_text"),e.enable_clock?(r.innerHTML=userClock(e.clock,e.id,!0),displayMode&&(userClock(e.clock,e.id),console.log("[Config] Activating UserClock for "+e.id))):r.innerHTML=generateMultiLineText(e.id,e.text,e.pos_x);t?$("#"+e.id).replaceWith(r):$(r).appendToWithIndex($("#placeholder_text"),e.position);break;case"svg":case"icon":let c=document.createElementNS("http://www.w3.org/2000/svg","symbol");"svg"==e.subType?(c=document.createElementNS("http://www.w3.org/2000/svg","svg"),c.setAttribute("class",i+" type_svg"),c.setAttribute("viewBox",e.viewBox||`0 0 ${e.width} ${e.height}`),c.innerHTML=e.svg_content):(c.setAttribute("class",i+" type_icon iconify"),c.setAttribute("data-icon",e.icon),c.setAttribute("data-width",e.width),c.setAttribute("data-height",e.height),c.setAttribute("data-rotate",e.rotate||0),c.setAttribute("data-flip",e.flip||"")),c.setAttribute("x",e.pos_x),c.setAttribute("y",e.pos_y),c.setAttribute("id",e.id),c.setAttribute("width",e.width),c.setAttribute("height",e.height),c.setAttribute("style",`color: ${e.color}; ${n}`),"svg"==e.subType?t?$("#"+e.id).replaceWith(c):$(c).appendToWithIndex($("#placeholder_elements"),e.position):t?$("#"+e.id).replaceWith(c):$(c).appendToWithIndex($("#placeholder_icons"),e.position);break;case"image":const d=await receiveImage(e.href);let u=document.createElementNS("http://www.w3.org/2000/svg","image");u.setAttribute("class",i+" type_image"),u.setAttribute("x",e.pos_x),u.setAttribute("y",e.pos_y),u.setAttribute("id",e.id),u.setAttribute("preserveAspectRatio",e.preserveAspectRatio),u.setAttribute("width",e.width),u.setAttribute("height",e.height),u.setAttribute("href",d),u.setAttribute("style",`${n} ${"#"==d?"display: none;":""}`),t?$("#"+e.id).replaceWith(u):$(u).appendToWithIndex($("#placeholder_elements"),e.position);break;case"foreignObject":let p=document.createElementNS("http://www.w3.org/2000/svg","foreignObject");p.setAttribute("class",i+" type_fObj"),p.setAttribute("x",e.pos_x),p.setAttribute("y",e.pos_y),p.setAttribute("id",e.id),p.setAttribute("width",e.width),p.setAttribute("height",e.height),p.setAttribute("style",`color: ${e.color}; ${n}`),p.innerHTML=e.fObj_content,t?$("#"+e.id).replaceWith(p):$(p).appendToWithIndex($("#placeholder_elements"),e.position);break;case"def":let g=document.createElementNS("http://www.w3.org/2000/svg","path");g.setAttribute("id",e.id),g.setAttribute("class","type_def"),g.setAttribute("d",e.d),t?$("#"+e.id).replaceWith(g):$(g).appendTo("#placeholder_defs");break;case"line":i="line type_line all_elements",displayMode?(e.url||e.action&&"none"!=e.action)&&(i+=" action_element"):i+=" line_cfg";let f=document.createElementNS("http://www.w3.org/2000/svg","use");f.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",e.href),f.setAttribute("id",e.id),f.setAttribute("class",i),f.setAttribute("style",`stroke:${e.color}; ${n}`),t?$("#"+e.id).replaceWith(f):$(f).appendTo("#placeholder_lines");break;case"animation":i=`type_animation all_elements anim_element ${e.css_general||""}`,i+=1==configuration.basic.enable_animation?" animation animation_cfg":" animation no_animation";let m=document.createElementNS("http://www.w3.org/2000/svg","use");m.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",e.href),m.setAttribute("id",e.id),m.setAttribute("class",i),m.setAttribute("style",`stroke:${e.color};`),t?$("#"+e.id).replaceWith(m):$(m).appendTo("#placeholder_animations")}"function"==typeof a&&a(e.id,e.type)}function getMaxID(){return Object.keys(configuration.elements).length>0?Math.max(...Object.keys(configuration.elements).map((e=>e)))+1:0}function getRandomInt(e){return Math.floor(Math.random()*e)}function getRandomRGBA(){var e=Math.round,t=Math.random;return"rgba("+e(255*t())+","+e(255*t())+","+e(255*t())+",1)"}function addDataSourceRow(e,t=!1){let o=$(`<tr class="highlight-green" data-source="${configuration.datasources[e].source}" data-alias="${configuration.datasources[e].alias}" data-id="${e}" data-factor="${configuration.datasources[e].factor}"><td>${configuration.datasources[e].alias}</td><td>${configuration.datasources[e].source}</td><td>${configuration.datasources[e].factor}</td><td><button class='all_datasource ds_buttons btn-update'><span class='iconify' data-height='24' data-icon='mdi:check'>Update</span></button><button class='all_datasource ds_buttons btn-cancel'><span class='iconify red_icon' data-height='24' data-icon='mdi:close'>Cancel</span></button><button class='all_datasource ds_buttons btn-edit'><span class='iconify' data-height='24' data-icon='mdi:pencil'>Edit</span></button><button class='all_datasource ds_buttons btn-delete'><span class='iconify red_icon' data-height='24' data-icon='mdi:delete'>Delete</span></button></td></tr>`);if(t){let t=$("#datasource-table th").eq(0).children(".sort_icon").is(":not(:empty)")?0:1,a=$(`#datasource-table tr td:nth-child(${t+1})`).map((function(){return $(this).text().toLowerCase()})).get(),n=$("#datasource-table th").eq(t).prop("asc"),i=0===t?configuration.datasources[e].alias.toLowerCase():configuration.datasources[e].source.toLowerCase();a.push(i);let s=a.sort();!1===n&&(s=s.reverse());let r=s.indexOf(i);$("#datasource-table tbody tr").length>r?$(`#datasource-table tbody tr:nth-child(${r+1})`).before(o.hide()):$("#datasource-table tbody").append(o.hide()),o.fadeIn(2e3)}else $("#datasource-table tbody").append(o);setTimeout((()=>{$(o).removeClass("highlight-green")}),4e3),$("#ds_tmp_line").remove()}function checkDuplicateDatasource(e){return Object.keys(configuration.datasources).find((t=>configuration.datasources[t].source.toLowerCase()===e.toLowerCase()))}function getdataSourceCellValue(e,t){return $(e).children("td").eq(t).text()}function dataSourceComparer(e){return function(t,o){var a=getdataSourceCellValue(t,e),n=getdataSourceCellValue(o,e);return $.isNumeric(a)&&$.isNumeric(n)?a-n:a.toString().localeCompare(n)}}function loadAdditionalJSFile(e){var t=document.createElement("script");t.type="text/javascript",t.src=e,t.onload=function(){console.log("[Config] Loaded additional file: "+e)},document.body.appendChild(t)}function setTheme(e){if("false"!=e&&""!=e){let t=document.createElement("link");t.id="theme_mode",t.rel="stylesheet",t.href=`style/${e}.css`,t.onload=function(){console.log("[Config] Loaded theme: "+e)},document.head.appendChild(t)}}function generateMultiLineText(e,t,o){let a="";if(t)if(isNaN(t))if(t.includes("<br>")||t.includes("\n")){let n;t.includes("<br>")&&(n=t.split("<br>")),t.includes("\n")&&(n=t.split("\n")),n.length>0&&((e.toString().includes("append")||e.toString().includes("unit")||e.toString().includes("prepend"))&&(a+=`<tspan id="${e}_line_tmp" x="${o}" dy="1em"></tspan>`),n.forEach((function(t,n){a+=`<tspan id="${e}_line_${n}" x="${o}" dy="1em">${t}</tspan>`})))}else a=`<tspan id="${e}_line_0">${t}</tspan >`;else a=`<tspan id="${e}_line_0">${t}</tspan >`;return a}async function saveWorkspace(){return new Promise(((e,t)=>{socket.emit("sendTo",appProperties.namespace,"_saveConfiguration",configuration,(function(o){o&&o.error?(console.log("An error occured, while saving the backup. The following error was provided: ",o.error),t("")):(console.log(o.data),getBackups("backup_list"),e(configuration))}))}))}function getBackups(e){socket.emit("sendTo",appProperties.namespace,"_getBackups",{},(function(t){if(t&&t.error)console.log("An error occured, while receiving the backups. The following error was provided: ",t.error);else{let o;t.data.sort(((e,t)=>-1*e.localeCompare(t))),$("#"+e).empty().append(new Option(translateWord("opt_please_choose"),"-1")),t.data.length>0?t.data.forEach((t=>{let a=new Date(parseInt(t)).toLocaleString("de-DE",{hour:"numeric",minute:"numeric",day:"2-digit",month:"2-digit",year:"numeric",second:"2-digit",hour12:!1});o=new Option(a,t),$("#"+e).append(o)})):($("#"+e).empty(),o=new Option(translateWord("opt_no_backups"),-1),$("#"+e).append(o))}}))}async function duplicateItems(e,t=!1){if(e.length>0){globalConfigChanged=!0;let o=[];for(let a=0;a<e.length;a++){const n=getMaxID();let i=JSON.parse(JSON.stringify(configuration.elements[e[a]]));i.id=n,i.pos_x=configuration.basic.width<parseInt(i.pos_x)+(i.width||2*i.radius)+15?parseInt(i.pos_x)-15:parseInt(i.pos_x)+15,i.pos_y=parseInt(i.pos_y)+15,configuration.elements[n]=i,saveUndoStep("add",i,""),1==e.length?svgElement(configuration.elements[n],!1,!1,(function(e,o){appProperties.isMobile||(showConfigBar(e,o),t&&successMessage(translateWord("succ_msg_duplicate")),globalMoving=[n])})):await svgElement(configuration.elements[n],!1,!1,(function(e,t){o.push(e)}))}if($(".draggable").removeClass("draggable-multi dragging"),o.length>0){globalMoving=o,t&&successMessage(translateWord("succ_msg_duplicate")),hideConfigBar();for(let e=0;e<o.length;e++)$(`#${o[e]}`).addClass("draggable-multi")}}}function saveUndoStep(e,t,o){globalRedoStack=[],$("#edit_redo").addClass("not_active"),globalUndoStack.push({action:e,oldProps:t,newProps:o}),$("#edit_undo").removeClass("not_active")}function undoStep(){if(globalUndoStack.length>0){hideConfigBar(),$(".draggable-multi").removeClass("draggable-multi");const e=globalUndoStack.pop();switch(globalRedoStack.push(e),$("#edit_redo").removeClass("not_active"),e.action){case"add":e.oldProps.id&&(delete configuration.elements[e.oldProps.id],$(`#${e.oldProps.id}`).remove()),3==Object.keys(e.oldProps).length&&(delete configuration.defs[e.oldProps.def.id],delete configuration.lines[e.oldProps.line.id],delete configuration.animations[e.oldProps.animation.id],$(`#${e.oldProps.def.id}, #${e.oldProps.line.id}, #${e.oldProps.animation.id}`).remove());break;case"move":moveSVGElement(e.oldProps,{x:e.oldProps.x,y:e.oldProps.y}),$("#placeholder_coordinate_desc").children().fadeOut("fast",(function(){$(this).remove()}));break;case"delete":e.oldProps.id&&(configuration.elements[e.oldProps.id]=e.oldProps,svgElement(e.oldProps)),3==Object.keys(e.oldProps).length&&(configuration.defs[e.oldProps.def.id]=e.oldProps.def,configuration.lines[e.oldProps.line.id]=e.oldProps.line,configuration.animations[e.oldProps.animation.id]=e.oldProps.animation,svgElement(configuration.defs[e.oldProps.def.id]),svgElement(configuration.lines[e.oldProps.line.id]),svgElement(configuration.animations[e.oldProps.animation.id]))}console.debug("Undo requested. Performing:",e.action),0===globalUndoStack.length&&$("#edit_undo").addClass("not_active")}}function redoStep(){if(globalRedoStack.length>0){hideConfigBar(),$(".draggable-multi").removeClass("draggable-multi");const e=globalRedoStack.pop();switch(globalUndoStack.push(e),$("#edit_undo").removeClass("not_active"),e.action){case"add":e.oldProps.id&&(configuration.elements[e.oldProps.id]=e.oldProps,svgElement(e.oldProps)),3==Object.keys(e.oldProps).length&&(configuration.defs[e.oldProps.def.id]=e.oldProps.def,configuration.lines[e.oldProps.line.id]=e.oldProps.line,configuration.animations[e.oldProps.animation.id]=e.oldProps.animation,svgElement(configuration.defs[e.oldProps.def.id]),svgElement(configuration.lines[e.oldProps.line.id]),svgElement(configuration.animations[e.oldProps.animation.id]));break;case"move":moveSVGElement(e.newProps,{x:e.newProps.x,y:e.newProps.y});break;case"delete":e.oldProps.id&&(delete configuration.elements[e.oldProps.id],$(`#${e.oldProps.id}`).remove()),3==Object.keys(e.oldProps).length&&(delete configuration.defs[e.oldProps.def.id],delete configuration.lines[e.oldProps.line.id],delete configuration.animations[e.oldProps.animation.id],$(`#${e.oldProps.def.id}, #${e.oldProps.line.id}, #${e.oldProps.animation.id}`).remove())}console.debug("Redo requested. Performing:",e.action),0===globalRedoStack.length&&$("#edit_redo").addClass("not_active")}}async function actionForElement(e,t,o=""){const a="string"==typeof e&&e.includes("line_")?configuration.lines[e]:configuration.elements[e];if("none"!=a.action&&!o||"click"==o){let s=a.source_action>=0?a.source_action:a.source;if(configuration.datasources.hasOwnProperty(s)){let r=configuration.datasources[s].source;switch(a.action){case"default":case"none":break;case"toggle":socket.emit("getState",r,(function(e,t){e?console.log("An error occured, while getting the state. The following error was provided: "+e):"boolean"==typeof t.val?socket.emit("setState",r,{val:!t.val,ack:!1},(function(e,t){e&&console.log("An error occured, while toggling the state. The following error was provided: "+e)})):console.error("This state can not be handled, because it is not a boolean state!")}));break;case"on":socket.emit("setState",r,{val:!0,ack:!1},(function(e){e&&console.log(`An error occured, while setting the state. The following error was provided: ${e}`)}));break;case"off":socket.emit("setState",r,{val:!1,ack:!1},(function(e){e&&console.log(`An error occured, while setting the state. The following error was provided: ${e}`)}));break;case"change":function l(e){socket.emit("setState",r,{val:e,ack:!1},(function(t,o){t&&console.log(`An error occured, while setting the state. The following error was provided: ${t}`),console.debug(`${e} submitted to host for state ${o}`)}))}let c=await new Promise(((e,t)=>{socket.emit("getState",r,((o,a)=>{a?(console.debug(`Pulled value from ioBroker: ${a.val}`),e(a.val)):t(`(ClickAction) The state could not be received! Please check the associated Datasource: ${r}`)}))})).catch((e=>{console.error(e),failedMessage(sprintf(systemDictionary.failmsg_invalid_ds[systemLang],r))})),d=[{text:translateWord("value_set_value"),class:"input_button",click:function(){l($("#shortcuts\\.action\\.value").val()),$(this).dialog("close")}},{text:translateWord("value_cancel"),class:"input_button red",click:function(){$(this).dialog("close")}}];if(a.hasOwnProperty("action_display_freeform")?($("#shortcuts\\.action").toggle(a.action_display_freeform),a.action_display_freeform||d.shift()):($("#shortcuts\\.action").toggle(!1),d.shift()),$("#shortcuts\\.action\\.value").attr("type",a.action_type).val(c),a.hasOwnProperty("shortcuts"))if(Object.keys(a.shortcuts).length>0){let u,p;const g=Object.entries(a.shortcuts).sort((([,e],[,t])=>e.alias.toLowerCase()<t.alias.toLowerCase()?-1:e.alias.toLowerCase()>t.alias.toLowerCase()?1:0));switch(a.action_display){default:case"button":for(var n of(u=$(`<span class="shortcuts_additional_buttons">${translateWord("shortcuts_additional_buttons")}</span>`),p=$("<div id='shortcuts_additional_buttons' />"),g)){let m;switch(typeof c){case"undefined":m="shortcut_inactive";break;case"string":m=n[1].value.toLowerCase()==c.toLowerCase()?"":"shortcut_inactive";break;case"number":m=parseInt(n[1].value)==c?"":"shortcut_inactive";break;case"boolean":m=n[1].value.toString().toLowerCase()==c.toString().toLowerCase()?"":"shortcut_inactive"}p.append($(`<input type="button" title="${n[1].alias}" class="input_button autowidth shortcuts.button ${m}" data-value="${n[1].value}" value="${n[1].alias||n[1].value}">`))}u.append(p);break;case"select":u=$('<div class="contentBox" />'),p=$('<div class="form_div select" />'),p.append($(`<label for="shortcuts.value.select" class="form_label">${translateWord("shortcuts_additional_buttons")}</label>`));let f=$('<select class="input_select" id="shortcuts.select" />');for(var n of g)f.append($("<option>",{value:n[1].value,text:n[1].alias||n[1].value,selected:n[1].value==c}));p.append(f),u.append(p)}$("#shortcuts\\.elements").show().html(u)}else $("#shortcuts\\.elements").hide().html("");else $("#shortcuts\\.elements").hide().html("");null!=c&&$("#action_change_value").dialog({title:configuration.datasources[s].alias||configuration.datasources[s].source,position:{my:"right-5 bottom-10",at:"left top",of:t,collision:"fit"},resizable:!1,height:"auto",maxHeight:"100%",width:"auto",modal:!0,classes:jQueryDialog.classes,open:jQueryDialog.open,beforeClose:jQueryDialog.beforeClose,create:function(){$("#shortcuts\\.action").is(":visible")&&$("#shortcuts\\.action\\.value").off().on("keypress",(function(e){13==(e.keyCode?e.keyCode:e.which)&&$(".ui-dialog-buttonset").children().first().click()})),$(".shortcuts\\.button").length>0&&$(".shortcuts\\.button").off().on("click",(function(){$("#shortcuts\\.action\\.value").val($(this).data("value")),$("#shortcuts\\.action").is(":hidden")&&(l($(this).data("value")),$(".ui-dialog-buttonset").children().first().click()),$(".shortcuts\\.button").addClass("shortcut_inactive"),$(this).toggleClass("shortcut_inactive"),$(this).blur()})),$("#shortcuts\\.select").length>0&&$("#shortcuts\\.select").off().on("change",(function(){$("#shortcuts\\.action\\.value").val($(this).val()),$("#shortcuts\\.action").is(":hidden")&&(l($(this).val()),$(".ui-dialog-buttonset").children().first().click())}))},buttons:d})}}else console.warn(`Element ${e} is configured to use Action '${a.action}' but it has no valid datasource assigned!`)}if(("none"==a.action||!a.hasOwnProperty("action"))&&""!=a.url&&null!=a.url&&!o||"url"==o){switch(a.frame){case"_blank":case"_self":if(o&&"_self"==a.frame)failedMessage(translateWord("failmsg_opening_frame_preview"));else{var i=window.open(a.url,a.frame);i?i.focus():failedMessage(translateWord("failmsg_opening_frame"))}break;default:displayLoading(translateWord("msg_loading_url"));const h=$(`<iframe id="overlay_frame" src="${a.url}" class="framed scrollbar" sandbox="allow-forms allow-modals allow-popups allow-same-origin allow-scripts allow-top-navigation" />`).on("load",(function(){""!=$(this).attr("src")&&($(".loading-spinner, #loading_text").fadeOut("fast"),$("#frameContainer").css({top:-60,opacity:0,display:"block"}),$("#frameContainer").animate({opacity:1,top:25},{duration:600,queue:!1}),$(this).off())}));$("#frameContainer").append(h)}console.log(`URL found! ${a.url} Frame: ${a.frame}`)}}function wrapUploadImage(e,t){let o=$(`<div class="imgContainer" id="${e}" />`),a=$('<div class="uploads_img" />'),n=$('<div class="uploads_name" />').attr("title",e).text(e),i=$('<div class="uploads_btn" />'),s=$("<input />",{type:"button",class:"input_button delete_upload",value:translateWord("value_delete")});i.append(s);var r=$("<img />",{src:appProperties.socketURL+appProperties.namespace+"/userFiles"+t+e,alt:e});return a.append(r),o.append(a,n,i),o}function getUserImages(){var e=new XMLHttpRequest;e.onload=function(){if(200==this.status){let t=JSON.parse(e.responseText),o=t.files,a=t.path;if(o.length>0){$("#userImages_dummy").hide(),$("#userImages div.imgContainer").remove(),globalUserImages=o,console.debug(`[Config] Using ${a} for userFiles!`);for(let e=0;e<o.length;e++)$("#userImages").append(wrapUploadImage(o[e],a))}}},e.open("GET",appProperties.socketURL+appProperties.namespace+"/?serve=getUploads",!0),e.send()}function deleteUserImage(e){var t=new XMLHttpRequest;t.onload=function(){if(200==this.status){let o=JSON.parse(t.responseText);if(o&&o.error)console.log("An error occured, while deleting the upload! The following error was provided: ",res.error);else{let t=o.filename.replaceAll(".","\\.");$(`#${t}`).fadeOut("fast",(function(){$(this).remove(),0==$("#userImages div").length&&$("#userImages_dummy").fadeIn("fast"),globalUserImages=globalUserImages.filter((t=>t!=e))}))}}},t.open("GET",appProperties.socketURL+appProperties.namespace+`/?serve=deleteUpload&image=${e}`,!0),t.send()}function startIconObserver(){new MutationObserver((function(e){const t=[];for(const{addedNodes:o}of e)for(const e of o)e.tagName&&"svg"!=e.tagName.toLowerCase()&&(e.classList.contains("iconify")?t.push(e):e.firstElementChild&&t.push(...e.getElementsByClassName("iconify")));t.forEach((function(e,t){$(e).data("icon")&&loadIconViaProxy($(e).data("icon"),$(e))}))})).observe(document,{childList:!0,subtree:!0})}function loadIconViaProxy(e,t){if(e&&"svg"!=$(t).prop("tagName"))try{var o=new XMLHttpRequest;let a=`icon=${e}&width=${t.data("width")||24}&height=${t.data("height")||24}&flip=${t.data("flip")||""}&rotate=${t.data("rotate")||0}`;o.open("GET",appProperties.socketURL+appProperties.namespace+`/?serve=icon&${a}`,!0),o.onload=function(){if(200==this.status){let e=JSON.parse(o.responseText),a=$($.parseHTML(e.icon)),n=t.attr("title");"Icon not found!"==e.message&&(n=e.message),a.data(t.data()).attr({id:t.attr("id"),class:t.attr("class"),style:t.attr("style"),title:n,x:t.attr("x"),y:t.attr("y"),width:t.attr("width"),height:t.attr("height")}).data("icon_status",e.status),t.replaceWith(a)}},o.onerror=function(){console.error(`Error while receiving icon "${e}" Error: ${this.status}`)},o.send()}catch(e){console.log("Error! "+e)}}function makeDraggable(e){let t,o={},a="tab1",n=!1,i=!1,s=!1,r=!1,l=!1,c=e.target,d=null,u=!1,p=null,g=!1;function f(e){u=!0,e.preventDefault(),1===globalMoving.length?$("#ctx_export").removeClass("not_active"):$("#ctx_export").addClass("not_active"),globalMoving.length>0?$("#ctx_copy").removeClass("not_active"):$("#ctx_copy").addClass("not_active"),globalClipboard.length>0?$("#ctx_paste").removeClass("not_active"):$("#ctx_paste").addClass("not_active");const t=document.body;e.touches&&(e=e.touches[0]);const o={top:t.clientHeight<e.pageY+120?e.pageY-120:e.pageY,left:t.clientWidth<e.pageX+170?e.pageX-170:e.pageX};$("#mouse_contextmenu").css({top:o.top,left:o.left+15,display:"block"})}function m(){$("#svg_config_div").removeClass("noscroll")}function h(){$(".draggable-multi").removeClass("draggable-multi dragging"),$(".line").removeClass("not_selectable")}function _(){o={},d=null,p=null,l=!1,n=!1}function b(e,t,o,a){$(`#coord_desc_div_${e.id}`).text(t);const n=Number(e.stroke)/2;let i="circle"==e.type||"text"==e.type?o-Number(e.width)/2-n:o-n,s="circle"==e.type||"text"==e.type?a-Number(e.height)/2-n:a-n;const r=$(`#coord_desc_div_${e.id}`),l=Math.round(r.width())+12,c=Math.round(r.height())+20;i=i+l>configuration.basic.width?i-l:Math.max(i,4),s=s<c?s+e.height+2*n+10:s-32,$(`#coord_desc_${e.id}`).attr({x:i,y:s})}function y(e){if(globalMoving.forEach((t=>{o[t]=getElementCoords(t,e)})),configuration.basic.enable_show_coordinates){const e=o[globalMoving[0]];if(0==$(`#coord_desc_${e.id}`).length){$("#placeholder_coordinate_desc").empty();let t=document.createElementNS("http://www.w3.org/2000/svg","foreignObject");t.setAttribute("id",`coord_desc_${e.id}`),t.setAttribute("width",1),t.setAttribute("height",1),t.setAttribute("class","coord_desc"),t.innerHTML=`<div id='coord_desc_div_${e.id}'>X: ${e.x} | Y: ${e.y}</div>`,$(t).hide().fadeIn("fast").appendTo("#placeholder_coordinate_desc")}b(e,`X: ${e.x} | Y: ${e.y}`,e.x,e.y)}n=!1}function v(e){if(u=2===e.button,u||$("#mouse_contextmenu").fadeOut(200),appProperties.isMobile&&(g||(g=setTimeout(f,500,e))),a=2===e.detail?"tab2":"tab1",$(e.target).hasClass("line")&&l?(e.stopPropagation(),failedMessage(translateWord("failmsg_drag_no_line"))):p=$(e.target).attr("id"),$(e.target).closest(".draggable-multi").length>0&&(1==$(e.target).closest(".draggable-multi").length&&(d=globalMoving[0]),y(e)),$(e.target).closest(".draggable:not(.draggable-multi)").attr("id")){const t=Number($(e.target).closest(".draggable").attr("id"));if(t>=0){if(l){$(".active_element").addClass("draggable-multi"),hideConfigBar();const e=globalMoving.indexOf(t);e>-1?(globalMoving.splice(e,1),$(`#${t}`).removeClass("draggable-multi")):(globalMoving.push(t),$(`#${t}`).addClass("draggable-multi"))}else _(),h(),globalMoving=[t],y(e),$(`#${t}`).addClass("draggable-multi");d=t}}e.target.classList.contains("lasso")&&(s=!0,t=getMousePosition(e),_(),h(),$("#placeholder_coordinate_desc").children().fadeOut("fast",(function(){$(this).remove()})),globalMoving=[],hideConfigBar())}function w(e){appProperties.isMobile&&($("#mouse_contextmenu").hide(),g&&(clearTimeout(g),g=!1));const a=getMousePosition(e);if(s)if(i=!0,r)$("#lasso_rect").attr({x:Math.min(t.x,a.x),y:Math.min(t.y,a.y),width:Math.abs(t.x-a.x),height:Math.abs(t.y-a.y)});else{let e=document.createElementNS("http://www.w3.org/2000/svg","rect");e.setAttribute("x",t.x),e.setAttribute("y",t.y),e.setAttribute("width",0),e.setAttribute("height",0),e.setAttribute("rx",0),e.setAttribute("id","lasso_rect"),e.setAttribute("style","stroke: var(--primary); stroke-width: 2px; fill: var(--secondary); fill-opacity:0.2;"),$(e).appendTo("#placeholder_lasso"),r=!0}else{if($("#align_elements").is(":visible"))return;if(l&&86==e.keyCode&&(globalClipboard.length>0?($(".draggable-multi").removeClass("draggable-multi"),duplicateItems(globalClipboard,!1)):failedMessage(translateWord("failmsg_no_elements_clipboard"))),46==e.keyCode&&(p||globalMoving.length>0)&&$("#dialog_section").prop("title",translateWord("lbl_delete_elements")).html(translateWord("msg_delete_elements")).dialog({resizable:!1,height:"auto",maxHeight:"100%",classes:jQueryDialog.classes,width:400,modal:!0,open:jQueryDialog.open,beforeClose:jQueryDialog.beforeClose,buttons:[{text:translateWord("value_delete"),class:"input_button red",click:async function(){let e=0,t=globalMoving.length;if(p){let e={animation:p.replace("line","anim"),def:p.replace("line_",""),line:p};saveUndoStep("delete",{animation:configuration.animations[e.animation],def:configuration.defs[e.def],line:configuration.lines[e.line]},""),delete configuration.defs[e.def],delete configuration.lines[e.line],delete configuration.animations[e.animation],$(`#${e.def}, #${e.line}, #${e.animation}`).remove(),p=null,t=0}else{[...globalMoving].forEach((t=>{if(0==lineConnection(t).length){saveUndoStep("delete",configuration.elements[t],""),delete configuration.elements[t],$(`#${t}`).remove();const o=globalMoving.indexOf(t);o>-1&&globalMoving.splice(o,1),e++}}))}e===t?successMessage(translateWord("succ_msg_selection_delete")):failedMessage(translateWord("failmsg_selection_delete")),$("#placeholder_coordinate_desc").empty(),$(this).dialog("close"),hideConfigBar()}},{text:translateWord("value_cancel"),class:"input_button",click:function(){$(this).dialog("close")}}]}),globalMoving.length>0&&(l?e.target.classList.contains("line")&&$(e.target).addClass("not_selectable"):$(e.target).removeClass("not_selectable"),e.keyCode&&(38==e.keyCode||40==e.keyCode||39==e.keyCode||37==e.keyCode?0==Object.keys(o).length&&y(e):l&&67==e.keyCode&&(Object.keys(o).some((e=>e.includes("line_")))?failedMessage(translateWord("failmsg_duplicate_no_line")):(successMessage(sprintf(systemDictionary.msg_copy_elements[systemLang],globalMoving.length)),globalClipboard=globalMoving,o={}))),Object.keys(o).length>0)){for(var c of($("#svg_config_div").addClass("noscroll"),$(".anim_element").removeClass("animation_cfg").addClass("no_animation"),hideConfigBar(),Object.keys(o))){let t=o[c],n=configuration.elements[c],i={x:a.x-t.offset.x,y:a.y-t.offset.y},s={x:"-",y:"-"};if($("#"+t.id).addClass("dragging"),isNaN(i.x)){let t={x:0,y:0};switch(e.keyCode){case 39:t.x=1;break;case 37:t.x=-1;break;case 38:t.y=-1;break;case 40:t.y=1}i={x:n.pos_x+t.x,y:n.pos_y+t.y}}const r=checkElementBounds(t,i);r.x&&(s.x=i.x),r.y&&(s.y=i.y),moveSVGElement(t,i),configuration.basic.enable_show_coordinates&&b(t,`X: ${s.x} | Y: ${s.y}`,i.x,i.y)}n=!0,globalConfigChanged=!0}}}function x(e){appProperties.isMobile&&g&&(clearTimeout(g),g=!1);let c=null;if(null!=s){if(s=null,r=!1,t=null,i){let e={start_x:parseInt($("#lasso_rect").attr("x")),start_y:parseInt($("#lasso_rect").attr("y")),end_x:parseInt($("#lasso_rect").attr("x"))+parseInt($("#lasso_rect").attr("width")),end_y:parseInt($("#lasso_rect").attr("y"))+parseInt($("#lasso_rect").attr("height"))};$(".added_elements").each((function(){let t=getElementCoords(this.id);const o="circle"==t.type||"text"==t.type?t.width/2:t.width,a="circle"==t.type||"text"==t.type?t.height/2:t.height;t.x>=e.start_x&&t.x+o<=e.end_x&&t.y>=e.start_y&&t.y+a<=e.end_y&&(globalMoving.push(t.id),$(`#${t.id}`).addClass("draggable-multi"))})),m()}i=!1,$("#lasso_rect").remove()}if(Object.keys(o).length>0){if(n)for(const e of Object.keys(o))saveUndoStep("move",o[e],getElementCoords(e));$(".added_elements").removeClass("dragging"),m(),c=setTimeout((function(){$("#basic\\.enable_animation").prop("checked")&&$(".anim_element").removeClass("no_animation").addClass("animation_cfg")}),1e3),!1!==n||u||(l||d>=0&&showConfigBar(d,o[d].type,a),$(".added_elements").removeClass("draggable-multi")),_()}}c.addEventListener("mousedown",v),c.addEventListener("touchstart",v,!1),c.addEventListener("mousemove",w),c.addEventListener("touchmove",w),c.addEventListener("mouseup",x),c.addEventListener("touchend",x,!1),c.addEventListener("touchleave",x,!1),c.addEventListener("touchcancel",x,!1),c.addEventListener("keydown",w),c.addEventListener("keyup",(function(){if(m(),Object.keys(o).length>0&&n){for(const e of Object.keys(o))saveUndoStep("move",o[e],getElementCoords(e));o={}}})),c.addEventListener("contextmenu",f),$("#ctx_copy").click((function(e){e.preventDefault(),globalMoving.length>0&&(successMessage(sprintf(systemDictionary.msg_copy_elements[systemLang],globalMoving.length)),globalClipboard=globalMoving,o={},$("#mouse_contextmenu").fadeOut(200))})),$("#ctx_paste").click((function(e){e.preventDefault(),globalClipboard.length>0&&($(".draggable-multi").removeClass("draggable-multi"),duplicateItems(globalClipboard,!1),$("#mouse_contextmenu").fadeOut(200))})),$("#ctx_export").click((function(e){e.preventDefault(),globalMoving.length>0&&(exportElement(globalMoving[0]),$("#mouse_contextmenu").fadeOut(200))})),$("#svg_config").on("keydown",(function(e){17!=e.keyCode&&91!=e.keyCode||(l=!0,e.preventDefault())})).keyup((function(e){17!=e.keyCode&&91!=e.keyCode||(l=!1)}))}socket.on("connect",(async function(){let e=(new Date).toLocaleString();console.log(`[Socket] connected at ${e}`),systemLang=await new Promise((e=>{socket.emit("getObject","system.config",(function(t,o){!t&&o&&o.common?(e(o.common.language),console.debug(`[Language] Got it from ioBroker! Translating Texts to locale ${o.common.language}!`)):(e(systemLang),console.debug(`[Language] Using locales! Translating Texts to locale ${systemLang}!`))}))})),translateAll(),multiselect_options.texts={placeholder:translateWord("opt_please_choose"),search:translateWord("lbl_search"),selectedOptions:" "+translateWord("lbl_selected")},socket.emit("getObject","system.adapter."+appProperties.namespace,(function(e,t){if(!e&&t&&t.common){let e=t.common.version;console.log(`[Version] Installed Version: ${e}`),$.getJSON(appProperties.updateCheck).done((function(t){let o=t[0].name.replace("v","");console.log(`[Version] Github Version: ${o}`),$("#runningVersion").html(`<a href='https://github.com/SKB-CGN/ioBroker.energiefluss-erweitert/releases/tag/v${e}' target='_blank'>Version: ${e}</a>`),$("#newVersion").html(""+(o>e?"("+translateWord("lbl_new_version")+")":"")).click((function(){window.open(appProperties.updateURL)}))}))}})),"Chrome"==appProperties.userAgent&&loadConfig()})),$((function(){if(!displayMode){let e;$(document).tooltip({position:{my:"center bottom-5",at:"center top",collision:"flipfit"},content:function(){return $(this).attr("title")}}),$(".basic_config").on("input change",(async function(t){globalConfigChanged=!0;let o=this.id.replace(".slider","").split(".");if(o.length>0){let a;switch(o.length){case 2:switch(this.id){default:configuration[o[0]][o[1]]=this.checked;break;case"basic.enable_ds_autocomplete":this.checked?$("#elm_ds_source").autocomplete(dataSourceAutocompleteOptions):$("#elm_ds_source").hasClass("ui-autocomplete-input")&&$("#elm_ds_source").autocomplete("destroy"),configuration[o[0]][o[1]]=this.checked;break;case"basic.enable_show_coordinates":this.checked||$("#placeholder_coordinate_desc").empty(),configuration[o[0]][o[1]]=this.checked;break;case"basic.enable_animation":this.checked?$(".anim_element").removeClass("no_animation").addClass("animation_cfg"):$(".anim_element").removeClass("animation_cfg").addClass("no_animation"),configuration[o[0]][o[1]]=this.checked;break;case"basic.enable_grid":this.checked?$("#help_grid").fadeIn("fast"):$("#help_grid").fadeOut("fast"),configuration[o[0]][o[1]]=this.checked;break;case"basic.enable_area_catch":this.checked?$(".tabbed").removeClass("no_catch"):$(".tabbed").addClass("no_catch"),configuration[o[0]][o[1]]=this.checked;break;case"basic.height.slider":case"basic.width.slider":$(`#${o[0]}\\.${o[1]}`).val(this.value).trigger("input");break;case"basic.height":case"basic.width":checkSVGSize("basic.height"==this.id?configuration.basic.width:this.value,"basic.height"==this.id?this.value:configuration.basic.height)[o[1]]?(a=parseInt(this.value),$(`#${o[0]}\\.${o[1]}\\.slider`).val(a),clearTimeout(e)):(a="basic.height"==this.id?configuration.basic.height:configuration.basic.width,"input"==t.type&&(clearTimeout(e),e=setTimeout((()=>{$(`#${o[0]}\\.${o[1]}\\.slider`).val(a),$(`#${o[0]}\\.${o[1]}`).val(a)}),500))),configuration[o[0]][o[1]]=a,resizeSVG()}console.debug("Basic Config changed: "+this.id,"checkbox"==this.type?this.checked:this.value,configuration[o[0]]);break;case 3:switch(this.type){case"text":a=this.value;break;case"select-multiple":a=$(this).val().map((e=>parseInt(e)));break;case"select-one":a=isNaN(this.value)?this.value:parseInt(this.value);break;case"number":a=parseInt(this.value);break;case"checkbox":a=this.checked}configuration[o[0]][o[1]][o[2]]=a,console.debug("Detailed Config changed: "+this.id,a,configuration[o[0]][o[1]]),configuration.calculation.battery.dod>=0&&null!=configuration.calculation.battery.dod&&configuration.calculation.battery.capacity>=0&&null!=configuration.calculation.battery.capacity&&configuration.calculation.battery.percent>=0&&null!=configuration.calculation.battery.percent&&configuration.calculation.battery.charge>=0&&null!=configuration.calculation.battery.charge&&configuration.calculation.battery.discharge>=0&&null!=configuration.calculation.battery.discharge?(console.debug("[Calculation] Battery configured!"),$("#calculation\\.battery\\.status").addClass("green").removeClass("red").text(translateWord("txt_calculation_succ"))):$("#calculation\\.battery\\.status").addClass("red").removeClass("green").text(translateWord("txt_calculation_fail")),0!=configuration.calculation.consumption.production.indexOf(-1)&&configuration.calculation.consumption.production.length>0&&configuration.calculation.consumption.gridFeed>=0&&null!=configuration.calculation.consumption.gridFeed&&configuration.calculation.consumption.gridConsume>=0&&null!=configuration.calculation.consumption.gridConsume?(console.debug("[Calculation] Consumption configured!"),$("#calculation\\.consumption\\.status").addClass("green").removeClass("red").text(translateWord("txt_calculation_succ"))):$("#calculation\\.consumption\\.status").addClass("red").removeClass("green").text(translateWord("txt_calculation_fail"))}}})),$("input:radio[name=tabs]").click((function(){$(".ui-dialog").remove(),hideConfigBar(),$("#align_elements").click(),$("#connect_elements").hasClass("red")&&$("#connect_elements").click(),$("#mouse_contextmenu").hide(),$("#placeholder_coordinate_desc").empty()})),$("#show_hide_config").click((function(){$("#container_menu").toggleClass("hidden")})),$(".tt-element").click((function(){$(".ui-tooltip").fadeOut()})),$(".line_preview").on("change input",(function(){linePreview(this.id)})),$(".align_elements").click((function(e){$(".added_elements").removeClass("alignable").addClass("draggable"),$(".all_elements, .align_elements").removeClass("faded_out");let t,o=$(this).closest("a").data("align");$(".align_elements").not(this).addClass("faded_out"),$("#align_elements").show(),$("#connect_elements").prop("disabled",!0),hideConfigBar(),$(".line:not(.preview)").addClass("not_selectable faded_out"),$(".added_elements").removeClass("draggable draggable-multi faded_out").addClass("alignable"),$("#ex_how_align").html(translateWord("ex_align_ref")+" <img src='img/icon_help.png' class='help' style='vertical-align:top;' placeholder='"+translateWord("ex_align_help")+"'>"),$(".alignable").off().click((function(e){if(null==t){const o=$(e.target).closest(".alignable").attr("id");$("#"+o).addClass("active_element not_selectable").off(),t=getElementCoords(o),$("#ex_how_align").html(translateWord("ex_align_ref_selected"))}else{globalConfigChanged=!0;const a=$(e.target).closest(".alignable").attr("id"),n=getElementCoords(a),i={x:t.cx?t.cx-t.width/2:t.x,y:t.cy?t.cy-t.height/2:t.y},s=(e,t,o)=>{switch(o){case"center":return e.cx>0?i.x+t.width/2:i.x+t.width/2-e.width/2;case"left":return e.cx>0?i.x-t.stroke/2+e.width/2+e.stroke/2:i.x-t.stroke/2+e.stroke/2;case"right":return e.cx>0?i.x+t.width+t.stroke/2-e.width/2-e.stroke/2:i.x+t.stroke/2+t.width-e.width-e.stroke/2;case"vcenter":case"top":case"bottom":return e.cx>0?e.cx:e.x;default:return 0}},r=(e,t,o)=>{switch(o){case"center":case"left":case"right":return e.cy>0?e.cy:e.y;case"vcenter":return e.cy>0?i.y+t.height/2:i.y+t.height/2-e.height/2;case"top":return e.cy>0?i.y-t.stroke/2+e.height/2+e.stroke/2:i.y-t.stroke/2+e.stroke/2;case"bottom":return e.cy>0?i.y+t.height+t.stroke/2-e.height/2-e.stroke/2:i.y+t.stroke/2+t.height-e.height-e.stroke/2;default:return 0}};moveSVGElement(n,{center:{x:s(n,t,"center"),y:r(n,t,"center")},left:{x:s(n,t,"left"),y:r(n,t,"left")},right:{x:s(n,t,"right"),y:r(n,t,"right")},vcenter:{x:s(n,t,"vcenter"),y:r(n,t,"vcenter")},top:{x:s(n,t,"top"),y:r(n,t,"top")},bottom:{x:s(n,t,"bottom"),y:r(n,t,"bottom")}}[o])?saveUndoStep("move",n,getElementCoords(a)):failedMessage(translateWord("failmsg_align_impossible"))}}))})),$("#align_elements").click((function(){$("#ex_how_align").html(translateWord("ex_align")),$("#connect_elements").prop("disabled",!1),$("#align_elements").hide(),$(".alignable").off(),$(".added_elements").removeClass("alignable").addClass("draggable"),$(".all_elements, .align_elements").removeClass("faded_out not_selectable active_element"),$(".line").removeClass("not_selectable")})),$("#import_element").click((function(){let e,t=getRandomInt(55);$(`<div id="tmpDiv_${t}" class="tmpDiv" />`).appendTo("body"),$(`#tmpDiv_${t}`).prop("title",translateWord("lbl_import_element")).dialog({resizable:!1,height:520,width:400,maxHeight:"100%",modal:!0,classes:jQueryDialog.classes,open:jQueryDialog.open,beforeClose:jQueryDialog.beforeClose,close:function(){e.destroy()},create:function(){e=ace.edit(`tmpDiv_${t}`),e.session.setMode("ace/mode/json"),e.setTheme("ace/theme/"+appProperties.aceEditorTheme[appProperties.colorScheme]),$(".ui-dialog-buttonset").children().first().prop("disabled",!0),e.getSession().off("changeAnnotation"),e.getSession().on("changeAnnotation",(function(){let t=e.getSession().getAnnotations().filter((e=>"error"==e.type));$(".ui-dialog-buttonset").children().first().prop("disabled",t.length>0||0==e.getSession().getValue().length)}))},buttons:[{text:translateWord("btn_import"),class:"input_button",click:function(){globalConfigChanged=!0;const t=JSON.parse(e.getValue());let o=0,a=0;const n=getMaxID();configuration.basic.enable_area_catch?(o=$("#svg_config_div").scrollLeft(),a=$("#svg_config_div").scrollTop()):(o=$(document).scrollLeft(),a=$(document).scrollTop()),t.id=n,t.source=-1,t.pos_x=o+(parseInt(configuration.basic.elm.pos_x)||50)+getRandomInt(50),t.pos_y=a+(parseInt(configuration.basic.elm.pos_y)||50)+getRandomInt(50),saveUndoStep("add",t,""),configuration.elements[n]=t,svgElement(configuration.elements[n]),console.debug(`Importing new Element with: ${t}`),$(this).dialog("close")}},{text:translateWord("value_cancel"),class:"input_button red",click:function(){$(this).dialog("close")}}]})})),$("#duplicate_elements").click((function(){let e=new Array;0==$(".draggable-multi").length?$("#elm_select").val()?$("#elm_select").val().includes("line")?failedMessage(translateWord("failmsg_duplicate_no_line")):e.push($("#elm_select").val()):failedMessage(translateWord("failmsg_duplicate_no_elm")):e=$(".draggable-multi").map((function(){return this.id})).get(),duplicateItems(e,!0)})),$(".undo_redo_element").click((function(){switch($(this).closest("a").attr("id")){case"edit_undo":undoStep();break;case"edit_redo":redoStep()}})),$(".add_element").click((function(e){globalConfigChanged=!0;let t=0,o=0;const a=getMaxID();configuration.basic.enable_area_catch?(t=$("#svg_config_div").scrollLeft(),o=$("#svg_config_div").scrollTop()):(t=$(document).scrollLeft(),o=$(document).scrollTop());let n={position:0,id:a,pos_x:t+(parseInt(configuration.basic.elm.pos_x)||50)+getRandomInt(50),pos_y:o+(parseInt(configuration.basic.elm.pos_y)||50)+getRandomInt(50),source:-1,threshold:0,frame:"_overlay",url:"",action:"none",shadow:""};switch($(this).closest("a").data("id")){case"circle":n.radius=parseInt(configuration.basic.circle.radius)||50,n.type="circle",n.fill_value="",n.fill_type=-1,n.fill_direction=90,n.fill_max=0,n.border_value="",n.border_type=-1,n.border_direction="cw",n.border_style="round",n.border_max=0,n.border_reverse_value="",n.border_reverse=!1,n.border_start=180,n.color=configuration.basic.elm.color||getRandomRGBA(),n.fill=configuration.basic.elm.fill||"none",n.stroke=parseInt(configuration.basic.elm.stroke_width)||5;break;case"rect":n.type="rect",n.width=parseInt(configuration.basic.rect.width)||100,n.height=parseInt(configuration.basic.rect.height)||100,n.rx=parseInt(configuration.basic.rect.corners)||10,n.fill_value="",n.fill_type=-1,n.fill_direction=90,n.fill_max=0,n.border_value="",n.border_type=-1,n.border_direction="cw",n.border_style="round",n.border_max=0,n.border_reverse_value="",n.border_reverse=!1,n.border_start=180,n.color=configuration.basic.elm.color||getRandomRGBA(),n.fill=configuration.basic.elm.fill||"none",n.stroke=parseInt(configuration.basic.elm.stroke_width)||5;break;case"text":n.type="text",n.text="Text",n.align=configuration.basic.font.align||"middle",n.color=configuration.basic.font.color||"none",n.fill=configuration.basic.font.fill||getRandomRGBA(),n.font_size=configuration.basic.font.size||20,n.font_family=configuration.basic.font.family||'"Arial", sans-serif';break;case"datasource":n.calculate_kw="none",n.counter_animation=!1,n.convert=!1,n.decimal_places=0,n.type="text",n.align=configuration.basic.font.align||"middle",n.subType="datasource",n.text="Datasource "+a,n.source_option=-1,n.source_display="value",n.linebreak=0,n.subtract=[],n.add=[],n.unit="kW",n.action="none",n.source_action=-1,n.color=configuration.basic.font.color||"none",n.fill=configuration.basic.font.fill||getRandomRGBA(),n.font_size=configuration.basic.font.size||20,n.font_family=configuration.basic.font.family||'"Arial", sans-serif';break;case"icon":n.type="icon",n.width=24,n.height=24,n.icon="mdi:omega",n.color=configuration.basic.icon.color||getRandomRGBA();break;case"svg":n.svg_content='<path d="M19.564 4.42a.75.75 0 0 0-1.378-.59l-6.75 15.75a.75.75 0 0 0 1.378.59l6.75-15.75ZM7 18.5a1.5 1.5 0 1 1-3 0a1.5 1.5 0 0 1 3 0Z" fill="currentColor"></path>',n.subType="svg",n.type="svg",n.width=24,n.height=24,n.viewBox="0 0 24 24";break;case"image":n.href="img/tmp_img.png",n.width=100,n.height=100,n.type="image",n.preserveAspectRatio="xMidYMid meet";break;case"fObj":n.fObj_content=`<div xmlns="http://www.w3.org/1999/xhtml">${translateWord("help_fObj_tmp")}</div>`,n.width=60,n.height=100,n.type="foreignObject",n.color=getRandomRGBA()}configuration.elements[a]=n,svgElement(n,!1),saveUndoStep("add",n,"")})),$("#config_close").click((function(){hideConfigBar(),$("#placeholder_coordinate_desc").children().fadeOut("fast",(function(){$(this).remove()}))})),$("#config_swap").click((function(){$("#config_bar").toggleClass("left right")})),$(".connect_elements").click((async function(e){await connectElements(e.target.id)})),$("#save_workspace, #save_workspace_exit").click((async function(){if(globalConfigChanged=!1,appProperties.localMode)successMessage(translateWord("succ_msg_local_output"));else{await saveWorkspace()&&(successMessage(translateWord("succ_msg_save_workspace")),"save_workspace_exit"==this.id&&window.location.replace("index.html?instance="+appProperties.instance))}aceLog.setValue(JSON.stringify(configuration,void 0,4),-1)})),$("#workspace_exit").click((function(){window.location.replace("index.html?instance="+appProperties.instance)})),$(".check_datasources").click((function(e){Object.entries(configuration.datasources).forEach((async t=>{const[o,a]=t;let n,i=$(`#datasource-table tbody tr[data-id="${o}"`);switch(e.target.id){case"check_datasources":console.debug(`Checking ${a.source}`);let e=await new Promise((e=>{socket.emit("getState",a.source,((t,o)=>{e(o)}))}));n=e?"highlight-green":"highlight-red";break;case"check_datasources_in_use":console.debug(`Checking ${o}`),n=Object.keys(checkDatasourcesInUse(o)).length>0?"highlight-green":"highlight-red"}$(i).addClass(n),setTimeout((()=>{$(i).removeClass(n)}),4e3)}))})),$("#restore_backup").click((function(){let e=$("#backup_list").val();-1!=e&&""!=e&&null!=e?$("#dialog_section").prop("title",translateWord("lbl_backup_section")).html(translateWord("msg_backup_restore")).dialog({resizable:!1,height:"auto",maxHeight:"100%",width:400,modal:!0,classes:jQueryDialog.classes,open:jQueryDialog.open,beforeClose:jQueryDialog.beforeClose,buttons:[{text:translateWord("value_save_restore"),width:"auto",class:"input_button",click:function(){$(this).dialog("close"),socket.emit("sendTo",appProperties.namespace,"_restoreBackup",{filename:e},(function(e){e&&e.error?(console.log("An error occured, while restoring the backup. The following error was provided: ",e.error),failedMessage(translateWord("failmsg_backup"))):(configuration=e.data,console.log(e.data),setLoadedConfig(),successMessage(translateWord("succ_msg_backup")))}))}},{text:translateWord("value_cancel"),class:"input_button red",click:function(){$(this).dialog("close"),failedMessage(translateWord("failmsg_backup_cancel"))}}]}):failedMessage(translateWord("failmsg_backup_no_valid"))}))}})),$(document).ready((function(e){displayMode?(document.body.addEventListener("dblclick",(()=>{const e=document.querySelector("body");document.fullscreenElement?document.exitFullscreen():e.requestFullscreen().catch((e=>{failedMessage("Your browser does not support fullscreen!")}))})),$("body").on("click",".action_element",(function(e){let t=$(this).attr("id");console.debug(`Clicked on Action Element ${t}`),actionForElement(t,e)}))):($("#drop_zone").on("dragover",(function(e){e.preventDefault(),$(this).addClass("dragFile"),$("#upload_info").text(translateWord("txt_upload_status_drop"))})),$("#drop_zone").on("dragleave",(function(e){e.preventDefault(),$(this).removeClass("dragFile"),$("#upload_info").text(translateWord("txt_upload_status_init"))})),$("#drop_zone").on("drop",(function(e){e.preventDefault(),$("#uploadFile").prop("files",e.originalEvent.dataTransfer.files).trigger("change")})),$("#uploadFile").on("change",(async function(){function e(e){return e.trim().replace(/[^a-z0-9._\-]/gi,"_").replace(/_{2,}/g,"_").toLowerCase()}function t(e){return new Promise((function(t,o){const a=new FormData;a.append("uploadFile",e);const n=new XMLHttpRequest;n.open("POST",appProperties.socketURL+appProperties.namespace+"/upload",!0),n.onload=function(){t(JSON.parse(n.responseText))},n.send(a)}))}$("#upload_progress>div").css("width","0%");let o=this.files.length,a=[],n=!1;for(const e of this.files){if(!(e.type.includes("image")&&e.size<=5242880)){n=!1;break}n=!0}if($("#file_selector").blur().prop("disabled",!0),n){$("#upload_errors").slideUp();for(const n of this.files){$("#upload_info").text(sprintf(systemDictionary.txt_upload_uploading[systemLang],Object.keys(a).length||1,o));const i=e(n.name),s=i.replaceAll(".","\\.");if($(`#${s}`).length>0)a.push({filename:i,success:!1,reason:"exists"});else{const e=await t(n);a.push({filename:e.filename,success:!0,reason:"success"}),globalUserImages.push(e.filename);let i=globalUserImages.sort().indexOf(e.filename),s=wrapUploadImage(e.filename,e.path).hide();$("#userImages_dummy").fadeOut("fast"),$("#userImages div.imgContainer").length>i?$(`#userImages div.imgContainer:nth-child(${i+1})`).before(s):$("#userImages").append(s),s.fadeIn(2e3),$("#upload_progress>div").css("width",Object.keys(a).length/o*100+"%")}appProperties.isMobile&&getUserImages()}a.find((e=>!1===e.success))?($("#upload_errors-table tbody").empty(),a.forEach((function(e){$("#upload_errors-table tbody").append(`<tr><td>${e.filename}</td><td>${translateWord("txt_upload_error_"+e.reason)}</td></tr>`)})),$("#upload_info").html(`${translateWord("txt_upload_status_error")} <a href="javascript:;" onclick="$('#upload_errors').slideToggle();"><span class="iconify" data-icon="material-symbols:error-outline" data-width="24" height="24" style="color:var(--red);"></span></a>`)):$("#upload_info").text(translateWord("txt_upload_status_success"))}else $("#upload_info").text(translateWord("txt_upload_status_tooBig"));$("#uploadFile").val(null),$("#file_selector").prop("disabled",!1),$("#drop_zone").removeClass("dragFile")})),window.addEventListener("keydown",(function(e){(e.ctrlKey||e.metaKey)&&"z"===e.key&&undoStep(),(e.ctrlKey||e.metaKey)&&"y"===e.key&&redoStep(),(e.ctrlKey||e.metaKey)&&"d"===e.key&&(e.preventDefault(),$("#duplicate_elements").click())})),$("body").on("click",".line:not(.preview,.not_selectable)",(function(e){showConfigBar(e.target.id,e.target.tagName.toLowerCase(),2===e.detail?"tab2":"tab1")})),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",(e=>{appProperties.colorScheme=e.matches?"dark":"light",console.log("Color-Scheme-changed: "+appProperties.colorScheme),aceLog.setTheme("ace/theme/"+appProperties.aceEditorTheme[appProperties.colorScheme]),aceCSS.setTheme("ace/theme/"+appProperties.aceEditorTheme[appProperties.colorScheme]),aceOverride.setTheme("ace/theme/"+appProperties.aceEditorTheme[appProperties.colorScheme])})),aceLog=ace.edit("save_output"),aceLog.session.setMode("ace/mode/json"),aceLog.setTheme("ace/theme/"+appProperties.aceEditorTheme[appProperties.colorScheme]),aceLog.setReadOnly(!0),aceOverride=ace.edit("codeEditor"),aceOverride.session.setMode("ace/mode/json"),aceOverride.setTheme("ace/theme/"+appProperties.aceEditorTheme[appProperties.colorScheme]),$(window).on("beforeunload",(function(){if(globalConfigChanged)return translateWord("leave_unsaved")})),$("body").on("click",".help",(function(){$("#help_section").html($(this).attr("placeholder")).dialog({resizable:!1,maxHeight:"100%",classes:jQueryDialog.classes,width:400,modal:!1,open:function(e,t){$(this).parent().focus()},close:function(){$(this).dialog("destroy")},buttons:[{text:translateWord("btn_close"),class:"input_button",click:function(){$(this).dialog("close")}}]})})),$("body").on("click",".delete_upload",(function(){deleteUserImage($(this).parent().parent().attr("id"))})),$("body").on("keyup",".userImages_filter",(function(){let e=new RegExp($(this).val().trim().toLowerCase()),t=$(this).parent().parent().siblings(".userImages").children(".imgContainer");t.show(),e&&t.each((function(){(this.id||$(this).data("id")).match(e)||$(this).hide()}))})),$("#frm-addDataSource").submit((function(e){e.preventDefault();let t=$("#elm_ds_source").val(),o=$("#elm_ds_alias").val()?$("#elm_ds_alias").val():"",a=Number($("#elm_ds_factor").val()),n=checkDuplicateDatasource(t);if(n){let e=$(`#datasource-table tbody tr[data-id="${n}"`);$("html, body").animate({scrollTop:$(e).offset().top-80},{complete:function(){$(e).addClass("highlight-red")}}),setTimeout((()=>{$(e).removeClass("highlight-red")}),4e3),failedMessage(translateWord("failmsg_ds_already_exists"))}else{globalConfigChanged=!0;let e=Object.keys(configuration.datasources).length>0?Math.max(...Object.keys(configuration.datasources).map((e=>e)))+1:0;console.debug(`New ID for added datasource: ${e}`),configuration.datasources[e]={source:t,alias:o,factor:a},addDataSourceRow(e,!0),successMessage(translateWord("succ_msg_ds_created")),$(this)[0].reset(),updateDataSources()}})),$("#datasource-table").on("click",".btn-delete",(function(){let e=$(this).parents("tr"),t=checkDatasourcesInUse(e.data("id"));if(Object.keys(t).length>0){let e,a=`<div class="data-table-div"><table class='used-ds-table config_table'><thead><tr><th>${translateWord("lbl_config_element")}</th><th>${translateWord("lbl_type")}</th><th>${translateWord("lbl_used_as")}</th></thead><tbody>`,n="";for(var o in t)n+=`<tr><td>${t[o].id}</td><td>${t[o].type}</td><td>${t[o].reason}</td></tr>`;e=`${a}${n} </tbody></table></div>`,$("#dialog_section").prop("title",translateWord("lbl_ds_delete_section")).html(`<span class='dsInUseInfoTitle'> ${translateWord("failmsg_delete_source")}</span>`).append(e).dialog({resizable:!1,maxHeight:"98%",width:"auto",modal:!0,classes:jQueryDialog.classes,beforeClose:jQueryDialog.beforeClose,open:jQueryDialog.open,close:function(){$(this).dialog("close")},buttons:[{text:translateWord("btn_close"),class:"input_button",click:function(){$(this).dialog("close")}}]})}else globalConfigChanged=!0,e.fadeOut("fast",(function(){$(this).remove(),0==$("#datasource-table tbody tr").length&&$("#datasource-table tbody").append("<tr id='ds_tmp_line' data-id='-1'><td>"+translateWord("no_ds_added")+"</td><td></td><td></td>"),delete configuration.datasources[e.data("id")]}))})),$("#datasource-table").on("click",".btn-edit",(function(){$("#frm-addDataSource :input, #frm-addDataSource a, .tabbed>input, .ds_buttons.btn-edit, .ds_buttons.btn-delete").prop("disabled",!0),$("#frm-addDataSource a, .tabbed nav label").attr("disabled",!0);let e=$(this).parents("tr"),t=e.data("alias"),o=e.data("source"),a=e.data("factor"),n=`<div class="form_div no_margin" > <input type="text" class="input_text" id="edit_ds_alias" name="edit_ds_alias" autocorrect="off" autocomplete="off" value="${t}"></div>`,i=`<div class="form_div no_margin" > <input type="text" class="input_text icon_in_input_pad datasource_autocomplete" id="edit_ds_source" name="edit_ds_source" autocorrect="off" autocomplete="off" minlength="3" value="${o}" required><div class="icon_wrapper"><a class="frm-datasource icon_in_input"><span class="iconify" data-icon="mdi:database-search" data-height="24"></span></a><div class="ds_search_spinner"><span class="spinner"></span></div></div></div>`,s=`<div class="form_div no_margin" > <select class="input_select elm_config" name="edit_ds_factor" id="edit_ds_factor"><option value="1">${translateWord("opt_ds_factor_1")}</option><option value="1000">${translateWord("opt_ds_factor_1000")}</option></select></div>`;e.find("td:eq(0)").html(n),e.find("td:eq(1)").html(i),e.find("td:eq(2)").html(s),e.find(".btn-update, .btn-cancel").show(),e.find(".btn-delete, .btn-edit").hide(),$("#edit_ds_factor").val(a),configuration.basic.enable_ds_autocomplete&&$("#edit_ds_source").autocomplete(dataSourceAutocompleteOptions)})),$("#datasource-table").on("click",".btn-cancel",(function(){$("#frm-addDataSource :input, #frm-addDataSource a, .tabbed>input, .ds_buttons.btn-edit, .ds_buttons.btn-delete").prop("disabled",!1),$("#frm-addDataSource a, .tabbed nav label").attr("disabled",!1);let e=$(this).parents("tr");e.find("td:eq(0)").text(e.data("alias")),e.find("td:eq(1)").text(e.data("source")),e.find("td:eq(2)").text(e.data("factor")),e.find(".btn-edit, .btn-delete").show(),e.find(".btn-cancel, .btn-update").hide()})),$("#datasource-table").on("click",".btn-update",(function(){$("#frm-addDataSource :input, #frm-addDataSource a, .tabbed>input, .ds_buttons.btn-edit, .ds_buttons.btn-delete").prop("disabled",!1),$("#frm-addDataSource a, .tabbed nav label").attr("disabled",!1);let e=$(this).parents("tr"),t=$("#edit_ds_alias").val(),o=$("#edit_ds_source").val(),a=Number($("#edit_ds_factor").val());if(o.length>=3){let n=checkDuplicateDatasource(o);null!=n&&n!=e.data("id")?($("#edit_ds_source").focus(),failedMessage(translateWord("failmsg_ds_already_exists"))):(configuration.datasources[e.data("id")]={source:o,alias:t,factor:a},console.debug(`Datasource updated: New values: ${JSON.stringify(configuration.datasources[e.data("id")])}`),$("#frm-addDataSource :input, #frm-addDataSource a").prop("disabled",!1),$("#frm-addDataSource a").attr("disabled",!1),globalConfigChanged=!0,e.find("td:eq(0)").text(t),e.find("td:eq(1)").text(o),e.find("td:eq(2)").text(a),e.data({alias:t,source:o,factor:a}),e.find(".btn-edit, .btn-delete").show(),e.find(".btn-cancel, .btn-update").hide(),updateDataSources())}else $("#edit_ds_source").focus(),failedMessage(translateWord("msg_ds_not_empty"))})),$("body").on("click",".frm-datasource",(function(){const e=new RegExp("{([^)]+)}"),t=$(this).parent("div").parent("div").children("input").attr("id");let o=configuration.basic.enable_last_id&&""==$("#"+t).val()?globalSelectedId:$("#"+t).val();if("elm_href"==t&&o.length>0){const t=o.match(e);t&&t.length>0&&(o=t[1])}$("#loading").fadeIn(600),$(".loading-spinner, #loading_text").hide(),$("#stateExplorerContainer").css({top:-60,opacity:0,display:"block"}),$("#stateExplorerContainer").animate({opacity:1,top:25},{duration:600,queue:!1,complete:function(){openStateTree("stateExplorer",o)}}),$("#select_state").off().on("click",(function(){let e=$(".state.active").parent().attr("id");"elm_href"==t?$("#"+t).val(`{${e}}`).focus().trigger("change"):$("#"+t).val(e).focus(),globalSelectedId=e,closeEditorContainer("stateExplorer"),$(".state").removeClass("active").children(".type").removeClass("file-selected")})),$("#reloadStateExplorer").off().on("click",(async function(){$("#select_state").prop("disabled",!0),$("#stateRoot").empty().remove(),$("#stateExplorer_placeholder").show(),iobObjects=await loadIobObjects(),generateStateTree(iobObjects,"stateExplorer"),$(".stateExplorerFilter").trigger("keyup")}))})),$("#datasource-table").on("click","th",(function(){$(".sort_icon").html("");var e=$(this).parents("table").eq(0),t=e.find("tr:gt(0)").toArray().sort(dataSourceComparer($(this).index()));$(this).find(".sort_icon").html('<span class="iconify" data-icon="mdi:sort-alphabetical-ascending" data-height="18">'),this.asc||(t=t.reverse(),$(this).find(".sort_icon").html('<span class="iconify" data-icon="mdi:sort-alphabetical-descending" data-height="18">'));for(var o=0;o<t.length;o++)e.append(t[o]);this.asc=!this.asc})),$("#image_href_gallery").click((function(){let e=$(this).parent("div").parent("div").children("input").attr("id");$("#userImagesBrowseDialog").prop("title",translateWord("lbl_gallery")).dialog({resizable:!1,maxHeight:500,height:"auto",width:640,modal:!0,classes:jQueryDialog.classes,beforeClose:jQueryDialog.beforeClose,close:function(){$(this).dialog("close")},create:function(){let t=$("#userImages").children().clone();t.each((function(e,t){$("#userImagesBrowseFilter").val(""),$(t).hasClass("imgContainer")&&($(t).data("id",this.id).attr("id","").show(),$(t).children(".uploads_btn").children().val(translateWord("value_select")).removeClass("delete_upload").addClass("select_upload"))})),$("#userImagesBrowse").empty().append(t),$(".select_upload").off().on("click",(function(){let t=$(this).parent().parent().data("id");$("#"+e).val(t).trigger("change"),$(".ui-dialog-buttonset").children().first().click()}))},open:jQueryDialog.open,buttons:[{text:translateWord("btn_close"),class:"input_button",click:function(){$(this).dialog("close")}}]})})),getUserImages()),"Firefox"==appProperties.userAgent&&loadConfig()}));