"use strict";$.fn.countTo=function(e,t,a){t||(t=1e3);var o,i=$.now(),n=i+t,s=String(e).split(".");s=s.length>1?s[1].length:0,e=parseFloat(e),this.each(function(r,l){var c=$(l),d=c.data(),u=c.is(":input")?"val":"text",p=parseFloat(c[u]()),g=Number(p),f=g,h=g-e;!function r(){d._counter&&clearTimeout(d._counter);var m,b=$.now();b<n&&f!=e?(m=(g-(b-i)/t*h).toFixed(s),d._counter=setTimeout(r,10)):(m=s?e.toFixed(s):e,delete d._counter),m!=f&&(f=m,o?p.value=m:p=m,c[u](p)),d._counter||"function"!=typeof a||a.call(l,e,p)}()})},$.fn.scrollTo=function(e,t,a){return $(this).animate({scrollTop:$(this).scrollTop()-$(this).offset().top+$(e).offset().top+(a||0)},void 0==t?1e3:t),this},$.expr.pseudos.icontains=function(e,t,a){return e.textContent.toUpperCase().includes(a[3].toUpperCase())},$.fn.appendToWithIndex=function(e,t=0){!e instanceof jQuery&&(e=$(e));let a=e.children().last().index()||0;0===t?$(this).prependTo(e):t>a?$(this).appendTo(e):$(this).insertAfter(e.children().eq(t-1))};let aceLog,aceCSS,aceOverride;const urlParams=new URLSearchParams(window.location.search);var iobPath=location.pathname,iobParts=iobPath.split("/");iobParts.splice(-3);const appProperties={instance:Number(urlParams.get("instance"))||0,lowPerformance:urlParams.get("lowPerformance")||!1,theme:urlParams.get("theme")||!1,updateCheck:"https://api.github.com/repos/SKB-CGN/ioBroker.energiefluss-erweitert/tags",updateURL:"https://github.com/SKB-CGN/ioBroker.energiefluss-erweitert/#changelog",namespace:`energiefluss-erweitert.${urlParams.get("instance")||0}`,hostname:window.location.hostname,localMode:!window.location.hostname,socketURL:window.location.hostname?"/":"https://192.168.2.19:8082/",socketPath:window.location.hostname?iobParts.join("/")+"/socket.io":"/socket.io",colorScheme:window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light",userAgent:navigator.userAgent.indexOf("Chrome")>-1?"Chrome":"Firefox",isMobile:/iPhone|iPad|iPod|Android/i.test(navigator.userAgent),aceEditorTheme:{dark:"clouds_midnight",light:"textmate"}},socket=io.connect(appProperties.socketURL,{path:appProperties.socketPath,reconnectionDelay:500,reconnectionAttempts:1/0,upgrade:!0,transports:appProperties.hostname.match(/iobroker\.pro|iobroker\.net/)?void 0:["websocket","polling"]});socket.on("reauthenticate",function(){let e=new Date().toLocaleString();console.log(`[Socket] reauthenticate ${e}`)}),socket.on("error",function(e){let t=new Date().toLocaleString();console.error(`[Socket] error: ${e} ${t}`)}),socket.on("permissionError",function(e){let t=new Date().toLocaleString();console.error(`[Socket] permission error: ${e} ${t}`)}),socket.on("upgrade",function(e){let t=new Date().toLocaleString();console.log(`[Socket] connection upgrade at ${t}`)}),socket.on("connect_error",function(e){let t=new Date().toLocaleString();console.error("[Socket] connect error: "+e+" "+t),console.log(`Current connection set: ${socket.io.opts.transports}`),socket.io.opts.forceNew=!0,"polling"==socket.io.opts.transports[0]?(socket.io.opts.transports=["websocket","polling"],console.log("[Socket] Connection Error. Trying websocket first!")):(socket.io.opts.transports=["polling","websocket"],console.log("[Socket] Connection Error. Trying polling first!"))}),console.debug(appProperties),console.log("Using Instance: "+appProperties.namespace);let subscribeObjID=[appProperties.namespace+".configuration",appProperties.namespace+".data","system.adapter."+appProperties.namespace+".alive"];systemLang=navigator.language||navigator.userLanguage,console.log("Detected System-Languag: "+systemLang);let backup_configuration={},configuration={},displayMode=!1,globalConfigChanged=!1,basicConfig=!1,globalSelectedId,globalLastSteps=[],globalLastStepsPos=0,globalAdapterOnline=!1,globalTmpCSS,globalIconProxy=!1,globalIconProxyPort=10123,globalIobObjectsLoaded=!1;const clockIntervals={};var filename=location.pathname.substr(location.pathname.lastIndexOf("/")+1);filename.includes("index")||""==filename?displayMode=!0:(jscolor.presets.default={alphaChannel:"auto",format:"any",borderColor:"var(--primary)",borderRadius:10,controlBorderColor:"#538EA3",previewSize:28,previewPosition:"right",required:!1,backgroundColor:"var(--white)",palette:["#00b5dd","#61687a","#ffce4a","#a1d343","#c5902e","#f20e40"]},ace.require("ace/ext/language_tools"));const dataSourceAutocompleteOptions={position:{my:"left top",at:"left bottom",collision:"fit"},source:async function(e,t){globalIobObjectsLoaded||(iobObjects=await loadIobObjects());let a=$.ui.autocomplete.filter(iobArray,e.term);t(a.slice(0,200))},classes:{"ui-autocomplete":"select_overflow"},minLength:3,delay:500,search:function(){globalIobObjectsLoaded||$(this).siblings(".icon_wrapper").find(".ds_search_spinner").show()},response:function(){setTimeout(()=>{$(this).siblings(".icon_wrapper").find(".ds_search_spinner").hide()},500)}};let iobObjects,iobArray=[],globalUserImages=[];const multiselect_options={columns:1,search:!0,minWidth:"250px",maxWidth:"auto",maxPlaceholderOpts:1,texts:{}};function loadIobObjects(){return console.log("iobObjects not present! Requesting!"),new Promise((e,t)=>{let a=performance.now();socket.emit("getObjects",function(t,o){let i=performance.now();globalIobObjectsLoaded=!0,console.log(`${Object.keys(o).length} Objects loaded in ${i-a} ms`);let n={};Object.keys(o).sort((e,t)=>e.toLowerCase().localeCompare(t.toLowerCase())).forEach(e=>n[e]=o[e]),iobArray=Object.keys(n).filter(e=>"state"==n[e].type),e(n)})})}function sprintf(e){var t=Array.prototype.slice.call(arguments,1),a=0;return e.replace(/%s/g,function(){return t[a++]})}function displayLoading(e){$("#loading_text").html(e),$("#loading, .loading-spinner, #loading_text").show(),$("#loading_text_error").hide()}function displayListener(){let e=new Date().toLocaleString();appProperties.localMode||(socket.emit("subscribe",subscribeObjID),console.log("[Socket] subscribed to: "+subscribeObjID.toString()+" at "+e),socket.on("reconnect",function(){console.log("[Socket] reconnected at "+e),socket.emit("subscribe",subscribeObjID),$("#loading").fadeOut("fast")}),socket.on("disconnect",function(){console.log("[Socket] disconnected "+e),displayLoading(translateWord("msg_reconnect"))}),socket.on("stateChange",function(t,a){setTimeout(function(){if(t==subscribeObjID[0])try{Object.keys(clockIntervals).forEach(e=>{clearTimeout(clockIntervals[e]),console.log("Cleared Clock-Timout for "+e)}),displayLoading(translateWord("msg_loading_config")),configuration=JSON.parse(a.val),setLoadedConfig(!0),console.log("Applied new configuration at "+e)}catch(o){console.log("Error while parsing Config in JSON-Object!")}if(t==subscribeObjID[1])try{refreshData(JSON.parse(a.val))}catch(i){console.log("Error while parsing Values in JSON-Object!")}if(t==subscribeObjID[2]){if(!1==a.val){let n=sprintf(systemDictionary.msg_instance_loading[systemLang],appProperties.instance);displayLoading(n),console.log("Adapter instance: "+appProperties.instance+" is not started! "+e),globalAdapterOnline=!1}else if(a.val!=globalAdapterOnline&&!0==a.val){console.log("Adapter instance: "+appProperties.instance+" started at "+e),globalAdapterOnline=!0;let s=(Math.random()+1).toString(36).substring(7);window.location.href=`?instance=${appProperties.instance}&hash=${s}&lowPerformance=${appProperties.lowPerformance}&theme=${appProperties.theme}`}}},0)}))}function addGradient(e,t,a,o=90){t=t||"transparent",a="none"==a?"transparent":a;let i=document.createElementNS("http://www.w3.org/2000/svg","linearGradient");i.setAttribute("id","gradient_"+e),i.setAttribute("gradientTransform","rotate("+o+",0.5,0.5)");let n=document.createElementNS("http://www.w3.org/2000/svg","stop");n.setAttribute("id","gradient_transparent_"+e),n.setAttribute("offset","0%"),n.setAttribute("stop-color",a),i.appendChild(n),(n=document.createElementNS("http://www.w3.org/2000/svg","stop")).setAttribute("id","gradient_color_"+e),n.setAttribute("stop-color",t),i.appendChild(n),$(i).appendTo("#placeholder_defs"),$("#"+e).css("fill","url(#gradient_"+e+")")}function updateGradient(e,t,a,o){try{let i;switch(o){case"percent":i=100-t;break;case"value":if(!a)throw Error("No max value for element declared!");i=100-t/a*100}void 0!=i&&$("#gradient_transparent_"+e).attr("offset",i+"%")}catch(n){console.error("Error while updating gradient for ID: "+e+"! "+n)}}function addBorderFill(e,t,a,o=-90){let i=$("#"+e),n=Math.PI*(2*i.attr("r")),s=Number(i.attr("height")),r=Number(i.attr("width")),l={id:`border_${e}`};if("rect"==i.prop("tagName"))switch(n=2*i.attr("width")+2*i.attr("height"),o=Number(o)+90){case 90:case 270:if(s!=r){let c=Math.abs(s-r)/2;l.width=s,l.height=r,l.x=s>r?Number(i.attr("x"))-c:Number(i.attr("x"))+c,l.y=s>r?Number(i.attr("y"))+c:Number(i.attr("y"))-c}}$(i.clone().attr(l).css({fill:"transparent",filter:"none","transform-box":"fill-box",transform:"rotate("+o+"deg)","transform-origin":"50% 50%",transition:"stroke-dashoffset 1s ease-in-out",strokeDashoffset:n,strokeDasharray:n,strokeLinecap:a,"pointer-events":"none"}).data("border_reverse_value_default",i.css("stroke"))).insertAfter(i),i.css({stroke:t})}function updateBorderFill(e,t,a,o,i="cw"){try{let n=$("#border_"+e),s,r,l=n.attr("r"),c=Math.PI*(2*l);switch("rect"==n.prop("tagName")&&(c=2*n.attr("width")+2*n.attr("height")),o){case"percent":r=100-Math.abs(t);break;case"value":if(!a)throw Error("No max value for element declared!");r=100-Math.abs(t)/a*100}r<0&&(r=0),r>100&&(r=100),n.data("border_reverse")&&(t<0?(i="cw"==i?"ccw":"cw",s=n.data("border_reverse_value")||n.data("border_reverse_value_default")):s=n.data("border_reverse_value_default")),c="cw"==i?c:-1*c;let d=r/100*c;n.css({strokeDashoffset:d,strokeDasharray:c,stroke:s})}catch(u){console.error("Error while updating border fill for ID: "+e+"! "+u)}}function userClock(e,t,a=!1){let o={},i,n=new Date;for(let s in e)"none"!=e[s]&&""!=e[s]&&(o[s]=e[s]);try{i=new Intl.DateTimeFormat(systemLang,o).format(n)}catch(r){console.log("Not a valid date. Waiting for setting-up correctely!",r.message)}return $("#"+t).text(i),a||(clockIntervals[t]=setTimeout(userClock,1e3,e,t)),i}function refreshData(e){try{if(Object.entries(e.values).forEach(t=>{let[a,o]=t;o&&("value"==configuration.elements[a].source_display?configuration.elements[a].counter_animation?isNaN(o)?$(`#${a}_value`).html(generateMultiLineText(`${a}_value`,o,configuration.elements[a].pos_x)):($(`#${a}_value`).children().length>0||$(`#${a}_value`).html(generateMultiLineText(`${a}_value`,0,configuration.elements[a].pos_x)),$(`#${a}_value_line_0`).countTo(o,configuration.basic.animation_timer||1e3)):($(`#${a}_value`).children().length>0||$(`#${a}_value`).html(generateMultiLineText(`${a}_value`,0,configuration.elements[a].pos_x)),$(`#${a}_value_line_0`).html(o)):$(`#${a}_value`).html(generateMultiLineText(`${a}_value`,o,configuration.elements[a].pos_x)),"auto"==configuration.elements[a].calculate_kw&&$(`#${a}_unit`).html(generateMultiLineText(`${a}_unit`," "+e.unit[a],configuration.elements[a].pos_x)))}),displayMode){try{Object.entries(e.fillValues).forEach(e=>{let[t,a]=e;if(configuration.elements.hasOwnProperty(t)){let o=configuration.elements[t];-1!=o.fill_type&&($("#gradient_"+t).length>0||(addGradient(t,o.fill_value,o.fill,o.fill_direction),console.log("Fill-Gradient added for: "+t)),updateGradient(t,a,o.fill_max,o.fill_type))}})}catch(t){console.error("Could not apply Fill-Values. The following error was thrown: "+t)}try{Object.entries(e.img_href).forEach(e=>{let[t,a]=e;a?$(`#${t}`).attr("href",a):$(`#${t}`).attr("href","")})}catch(a){console.error("Could not apply Image-Sources. The following error was thrown: "+a)}try{Object.entries(e.borderValues).forEach(e=>{let[t,a]=e,o=configuration.elements[t];-1!=o.border_type&&($("#border_"+t).length>0||(addBorderFill(t,o.border_value,o.border_style,o.border_start),console.log("Border-Fill added for: "+t)),updateBorderFill(t,a,o.border_max,o.border_type,o.border_direction))})}catch(o){console.error("Could not apply Border-Values. The following error was thrown: "+o)}try{Object.entries(e.animations).forEach(t=>{let[a,o]=t,i="",n="",s="";e.animationProperties.hasOwnProperty(a)&&("dots"==e.animationProperties[a].type&&(i=e.animationProperties[a].stroke),"duration"==e.animationProperties[a].type&&(n=e.animationProperties[a].duration),"reverse"==e.animationProperties[a].option&&(s="reverse")),configuration.basic.enable_low_performance||"true"===appProperties.lowPerformance?$("#"+a).css({display:o?"inline":"none","stroke-dasharray":i,"animation-direction":s}):$("#"+a).css({display:o?"inline":"none","stroke-dasharray":i,"animation-duration":n+"ms","animation-direction":s})})}catch(i){console.error("Could not apply Animations. The following error was thrown: "+i)}try{e.hasOwnProperty("css")&&JSON.stringify(e.css)!=JSON.stringify(globalTmpCSS)&&(Object.entries(e.css).forEach(e=>{let[t,a]=e;a.inactPos&&$("#"+t).removeClass(a.inactPos),a.inactNeg&&$("#"+t).removeClass(a.inactNeg),a.actPos&&$("#"+t).addClass(a.actPos),a.actNeg&&$("#"+t).addClass(a.actNeg)}),globalTmpCSS=e.css)}catch(n){console.error("Could not apply Own CSS-Values. The following error was thrown: "+n)}e.hasOwnProperty("override")&&applyElementOverrides(e.override)}}catch(s){console.error("An error occured, while refreshing the data! The following Error was thrown: "+s)}}async function applyElementOverrides(e){try{Object.keys(e).length>0&&Object.entries(e).forEach(async e=>{let[t,a]=e;Object.keys(a).length>0&&Object.entries(a).forEach(e=>{let[a,o]=e;switch(a.toLowerCase()){case"value":!1===o.status?console.warn(`Value-Overrides for element ${t} can not be processed, as they are not correctly formatted! Error: ${o.error} Supplied function: ${o.function}`):$(`#${t}_value`).html(generateMultiLineText(`${t}_value`,o,configuration.elements[t].pos_x));break;case"unit":!1===o.status?console.warn(`Unit-Overrides for element ${t} can not be processed, as they are not correctly formatted! Error: ${o.error} Supplied function: ${o.function}`):$(`#${t}_unit`).html(generateMultiLineText(`${t}_unit`,o,configuration.elements[t].pos_x));break;case"append":$(`#${t}_append`).html(generateMultiLineText(`${t}_append`,o,configuration.elements[t].pos_x));break;case"prepend":$(`#${t}_prepend`).html(generateMultiLineText(`${t}_prepend`,o,configuration.elements[t].pos_x));break;case"borderfillcolor":$(`#border_${t}`).css("stroke",o);break;case"fillcolor":$(`#gradient_color_${t}`).attr("stop-color",o);break;case"bordercolor":$(`#${t}`).css("stroke",o);break;case"img_url":$(`#${t}`).attr("href",o);break;case"icon":iconHandler(t,o);break;case"pos_x":case"pos_y":if(configuration.elements.hasOwnProperty(t)){if("text"==configuration.elements[t].type){let i="pos_x"==a.toLocaleLowerCase()?"x":"y";$(`#${t}`).attr(i,o)}else console.warn(`Pos X or Pos Y can not be applied to Element ${t}! This property can only be used on text or datasource elements!`)}break;case"pos_y":break;default:!1===o.status?console.warn(`Overrides for element ${t} can not be processed, as they are not correctly formatted! Error: ${o.error} Supplied function: ${o.function}`):$(`#${t}`).css(a,o)}})})}catch(t){console.error("Could not apply override rules. The following error was thrown: "+t)}}async function translateGoogle(e,t){try{$.ajax({minLength:1,url:"http://translate.googleapis.com/translate_a/single?client=gtx&sl=en&dt=t",type:"GET",data:{tl:t,q:e},success:function(e){console.log(e[0][0][0])},error:function(){console.log("Error while translating into "+t)},timeout:3e3})}catch(a){console.log("Error!")}}function loadConfig(){console.log("Loading config for instance: "+appProperties.instance),setTheme(appProperties.theme),appProperties.localMode?(getBackups("backup_list"),(configuration=localTest)?(console.log("Loading Local Config"),setLoadedConfig()):(basicConfig=!0,failedMessage(!0==displayMode?translateWord("failmsg_no_config_display_mode"):translateWord("failmsg_no_config")))):socket.emit("getStates",subscribeObjID,function(e,t){if(e)console.log(e),failedMessage(translateWord("failmsg_receiving_data"));else if(t){if(null!=t[subscribeObjID[0]]){console.log("Trying to load configuration from state!");try{if(configuration=JSON.parse(t[subscribeObjID[0]].val),0==Object.keys(configuration).length)throw Error("No configuration found in state! Using basic configuration instead!");backup_configuration=configuration,getBackups("backup_list")}catch(a){console.log("Error: No configuration in states found! Using basic configuration! "+a),basicConfig=!0,failedMessage(!0==displayMode?translateWord("failmsg_no_config_display_mode"):translateWord("failmsg_no_config")),console.log("Loading Basic configuration from file!"),$.getJSON("js/basic_config.json",function(e){(configuration=e)?(console.log("File loaded!"),console.debug(configuration),setLoadedConfig()):failedMessage(translateWord("failmsg_failed_config"))})}setLoadedConfig()}else sprintf(systemDictionary.msg_instance_loading[systemLang],appProperties.instance),failedMessage(sprintf(systemDictionary.failmsg_instance[systemLang],appProperties.instance));if(null!=t[subscribeObjID[1]])try{if(console.log("Loading initial Data"),t[subscribeObjID[1]].val)refreshData(JSON.parse(t[subscribeObjID[1]].val));else throw Error("No data to display found! Please check, if layout is configured and saved properly!")}catch(o){console.log("An error occured, while loading data! "+o)}globalAdapterOnline=null!=t[subscribeObjID[2]]&&t[subscribeObjID[2]].val}else failedMessage(translateWord("failmsg_no_values"))})}function generateStateTree(e,t){var a=performance.now();$(".title.folder, .title.state").off();let o=document,i=o.createElement("div"),n={};for(let s in i.setAttribute("id","stateRoot"),$("#"+t).append(i),e){let r=s.split("."),l="",c="";for(let d=0;d<r.length;d++)if(c=l,l=d>0?l+"."+r[d]:l+r[d],!o.getElementById(l)){let u=o.createElement("div");if(u.setAttribute("id",l),0==d)u.className="root",u.innerHTML=`<div class='title folder'><span class='type folderClosed'></span><span>${r[d]}</span></div>`,i.append(u);else if(u.className="sub","state"==e[s].type&&d==r.length-1)n[l]=e[s];else{let p="";d>1&&(p=e[s].hasOwnProperty("common")&&"state"!=e[s].type?e[s].common.name:""),u.innerHTML=`<div class='title folder'><span class='type folderClosed'></span><span>${r[d]}</span><span>${p}</span></div>`,o.getElementById(c)&&o.getElementById(c).append(u)}}}for(let g in n){let f=g,h=f.lastIndexOf("."),m=f.slice(0,h),b=f.slice(h+1,f.length);if(o.getElementById(m)){let y=o.createElement("div"),v="",x="";v=e[g].hasOwnProperty("common")?"object"==typeof e[g].common.name?e[g].common.name[systemLang]:e[g].common.name:"",x=n[g].hasOwnProperty("common")&&n[g].common.role||"",y.setAttribute("id",f),y.className="sub",y.innerHTML=`<div class='title state'><span class='type file'></span><span>${b}</span><span>${v}</span><span>${n[g].type}</span><span>${x}</span><span>${n[g].common.type}</span></div>`,o.getElementById(m).append(y)}}$(".title.folder").click(function(){$(this).find(".type").first().toggleClass("folderOpen folderClosed"),$(this).siblings().not(".filter_hidden").slideToggle("fast")}),$(".title.state").click(function(){$(".state").removeClass("active"),$(".state").children(".type").removeClass("file-selected"),$(this).toggleClass("active"),$(this).children(".type").addClass("file-selected"),console.log("Active state: "+$(this).parent().attr("id")),$("#select_state").prop("disabled",!1)}),document.querySelector(".stateExplorerFilter").onkeyup=null,document.querySelector(".stateExplorerFilter").onkeyup=async function(){let e=performance.now(),t=$("#stateRoot"),a=RegExp(this.value.trim().toLowerCase(),"gi");if($(".state").removeClass("active").children(".type").removeClass("file-selected"),$("#select_state").prop("disabled",!0),this.value)setTimeout(function(){t.find(".title").each(function(e,t){$(t).text().match(a)?$(t).parents(".root, .sub").removeClass("filter_hidden").addClass("filter green"):$(t).parent().removeClass("filter green").addClass("filter_hidden")}),t.find(".sub:visible").siblings().each(function(e,t){$(t).hasClass("filter_hidden")?$(t).slideUp():$(t).slideDown()});let o=performance.now();console.debug(`Filtered elements in ${o-e} ms`)},0);else{t.find(".root, .sub").removeClass("filter filter_hidden green");let o=t.find(".sub:visible").siblings();o.slideDown(),o.children(".folder").children("span.folderOpen").parent().siblings().slideDown()}},$("#stateExplorer_placeholder").hide();var w=performance.now();console.log(`StateTree build up in ${w-a} ms`)}async function openStateTree(e,t=""){globalIobObjectsLoaded||(iobObjects=await loadIobObjects(),generateStateTree(iobObjects,"stateExplorer")),$("#select_state").prop("disabled",!0),$("#"+e).scrollTop(0);let a=$("[id^='"+t+"']").first();$(".sub").hide(),$(".type.folderOpen").removeClass("folderOpen").addClass("folderClosed"),$(".stateExplorerFilter").val("").trigger("keyup"),$("#"+e).show(),a.length&&(a.children(".title.state").addClass("active"),a.children(".title.state").children(".type").addClass("file-selected"),a.parents(".sub").show(),a.parents(".sub").children(".sub").show(),a.siblings().show(),a.parents(".sub, .root").children("div.title").children(".type").toggleClass("folderOpen folderClosed"),$("#"+e).animate({scrollTop:a.offset().top-$("#stateExplorerContainer").height()/2}),$("#select_state").prop("disabled",!1))}function getElements(e,t){let a={},o=[],i=[],n=[],s=[],r=[],l=[],c=[],d=[],u=[];Object.entries(configuration.elements).forEach(e=>{let[t,a]=e;switch(a.type){case"text":"datasource"==a.subType?i.push({id:a.id,text:`${$(`#${t}`).text()} (${-1!=a.source?configuration.datasources[a.source].alias:""} - ID:  ${a.id})`}):o.push({id:a.id,text:`${$(`#${t}`).text()} (ID: ${a.id})`});break;case"circle":n.push({id:a.id,text:`ID ${a.id} (X: ${a.pos_x} Y: ${a.pos_y})`,y:a.pos_y});break;case"rect":s.push({id:a.id,text:`ID ${a.id} (X: ${a.pos_x} Y: ${a.pos_y})`,y:a.pos_y});break;case"icon":r.push({id:a.id,text:`ID ${a.id} (X: ${a.pos_x} Y: ${a.pos_y} - ${a.icon})`,y:a.pos_y});break;case"svg":c.push({id:a.id,text:`ID ${a.id} (X: ${a.pos_x} Y: ${a.pos_y})`,y:a.pos_y});break;case"image":d.push({id:a.id,text:`ID ${a.id} (X: ${a.pos_x} Y: ${a.pos_y})`,y:a.pos_y});break;case"foreignObject":u.push({id:a.id,text:`ID ${a.id} (X: ${a.pos_x} Y: ${a.pos_y})`,y:a.pos_y})}}),Object.entries(configuration.defs).forEach(e=>{let[t,a]=e,o=a.d.substring(1,a.d.indexOf(" "));l.push({id:`line_${a.id}`,text:`ID line_${a.id} (X: ${o})`,d:o})}),a={opt_elm_circle:n.sort((e,t)=>parseFloat(e.y)-parseFloat(t.y)),opt_elm_ds:i.sort((e,t)=>parseFloat(e.id)-parseFloat(t.id)),opt_elm_icons:r.sort((e,t)=>parseFloat(e.y)-parseFloat(t.y)),opt_elm_svg:c.sort((e,t)=>parseFloat(e.y)-parseFloat(t.y)),opt_elm_image:d.sort((e,t)=>parseFloat(e.y)-parseFloat(t.y)),opt_elm_fObj:u.sort((e,t)=>parseFloat(e.y)-parseFloat(t.y)),opt_elm_lines:l.sort((e,t)=>parseFloat(e.d)-parseFloat(t.d)),opt_elm_rect:s.sort((e,t)=>parseFloat(e.y)-parseFloat(t.y)),opt_elm_text:o.sort((e,t)=>e.text<t.text?-1:e.text>t.text?1:0)};let p=document.createDocumentFragment();for(var g of Object.keys(a)){let f=document.createElement("optgroup");for(var h of(f.label=translateWord(g),Object.keys(a[g]))){let m=new Option(a[g][h].text,a[g][h].id);m.selected=a[g][h].id==t,f.append(m)}p.appendChild(f)}let b=document.getElementById(e);b&&(b.innerHTML="",b.append(p))}function getDataSources(e,t,a=!0){let o=document.createDocumentFragment(),i;if(a&&o.append(new Option(translateWord("opt_please_choose"),"-1")),Object.keys(configuration.datasources).length>0){let n=Object.entries(configuration.datasources).sort(([,e],[,t])=>e.alias.toLowerCase()<t.alias.toLowerCase()?-1:e.alias.toLowerCase()>t.alias.toLowerCase()?1:0);for(var s of n){if(i=new Option(`${s[1].alias} (${s[1].source})`,s[0]),"object"==typeof t)for(var r in t)t[r]==s[0]&&(i.selected=!0);else i.selected=s[0]==t;o.appendChild(i)}}else(i=new Option(translateWord("no_ds_added"),"-1")).disabled=!0,i.title=translateWord("ex_no_ds_added"),o.appendChild(i);let l=document.getElementById(e);l&&(l.innerHTML="",l.append(o))}function checkDatasourcesInUse(e){let t={},a=0;return Object.entries(configuration.elements).forEach(o=>{let[i,n]=o;Array.isArray(n.add)&&-1!==n.add.map(e=>parseInt(e)).indexOf(e)&&(t[a++]={id:n.id,type:translateWord(`lbl_${n.subType?n.subType:n.type}`),reason:translateWord("failmsg_delete_source_as_addition")}),Array.isArray(n.subtract)&&-1!==n.subtract.map(e=>parseInt(e)).indexOf(e)&&(t[a++]={id:n.id,type:translateWord(`lbl_${n.subType?n.subType:n.type}`),reason:translateWord("failmsg_delete_source_as_subtraction")}),n.source==e&&(t[a++]={id:n.id,type:translateWord(`lbl_${n.subType?n.subType:n.type}`),reason:translateWord("failmsg_delete_source_as_source")}),n.source_action==e&&(t[a++]={id:n.id,type:translateWord(`lbl_${n.subType?n.subType:n.type}`),reason:translateWord("failmsg_delete_source_as_source_action")})}),Object.entries(configuration.calculation.consumption).forEach(o=>{let[i,n]=o;"boolean"!=typeof n&&n===e&&(t[a++]={id:translateWord(`lbl_consumption_${i}`).replace("*",""),type:translateWord(`lbl_consumption_${i}`).replace("*",""),reason:translateWord("failmsg_delete_source_as_consumption")}),Array.isArray(n)&&"production"==i&&-1!=n.map(e=>parseInt(e)).indexOf(e)&&(t[a++]={id:translateWord(`lbl_consumption_${i}`).replace("*",""),type:translateWord(`lbl_consumption_${i}`).replace("*",""),reason:translateWord("failmsg_delete_source_as_production")})}),Object.entries(configuration.calculation.battery).forEach(o=>{let[i,n]=o;"boolean"!=typeof n&&n==e&&(t[a++]={id:translateWord(`lbl_battery_${i}`).replace("*",""),type:translateWord(`lbl_battery_${i}`).replace("*",""),reason:translateWord("failmsg_delete_source_as_calculation")})}),Object.entries(configuration.animations).forEach(o=>{let[i,n]=o;n.source==e&&(t[a++]={id:i.replace("anim","line"),type:translateWord("lbl_animation"),reason:translateWord("failmsg_delete_source_as_source")})}),t}function receiveImage(e){return new Promise((t,a)=>{if(e){let o=new Image;if(e.startsWith("{")){console.debug("Loading image URL via ioBroker state: "+e);let i=e.substring(1,e.lastIndexOf("}"));socket.emit("getState",i,function(e,a){a?(o.onload=function(){t(a.val)},o.onerror=function(){t("")},null!=a.val&&""!=a.val?o.src=a.val:displayMode||t("img/icon_not_found.png")):console.log("A valid picture URL under the given source could not be found!")})}else e.match(/\//)||(e=appProperties.socketURL+appProperties.namespace+"/userFiles/"+e,console.debug("Loading image from gallery: "+e)),o.onload=function(){t(e)},o.onerror=function(){t("img/tmp_img.png")},o.src=e}else t("img/tmp_img.png");displayMode&&$(".type_image").removeClass("draggable")})}function updateDataSources(){for(var e of(console.debug("Refreshing Datasources!"),Object.keys(configuration.calculation)))for(var t of Object.keys(configuration.calculation[e]))"production"===t?(getDataSources(`calculation.${e}.${t}`,configuration.calculation[e][t],!1),$(`#calculation\\.${e}\\.${t}`).multiselect(multiselect_options)):"boolean"!=typeof configuration.calculation[e][t]&&getDataSources(`calculation.${e}.${t}`,configuration.calculation[e][t],!0)}function setLoadedConfig(e=!1){let t=0;if(configuration.basic.enable_icon_proxy?appProperties.hostname.match(/iobroker\.pro|iobroker\.net/)?(console.log("Using direct load via iconify-API!"),loadAdditionalJSFile("js/iconify.min.js")):(console.log("Using Icon-Proxy for Icons"),startIconObserver(),$(".iconify").each(async function(){loadIconViaProxy($(this).data("icon"),$(this))})):(console.log("Using direct load via iconify-API!"),loadAdditionalJSFile("js/iconify.min.js")),e&&$("#style_user").empty(),$("#style_user").append(configuration.basic.styles),!displayMode){for(var a of(t=100,resizeSVG(),Object.entries(configuration.basic).forEach(e=>{let[t,a]=e;if("object"==typeof a)for(var o of Object.keys(configuration.basic[t]))$(`#basic\\.${t}\\.${o}`).hasClass("color")?$(`#basic\\.${t}\\.${o}`)[0].jscolor.fromString(configuration.basic[t][o]):$(`#basic\\.${t}\\.${o}`).val(configuration.basic[t][o]);else switch(t){default:switch(typeof a){case"boolean":$(`#basic\\.${t}`).prop("checked",a);break;case"number":case"string":$(`#basic\\.${t}`).val(a)}break;case"enable_grid":$(`#basic\\.${t}`).prop("checked",a),a&&$("#help_grid").fadeIn("fast");break;case"height":$("#basic\\.height\\.slider").val(a),$("#basic\\.height").val(a),resizeSVG();break;case"width":$("#basic\\.width\\.slider").val(a),resizeSVG();break;case"background_color":$("#basic\\.background_color")[0].jscolor.fromString(a);break;case"styles":$("#own_css").length>0&&((aceCSS=ace.edit("own_css")).session.setMode("ace/mode/css"),aceCSS.setTheme("ace/theme/"+appProperties.aceEditorTheme[appProperties.colorScheme]),aceCSS.setOptions({enableBasicAutocompletion:!0,enableSnippets:!0,enableLiveAutocompletion:!0,enableAutoIndent:!0}),aceCSS.setValue(configuration.basic.styles,-1),aceCSS.resize(),aceCSS.on("change",function(){configuration.basic.styles=aceCSS.getSession().getValue(),$("#style_user").empty().append(configuration.basic.styles)}));break;case"animation_timer":$("#basic\\.animation_timer").val(configuration.basic.animation_timer?configuration.basic.animation_timer:1e3)}}),Object.keys(configuration.animation)))$(`#animation\\.${a}`).val(configuration.animation[a]);for(var a of Object.keys(configuration.animation_configuration))$(`#animation_configuration\\.${a}`).val(configuration.animation_configuration[a]);for(var a of Object.keys(configuration.line))$(`#line\\.${a}`).val(configuration.line[a]);for(var a of Object.keys(configuration.calculation))for(var o of Object.keys(configuration.calculation[a]))switch(o){default:getDataSources(`calculation.${a}.${o}`,configuration.calculation[a][o],!0);break;case"production":getDataSources(`calculation.${a}.${o}`,configuration.calculation[a][o],!1),$(`#calculation\\.${a}\\.${o}`).multiselect(multiselect_options);break;case"charge_prop":case"discharge_prop":case"gridFeed_prop":case"gridConsume_prop":case"batteryCharge_prop":case"batteryDischarge_prop":$(`#calculation\\.${a}\\.${o}`).prop("checked",configuration.calculation[a][o])}for(var a of(configuration.calculation.battery.dod>=0&&null!=configuration.calculation.battery.dod&&configuration.calculation.battery.capacity>=0&&null!=configuration.calculation.battery.capacity&&configuration.calculation.battery.percent>=0&&null!=configuration.calculation.battery.percent&&configuration.calculation.battery.charge>=0&&null!=configuration.calculation.battery.charge&&configuration.calculation.battery.discharge>=0&&null!=configuration.calculation.battery.discharge&&(console.debug("Battery configured!"),$("#calculation\\.battery\\.status").addClass("green").removeClass("red").text(translateWord("txt_calculation_succ"))),0!=configuration.calculation.consumption.production.indexOf(-1)&&configuration.calculation.consumption.production.length>0&&configuration.calculation.consumption.gridFeed>=0&&null!=configuration.calculation.consumption.gridFeed&&configuration.calculation.consumption.gridConsume>=0&&null!=configuration.calculation.consumption.gridConsume&&(console.debug("Consumption configured!"),$("#calculation\\.consumption\\.status").addClass("green").removeClass("red").text(translateWord("txt_calculation_succ"))),Object.keys(configuration.datasources)))addDataSourceRow(a,!0);configuration.basic.enable_ds_autocomplete&&$("#elm_ds_source").autocomplete(dataSourceAutocompleteOptions)}if(configuration.hasOwnProperty("elements")){$(".placeholders").empty();let i=[];for(var a in configuration.elements)i.push({key:a,position:configuration.elements[a].position||0});i.sort(function(e,t){return e.position-t.position});for(var n=0;n<i.length;n++)svgElement(configuration.elements[i[n].key],!1);for(var a of Object.keys(configuration.defs))svgElement(configuration.defs[a],!1);for(var a of Object.keys(configuration.lines))svgElement(configuration.lines[a],!1);for(var a of Object.keys(configuration.animations))svgElement(configuration.animations[a],!1);if(updateLineAnimation(),displayMode){if(configuration.basic.background_color&&(console.debug("Setting background color!"),$("#style_user").append(`html,body { background-color: ${configuration.basic.background_color}; }`)),$("#svg_display").attr({viewBox:"0 0 "+configuration.basic.width+" "+configuration.basic.height}),$(".all_elements").removeClass("anim_element no_animation"),$("#style_general").empty().append(".line { cursor: none; pointer-events: none; } .all_elements:hover { opacity: unset; }"),$("#config_link > a").attr("href","configuration.html?instance="+appProperties.instance),!1==configuration.basic.enable_config_icon?$("#config_link").hide():$("#config_link").show(),configuration.basic.enable_low_performance||"true"===appProperties.lowPerformance){console.log("Low performance mode activated!"),$(".type_animation").addClass("animation");var s=$(".animation");let r=0;setInterval(function(){r=r<=-136?0:r,s.css("stroke-dashoffset",r),r-=1},20)}else $(".type_animation").addClass("animation animation_cfg");$("#overlay_frame").on("load",function(){""!=$(this).attr("src")&&($(".loading-spinner, #loading_text").fadeOut("fast"),$("#frameContainer").fadeIn("middle").css("display","block"))}),e?console.log("Applying config without re-adding socket listener!"):displayListener()}basicConfig||displayMode||successMessage(translateWord("succ_msg_loading")),setTimeout(()=>{$("#loading").fadeOut("fast")},t)}else successMessage(translateWord("succ_msg_loading_basic")),setTimeout(()=>{$("#loading").fadeOut("fast")},t),$("#config_link > a").attr("href","configuration.html?instance="+appProperties.instance).show()}function updateLineAnimation(){$("#style_animation").empty().append(`.line {stroke-width:${configuration.line.stroke_width}px; stroke:${configuration.line.stroke}; }`).append(`.animation {stroke:${configuration.animation.stroke}; stroke-dasharray:${configuration.animation.stroke_dasharray};`).append(`stroke-width:${configuration.animation.stroke_width}px; stroke-linecap:${configuration.animation.stroke_linecap}; }`).append(`.animation_cfg {animation-duration:${configuration.animation.animation_duration}ms; animation-timing-function:${configuration.animation.animation_timing_function}; }`),displayMode&&$("#style_animation").append(".type_animation {display: none;}")}function linePreview(e){let t="",a=136,o=parseInt($("#animation\\.stroke_width").val()),i=parseInt($("#animation_configuration\\.dots").val()),n=parseInt($("#animation_configuration\\.distance").val()),s=parseInt($("#animation_configuration\\.length").val()),r=parseInt($("#line\\.stroke_width").val()),l=parseInt($("#animation\\.animation_duration").val()),c=$("#animation\\.stroke_linecap").val(),d=$("#animation\\.animation_timing_function").val();for(let u=0;u<i;u++)n>0&&s>0&&(t+=s+" ",u!=i-1&&(t+=n+" ",a-=n),a-=s);i>0&&s>0&&n&&(t+=" "+a),a<0&&$("#"+e).val($("#"+e).val()-1),configuration.animation={stroke_dasharray:t,stroke_width:o,animation_duration:l,stroke_linecap:c,animation_timing_function:d},configuration.animation_configuration={dots:i,distance:n,length:s},configuration.line={stroke_width:r,stroke:"#000000"},updateLineAnimation()}function successMessage(e){let t=$("#message_success");t.html(e),t.stop().fadeIn("middle",function(){$(this).delay(2e3).fadeOut("middle",function(){$(this).html("")})})}function failedMessage(e){let t=$("#message_failed");t.html(e),t.stop().fadeIn("middle",function(){$(this).delay(2e3).fadeOut("middle",function(){$(this).html("")})})}function resizeSVG(){let e=document.getElementById("svg_config");e.setAttribute("width",configuration.basic.width),e.setAttribute("height",configuration.basic.height),e.setAttribute("viewBox",`0 0 ${configuration.basic.width} ${configuration.basic.height}`)}function getCoords(e){let t=Number(configuration.elements[e].width),a=Number(configuration.elements[e].height),o=Number(configuration.elements[e].pos_x),i=Number(configuration.elements[e].pos_y),n=Number(configuration.elements[e].radius)||0,s=0,r=0;switch(configuration.elements[e].type){case"circle":t=2*n,a=2*n,o-=n,i-=n,s=Number(configuration.elements[e].pos_x),r=Number(configuration.elements[e].pos_y);break;case"text":let l=document.getElementById(e).getBBox();t=Math.round(l.width),a=Math.round(l.height),o=Math.round(o-t/2),i=Math.round(i-a/2)}return{cx:s,cy:r,x:o,y:i,width:t,height:a,r:n,stroke:Number(configuration.elements[e].stroke)||0}}function showConnectionPoints(e=!0){e?($("#connection_points").empty(),$(".connector").each(function(){let e=$(this).attr("id"),t={};t[e]={};let a=$(this).prop("tagName"),o,i,n,s,r,l,c;switch(a){case"circle":o=2*parseInt($(this).attr("r")),i=2*parseInt($(this).attr("r")),n=parseInt($(this).attr("cx"))-i/2,s=parseInt($(this).attr("cy"))-o/2,r=parseInt($(this).attr("r")),l=parseInt($(this).attr("cx")),c=parseInt($(this).attr("cy")),t[e].top_left={x:l+r*Math.cos(connectorAngle(340)),y:c+r*Math.sin(connectorAngle(340))},t[e].top_right={x:l+r*Math.cos(connectorAngle(20)),y:c+r*Math.sin(connectorAngle(20))},t[e].right_top={x:l+r*Math.cos(connectorAngle(70)),y:c+r*Math.sin(connectorAngle(70))},t[e].right_bottom={x:l+r*Math.cos(connectorAngle(110)),y:c+r*Math.sin(connectorAngle(110))},t[e].bottom_left={x:l+r*Math.cos(connectorAngle(200)),y:c+r*Math.sin(connectorAngle(200))},t[e].bottom_right={x:l+r*Math.cos(connectorAngle(160)),y:c+r*Math.sin(connectorAngle(160))},t[e].left_bottom={x:l+r*Math.cos(connectorAngle(250)),y:c+r*Math.sin(connectorAngle(250))},t[e].left_top={x:l+r*Math.cos(connectorAngle(290)),y:c+r*Math.sin(connectorAngle(290))};break;case"rect":o=parseInt($(this).attr("height")),i=parseInt($(this).attr("width")),n=parseInt($(this).attr("x")),s=parseInt($(this).attr("y")),t[e].top_left={x:n+i/2-20,y:s},t[e].top_right={x:n+i/2+20,y:s},t[e].left_top={x:n,y:s+o/2-20},t[e].left_bottom={x:n,y:s+o/2+20},t[e].right_top={x:n+i,y:s+o/2-20},t[e].right_bottom={x:n+i,y:s+o/2+20},t[e].bottom_left={x:n+i/2-20,y:s+o},t[e].bottom_right={x:n+i/2+20,y:s+o}}t[e].top={x:n+i/2,y:s},t[e].left={x:n,y:s+o/2},t[e].right={x:n+i,y:s+o/2},t[e].bottom={x:n+i/2,y:s+o},Object.entries(t).forEach(t=>{let[a,o]=t;Object.entries(o).forEach(t=>{let[a,o]=t,i=document.createElementNS("http://www.w3.org/2000/svg","circle");i.setAttribute("class","tmp_conn_points"),i.setAttribute("cx",o.x),i.setAttribute("cy",o.y),i.setAttribute("r",5),i.setAttribute("class","connPoints clickable"),i.setAttribute("data-slot",a),i.setAttribute("data-element",e),$(i).appendTo("#connection_points")})})})):$("#connection_points").empty()}function getSlots(e){let t=Math.floor(e.width/2),a=Math.floor(e.height/2),o=Math.floor(e.stroke/2);return{top:{x:e.x+t,y:e.y-o,direction:"vertical"},right:{x:e.x+e.width+o,y:e.y+a,direction:"horizontal"},bottom:{x:e.x+t,y:e.y+e.height+o,direction:"vertical"},left:{x:e.x-o,y:e.y+a,direction:"horizontal"}}}function connectorAngle(e){return(e-90)*Math.PI/180}function getSpecialSlots(e,t){let a=Math.floor(e.width/2),o=Math.floor(e.height/2),i=Math.floor(e.stroke/2),n=[];return n.top={x:e.x+a,y:e.y-i,direction:"vertical"},n.left={x:e.x-i,y:e.y+o,direction:"horizontal"},n.right={x:e.x+e.width+i,y:e.y+o,direction:"horizontal"},n.bottom={x:e.x+a,y:e.y+e.height+i,direction:"vertical"},e.r>0?(n.top_left={x:e.cx+e.r*Math.cos(connectorAngle(340)),y:e.cy+e.r*Math.sin(connectorAngle(340))-i,direction:"vertical"},n.top_right={x:e.cx+e.r*Math.cos(connectorAngle(20)),y:e.cy+e.r*Math.sin(connectorAngle(20))-i,direction:"vertical"},n.right_top={x:e.cx+e.r*Math.cos(connectorAngle(70))+i,y:e.cy+e.r*Math.sin(connectorAngle(70)),direction:"horizontal"},n.right_bottom={x:e.cx+e.r*Math.cos(connectorAngle(110))+i,y:e.cy+e.r*Math.sin(connectorAngle(110)),direction:"horizontal"},n.bottom_left={x:e.cx+e.r*Math.cos(connectorAngle(200)),y:e.cy+e.r*Math.sin(connectorAngle(200))+i,direction:"vertical"},n.bottom_right={x:e.cx+e.r*Math.cos(connectorAngle(160)),y:e.cy+e.r*Math.sin(connectorAngle(160))+i,direction:"vertical"},n.left_bottom={x:e.cx+e.r*Math.cos(connectorAngle(250))-i,y:e.cy+e.r*Math.sin(connectorAngle(250)),direction:"horizontal"},n.left_top={x:e.cx+e.r*Math.cos(connectorAngle(290))-i,y:e.cy+e.r*Math.sin(connectorAngle(290)),direction:"horizontal"}):(n.top_left={x:e.x+a-20,y:e.y-i,direction:"vertical"},n.top_right={x:e.x+a+20,y:e.y-i,direction:"vertical"},n.right_top={x:e.x+e.width+i,y:e.y+o-20,direction:"horizontal"},n.right_bottom={x:e.x+e.width+i,y:e.y+o+20,direction:"horizontal"},n.bottom_left={x:e.x+a-20,y:e.y+e.height+i,direction:"vertical"},n.bottom_right={x:e.x+a+20,y:e.y+e.height+i,direction:"vertical"},n.left_top={x:e.x-i,y:e.y+o-20,direction:"horizontal"},n.left_bottom={x:e.x-i,y:e.y+o+20,direction:"horizontal"}),{spec:n[t]}}function getDistance(e,t){let a=0,o=0;return a=t.x>e.x?t.x-e.x:e.x-t.x,a*=a,o=t.y>e.y?t.y-e.y:e.y-t.y,Math.sqrt(a+(o*=o))}async function connectElements(e){return new Promise((t,a)=>{let o=$(".line:not(.faded_out, .preview)"),i,n,s,r;$(".connector").length>=2?($(`#${e}`).toggleClass("red"),$(`.connect_elements:not(#${e})`).prop("disabled",!0)):failedMessage(translateWord("failmsg_no_elements")),$(`#${e}`).hasClass("red")?($(`#${e}`).val(translateWord("value_cancel")),"connect_elements"==e&&hideConfigBar(),showConnectionPoints(),$(`#ex_${e}`).html("connect_elements"==e?translateWord("ex_connect_ref")+" <img src='img/icon_help.png' class='help' style='vertical-align: bottom;' placeholder='"+translateWord("help_connect")+"'>":translateWord("ex_reconnect_ref")),$(".all_elements").addClass("faded_out no_click"),"reconnect_elements"==e&&$("#"+o[0].id+", #"+o[0].id.replace("anim","line")).removeClass("faded_out"),$(".connector").removeClass("draggable faded_out no_click").addClass("clickable"),$(".clickable").off().click(function(a){let l=a.target.id?a.target.id:$(this).data("element"),c=$(this).data("slot")?$(this).data("slot"):"element";if(null==i)i=l,s=c,$(`#ex_${e}`).html(translateWord("ex_connect_start")),$(this).addClass("red");else if(i==l)$(`#ex_${e}`).html(translateWord("ex_connect_same")),n=null,r=null;else{n=l,r=c;let d="path_"+i+"_"+n;if($("#"+d).length>0)"connect_elements"==e?failedMessage(translateWord("failmsg_conn_exists")):(configuration.defs[d].startSlot=s,configuration.defs[d].endSlot=r,calculatePath(d,i,n),globalConfigChanged=!0);else{switch(configuration.defs[d]={type:"def",id:d,startSlot:s,endSlot:r,d:""},svgElement(configuration.defs[d],!1),calculatePath(d,i,n),e){case"connect_elements":configuration.lines["line_"+d]={type:"line",id:"line_"+d,color:configuration.line.stroke,href:"#"+d},configuration.animations["anim_"+d]={type:"animation",id:"anim_"+d,color:configuration.animation.stroke,href:"#"+d,source:-1,animation_properties:"positive",animation_option:!1,threshold:null,dots:null,duration:null,power:null,animation_type:-1,css_general:"",css_active_positive:"",css_inactive_positive:"",css_active_negative:"",css_inactive_negative:""};break;case"reconnect_elements":if(1==o.length){let u=o[0].id,p=o[0].id.replace("line_",""),g=o[0].id.replace("line","anim");delete Object.assign(configuration.defs,{[d]:configuration.defs[p]})[p],delete Object.assign(configuration.lines,{["line_"+d]:configuration.lines[u]})[u],delete Object.assign(configuration.animations,{["anim_"+d]:configuration.animations[g]})[g],configuration.defs[d].id=d,configuration.lines["line_"+d].id="line_"+d,configuration.lines["line_"+d].href="#"+d,configuration.animations["anim_"+d].id="anim_"+d,configuration.animations["anim_"+d].href="#"+d,$(`#${g}, #${u}, #${p}`).remove()}}svgElement(configuration.lines["line_"+d],!1),svgElement(configuration.animations["anim_"+d],!1),globalConfigChanged=!0}t("line_"+d),showConnectionPoints(!1),i=null,n=null,$(`#${e}`).val("connect_elements"==e?translateWord("value_connect"):translateWord("value_reconnect")).removeClass("red"),$(`#ex_${e}`).html("connect_elements"==e?translateWord("ex_connect"):translateWord("ex_reconnect")),$(".connect_elements").prop("disabled",!1),$(".clickable").off(),$(".added_elements").removeClass("clickable").addClass("draggable"),$(".all_elements").removeClass("connect_elements"==e?"no_click faded_out":"no_click")}})):($(".clickable").off(),$(".added_elements").removeClass("clickable").addClass("draggable"),$(".all_elements").removeClass("faded_out no_click"),$(`#${e}`).val("connect_elements"==e?translateWord("value_connect"):translateWord("value_reconnect")),$(`#ex_${e}`).html("connect_elements"==e?translateWord("ex_connect"):translateWord("ex_reconnect")),showConnectionPoints(!1),$(".connect_elements").prop("disabled",!1))})}function calculatePath(e,t,a){let o=getCoords(t),i=getCoords(a),n,s,r=configuration.defs[e].startSlot,l=configuration.defs[e].endSlot,c=[],d=[],u=[],p=[],g=[],f=[],h=[];for(var m of(n="element"!=r?getSpecialSlots(o,r):getSlots(o),s="element"!=l?getSpecialSlots(i,l):getSlots(i),console.log(n),Object.keys(n))){let b=n[m];for(var m of Object.keys(s)){let y=s[m];c.push(getDistance(b,y)),d.push(b.x),p.push(b.y),f.push(b.direction),u.push(y.x),g.push(y.y),h.push(y.direction)}}let v=c[0],x=0;for(var w=1;w<c.length;w++)c[w]<v&&(v=c[w],x=w);let k=d[x],C=p[x],_;drawPath(e,k,C,u[x],g[x],f[x],h[x])}function polarToCartesian(e,t,a,o){var i=(o-90)*Math.PI/180;return{x:e+a*Math.cos(i),y:t+a*Math.sin(i)}}function describeArc(e,t,a,o,i,n){var s=polarToCartesian(e,t,a,i);return["A",a,a,0,i-o<=180?"0":"1",n,s.x,s.y]}function drawPath(e,t,a,o,i,n,s,r){console.log(n,s);let l={x:t,y:a},c=[`M${t} ${a}`],d=Math.abs(o-t),u=Math.abs(i-a),p=15,g;function f(e){c.push(`H ${e}`),l.x=e}function h(e){c.push(`V ${e}`),l.y=e}d<2*p&&(p=Math.floor(d/2)),u<2*p&&(p=Math.floor(u/2)),i==a&&f(o),o===t&&h(i),i>a&&o>t&&("horizontal"==n?"horizontal"==s?(f(t+.2*d),g=describeArc(l.x,l.y+p,p,0,90,1),c.push(g.join(" ")),h(i-p),c.push(describeArc(g[6],l.y+p,p,0,90,0).join(" ")),f(o)):(f(o-p),c.push(describeArc(l.x,l.y+p,p,0,90,1).join(" ")),h(i)):"vertical"==s?(h(a+.2*u),g=describeArc(l.x,l.y+p,p,0,90,0),c.push(g.join(" ")),f(o-p),c.push(describeArc(l.x,g[7]+p,p,0,90,1).join(" ")),h(i),console.log(c)):(h(i-p),g=describeArc(l.x,l.y+p,p,0,90,0),c.push(g.join(" ")),f(o))),i>a&&o<t&&("horizontal"==n?"horizontal"==s?(f(t-.2*d),g=describeArc(l.x,l.y+p,p,180,270,0),c.push(g.join(" ")),h(i-p),c.push(describeArc(g[6],l.y+p,p,180,270,1).join(" ")),f(o)):(f(o+p),c.push(describeArc(l.x,l.y+p,p,180,270,0).join(" ")),h(i)):"vertical"==s?(h(a+.2*u),g=describeArc(l.x-p,l.y,p,90,180,1),c.push(g.join(" ")),f(o+p),c.push(describeArc(l.x,g[7]+p,p,180,270,0).join(" ")),h(i)):(h(i-p),c.push(describeArc(l.x,l.y+p,p,180,270,1).join(" ")),f(o))),i<a&&o>t&&("horizontal"==n?"horizontal"==s?(f(t+.2*d),g=describeArc(l.x,l.y-p,p,0,90,0),c.push(g.join(" ")),h(i+p),c.push(describeArc(g[6]+p,l.y,p,270,360,1).join(" ")),f(o)):(f(o-p),c.push(describeArc(l.x,l.y-p,p,0,90,0).join(" ")),h(i)):"vertical"==s?(h(a-.2*u),g=describeArc(l.x,l.y-p,p,0,90,1),c.push(g.join(" ")),f(o-p),c.push(describeArc(l.x,g[7]-p,p,0,90,0).join(" ")),h(i)):(h(i+p),c.push(describeArc(l.x,l.y-p,p,0,90,1).join(" ")),f(o))),i<a&&o<t&&(console.log("Main"),"horizontal"==n?"horizontal"==s?(f(t-.2*d),g=describeArc(l.x,l.y-p,p,180,270,1),c.push(g.join(" ")),h(i+p),c.push(describeArc(g[6]-2*p,l.y-p,p,0,90,0).join(" ")),f(o)):(f(o+p),c.push(describeArc(l.x,l.y-p,p,180,270,1).join(" ")),h(i)):"vertical"==s?(h(a-.2*u),g=describeArc(l.x-2*p,l.y-p,p,0,90,0),c.push(g.join(" ")),f(o+p),c.push(describeArc(l.x,g[7]-p,p,180,270,1).join(" ")),h(i)):(h(i+p),c.push(describeArc(l.x-2*p,l.y-p,p,0,90,0).join(" ")),f(o))),configuration.defs[e].d=c.join(" "),console.debug(`Setting path for ${e} to: ${configuration.defs[e].d}`),$("#"+e).attr("d",configuration.defs[e].d)}function showConfigBar(e,t){$(".tab1_config").scrollTop(0),$(".tab2_config").scrollTop(0),$("#tab1_config").prop("checked",!0),$("#elm_counter_animation, #elm_convert").prop("checked",!1),$("#elm_select").selectmenu({open:function(){$($(this).selectmenu("instance").menu).children(".ui-menu-item").find("div.ui-state-active")[0].scrollIntoView({block:"center"})},position:{my:"right top+2",at:"right bottom",collision:"fit"}}).selectmenu("menuWidget").addClass("select_overflow"),getElements("elm_select",e),$("#elm_select").val(e).selectmenu("refresh").off().on("selectmenuchange",function(){showConfigBar($(this).val(),$("#"+$(this).val()).prop("tagName"))}),$(".all_elements").removeClass("active_element").addClass("faded_out"),$("#"+e).removeClass("faded_out").addClass("active_element"),$(".elm_config, #reconnect_elements, #delete_element").prop("disabled",!1),$("#restore_element").prop("disabled",!0),$(".elm_config_box, .elm_config_box_sub, .frame_deactivated, .enable_clock").hide(),$(".elm_config").val(""),$(".elm_config").prop("checked",!1),$("select.elm_config").each(function(){$(this)[0].selectedIndex=0}),$(".elm_config.color").each(function(){$(this)[0].jscolor.fromString("")}),$("#elm_icon").hasClass("ui-autocomplete-input")&&$("#elm_icon").autocomplete("destroy"),$("#elm_href").hasClass("ui-autocomplete-input")&&$("#elm_href").autocomplete("destroy");let a=Object.assign({},configuration.elements[e]),o={},i={},n={};switch(t){case"rect":$(".elm_config_box.rect").show();break;case"circle":$(".elm_config_box.circle").show();break;case"text":if($(".elm_config_box.text").show(),$(".text_not_ds").show(),"datasource"==a.subType)switch($(".elm_config_box.datasource").show(),$(".text_not_ds, .text_only").hide(),getDataSources("elm_subtract",a.subtract,!1),getDataSources("elm_add",a.add,!1),$("#elm_subtract").siblings(".ms-options-wrap").length>0?$("#elm_subtract").multiselect("reload"):$("#elm_subtract").multiselect(multiselect_options),$("#elm_add").siblings(".ms-options-wrap").length>0?$("#elm_add").multiselect("reload"):$("#elm_add").multiselect(multiselect_options),getDataSources("elm_source_action",a.source_action,!0),a.source_display){default:case"value":$(".text_not_ds").hide(),$(".linebreak_text").hide();break;case"own_text":$(".text_not_ds").show();break;case"text":$(".linebreak_text").show()}break;case"use":$(".elm_config_box.use").show(),n={animation:e.replace("line","anim"),def:e.replace("line_",""),line:e},console.debug(`Init: ${JSON.stringify(n)}`),a=Object.assign({},configuration.animations[n.animation]),o=Object.assign({},configuration.lines[n.line]),i=Object.assign({},configuration.defs[n.def]),getDataSources("elm_animation",a.source,!0),$("#elm_start_slot").val("element"==i.startSlot?translateWord("value_element"):translateWord("value_"+i.startSlot)),$("#elm_end_slot").val("element"==i.endSlot?translateWord("value_element"):translateWord("value_"+i.endSlot)),$("#elm_line_color")[0].jscolor.fromString(o.color),$("#"+e).removeClass("faded_out");break;case"svg":"svg"==a.subType?$(".elm_config_box.svg").show():$(".elm_config_box.icon").show();break;case"image":$(".elm_config_box.image").show();break;case"foreignObject":$(".elm_config_box.fObj").show()}switch(Object.entries(a).forEach(e=>{let[t,o]=e;if("object"==typeof o&&o&&"clock"===t)for(var i of Object.keys(a[t]))$(`#elm_${t}\\.${i}`).val(a[t][i]);$(`#elm_${t}`).val(o),$(`#elm_${t}`).data("jscolor")&&(o?($(`#elm_${t}`)[0].jscolor.fromString("none"==o||""==o?"":o),"color"==t&&$("#elm_border_value_fill").prop("disabled",!0)[0].jscolor.fromString(a.color)):$(`#elm_${t}`).val("")),"boolean"==typeof o&&$(`#elm_${t}`).prop("checked",!0===o)}),-1!=a.fill_type&&a.fill_type?($(".fill_type").show(),"value"==a.fill_type?$(".fill_type_value").show():$(".fill_type_value").hide()):($(".fill_type,.fill_type_value").hide(),$("#elm_fill_type").val("-1")),-1!=a.border_type&&a.border_type?($(".border_type").show(),"value"==a.border_type?$(".border_type_value").show():$(".border_type_value").hide()):($(".border_type,.border_type_value").hide(),$("#elm_border_type").val("-1")),a.border_reverse&&$(".border_reverse_value").show(),a.enable_clock&&($(".enable_clock").show(),$("#elm_text").prop("disabled",!0)),getDataSources("elm_source",a.source,!0),a.action){case"none":$(".action_shortcuts, .frame_deactivated").hide();break;case"on":case"off":case"toggle":$(".frame_deactivated").show(),$(".action_shortcuts").hide();break;case"change":$(".frame_deactivated, .action_shortcuts").show()}let s=null;$("#config_bar").addClass("show");let r=0,l;function c(){if("datasource"==a.subType){if("own_text"!=configuration.elements[e].source_display&&-1!=configuration.elements[e].source){let t={id:e,source:configuration.datasources[configuration.elements[e].source].source,source_option:configuration.elements[e].source_option,source_display:configuration.elements[e].source_display,linebreak:configuration.elements[e].linebreak,type:configuration.elements[e].type,threshold:configuration.elements[e].threshold,calculate_kw:configuration.elements[e].calculate_kw,decimal_places:configuration.elements[e].decimal_places,override:configuration.elements[e].override};console.debug("Requesting new Data with: ",t),socket.emit("sendTo",appProperties.namespace,"_updateElementInView",t,function(t){t&&t.error?console.log("An error occured, while getting the updated value: ",t.error):($(`#${t.data.id}_value`).html(generateMultiLineText(`${t.data.id}_value`,t.data.value,$("#"+e).attr("x"))),Object.keys(t.data.override).length>0&&applyElementOverrides(t.data.override))})}else console.log("Source option is own text! Not requesting!")}}$(".degree").off().on("click",function(){globalConfigChanged=!0,$("#restore_element").prop("disabled",!1);let t=configuration.elements[e].degree||0;t=(t="rotate_cw"==$(this).attr("id")?t+45:t-45)<=315&&t>=-315?t:0,configuration.elements[e].degree=t,$("#"+e).css({"transform-box":"fill-box",transform:`rotate(${t}deg)`})}),$("#delete_element").off().click(function(){(this.blur(),"animation"===a.type)?(delete configuration.lines[n.line],delete configuration.defs[n.def],delete configuration.animations[n.animation],$(`#${n.def}, #${n.line}, #${n.animation} `).remove(),successMessage(translateWord("succ_msg_line_delete")),$("#restore_element").prop("disabled",!1),$(".elm_config, #reconnect_elements, #delete_element").prop("disabled",!0)):-1!=$("[id^=line_path").map(function(){let e=this.id.split("_");return[parseInt(e[2]),parseInt(e[3])]}).get().indexOf(parseInt(e))?failedMessage(translateWord("failmsg_element_delete")):(delete configuration.elements[e],$("#"+e).remove(),successMessage(translateWord("succ_msg_delete")),$("#restore_element").prop("disabled",!1),$(".elm_config, #reconnect_elements, #delete_element").prop("disabled",!0))}),$(".changeOrder").off().click(function(){$("#restore_element").prop("disabled",!1);let t=$("#"+e).next(),o=$("#"+e).prev();switch($(this).attr("id")){case"changeOrder_foreground":t.length>0?$("#"+e).insertAfter(t):failedMessage(translateWord("failmsg_max_foreground"));break;case"changeOrder_background":o.length>0?$("#"+e).insertBefore(o):failedMessage(translateWord("failmsg_max_background"))}"animation"===a.type?configuration.lines[e].position=$("#"+e).index():configuration.elements[e].position=$("#"+e).index()}),$(".elm_config").off().on("input change",async function(t){$("#restore_element").prop("disabled",!1),globalConfigChanged=!0;let o=t.target.id.replace("elm_",""),i;switch(this.type){case"textarea":case"url":case"text":i=this.value;break;case"select-multiple":i=$(this).val().map(e=>parseInt(e));break;case"select-one":i=isNaN(this.value)?this.value:parseInt(this.value);break;case"number":i=parseInt(this.value);break;case"checkbox":i=this.checked}switch(l==t.target.id||(r=t.target.value,l=t.target.id),t.target.id){case"elm_animation_type":"dots"==i?($(".anim_type_duration").hide(),$(".anim_type_dots, .anim_type_power").slideDown("slow")):"duration"==i?($(".anim_type_dots").hide(),$(".anim_type_duration, .anim_type_power").slideDown("slow")):$(".anim_type_duration, .anim_type_dots, .anim_type_power").slideUp("slow");break;case"elm_fill_type":-1==i?$(".fill_type,.fill_type_value").slideUp("slow"):($(".fill_type").slideDown("slow"),$("#elm_fill_direction").val(a.fill_direction||90).trigger("change"),"value"==i?$(".fill_type_value").slideDown("slow"):$(".fill_type_value").slideUp("slow"));break;case"elm_border_type":-1==i?$(".border_type, .border_type_value").slideUp("slow"):($(".border_type").slideDown("slow"),$("#elm_border_start").val(a.border_start||180).trigger("change"),$("#elm_border_direction").val(a.border_direction||"cw").trigger("change"),$("#elm_border_style").val(a.border_style||"round").trigger("change"),$("#elm_border_reverse").prop("checked",a.border_reverse).trigger("change"),"value"==i?$(".border_type_value").slideDown("slow"):$(".border_type_value").slideUp("slow"));break;case"elm_border_reverse":i?$(".border_reverse_value").slideDown("slow"):($("#elm_border_reverse_value")[0].jscolor.fromString(""),$(".border_reverse_value").slideUp("slow"));break;case"elm_source_display":switch(i){default:case"value":$(".text_not_ds").slideUp("slow"),$(".linebreak_text").slideUp("slow"),$("#elm_counter_animation").prop("disabled",!1);break;case"own_text":$("#elm_text").val(`ID ${e}`),$(".text_not_ds").slideDown("fast"),$(".tab1_config").scrollTo($("#elm_text").parent().closest(".detail_box"),1e3);break;case"text":$(".linebreak_text").slideDown("slow"),$("#elm_counter_animation").prop("disabled",!0)}break;case"elm_action":switch(i){case"none":$(".action_shortcuts, .frame_deactivated").slideUp("slow");break;case"on":case"off":case"toggle":$(".frame_deactivated").slideDown("slow"),$(".action_shortcuts").slideUp("slow");break;case"change":$(".frame_deactivated").fadeIn("slow"),$(".frame_deactivated, .action_shortcuts").slideDown("slow"),$(".tab2_config").scrollTo($(this).parent().closest(".detail_box"),1e3,0),$("#elm_action_type").val(configuration.elements[e].hasOwnProperty("action_type")?configuration.elements[e].action_type:"number"),configuration.elements[e].hasOwnProperty("action_type")||(configuration.elements[e].action_type="number"),$("#elm_action_display").val(configuration.elements[e].hasOwnProperty("action_display")?configuration.elements[e].action_display:"button"),configuration.elements[e].hasOwnProperty("action_display")||(configuration.elements[e].action_display="button"),$("#elm_action_display_freeform").prop("checked",!configuration.elements[e].hasOwnProperty("action_display_freeform")||configuration.elements[e].action_display_freeform),configuration.elements[e].hasOwnProperty("action_display_freeform")||(configuration.elements[e].action_display_freeform=!0)}break;case"elm_enable_clock":i?($("#elm_text").prop("disabled",!0),$(".enable_clock").slideDown("slow"),$(".tab1_config").scrollTo($(this).parent().closest(".detail_box"),1e3,0)):($("#elm_text").prop("disabled",!1),$(".enable_clock").slideUp("slow"))}let d=$("path[id*="+e+"]");d.length>0&&d.each(function(e){let t=d[e].id.split("_");calculatePath(d[e].id,t[1],t[2])});let u=parseInt($("#svg_config").attr("height")),p=parseInt($("#svg_config").attr("width")),g=parseInt($("#elm_radius").val()),f=parseInt($("#elm_stroke").val())/2,h=parseInt($("#elm_font_size").val()),m,b,y=parseInt($("#elm_pos_x").val()),v=parseInt($("#elm_pos_y").val());function x(){"input"==t.type&&(clearTimeout(s),s=setTimeout(()=>{$("#"+t.target.id).val(r)},500))}switch(a.type){case"rect":m=p-$("#elm_width").val()-f,b=u-$("#elm_height").val()-f,y-f>=0&&y<=m&&v-f>=0&&v<=b?(r=t.target.value,$("#"+e).attr({width:$("#elm_width").val(),height:$("#elm_height").val(),rx:$("#elm_rx").val(),x:y,y:v}),clearTimeout(s)):x(),$("#elm_border_value_fill").prop("disabled",!0)[0].jscolor.fromString($("#elm_color").val());break;case"circle":m=p-g-f,b=u-g-f,y-f-g>=0&&v-f-g>=0&&y<=m&&v<=b?(r=t.target.value,$("#"+e).attr({r:$("#elm_radius").val(),cx:y,cy:v}),clearTimeout(s)):x(),$("#elm_border_value_fill").prop("disabled",!0)[0].jscolor.fromString($("#elm_color").val());break;case"text":m=p-$("#elm_font_size").val(),b=u-$("#elm_font_size").val()/2,y-h>=0&&y<=m&&v-h/2>=0&&v<=b?(r=t.target.value,$("#"+e).attr({x:y,y:v}),clearTimeout(s)):x(),"datasource"==a.subType?($("#"+e+"_unit").html(" "+generateMultiLineText(`${e}_unit`,$("#elm_unit").val(),y)),$("#"+e+"_append").html(generateMultiLineText(`${e}_append`,$("#elm_append").val(),y)),$("#"+e+"_prepend").html(generateMultiLineText(`${e}_prepend`,$("#elm_prepend").val(),y)),"own_text"==$("#elm_source_display").val()&&$("#"+e+"_value").html(generateMultiLineText(`${e}_value`,$("#elm_text").val(),y))):configuration.elements[e].enable_clock?userClock(configuration.elements[e].clock,e,!0):$("#"+e).html(generateMultiLineText(e,$("#elm_text").val(),y));break;case"svg":case"icon":m=p-$("#elm_width").val(),b=u-$("#elm_height").val(),y>=0&&y<=m&&v>=0&&v<=b?(r=t.target.value,$("#"+e).attr({width:$("#elm_width").val(),height:$("#elm_height").val(),x:y,y:v,"data-rotate":$("#elm_rotate").val(),"data-flip":$("#elm_flip").val(),"data-width":$("#elm_width").val(),"data-height":$("#elm_height").val()}),iconHandler(e,configuration.elements[e].icon,!0),clearTimeout(s)):x();break;case"image":m=p-$("#elm_width").val(),b=u-$("#elm_height").val(),y>=0&&y<=m&&v>=0&&v<=b?(r=t.target.value,$("#"+e).attr({width:$("#elm_width").val(),height:$("#elm_height").val(),x:y,y:v,href:await receiveImage($("#elm_href").val()),preserveAspectRatio:$("#elm_preserveAspectRatio").val()}),clearTimeout(s)):x();break;case"foreignObject":m=p-$("#elm_width").val(),b=u-$("#elm_height").val(),y>=0&&y<=m&&v>=0&&v<=b?(r=t.target.value,$("#"+e).attr({width:$("#elm_width").val(),height:$("#elm_height").val(),x:y,y:v}),clearTimeout(s)):x()}if($(this).hasClass("color")||$(this).hasClass("style")){let w={animation:{color:{target:n.animation,property:"stroke",value:i},line_color:{target:n.line,property:"stroke",value:i},shadow:{target:n.line,property:"filter",value:`drop-shadow(0px 3px 3px ${i})`}},rect:{color:{target:e,property:"stroke",value:i},shadow:{target:e,property:"filter",value:`drop-shadow(0px 3px 3px ${i})`},stroke:{target:e,property:"strokeWidth",value:i+"px"}},circle:{color:{target:e,property:"stroke",value:i},shadow:{target:e,property:"filter",value:`drop-shadow(0px 3px 3px ${i})`},stroke:{target:e,property:"strokeWidth",value:i+"px"}},text:{color:{target:e,property:"stroke",value:i},shadow:{target:e,property:"filter",value:`drop-shadow(0px 3px 3px ${i})`},font_size:{target:e,property:"font-size",value:i+"px"},font_family:{target:e,property:"font-family",value:i},align:{target:e,property:"text-anchor",value:i}},icon:{shadow:{target:e,property:"filter",value:`drop-shadow(0px 3px 3px ${i})`}}},k,C,_;if(w.hasOwnProperty(a.type)&&w[a.type].hasOwnProperty(o)?(k=w[a.type][o].target,C=w[a.type][o].property,_=w[a.type][o].value):(k=e,C=o,_=i),$(`#${k}`).css(C,_),"animation"===a.type)switch(o){case"color":console.debug(`Animation color change! Value: ${i} | Before: ${configuration.animations[n.animation].color}`),configuration.animations[n.animation].color=i;break;case"line_color":console.debug(`Line color change! Value: ${i} | Before: ${configuration.lines[n.line].color}`),configuration.lines[n.line].color=i}else console.debug(`Element CSS property change! Source: ${C} Value: ${_} | Before: ${configuration.elements[e][o]}`),configuration.elements[e][o]=i}else if("animation"===a.type)o="animation"==o?"source":o,console.debug(`Animation property change! Source: ${o} Value: ${i} | Before: ${configuration.animations[n.animation][o]}`),configuration.animations[n.animation][o]=i,console.debug(configuration.animations[n.animation]);else{if(o.match(/\./)){let S=o.split(".");configuration.elements[e].hasOwnProperty(S[0])||(configuration.elements[e][S[0]]={}),console.debug(`Sub-Object property change! Source: ${o} Value: ${i} | Before: ${configuration.elements[e][S[0]][S[1]]}`),configuration.elements[e][S[0]][S[1]]=i}else console.debug(`Normal property change! Source: ${o} Value: ${i} | Before: ${configuration.elements[e][o]}`),configuration.elements[e][o]=i;console.info("Object after change",configuration.elements[e])}$(this).hasClass("elm_config_update")&&c()}),$("#reconnect_elements").off().on("click",async function(){n={animation:(e=await connectElements(this.id)).replace("line","anim"),def:e.replace("line_",""),line:e},console.debug(`After reconnect: ${JSON.stringify(n)}`),getElements("elm_select",n.line),$("#elm_select").selectmenu("refresh"),$(`#${n.line}`).addClass("active_element"),$(".type_rect, .type_circle").addClass("faded_out"),$("#restore_element").prop("disabled",!1),$("#elm_start_slot").val("element"==configuration.defs[n.def].startSlot?translateWord("value_element"):translateWord("value_"+configuration.defs[n.def].startSlot)),$("#elm_end_slot").val("element"==configuration.defs[n.def].endSlot?translateWord("value_element"):translateWord("value_"+configuration.defs[n.def].endSlot))}),$("#elm_icon").off().on("input",function(){$(this).autocomplete({position:{my:"right top",at:"right bottom",collision:"fit"},classes:{"ui-autocomplete":"ui-autocomplete-icon"},source:function(e,t){$.ajax({minLength:1,url:"https://api.iconify.design/search?",type:"GET",data:{query:e.term},success:function(e){t($.map(e.icons,function(e){return{label:e}}))}})},select:function(t,a){return iconHandler(e,a.item.value,!0),configuration.elements[e].icon=a.item.value,a.item.value}}).autocomplete("instance")._renderItem=function(e,t){return $("<li class='ui-menu-item'>").append(`<div class='ui-menu-item-wrapper'><span class='iconify' data-width='24' data-icon='${t.label}'></span><span style='font-weight: normal; padding-left:10px;'>${t.label}</span></div>`).appendTo(e)}}),$(".preview_element").off().on("click",async function(t){if(configuration.elements[e].source>=0){let a=await new Promise((t,a)=>{socket.emit("getState",configuration.datasources[configuration.elements[e].source].source,(o,i)=>{i?(console.debug(`Pulled value from ioBroker: ${i.val}`),t(i.val)):a(`(PreviewElement) The state could not be received! Please check the associated Datasource: ${configuration.datasources[configuration.elements[e].source].source}`)})}).catch(t=>{console.error(t),failedMessage(sprintf(systemDictionary.failmsg_invalid_ds[systemLang],configuration.datasources[configuration.elements[e].source].source))});if("value"==configuration.elements[e].fill_type&&configuration.elements[e].fill_max>0||"value"==configuration.elements[e].border_type&&configuration.elements[e].border_max>0||-1!=configuration.elements[e].fill_type||-1!=configuration.elements[e].border_type){let o=getRandomInt(55);$(`<div id="tmpDiv_${o}" />`).appendTo("body");let i=configuration.elements[e].type,n=configuration.elements[e].stroke,s=n+("rect"==i?configuration.elements[e].width:2*configuration.elements[e].radius),r=n+("rect"==i?configuration.elements[e].height:2*configuration.elements[e].radius);void 0!=a&&$(`#tmpDiv_${o}`).prop("title",translateWord("lbl_preview_element")).dialog({resizable:!1,width:s+50,maxHeight:"100%",modal:!0,classes:{"ui-dialog":"no-close"},create:async function(){$(this).html($(`<svg id='preview_${o}' width='${s}' height='${r}' style='width:100%;height:100%;display:block;' />`));let l=Object.assign({},configuration.elements[e]);l.pos_x=4+n/2+("rect"==i?0:s/2-n/2),l.pos_y=4+n/2+("rect"==i?0:r/2-n/2),l.id=`preview_elm_${o}`;let c=await svgElement(l,!1,!0);switch($(c).appendTo($(`#preview_${o}`)),t.target.id){case"preview_element_fill":addGradient(`preview_elm_${o}`,configuration.elements[e].fill_value,configuration.elements[e].fill,configuration.elements[e].fill_direction),updateGradient(`preview_elm_${o}`,a,configuration.elements[e].fill_max,configuration.elements[e].fill_type);break;case"preview_element_border":addBorderFill(`preview_elm_${o}`,configuration.elements[e].border_value,configuration.elements[e].border_style,configuration.elements[e].border_start),updateBorderFill(`preview_elm_${o}`,a,configuration.elements[e].border_max,configuration.elements[e].border_type,configuration.elements[e].border_direction)}},open:function(){$(".ui-widget-overlay").hide().fadeIn("slow"),$(this).parent().focus()},show:"fade",hide:"fade",beforeClose:function(){$('<div class="ui-widget-overlay-fading" />)').appendTo("body"),$(".ui-widget-overlay-fading").fadeOut("fast",function(){$(this).remove()})},close:function(){$(this).dialog("destroy"),$(`#tmpDiv_${o}`).remove()},buttons:[{text:translateWord("btn_close"),class:"input_button",click:function(){$(this).dialog("close")}}]})}else failedMessage(translateWord("failmsg_preview_element_not_all"))}else failedMessage(translateWord("failmsg_preview_element_no_ds"))}),$(".preview_action").off().on("click",function(t){switch(t.target.id){case"preview_action_url":""!=configuration.elements[e].url&&void 0!=configuration.elements[e].url?actionForElement(e,t,"url"):failedMessage(translateWord("failmsg_preview_element_not_all"));break;case"preview_action_click":configuration.elements[e].source>=0||configuration.elements[e].source_action>=0?"none"==configuration.elements[e].action||void 0==configuration.elements[e].action?failedMessage(translateWord("failmsg_preview_element_no_action")):actionForElement(e,t,"click"):failedMessage(translateWord("failmsg_preview_element_no_ds"))}}),$("#manage_shortcuts").off().on("click",function(){function t(t){let a=$(`<tr><td>${configuration.elements[e].shortcuts[t].alias}</td><td>${configuration.elements[e].shortcuts[t].value}</td><td><button class= 'all_datasource ds_buttons btn-update' > <span class='iconify' data-height='24' data-icon='mdi:check'>Update</span></button><button class='all_datasource ds_buttons btn-cancel'><span class='iconify red_icon' data-height='24' data-icon='mdi:close'>Cancel</span></button><button class='all_datasource ds_buttons btn-edit'><span class='iconify' data-height='24' data-icon='mdi:pencil'>Edit</span></button><button class='all_datasource ds_buttons btn-delete'><span class='iconify red_icon' data-height='24' data-icon='mdi:delete'>Delete</span></button></td></tr>`).data({id:t,alias:configuration.elements[e].shortcuts[t].alias,value:configuration.elements[e].shortcuts[t].value});$("#shortcut-table tbody").append(a)}$("#shortcut-table").off(),$("#frm-addQuickAccess").off().submit(function(a){a.preventDefault();let o=0;configuration.elements[e].hasOwnProperty("shortcuts")?o=Object.keys(configuration.elements[e].shortcuts).length>0?Math.max(...Object.keys(configuration.elements[e].shortcuts).map(e=>e))+1:0:configuration.elements[e].shortcuts={},configuration.elements[e].shortcuts[o]={alias:$("#shortcut_alias").val(),value:$("#shortcut_value").val()},$("#shortcut-table tbody").children().length>0&&$("#shortcut_tmp_line").hide(),t(o),$(this)[0].reset(),$(this)[0][0].focus(),globalConfigChanged=!0}),$("#shortcut-table").on("click",".btn-edit",function(){let e=$(this).parents("tr"),t=e.data("alias"),a=e.data("value"),o=`<div class="form_div no_margin"><input type="text" class="input_text" id="edit_shortcut_alias" name="edit_shortcut_alias" autocorrect="off" autocomplete="off" value="${t}"></div>`,i=`<div class="form_div no_margin"><input type="text" class="input_text" id="edit_shortcut_value" name="edit_shortcut_value" autocorrect="off" autocomplete="off" value="${a}"></div>`;e.find("td:eq(0)").html(o),e.find("td:eq(1)").html(i),e.find(".btn-update, .btn-cancel").show(),e.find(".btn-delete, .btn-edit").hide()}),$("#shortcut-table").on("click",".btn-cancel",function(){let e=$(this).parents("tr");e.find("td:eq(0)").text(e.data("alias")),e.find("td:eq(1)").text(e.data("value")),e.find(".btn-update, .btn-cancel").hide(),e.find(".btn-delete, .btn-edit").show()}),$("#shortcut-table").on("click",".btn-update",function(){let t=$(this).parents("tr"),a=$("#edit_shortcut_alias").val(),o=$("#edit_shortcut_value").val();configuration.elements[e].shortcuts[t.data("id")]={alias:a,value:o},t.find("td:eq(0)").text(a),t.find("td:eq(1)").text(o),t.find(".btn-update, .btn-cancel").hide(),t.find(".btn-delete, .btn-edit").show(),globalConfigChanged=!0}),$("#shortcut-table").on("click",".btn-delete",function(){let t=$(this).parents("tr");delete configuration.elements[e].shortcuts[t.data("id")],t.fadeOut("fast",function(){$(this).remove();let e=$("#shortcut-table tbody").children();1==e.length&&"shortcut_tmp_line"==e[0].id&&$("#shortcut_tmp_line").fadeIn("fast")}),globalConfigChanged=!0}),$("#manage_shortcuts_section").dialog({resizable:!1,height:"auto",maxHeight:"100%",classes:{"ui-dialog":"no-close"},show:"fade",hide:"fade",width:550,modal:!0,beforeClose:function(){$('<div class="ui-widget-overlay-fading" />)').appendTo("body"),$(".ui-widget-overlay-fading").fadeOut("fast",function(){$(this).remove()})},close:function(){$(this).dialog("destroy")},create:function(a,o){if($("#shortcut-table tbody").children().not("#shortcut_tmp_line").remove(),$("#frm-addQuickAccess")[0].reset(),configuration.elements[e].hasOwnProperty("shortcuts")){if(Object.keys(configuration.elements[e].shortcuts).length>0){$("#shortcut_tmp_line").hide();let i=Object.entries(configuration.elements[e].shortcuts).sort(([,e],[,t])=>e.alias.toLowerCase()<t.alias.toLowerCase()?-1:e.alias.toLowerCase()>t.alias.toLowerCase()?1:0);for(var n of i)t(n[0])}}else $("#shortcut_tmp_line").show()},open:function(e,t){$(".ui-widget-overlay").hide().fadeIn("slow"),$("#shortcut_alias").focus()},buttons:[{text:translateWord("btn_close"),class:"input_button",click:function(){$(this).dialog("close")}}]})}),$(".override_settings").off().on("click",function(t){let o;switch(t.target.id){case"override_settings":o="animation"==a.type?configuration.lines[n.line].override:configuration.elements[e].override;break;case"override_settings_animation":o=configuration.animations[n.animation].override}aceOverride.setValue(JSON.stringify(o,void 0,4),-1),$("#loading").fadeIn("fast"),$(".loading-spinner, #loading_text").fadeOut("fast"),$("#codeEditorContainer").fadeIn("fast"),aceOverride.getSession().off("changeAnnotation"),aceOverride.getSession().on("changeAnnotation",function(){let e=aceOverride.getSession().getAnnotations().filter(e=>"error"==e.type);$("#save_code").prop("disabled",e.length>0)}),aceOverride.focus(),$("#save_code").off().on("click",function(){let o=aceOverride.getValue()?JSON.parse(aceOverride.getValue()):{};switch(t.target.id){case"override_settings":"animation"==a.type?configuration.lines[n.line].override=o:(configuration.elements[e].override=o,c());break;case"override_settings_animation":configuration.animations[n.animation].override=o}hideCodeEditor(),$("#restore_element").prop("disabled",!1),globalConfigChanged=!0})}),$("#export_element").off().on("click",function(){let t,a=Object.assign({},configuration.elements[e]);["id","source","source_action","pos_x","pos_y"].forEach(e=>delete a[e]);let o=getRandomInt(55);$(`<div id="tmpDiv_${o}" />`).appendTo("body"),$(`#tmpDiv_${o}`).prop("title",translateWord("lbl_export_element")).dialog({resizable:!1,height:520,width:400,maxHeight:"100%",modal:!0,classes:{"ui-dialog":"no-close"},create:function(e,i){(t=ace.edit(`tmpDiv_${o}`)).session.setMode("ace/mode/json"),t.setTheme("ace/theme/"+appProperties.aceEditorTheme[appProperties.colorScheme]),t.setReadOnly(!0),t.setValue(JSON.stringify(a,void 0,4),-1)},open:function(e,t){$(".ui-widget-overlay").hide().fadeIn("fast"),$(this).parent().focus()},show:"fade",hide:"fade",beforeClose:function(){$('<div class="ui-widget-overlay-fading" />)').appendTo("body"),$(".ui-widget-overlay-fading").fadeOut("fast",function(){$(this).remove()})},close:function(){$(".ui-dialog").remove(),t.destroy(),$(`#tmpDiv_${o}`).remove()},buttons:[{text:translateWord("btn_copy"),class:"input_button",click:function(){if(void 0!==navigator.clipboard&&"undefined"!==navigator.permissions)navigator.clipboard.writeText(t.getValue()).then(()=>{successMessage(translateWord("elm_copy_success")),console.debug("Text copied to clipboard via Clipboard API!")}).catch(e=>{console.error(e.message),alert(e.message),failedMessage(translateWord("elm_copy_failed"))});else{t.selectAll(),t.focus();try{document.execCommand("copy"),successMessage(translateWord("elm_copy_success")),console.debug("Text copied to clipboard via exec-copy!")}catch(e){failedMessage(translateWord("elm_copy_failed"))}}}},{text:translateWord("btn_close"),class:"input_button",click:function(){$(this).dialog("close")}}]})}),$("#overrideFormatCode").off().on("click",function(e){try{aceOverride.setValue(JSON.stringify(JSON.parse(aceOverride.getValue()),void 0,4),-1)}catch(t){failedMessage(translateWord("msg_json_malformmated"))}}),$("#restore_element").off().click(async function(){let t=!1;$("#dialog_section").prop("title",translateWord("lbl_restore_element")).html(translateWord("msg_restore_element")).dialog({resizable:!1,height:"auto",maxHeight:"100%",classes:{"ui-dialog":"no-close"},show:"fade",width:400,modal:!0,open:function(e,t){$(".ui-widget-overlay").hide().fadeIn("slow"),$(this).parent().focus()},buttons:[{text:translateWord("value_restore"),width:"auto",class:"input_button",click:async function(){($(this).dialog("destroy"),"animation"===a.type)?(console.log("Opened Element: "+n.line+" Saved for restore: "+o.id),(t=!!configuration.animations.hasOwnProperty(a.id))||(console.debug(`Line was reconnected during configuration. Restoring previous one (${o.id}) and deleting new one (${e})!`),delete configuration.defs[n.def],delete configuration.lines[n.line],delete configuration.animations[n.animation],$(`#${n.def}, #${n.line}, #${n.animation} `).remove()),configuration.defs[i.id]=i,configuration.lines[o.id]=o,configuration.animations[a.id]=a,await svgElement(configuration.defs[i.id],t),await svgElement(configuration.lines[o.id],t),await svgElement(configuration.animations[a.id],t),showConfigBar(o.id,"use")):(console.debug("Restore Obj: ",a),t=!!configuration.elements.hasOwnProperty(e),configuration.elements[e]=a,await svgElement(configuration.elements[e],t,!1,function(){showConfigBar(e,a.type)}))}},{text:translateWord("value_cancel"),class:"input_button red",click:function(){$(this).dialog("destroy")}}]})}),$(".form_label").removeClass("form_label").addClass("form_label")}function hideConfigBar(){$(".all_elements").removeClass("faded_out active_element"),$("#config_bar").removeClass("show"),$(".elm_config").off().val(""),$("#tab1_config").prop("checked",!0),$("#elm_select").val(""),$(".ui-dialog").remove()}function hideStateExplorer(){$("#loading").fadeOut("fast",function(){$("#stateExplorerContainer").hide(),$("#stateExplorer").scrollTop(0),$(".state").removeClass("active"),$(".state").children(".type").removeClass("file-selected")})}function hideCodeEditor(){$("#loading").fadeOut("fast",function(){$("#codeEditorContainer").hide(),$("#codeEditor").scrollTop(0)})}function iconHandler(e,t,a=!1){let o=$("<symbol />");$.each($("#"+e).prop("attributes"),function(){o.attr(this.name,this.value)});let i=t.split("?");if(i[1]){t=i[0];let n=new URLSearchParams(i[1]);o.attr({"data-icon":t,"data-flip":n.get("flip"),"data-rotate":n.get("rotate")})}else o.attr({"data-icon":t,"data-flip":configuration.elements[e].flip,"data-rotate":configuration.elements[e].rotate});($("#"+e).data("icon")!=t||!0==a)&&$("#"+e).replaceWith(o)}async function svgElement(e,t=!1,a=!1,o){let i=e.shadow?`filter: drop-shadow(0px 3px 3px ${e.shadow});`:"",n=`all_elements added_elements ${e.css_general||""}`;switch(displayMode||(n+=" draggable"),displayMode&&(e.url||e.action&&"none"!=e.action)&&(n+=" action_element"),e.type){case"rect":let s=document.createElementNS("http://www.w3.org/2000/svg","rect");if(s.setAttribute("x",e.pos_x),s.setAttribute("y",e.pos_y),s.setAttribute("width",e.width),s.setAttribute("height",e.height),s.setAttribute("rx",e.rx),s.setAttribute("class",n+" type_rect connector"),s.setAttribute("id",e.id),s.setAttribute("style",`stroke: ${e.color}; stroke-width:${e.stroke}px; fill:${e.fill}; ${i}`),a)return s;t?$("#"+e.id).replaceWith(s):$(s).appendToWithIndex($("#placeholder_elements"),e.position);break;case"circle":let r=document.createElementNS("http://www.w3.org/2000/svg","circle");if(r.setAttribute("cx",e.pos_x),r.setAttribute("cy",e.pos_y),r.setAttribute("r",e.radius),r.setAttribute("class",n+" type_circle connector"),r.setAttribute("id",e.id),r.setAttribute("style",`stroke:${e.color}; stroke-width:${e.stroke}px; fill:${e.fill}; ${i}`),a)return r;t?$("#"+e.id).replaceWith(r):$(r).appendToWithIndex($("#placeholder_elements"),e.position);break;case"text":let l=document.createElementNS("http://www.w3.org/2000/svg","text"),c=e.degree?` transform-box: fill-box; transform: rotate(${e.degree}deg);`:"";if(l.setAttribute("x",e.pos_x),l.setAttribute("y",e.pos_y),l.setAttribute("id",e.id),l.setAttribute("dominant-baseline","central"),l.setAttribute("style",`stroke:${e.color}; fill:${e.fill}; font-family:${e.font_family}; text-anchor:${e.align}; transform-origin:50% 50%; font-size:${e.font_size}px; ${c} ${i}`),"datasource"==e.subType){let d=-1!=e.source?Number(0).toFixed(e.decimal_places):e.text,u="none";switch(e.calculate_kw){case!0:u="calc";break;case!1:u="none";break;case"calc":u="calc";break;case"auto":u="auto"}l.setAttribute("class",n+" type_datasource"),"own_text"==e.source_display&&(d=e.text),l.innerHTML=`<tspan id='${e.id}_prepend'>${generateMultiLineText(e.id+"_prepend",e.prepend,e.pos_x)}</tspan><tspan id='${e.id}_value'>${generateMultiLineText(e.id+"_value",d,e.pos_x)}</tspan><tspan id='${e.id}_append'>${generateMultiLineText(e.id+"_append",e.append,e.pos_x)}</tspan><tspan id='${e.id}_unit'> ${generateMultiLineText(e.id+"_unit",e.unit,e.pos_x)}</tspan>`}else l.setAttribute("class",n+" type_text"),e.enable_clock?(l.innerHTML=userClock(e.clock,e.id,!0),displayMode&&(userClock(e.clock,e.id),console.log("Activating UserClock for "+e.id))):l.innerHTML=generateMultiLineText(e.id,e.text,e.pos_x);t?$("#"+e.id).replaceWith(l):$(l).appendToWithIndex($("#placeholder_text"),e.position);break;case"svg":case"icon":let p=document.createElementNS("http://www.w3.org/2000/svg","symbol");"svg"==e.subType?((p=document.createElementNS("http://www.w3.org/2000/svg","svg")).setAttribute("class",n+" type_svg"),p.setAttribute("viewBox",e.viewbox),p.innerHTML=e.svg_content):(p.setAttribute("class",n+" type_icon iconify"),p.setAttribute("data-icon",e.icon),p.setAttribute("data-width",e.width),p.setAttribute("data-height",e.height),p.setAttribute("data-rotate",e.rotate||0),p.setAttribute("data-flip",e.flip||"")),p.setAttribute("x",e.pos_x),p.setAttribute("y",e.pos_y),p.setAttribute("id",e.id),p.setAttribute("width",e.width),p.setAttribute("height",e.height),p.setAttribute("style",`color: ${e.color}; ${i}`),"svg"==e.subType?t?$("#"+e.id).replaceWith(p):$(p).appendToWithIndex($("#placeholder_elements"),e.position):t?$("#"+e.id).replaceWith(p):$(p).appendToWithIndex($("#placeholder_icons"),e.position);break;case"image":let g=document.createElementNS("http://www.w3.org/2000/svg","image");g.setAttribute("class",n+" type_image"),g.setAttribute("x",e.pos_x),g.setAttribute("y",e.pos_y),g.setAttribute("id",e.id),g.setAttribute("preserveAspectRatio",e.preserveAspectRatio),g.setAttribute("width",e.width),g.setAttribute("height",e.height),g.setAttribute("href",await receiveImage(e.href)),g.setAttribute("style",i),t?$("#"+e.id).replaceWith(g):$(g).appendToWithIndex($("#placeholder_elements"),e.position);break;case"foreignObject":let f=document.createElementNS("http://www.w3.org/2000/svg","foreignObject");f.setAttribute("class",n+" type_fObj"),f.setAttribute("x",e.pos_x),f.setAttribute("y",e.pos_y),f.setAttribute("id",e.id),f.setAttribute("width",e.width),f.setAttribute("height",e.height),f.setAttribute("style",i),f.innerHTML=e.fObj_content,t?$("#"+e.id).replaceWith(f):$(f).appendToWithIndex($("#placeholder_elements"),e.position);break;case"def":let h=document.createElementNS("http://www.w3.org/2000/svg","path");h.setAttribute("id",e.id),h.setAttribute("class","type_def"),h.setAttribute("d",e.d),t?$("#"+e.id).replaceWith(h):$(h).appendTo("#placeholder_defs");break;case"line":let m=document.createElementNS("http://www.w3.org/2000/svg","use");m.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",e.href),m.setAttribute("id",e.id),m.setAttribute("class","line type_line all_elements"),m.setAttribute("style",`stroke:${e.color}; ${i}`),t?$("#"+e.id).replaceWith(m):$(m).appendTo("#placeholder_lines");break;case"animation":n="type_animation all_elements anim_element",n+=!0==configuration.basic.enable_animation?" animation animation_cfg":" animation no_animation";let b=document.createElementNS("http://www.w3.org/2000/svg","use");b.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",e.href),b.setAttribute("id",e.id),b.setAttribute("class",n),b.setAttribute("style",`stroke:${e.color};`),t?$("#"+e.id).replaceWith(b):$(b).appendTo("#placeholder_animations")}"function"==typeof o&&o(e.id,e.type)}function getMaxID(){return Object.keys(configuration.elements).length>0?Math.max(...Object.keys(configuration.elements).map(e=>e))+1:0}function getRandomInt(e){return Math.floor(Math.random()*e)}function getRandomRGBA(){var e=Math.round,t=Math.random;return"rgba("+e(255*t())+","+e(255*t())+","+e(255*t())+",1)"}function addDataSourceRow(e,t=!1){let a=$(`<tr class="highlight-green" data-source="${configuration.datasources[e].source}" data-alias="${configuration.datasources[e].alias}" data-id="${e}" data-factor="${configuration.datasources[e].factor}"><td>${configuration.datasources[e].alias}</td><td>${configuration.datasources[e].source}</td><td>${configuration.datasources[e].factor}</td><td><button class='all_datasource ds_buttons btn-update'><span class='iconify' data-height='24' data-icon='mdi:check'>Update</span></button><button class='all_datasource ds_buttons btn-cancel'><span class='iconify red_icon' data-height='24' data-icon='mdi:close'>Cancel</span></button><button class='all_datasource ds_buttons btn-edit'><span class='iconify' data-height='24' data-icon='mdi:pencil'>Edit</span></button><button class='all_datasource ds_buttons btn-delete'><span class='iconify red_icon' data-height='24' data-icon='mdi:delete'>Delete</span></button></td></tr>`);if(t){let o=$("#datasource-table th").eq(0).children(".sort_icon").is(":not(:empty)")?0:1,i=$(`#datasource-table tr td:nth-child(${o+1})`).map(function(){return $(this).text().toLowerCase()}).get(),n=$("#datasource-table th").eq(o).prop("asc"),s=0===o?configuration.datasources[e].alias.toLowerCase():configuration.datasources[e].source.toLowerCase();i.push(s);let r=i.sort();!1===n&&(r=r.reverse());let l=r.indexOf(s);$("#datasource-table tbody tr").length>l?$(`#datasource-table tbody tr:nth-child(${l+1})`).before(a.hide()):$("#datasource-table tbody").append(a.hide()),a.fadeIn(2e3)}else $("#datasource-table tbody").append(a);setTimeout(()=>{$(a).removeClass("highlight-green")},4e3),$("#ds_tmp_line").remove()}function checkDuplicateDatasource(e){return Object.keys(configuration.datasources).find(t=>configuration.datasources[t].source.toLowerCase()===e.toLowerCase())}function getdataSourceCellValue(e,t){return $(e).children("td").eq(t).text()}function dataSourceComparer(e){return function(t,a){var o=getdataSourceCellValue(t,e),i=getdataSourceCellValue(a,e);return $.isNumeric(o)&&$.isNumeric(i)?o-i:o.toString().localeCompare(i)}}function loadAdditionalJSFile(e){var t=document.createElement("script");t.type="text/javascript",t.src=e,t.onload=function(){console.log("Loaded additional file: "+e)},document.body.appendChild(t)}function setTheme(e){if("false"!=e&&""!=e){let t=document.createElement("link");t.id="theme_mode",t.rel="stylesheet",t.href=`style/${e}.css`,t.onload=function(){console.log("Loaded theme: "+e)},document.head.appendChild(t)}}function generateMultiLineText(e,t,a){let o="";if(t){if(isNaN(t)){if(t.includes("<br>")||t.includes("\n")){let i;t.includes("<br>")&&(i=t.split("<br>")),t.includes("\n")&&(i=t.split("\n")),i.length>0&&((e.toString().includes("append")||e.toString().includes("unit")||e.toString().includes("prepend"))&&(o+=`<tspan id="${e}_line_tmp" x="${a}" dy="1em"></tspan>`),i.forEach(function(t,i){o+=`<tspan id="${e}_line_${i}" x="${a}" dy="1em">${t}</tspan>`}))}else o=`<tspan id="${e}_line_0">${t}</tspan >`}else o=`<tspan id="${e}_line_0">${t}</tspan >`}return o}async function saveWorkspace(){return new Promise((e,t)=>{socket.emit("sendTo",appProperties.namespace,"_storeBackup",backup_configuration,function(e){e&&e.error?console.log("An error occured, while saving the backup. The following error was provided: ",e.error):(console.log(e.data),getBackups("backup_list"))}),socket.emit("setState",subscribeObjID[0],{val:JSON.stringify(configuration),ack:!0},function(a,o){a?(console.log(a),t("")):e(configuration)})})}function getBackups(e){socket.emit("sendTo",appProperties.namespace,"_getBackups",{},function(t){if(t&&t.error)console.log("An error occured, while receiving the backups. The following error was provided: ",t.error);else{t.data.sort((e,t)=>-1*e.localeCompare(t)),$("#"+e).empty().append(new Option(translateWord("opt_please_choose"),"-1"));let a;t.data.length>0?t.data.forEach(t=>{let o=new Date(parseInt(t)).toLocaleString("de-DE",{hour:"numeric",minute:"numeric",day:"2-digit",month:"2-digit",year:"numeric",second:"2-digit",hour12:!1});a=new Option(o,t),$("#"+e).append(a)}):($("#"+e).empty(),a=new Option(translateWord("opt_no_backups"),-1),$("#"+e).append(a))}})}async function actionForElement(e,t,a=""){if("none"!=configuration.elements[e].action&&!a||"click"==a){let o=configuration.elements[e].source_action>=0?configuration.elements[e].source_action:configuration.elements[e].source;if(configuration.datasources.hasOwnProperty(o)){let i=configuration.datasources[o].source;switch(configuration.elements[e].action){case"default":case"none":break;case"toggle":socket.emit("getState",i,function(e,t){e?console.log("An error occured, while getting the state. The following error was provided: "+e):"boolean"==typeof t.val?socket.emit("setState",i,{val:!t.val,ack:!1},function(e,t){e&&console.log("An error occured, while toggling the state. The following error was provided: "+e)}):console.error("This state can not be handled, because it is not a boolean state!")});break;case"on":socket.emit("setState",i,{val:!0,ack:!1},function(e){e&&console.log(`An error occured, while setting the state. The following error was provided: ${e}`)});break;case"off":socket.emit("setState",i,{val:!1,ack:!1},function(e){e&&console.log(`An error occured, while setting the state. The following error was provided: ${e}`)});break;case"change":function n(e){socket.emit("setState",i,{val:e,ack:!1},function(t,a){t&&console.log(`An error occured, while setting the state. The following error was provided: ${t}`),console.debug(`${e} submitted to host for state ${a}`)})}let s=await new Promise((e,t)=>{socket.emit("getState",i,(a,o)=>{o?(console.debug(`Pulled value from ioBroker: ${o.val}`),e(o.val)):t(`(ClickAction) The state could not be received! Please check the associated Datasource: ${i}`)})}).catch(e=>{console.error(e),failedMessage(sprintf(systemDictionary.failmsg_invalid_ds[systemLang],i))}),r=[{text:translateWord("value_set_value"),class:"input_button",click:function(){n($("#shortcuts\\.action\\.value").val()),$(this).dialog("close")}},{text:translateWord("value_cancel"),class:"input_button red",click:function(){$(this).dialog("close")}}];if(configuration.elements[e].hasOwnProperty("action_display_freeform")?($("#shortcuts\\.action").toggle(configuration.elements[e].action_display_freeform),configuration.elements[e].action_display_freeform||r.shift()):($("#shortcuts\\.action").toggle(!1),r.shift()),$("#shortcuts\\.action\\.value").attr("type",configuration.elements[e].action_type).val(s),configuration.elements[e].hasOwnProperty("shortcuts")){if(Object.keys(configuration.elements[e].shortcuts).length>0){let l,c,d=Object.entries(configuration.elements[e].shortcuts).sort(([,e],[,t])=>e.alias.toLowerCase()<t.alias.toLowerCase()?-1:e.alias.toLowerCase()>t.alias.toLowerCase()?1:0);switch(configuration.elements[e].action_display){default:case"button":for(var u of(l=$(`<span class="shortcuts_additional_buttons">${translateWord("shortcuts_additional_buttons")}</span>`),c=$("<div id='shortcuts_additional_buttons' />"),d)){let p;switch(typeof s){case"undefined":p="shortcut_inactive";break;case"string":p=u[1].value.toLowerCase()==s.toLowerCase()?"":"shortcut_inactive";break;case"number":p=parseInt(u[1].value)==s?"":"shortcut_inactive";break;case"boolean":p=u[1].value.toString().toLowerCase()==s.toString().toLowerCase()?"":"shortcut_inactive"}c.append($(`<input type="button" title="${u[1].alias}" class="input_button autowidth shortcuts.button ${p}" data-value="${u[1].value}" value="${u[1].alias||u[1].value}">`))}l.append(c);break;case"select":l=$('<div class="contentBox" />'),(c=$('<div class="form_div select" />')).append($(`<label for="shortcuts.value.select" class="form_label">${translateWord("shortcuts_additional_buttons")}</label>`));let g=$('<select class="input_select" id="shortcuts.select" />');for(var u of d)g.append($("<option>",{value:u[1].value,text:u[1].alias||u[1].value,selected:u[1].value==s}));c.append(g),l.append(c)}$("#shortcuts\\.elements").show().html(l)}else $("#shortcuts\\.elements").hide().html("")}else $("#shortcuts\\.elements").hide().html("");void 0!=s&&$("#action_change_value").dialog({title:configuration.datasources[o].alias||configuration.datasources[o].source,position:{my:"right-5 bottom-10",at:"left top",of:t,collision:"fit"},resizable:!1,height:"auto",maxHeight:"100%",classes:{"ui-dialog":"no-close"},width:"auto",modal:!0,open:function(){$(".ui-widget-overlay").hide().fadeIn("slow"),$(this).parent().focus(),$("#shortcuts\\.action").is(":visible")&&$("#shortcuts\\.action\\.value").off().on("keypress",function(e){13==(e.keyCode?e.keyCode:e.which)&&$(".ui-dialog-buttonset").children().first().click()}),$(".shortcuts\\.button").length>0&&$(".shortcuts\\.button").off().on("click",function(){$("#shortcuts\\.action\\.value").val($(this).data("value")),$("#shortcuts\\.action").is(":hidden")&&(n($(this).data("value")),$(".ui-dialog-buttonset").children().first().click()),$(".shortcuts\\.button").addClass("shortcut_inactive"),$(this).toggleClass("shortcut_inactive"),$(this).blur()}),$("#shortcuts\\.select").length>0&&$("#shortcuts\\.select").off().on("change",function(){$("#shortcuts\\.action\\.value").val($(this).val()),$("#shortcuts\\.action").is(":hidden")&&(n($(this).val()),$(".ui-dialog-buttonset").children().first().click())})},buttons:r,show:"puff",hide:"puff",beforeClose:function(){$('<div class="ui-widget-overlay-fading" />)').appendTo("body"),$(".ui-widget-overlay-fading").fadeOut("fast",function(){$(this).remove()})},close:function(){$(this).dialog("close")}})}}else console.warn(`Element ${e} is configured to use Action '${configuration.elements[e].action}' but it has no valid datasource assigned!`)}if(("none"==configuration.elements[e].action||!configuration.elements[e].hasOwnProperty("action"))&&""!=configuration.elements[e].url&&void 0!=configuration.elements[e].url&&!a||"url"==a){switch(configuration.elements[e].frame){case"_blank":case"_self":if(a&&"_self"==configuration.elements[e].frame)failedMessage(translateWord("failmsg_opening_frame_preview"));else{var f=window.open(configuration.elements[e].url,configuration.elements[e].frame);f?f.focus():failedMessage(translateWord("failmsg_opening_frame"))}break;case"_overlay":displayLoading(translateWord("msg_loading_url")),$("#overlay_frame").attr("src",configuration.elements[e].url),$("#frameContainer").fadeIn("middle").css("display","block")}console.log(`URL found! ${configuration.elements[e].url} Frame: ${configuration.elements[e].frame}`)}}function wrapUploadImage(e,t){let a=$(`<div class="imgContainer" id="${e}" />`),o=$('<div class="uploads_img" />'),i=$('<div class="uploads_name" />').attr("title",e).text(e),n=$('<div class="uploads_btn" />'),s=$("<input />",{type:"button",class:"input_button delete_upload",value:translateWord("value_delete")});n.append(s);var r=$("<img />",{src:appProperties.socketURL+appProperties.namespace+"/userFiles"+t+e,alt:e});return o.append(r),a.append(o,i,n),a}function getUserImages(){var e=new XMLHttpRequest;e.onload=function(){if(200==this.status){let t=JSON.parse(e.responseText),a=t.files,o=t.path;if(a.length>0){$("#userImages_dummy").hide(),$("#userImages div.imgContainer").remove(),globalUserImages=a,console.debug(`Using ${o} for userFiles!`);for(let i=0;i<a.length;i++)$("#userImages").append(wrapUploadImage(a[i],o))}}},e.open("GET",appProperties.socketURL+appProperties.namespace+"/?serve=getUploads",!0),e.send()}function deleteUserImage(e){var t=new XMLHttpRequest;t.onload=function(){if(200==this.status){let a=JSON.parse(t.responseText);a&&a.error?console.log("An error occured, while deleting the upload! The following error was provided: ",res.error):$(`#${a.filename.replaceAll(".","\\.")}`).fadeOut("fast",function(){$(this).remove(),0==$("#userImages div").length&&$("#userImages_dummy").fadeIn("fast"),globalUserImages=globalUserImages.filter(t=>t!=e)})}},t.open("GET",appProperties.socketURL+appProperties.namespace+`/?serve=deleteUpload&image=${e}`,!0),t.send()}function startIconObserver(){let e=new MutationObserver(function e(t){let a=[];for(let{addedNodes:o}of t)for(let i of o)i.tagName&&"svg"!=i.tagName.toLowerCase()&&(i.classList.contains("iconify")?a.push(i):i.firstElementChild&&a.push(...i.getElementsByClassName("iconify")));a.forEach(function(e,t){loadIconViaProxy($(e).data("icon"),$(e))})});e.observe(document,{childList:!0,subtree:!0})}function loadIconViaProxy(e,t){if("svg"!=$(t).prop("tagName"))try{var a=new XMLHttpRequest;let o=`icon=${e}&width=${t.data("width")||24}&height=${t.data("height")||24}&flip=${t.data("flip")||""}&rotate=${t.data("rotate")||0} `;a.open("GET",appProperties.socketURL+appProperties.namespace+`/?serve=icon&${o} `,!0),a.onload=function(){if(200==this.status){let e=JSON.parse(a.responseText),o=$($.parseHTML(e.icon)),i=t.attr("title");"Icon not found!"==e.message&&(i=e.message),o.data(t.data()).attr({id:t.attr("id"),class:t.attr("class"),style:t.attr("style"),title:i,x:t.attr("x"),y:t.attr("y"),width:t.attr("width"),height:t.attr("height")}).data("icon_status",e.status),t.replaceWith(o)}},a.onerror=function(){console.error(`Error while receiving icon "${e}" Error: ${this.status} `)},a.send()}catch(i){console.log("Error! "+i)}else console.debug("Already iconified!")}function makeDraggable(e){let t={},a=!1,o=!1,i=!1,n=!1,s,r=!1,l=e.target,c=null;function d(){$("#svg_config_div").removeClass("noscroll")}function u(e){$(".draggable-multi").removeClass("draggable-multi dragging"),$(".line").removeClass("not_selectable")}function p(e){var t=l.getScreenCTM();return e.touches&&(e=e.touches[0]),{x:parseInt((e.clientX-t.e)/t.a),y:parseInt((e.clientY-t.f)/t.d)}}function g(e,t){let a=parseInt($("#svg_config").attr("height")),o=parseInt($("#svg_config").attr("width")),i;for(var n of Object.keys(t)){let s=t[n].id,r={},l=[],c=parseInt($("#"+s).css("strokeWidth"))/2,d=parseInt($("#"+s).attr("r")),u=parseInt($("#"+s).css("font-size")),g=p(e);switch((i=$("path[id*="+s+"]")).length>0&&i.each(function(e){let t=i[e].id.split("_");l.push({path:i[e].id,from:t[1],to:t[2]})}),t[n].type){case"circle":r.x=o-d-c,r.y=a-d-c,g.x-=parseInt($("#"+s).attr("cx")),g.y-=parseInt($("#"+s).attr("cy"));break;case"rect":r.x=o-parseInt($("#"+s).attr("width"))-c,r.y=a-parseInt($("#"+s).attr("height"))-c,g.x-=parseInt($("#"+s).attr("x")),g.y-=parseInt($("#"+s).attr("y"));break;case"text":r.x=o-u,r.y=a-u/2,g.x-=parseInt($("#"+s).attr("x")),g.y-=parseInt($("#"+s).attr("y"));break;case"image":case"svg":case"foreignObject":r.x=o-parseInt($("#"+s).attr("width")),r.y=a-parseInt($("#"+s).attr("height")),g.x-=parseInt($("#"+s).attr("x")),g.y-=parseInt($("#"+s).attr("y"))}t[n]={id:s,type:t[n].type,stroke_width:c,font_size:u,circle_radius:d,offset:g,max:r,reconnect_elements:l}}}function f(){t={},$(".draggable-multi").each(function(){t[this.id]={id:this.id,type:this.tagName}})}function h(e,a){r?($(`#${e} `).toggleClass("draggable-multi"),"use"==$(".active_element").prop("tagName")&&$(".active_element").removeClass("active_element"),$(".active_element").toggleClass("draggable-multi active_element"),hideConfigBar()):t[e]={id:e,type:a}}function m(e){if(e.target.classList.contains("draggable")){let o=e.target.id;c=o,h(o,e.target.tagName)}if($(e.target).closest("svg").hasClass("draggable")){let n=$(e.target).closest("svg").attr("id");c=n,h(n,$(e.target).closest("svg").prop("tagName"))}if($(e.target).closest("text").hasClass("draggable")){let r=$(e.target).closest("text").attr("id");c=r,h(r,$(e.target).closest("text").prop("tagName"))}if($(e.target).closest("foreignObject").hasClass("draggable")){let l=$(e.target).closest("foreignObject").attr("id");c=l,h(l,$(e.target).closest("foreignObject").prop("tagName"))}(e.target.classList.contains("draggable-multi")||$(e.target).closest("svg").hasClass("draggable-multi")||$(e.target).closest("text").hasClass("draggable-multi")||$(e.target).closest("foreignObject").hasClass("draggable-multi"))&&f(),e.target.classList.contains("lasso")&&(i=!0,s=p(e),u(),hideConfigBar(),t={},c=null),Object.keys(t).length>0&&(a=!1,g(e,t)),Object.keys(t).length>1&&$(".line").addClass("not_selectable")}function b(e){if(i){t={},o=!0;var r=p(e);if(n)$("#lasso_rect").attr({x:Math.min(s.x,r.x),y:Math.min(s.y,r.y),width:Math.abs(s.x-r.x),height:Math.abs(s.y-r.y)});else{let l=document.createElementNS("http://www.w3.org/2000/svg","rect");l.setAttribute("x",s.x),l.setAttribute("y",s.y),l.setAttribute("width",0),l.setAttribute("height",0),l.setAttribute("rx",0),l.setAttribute("id","lasso_rect"),l.setAttribute("style","stroke: var(--primary); stroke-width: 2px; fill: var(--secondary); fill-opacity:0.2;"),$(l).appendTo("#placeholder_lasso"),n=!0}}if(0==Object.keys(t).length&&(37==e.keyCode||38==e.keyCode||39==e.keyCode||40==e.keyCode||46==e.keyCode)){let c=$(".active_element");1==c.length?t[c.attr("id")]={id:c.attr("id"),type:c.prop("tagName")}:f(),g(e,t)}if(Object.keys(t).length>0){$("#svg_config_div").addClass("noscroll"),$(".anim_element").removeClass("animation_cfg").addClass("no_animation"),hideConfigBar();let d=!1,u=!1;for(var h of(a=!0,globalConfigChanged=!0,46==e.keyCode&&$("#dialog_section").prop("title",translateWord("lbl_delete_elements")).html(translateWord("msg_delete_elements")).dialog({resizable:!1,height:"auto",maxHeight:"100%",classes:{"ui-dialog":"no-close"},width:400,show:"fade",modal:!0,open:function(e,t){$(".ui-widget-overlay").hide().fadeIn("slow"),$(this).parent().focus()},buttons:[{text:translateWord("value_delete"),class:"input_button red",click:async function(){let e=0,a=Object.keys(t).length;for(var o of Object.keys(t))if("use"===t[o].type){let i={animation:t[o].id.replace("line","anim"),def:t[o].id.replace("line_",""),line:t[o].id};delete configuration.defs[i.def],delete configuration.lines[i.line],delete configuration.animations[i.animation],$(`#${i.def}, #${i.line}, #${i.animation} `).remove(),delete t[o],e++}else -1==$("[id^=line_path").map(function(){let e=this.id.split("_");return[parseInt(e[2]),parseInt(e[3])]}).get().indexOf(parseInt(t[o].id))&&(delete configuration.elements[t[o].id],$(`#${t[o].id} `).remove(),delete t[o],e++);e===a?successMessage(translateWord("succ_msg_selection_delete")):failedMessage(translateWord("failmsg_selection_delete")),$(this).dialog("destroy")}},{text:translateWord("value_cancel"),class:"input_button",click:function(){$(this).dialog("destroy")}}]}),Object.keys(t))){let m=t[h],b=m.id,y=p(e),v={x:y.x-m.offset.x,y:y.y-m.offset.y};if($("#"+b).addClass("dragging"),isNaN(v.x)){let x={x:0,y:0};switch(e.keyCode){case 39:x.x=1;break;case 37:x.x=-1;break;case 38:x.y=-1;break;case 40:x.y=1}v={x:(parseInt($("#"+b).attr("cx"))||parseInt($("#"+b).attr("x")))+x.x,y:(parseInt($("#"+b).attr("cy"))||parseInt($("#"+b).attr("y")))+x.y}}switch(m.type){case"circle":v.x-m.stroke_width>=m.circle_radius&&v.x<=m.max.x&&!d?($("#"+b).attr("cx",v.x),configuration.elements[b].pos_x=v.x):d=!0,v.y-m.stroke_width>=m.circle_radius&&v.y<=m.max.y&&!u?($("#"+b).attr("cy",v.y),configuration.elements[b].pos_y=v.y):u=!0;break;case"rect":v.x-m.stroke_width>=0&&v.x<=m.max.x&&!d?($("#"+b).attr("x",v.x),configuration.elements[b].pos_x=v.x):d=!0,v.y-m.stroke_width>=0&&v.y<=m.max.y&&!u?($("#"+b).attr("y",v.y),configuration.elements[b].pos_y=v.y):u=!0;break;case"text":v.x-m.font_size>=0&&v.x<=m.max.x&&!d?($("#"+b).attr("x",v.x),configuration.elements[b].pos_x=v.x,$("#"+b).hasClass("type_text")&&$("#"+b).children().attr("x",v.x),$(`#${b} `).hasClass("type_datasource")&&$(`#${b} _prepend, #${b} _append, #${b} _value, #${b} _unit`).children().each(function(e,t){$(this).attr("x")&&$(this).attr("x",v.x)})):d=!0,v.y-m.font_size/2>=0&&v.y<=m.max.y&&!u?($("#"+b).attr("y",v.y),configuration.elements[b].pos_y=v.y):u=!0;break;case"image":case"svg":case"foreignObject":v.x>=0&&v.x<=m.max.x&&!d&&($("#"+b).attr("x",v.x),configuration.elements[b].pos_x=v.x),v.y>=0&&v.y<=m.max.y&&!u&&($("#"+b).attr("y",v.y),configuration.elements[b].pos_y=v.y)}if(m.reconnect_elements)for(var w of m.reconnect_elements)calculatePath(w.path,w.from,w.to)}}}function y(e){let l=null;if(null!=i){if(i=null,n=!1,s=null,o){let p={start_x:parseInt($("#lasso_rect").attr("x")),start_y:parseInt($("#lasso_rect").attr("y")),end_x:parseInt($("#lasso_rect").attr("x"))+parseInt($("#lasso_rect").attr("width")),end_y:parseInt($("#lasso_rect").attr("y"))+parseInt($("#lasso_rect").attr("height"))};$(".added_elements").each(function(){let e=getCoords(this.id);e.x>p.start_x&&e.x+e.width<p.end_x&&e.y>p.start_y&&e.y+e.height<p.end_y&&($(this).closest("svg").hasClass("draggable")?$(this).closest("svg").addClass("draggable-multi"):$("#"+this.id).addClass("draggable-multi"))}),d()}o=!1,$("#lasso_rect").remove()}Object.keys(t).length>0&&($(".added_elements").removeClass("dragging"),d(),l=setTimeout(function(){$("#basic\\.enable_animation").prop("checked")&&$(".anim_element").removeClass("no_animation").addClass("animation_cfg")},1e3),!1===a&&!r&&(u(),c&&showConfigBar(c,t[c].type)),t={})}l.addEventListener("mousedown",m),l.addEventListener("touchstart",m),l.addEventListener("mousemove",b),l.addEventListener("touchmove",b),l.addEventListener("mouseup",y),l.addEventListener("touchend",y),l.addEventListener("touchleave",y),l.addEventListener("touchcancel",y),l.addEventListener("keydown",b),l.addEventListener("keyup",d),$("#svg_config").on("keydown",function(e){e.ctrlKey&&(r=!0,e.preventDefault())}),$("#svg_config").on("keyup",function(e){r=!1})}socket.on("connect",async function(){let e=new Date().toLocaleString();console.log(`[Socket] connected at ${e}`),systemLang=await new Promise(e=>{socket.emit("getObject","system.config",function(t,a){!t&&a&&a.common?(e(a.common.language),console.debug(`[Language] Got from ioBroker! Translating Texts to locale ${a.common.language}!`)):(e(systemLang),console.debug(`[Language] Using locales! Translating Texts to locale ${systemLang}!`))})}),translateAll(),multiselect_options.texts={placeholder:translateWord("opt_select_source"),search:translateWord("lbl_search"),selectedOptions:" "+translateWord("lbl_selected")},socket.emit("getObject","system.adapter."+appProperties.namespace,function(e,t){if(!e&&t&&t.common){let a=t.common.version;console.log(`Installed Version: ${a}`),$.getJSON(appProperties.updateCheck).done(function(e){let t=e[0].name.replace("v","");console.log(`Github Version: ${t}`),$("#runningVersion").text(`Version: ${a}`),$("#newVersion").html(`${t>a?"("+translateWord("lbl_new_version")+")":""}`).click(function(){window.open(appProperties.updateURL)})})}}),"Chrome"==appProperties.userAgent&&loadConfig()}),$(function(){$("#iframe_close").click(function(){$("#loading").fadeOut("fast",function(){$("#overlay_frame").attr("src",""),$("#frameContainer").hide()})}),displayMode||($(document).tooltip({position:{my:"center bottom-20",at:"center top",collision:"flipfit"},content:function(){return $(this).attr("title")}}),$(".basic_config").on("input change",function(){globalConfigChanged=!0;let e=this.id.replace(".slider","").split(".");if(e.length>0)switch(e.length){case 2:switch(configuration[e[0]][e[1]]="checkbox"==this.type?this.checked:isNaN(this.value)?this.value:parseInt(this.value),console.debug("Basic Config changed: "+this.id,"checkbox"==this.type?this.checked:this.value,configuration[e[0]]),this.id){case"basic.enable_ds_autocomplete":this.checked?$("#elm_ds_source").autocomplete(dataSourceAutocompleteOptions):$("#elm_ds_source").hasClass("ui-autocomplete-input")&&$("#elm_ds_source").autocomplete("destroy");break;case"basic.enable_animation":this.checked?$(".anim_element").removeClass("no_animation").addClass("animation_cfg"):$(".anim_element").removeClass("animation_cfg").addClass("no_animation");break;case"basic.enable_grid":this.checked?$("#help_grid").fadeIn("fast"):$("#help_grid").fadeOut("fast");break;case"basic.enable_area_catch":this.checked?$(".tabbed").removeClass("no_catch"):$(".tabbed").addClass("no_catch");break;case"basic.height":case"basic.width":$(`#${e[0]}\\.${e[1]}\\.slider`).val(this.value),resizeSVG();break;case"basic.height.slider":case"basic.width.slider":$(`#${e[0]}\\.${e[1]}`).val(this.value),resizeSVG()}break;case 3:let t;switch(this.type){case"text":t=this.value;break;case"select-multiple":t=$(this).val().map(e=>parseInt(e));break;case"select-one":t=isNaN(this.value)?this.value:parseInt(this.value);break;case"number":t=parseInt(this.value);break;case"checkbox":t=this.checked}configuration[e[0]][e[1]][e[2]]=t,console.debug("Detailed Config changed: "+this.id,t,configuration[e[0]][e[1]]),configuration.calculation.battery.dod>=0&&null!=configuration.calculation.battery.dod&&configuration.calculation.battery.capacity>=0&&null!=configuration.calculation.battery.capacity&&configuration.calculation.battery.percent>=0&&null!=configuration.calculation.battery.percent&&configuration.calculation.battery.charge>=0&&null!=configuration.calculation.battery.charge&&configuration.calculation.battery.discharge>=0&&null!=configuration.calculation.battery.discharge?(console.debug("Battery configured!"),$("#calculation\\.battery\\.status").addClass("green").removeClass("red").text(translateWord("txt_calculation_succ"))):$("#calculation\\.battery\\.status").addClass("red").removeClass("green").text(translateWord("txt_calculation_fail")),0!=configuration.calculation.consumption.production.indexOf(-1)&&configuration.calculation.consumption.production.length>0&&configuration.calculation.consumption.gridFeed>=0&&null!=configuration.calculation.consumption.gridFeed&&configuration.calculation.consumption.gridConsume>=0&&null!=configuration.calculation.consumption.gridConsume?(console.debug("Consumption configured!"),$("#calculation\\.consumption\\.status").addClass("green").removeClass("red").text(translateWord("txt_calculation_succ"))):$("#calculation\\.consumption\\.status").addClass("red").removeClass("green").text(translateWord("txt_calculation_fail"))}}),$("input:radio[name=tabs]").click(function(){$(".ui-dialog").remove(),hideConfigBar(),$("#align_elements").click(),$("#connect_elements").hasClass("red")&&$("#connect_elements").click()}),$("#show_hide_config").click(function(){$("#container_menu").toggleClass("hidden")}),$(".tt-element").click(function(){$(".ui-tooltip").fadeOut()}),$(".line_preview").on("change input",function(){linePreview(this.id)}),$(".align_elements").click(function(e){globalLastSteps=[],$(".added_elements").removeClass("alignable").addClass("draggable"),$(".all_elements, .align_elements").removeClass("faded_out");let t=e.target.id,a,o;""==t&&(t=$(this).closest("a").attr("id")),$(".align_elements:not(#"+t+")").addClass("faded_out"),$("#align_elements, #undo_align_elements").show(),$("#all_undo_align_elements").css("display","inline-flex"),$("#undo_steps").text(sprintf(systemDictionary.ex_align_saved_steps[systemLang],"-")),$("#connect_elements").prop("disabled",!0),hideConfigBar(),$(".all_elements").addClass("faded_out"),$(".added_elements").removeClass("draggable faded_out").addClass("alignable"),$("#ex_how_align").html(translateWord("ex_align_ref")+" <img src='img/icon_help.png' class='help' style='vertical-align:top;' placeholder='"+translateWord("ex_align_help")+"'>"),$(".alignable").off().click(function(e){let i=e.target.id,n={};if(null==o)(""==(i=e.target.id)||i.includes("_"))&&(i=e.target.parentNode.id,"g"==e.target.parentNode.tagName.toLowerCase()&&(i=e.target.ownerSVGElement.id),"tspan"==e.target.parentNode.tagName.toLowerCase()&&(i=$(e.target).closest("text").attr("id"))),o=getSlots(a=getCoords(i)),$("#ex_how_align").html(translateWord("ex_align_ref_selected"));else{globalConfigChanged=!0;let s=e.target.tagName.toLowerCase(),r="";switch((""==(i=e.target.id)||i.includes("_"))&&(i=e.target.parentNode.id,s=e.target.parentNode.tagName,"g"==e.target.parentNode.tagName.toLowerCase()&&(i=e.target.ownerSVGElement.id,s=e.target.ownerSVGElement.tagName),"tspan"==e.target.parentNode.tagName.toLowerCase()&&(i=$(e.target).closest("text").attr("id"),s=$(e.target).closest("text").prop("tagName"))),t.replace("align_","")){case"center":switch(s){case"circle":n={id:i,step:globalLastStepsPos++,coord:"cx",plain:"x",value:$("#"+i).attr("cx")},$("#"+i).attr("cx",o.top.x),configuration.elements[i].pos_x=o.top.x;break;case"rect":case"svg":n={id:i,step:globalLastStepsPos++,coord:"x",plain:"x",value:$("#"+i).attr("x")},r=o.top.x-Math.floor(parseInt($(this).attr("width"))/2),$("#"+i).attr("x",r),configuration.elements[i].pos_x=r;break;case"text":n={id:i,step:globalLastStepsPos++,coord:"x",plain:"x",value:$("#"+i).attr("x")},$("#"+i).attr("x",o.top.x),configuration.elements[i].pos_x=o.top.x,$("#"+i).hasClass("type_text")&&$("#"+i).children().attr("x",o.top.x),$("#"+i).hasClass("type_datasource")&&$(`#${i}_prepend, #${i}_append, #${i}_value, #${i}_unit`).children().each(function(e,t){$(this).attr("x")&&$(this).attr("x",o.top.x)})}break;case"left":switch(s){case"circle":n={id:i,step:globalLastStepsPos++,coord:"cx",plain:"x",value:$("#"+i).attr("cx")},r=o.left.x+parseInt($(this).attr("r"))+Math.floor(parseInt($(this).css("stroke-width"))/2),$("#"+i).attr("cx",r),configuration.elements[i].pos_x=r;break;case"rect":case"svg":n={id:i,step:globalLastStepsPos++,coord:"x",plain:"x",value:$("#"+i).attr("x")},r=o.left.x+Math.floor(parseInt($(this).css("stroke-width"))/2),$("#"+i).attr("x",r),configuration.elements[i].pos_x=r;break;case"text":n={id:i,step:globalLastStepsPos++,coord:"x",plain:"x",value:$("#"+i).attr("x")},r=o.left.x+Math.floor(e.target.getComputedTextLength()/2),$("#"+i).attr("x",r),configuration.elements[i].pos_x=r,$("#"+i).hasClass("type_text")&&$("#"+i).children().attr("x",r),$("#"+i).hasClass("type_datasource")&&$(`#${i}_prepend, #${i}_append, #${i}_value, #${i}_unit`).children().each(function(e,t){$(this).attr("x")&&$(this).attr("x",r)})}break;case"right":switch(s){case"circle":n={id:i,step:globalLastStepsPos++,coord:"cx",plain:"y",value:$("#"+i).attr("cx")},$("#"+i).attr("cx",o.right.x-parseInt($(this).attr("r"))-Math.floor(parseInt($(this).css("stroke-width"))/2));break;case"rect":case"svg":n={id:i,step:globalLastStepsPos++,coord:"x",plain:"y",value:$("#"+i).attr("x")},r=o.right.x-Math.floor(parseInt($(this).attr("width")))-Math.floor(parseInt($(this).css("stroke-width"))/2),$("#"+i).attr("x",r),configuration.elements[i].pos_x=r;break;case"text":n={id:i,step:globalLastStepsPos++,coord:"x",plain:"y",value:$("#"+i).attr("x")},r=o.right.x-Math.floor(e.target.getComputedTextLength()/2),$("#"+i).attr("x",r),configuration.elements[i].pos_x=r,$("#"+i).hasClass("type_text")&&$("#"+i).children().attr("x",r),$("#"+i).hasClass("type_datasource")&&$(`#${i}_prepend, #${i}_append, #${i}_value, #${i}_unit`).children().each(function(e,t){$(this).attr("x")&&$(this).attr("x",r)})}break;case"vcenter":switch(s){case"circle":n={id:i,step:globalLastStepsPos++,coord:"cy",plain:"y",value:$("#"+i).attr("cy")},$("#"+i).attr("cy",o.right.y),configuration.elements[i].pos_y=o.right.y;break;case"rect":case"svg":n={id:i,step:globalLastStepsPos++,coord:"y",plain:"y",value:$("#"+i).attr("y")},r=o.right.y-Math.floor(parseInt($(this).attr("height"))/2),$("#"+i).attr("y",r),configuration.elements[i].pos_y=r;break;case"text":n={id:i,step:globalLastStepsPos++,coord:"y",plain:"y",value:$("#"+i).attr("y")},$("#"+i).attr("y",o.right.y),configuration.elements[i].pos_y=o.right.y}break;case"top":switch(s){case"circle":n={id:i,step:globalLastStepsPos++,coord:"cy",plain:"y",value:$("#"+i).attr("cy")},r=o.top.y+parseInt($(this).attr("r"))+Math.floor(parseInt($(this).css("stroke-width"))/2),$("#"+i).attr("cy",r),configuration.elements[i].pos_y=r;break;case"rect":case"svg":n={id:i,step:globalLastStepsPos++,coord:"y",plain:"y",value:$("#"+i).attr("y")},r=o.top.y+Math.floor(parseInt($(this).css("stroke-width"))/2),$("#"+i).attr("y",r),configuration.elements[i].pos_y=r;break;case"text":n={id:i,step:globalLastStepsPos++,coord:"y",plain:"y",value:$("#"+i).attr("y")},r=o.top.y+Math.floor(parseInt($(this).css("font-size"))/2),$("#"+i).attr("y",r),configuration.elements[i].pos_y=r}break;case"bottom":switch(s){case"circle":n={id:i,step:globalLastStepsPos++,coord:"y",plain:"y",value:$("#"+i).attr("y")},r=o.bottom.y-parseInt($(this).attr("r"))-Math.floor(parseInt($(this).css("stroke-width"))/2),$("#"+i).attr("cy",r),configuration.elements[i].pos_y=r;break;case"rect":case"svg":n={id:i,step:globalLastStepsPos++,coord:"y",plain:"y",value:$("#"+i).attr("y")},r=o.bottom.y-Math.floor(parseInt($(this).attr("height")))-Math.floor(parseInt($(this).css("stroke-width"))/2),$("#"+i).attr("y"),configuration.elements[i].pos_y=r;break;case"text":n={id:i,step:globalLastStepsPos++,coord:"y",plain:"y",value:$("#"+i).attr("y")},r=o.bottom.y-Math.floor(parseInt($(this).css("font-size"))/2),$("#"+i).attr("y",r),configuration.elements[i].pos_y=r}}globalLastSteps.push(n);let l=globalLastSteps.length;l>0?($("#undo_align_elements").prop("disabled",!1),$("#undo_steps").text(sprintf(systemDictionary.ex_align_saved_steps[systemLang],l))):$("#undo_align_elements").prop("disabled",!0);let c=$("path[id*="+i+"]");c.length>0&&c.each(function(e){let t=c[e].id.split("_");calculatePath(c[e].id,t[1],t[2])})}})}),$("#align_elements, #undo_align_elements").click(function(){globalLastSteps.sort(function(e,t){return t.step-e.step});let e=globalLastSteps.length;if("undo_align_elements"==this.id){if(e>0){let t=globalLastSteps[0];console.log("Restoring Element: "+t.id+" with "+t.coord+" and Value: "+t.value),$("#"+t.id).attr(t.coord,t.value),configuration.elements[t.id]["pos_"+t.plain]=parseInt(t.value),$("#"+t.id).hasClass("type_text")&&"y"!=t.coord&&$("#"+t.id).children().attr(t.coord,t.value),$("#"+t.id).hasClass("type_datasource")&&"y"!=t.coord&&$(`#${t.id}_prepend, #${t.id}_append, #${t.id}_value, #${t.id}_unit`).children().each(function(e,a){$(this).attr("x")&&$(this).attr("x",t.value)});let a=$("path[id*="+t.id+"]");a.length>0&&a.each(function(e){let t=a[e].id.split("_");calculatePath(a[e].id,t[1],t[2])}),globalLastSteps.shift(),(e=globalLastSteps.length)>0?$("#undo_steps").text(sprintf(systemDictionary.ex_align_saved_steps[systemLang],e)):($("#undo_steps").text(sprintf(systemDictionary.ex_align_saved_steps[systemLang],"-")),$("#undo_align_elements").prop("disabled",!0))}}else $("#ex_how_align").html(translateWord("ex_align")),$("#connect_elements").prop("disabled",!1),$("#align_elements, #undo_align_elements").hide(),$("#all_undo_align_elements").css("display","none"),$("#undo_steps").text(sprintf(systemDictionary.ex_align_saved_steps[systemLang],"-")),$("#undo_align_elements").prop("disabled",!0),$(".alignable").off(),$(".added_elements").removeClass("alignable").addClass("draggable"),$(".all_elements, .align_elements").removeClass("faded_out")}),$("#import_element").click(function(){let e,t=getRandomInt(55);$(`<div id="tmpDiv_${t}" />`).appendTo("body"),$(`#tmpDiv_${t}`).prop("title",translateWord("lbl_import_element")).dialog({resizable:!1,height:520,width:400,maxHeight:"100%",modal:!0,classes:{"ui-dialog":"no-close"},show:"fade",hide:"fade",beforeClose:function(){$('<div class="ui-widget-overlay-fading" />)').appendTo("body"),$(".ui-widget-overlay-fading").fadeOut("fast",function(){$(this).remove()})},close:function(){$(this).dialog("destroy"),e.destroy(),$(`#tmpDiv_${t}`).remove()},create:function(a,o){(e=ace.edit(`tmpDiv_${t}`)).session.setMode("ace/mode/json"),e.setTheme("ace/theme/"+appProperties.aceEditorTheme[appProperties.colorScheme])},open:function(t,a){$(".ui-widget-overlay").hide().fadeIn("fast"),$(this).parent().focus(),$(".ui-dialog-buttonset").children().first().prop("disabled",!0),e.getSession().off("changeAnnotation"),e.getSession().on("changeAnnotation",function(){let t=e.getSession().getAnnotations().filter(e=>"error"==e.type);$(".ui-dialog-buttonset").children().first().prop("disabled",t.length>0||0==e.getSession().getValue().length)})},buttons:[{text:translateWord("btn_import"),class:"input_button",click:function(){globalConfigChanged=!0;let t=JSON.parse(e.getValue()),a=0,o=0,i=getMaxID();configuration.basic.enable_area_catch?(a=$("#svg_config_div").scrollLeft(),o=$("#svg_config_div").scrollTop()):(a=$(document).scrollLeft(),o=$(document).scrollTop()),t.id=i,t.source=-1,t.pos_x=a+(parseInt(configuration.basic.elm.pos_x)||50)+getRandomInt(50),t.pos_y=o+(parseInt(configuration.basic.elm.pos_y)||50)+getRandomInt(50),configuration.elements[i]=t,svgElement(configuration.elements[i]),console.debug(`Importing new Element with: ${t}`),$(this).dialog("close")}},{text:translateWord("value_cancel"),class:"input_button red",click:function(){$(this).dialog("close")}}]})}),$("#duplicate_elements").click(async function(){globalConfigChanged=!0;let e=[],t=[];if(0==$(".draggable-multi").length?$("#elm_select").val()?$("#elm_select").val().includes("line")?failedMessage(translateWord("failmsg_duplicate_no_line")):e.push($("#elm_select").val()):failedMessage(translateWord("failmsg_duplicate_no_elm")):$(".draggable-multi").each(function(){e.push(this.id)}),e.length>0){for(let a=0;a<e.length;a++){let o=getMaxID(),i=JSON.parse(JSON.stringify(configuration.elements[e[a]]));i.id=o,i.pos_x=parseInt(i.pos_x)+15,i.pos_y=parseInt(i.pos_y)+15,configuration.elements[o]=i,1==e.length?svgElement(configuration.elements[o],!1,!1,function(e,t){showConfigBar(e,t),successMessage(translateWord("succ_msg_duplicate"))}):await svgElement(configuration.elements[o],!1,!1,function(e,a){t.push(e)})}if(t.length>0){successMessage(translateWord("succ_msg_duplicate")),$(".draggable").removeClass("draggable-multi"),hideConfigBar();for(let n=0;n<t.length;n++)$(`#${t[n]}`).addClass("draggable-multi")}}}),$(".add_element").click(function(e){globalConfigChanged=!0;let t=0,a=0,o=getMaxID();configuration.basic.enable_area_catch?(t=$("#svg_config_div").scrollLeft(),a=$("#svg_config_div").scrollTop()):(t=$(document).scrollLeft(),a=$(document).scrollTop());let i={position:0,id:o,width:parseInt(configuration.basic.rect.width)||100,height:parseInt(configuration.basic.rect.height)||100,pos_x:t+(parseInt(configuration.basic.elm.pos_x)||50)+getRandomInt(50),pos_y:a+(parseInt(configuration.basic.elm.pos_y)||50)+getRandomInt(50),source:-1,threshold:0,frame:"_overlay",url:"",action:"none"},n=e.target.id||$(this).closest("a").attr("id");switch(n){case"add_circle":i.radius=parseInt(configuration.basic.circle.radius)||50,i.type="circle",i.fill_value="",i.fill_type=-1,i.fill_direction=90,i.fill_max=0,i.border_value="",i.border_type=-1,i.border_direction="cw",i.border_style="round",i.border_max=0,i.border_reverse_value="",i.border_reverse=!1,i.border_start=180,i.color=configuration.basic.elm.color||getRandomRGBA(),i.fill=configuration.basic.elm.fill||"none",i.stroke=parseInt(configuration.basic.elm.stroke_width)||5;break;case"add_rect":i.type="rect",i.rx=parseInt(configuration.basic.rect.corners)||10,i.fill_value="",i.fill_type=-1,i.fill_direction="cw",i.fill_max=0,i.border_value="",i.border_type=-1,i.border_direction="cw",i.border_style="round",i.border_max=0,i.border_reverse_value="",i.border_reverse=!1,i.border_start=180,i.color=configuration.basic.elm.color||getRandomRGBA(),i.fill=configuration.basic.elm.fill||"none",i.stroke=parseInt(configuration.basic.elm.stroke_width)||5;break;case"add_text":i.type="text",i.text="Text",i.align=configuration.basic.font.align||"middle",i.color=configuration.basic.font.color||"none",i.fill=configuration.basic.font.fill||getRandomRGBA(),i.font_size=configuration.basic.font.size||20,i.font_family=configuration.basic.font.family||'"Arial", sans-serif';break;case"add_datasource":i.calculate_kw="none",i.counter_animation=!1,i.convert=!1,i.decimal_places=0,i.type="text",i.align=configuration.basic.font.align||"middle",i.subType="datasource",i.text="Datasource "+o,i.source_option=-1,i.source_display="value",i.linebreak=0,i.subtract=[],i.add=[],i.unit="kW",i.action="none",i.source_action=-1,i.color=configuration.basic.font.color||"none",i.fill=configuration.basic.font.fill||getRandomRGBA(),i.font_size=configuration.basic.font.size||20,i.font_family=configuration.basic.font.family||'"Arial", sans-serif';break;case"add_icon":i.type="icon",i.width=24,i.height=24,i.icon="mdi:omega",i.color=configuration.basic.icon.color||getRandomRGBA();break;case"add_svg":i.svg_content='<path d="M19.564 4.42a.75.75 0 0 0-1.378-.59l-6.75 15.75a.75.75 0 0 0 1.378.59l6.75-15.75ZM7 18.5a1.5 1.5 0 1 1-3 0a1.5 1.5 0 0 1 3 0Z" fill="currentColor"></path>',i.subType="svg",i.type="svg",i.width=24,i.height=24,i.viewbox="0 0 24 24";break;case"add_image":i.href="img/tmp_img.png",i.width=100,i.height=100,i.type="image",i.preserveAspectRatio="xMidYMid meet";break;case"add_fObj":i.fObj_content=`<div xmlns="http://www.w3.org/1999/xhtml">${translateWord("help_fObj_tmp")}</div>`,i.width=48,i.height=48,i.type="foreignObject"}configuration.elements[o]=i,svgElement(i,!1)}),$("#config_close").click(function(){hideConfigBar()}),$("#config_swap").click(function(){$("#config_bar").toggleClass("left right")}),$(".stateExplorer_close").click(function(){hideStateExplorer()}),$(".codeEditor_close").click(function(){hideCodeEditor()}),$(".connect_elements").click(async function(e){await connectElements(e.target.id)}),$("#save_workspace, #save_workspace_exit").click(async function(){(globalConfigChanged=!1,appProperties.localMode)?successMessage(translateWord("succ_msg_local_output")):await saveWorkspace()&&(successMessage(translateWord("succ_msg_save_workspace")),"save_workspace_exit"==this.id&&window.location.replace("index.html?instance="+appProperties.instance)),aceLog.setValue(JSON.stringify(configuration,void 0,4),-1)}),$("#workspace_exit").click(function(){window.location.replace("index.html?instance="+appProperties.instance)}),$(".check_datasources").click(function(e){Object.entries(configuration.datasources).forEach(async t=>{let[a,o]=t,i=$(`#datasource-table tbody tr[data-id="${a}"`),n;switch(e.target.id){case"check_datasources":console.debug(`Checking ${o.source}`);n=await new Promise(e=>{socket.emit("getState",o.source,(t,a)=>{e(a)})})?"highlight-green":"highlight-red";break;case"check_datasources_in_use":console.debug(`Checking ${a}`),n=Object.keys(checkDatasourcesInUse(a)).length>0?"highlight-green":"highlight-red"}$(i).addClass(n),setTimeout(()=>{$(i).removeClass(n)},4e3)})}),$("#restore_backup").click(function(){let e=$("#backup_list").val();-1!=e&&""!=e&&null!=e?$("#dialog_section").prop("title",translateWord("lbl_backup_section")).html(translateWord("msg_backup_restore")).dialog({resizable:!1,height:"auto",maxHeight:"100%",classes:{"ui-dialog":"no-close"},show:"fade",width:400,modal:!0,open:function(e,t){$(".ui-widget-overlay").hide().fadeIn("slow"),$(this).parent().focus()},buttons:[{text:translateWord("value_save_restore"),width:"auto",class:"input_button",click:function(){$(this).dialog("destroy"),socket.emit("sendTo",appProperties.namespace,"_restoreBackup",{filename:e},function(e){e&&e.error?(console.log("An error occured, while restoring the backup. The following error was provided: ",e.error),failedMessage(translateWord("failmsg_backup"))):(configuration=e.data,console.log(e.data),setLoadedConfig(),successMessage(translateWord("succ_msg_backup")))})}},{text:translateWord("value_cancel"),class:"input_button red",click:function(){$(this).dialog("destroy"),failedMessage(translateWord("failmsg_backup_cancel"))}}]}):failedMessage(translateWord("failmsg_backup_no_valid"))}))}),$(document).ready(function(e){displayMode?(setTimeout(()=>{$("#loading_text_error").fadeIn("fast")},4e3),$("body").on("click",".action_element",function(e){let t=$(this).attr("id");console.debug(`Clicked on Action Element ${t}`),actionForElement(t,e)})):($("#drop_zone").on("dragover",function(e){e.preventDefault(),$(this).addClass("dragFile"),$("#upload_info").text(translateWord("txt_upload_status_drop"))}),$("#drop_zone").on("dragleave",function(e){e.preventDefault(),$(this).removeClass("dragFile"),$("#upload_info").text(translateWord("txt_upload_status_init"))}),$("#drop_zone").on("drop",function(e){e.preventDefault(),$("#uploadFile").prop("files",e.originalEvent.dataTransfer.files).trigger("change")}),$("#uploadFile").on("change",async function(){function e(e){return e.trim().replace(/[^a-z0-9._\-]/gi,"_").replace(/_{2,}/g,"_").toLowerCase()}function t(e){return new Promise(function(t,a){let o=new FormData;o.append("uploadFile",e);let i=new XMLHttpRequest;i.open("POST",appProperties.socketURL+appProperties.namespace+"/upload",!0),i.onload=function(){t(JSON.parse(i.responseText))},i.send(o)})}$("#upload_progress>div").css("width","0%");let a=this.files.length,o=[],i=!1;for(let n of this.files)if(n.type.includes("image")&&n.size<=5242880)i=!0;else{i=!1;break}if($("#file_selector").blur().prop("disabled",!0),i){for(let s of($("#upload_errors").slideUp(),this.files)){$("#upload_info").text(sprintf(systemDictionary.txt_upload_uploading[systemLang],Object.keys(o).length||1,a));let r=e(s.name),l=r.replaceAll(".","\\.");if($(`#${l}`).length>0)o.push({filename:r,success:!1,reason:"exists"});else{let c=await t(s);o.push({filename:c.filename,success:!0,reason:"success"}),globalUserImages.push(c.filename);let d=globalUserImages.sort().indexOf(c.filename),u=wrapUploadImage(c.filename,c.path).hide();$("#userImages_dummy").fadeOut("fast"),$("#userImages div.imgContainer").length>d?$(`#userImages div.imgContainer:nth-child(${d+1})`).before(u):$("#userImages").append(u),u.fadeIn(2e3),$("#upload_progress>div").css("width",Object.keys(o).length/a*100+"%")}appProperties.isMobile&&getUserImages()}o.find(e=>!1===e.success)?($("#upload_errors-table tbody").empty(),o.forEach(function(e){$("#upload_errors-table tbody").append(`<tr><td>${e.filename}</td><td>${translateWord("txt_upload_error_"+e.reason)}</td></tr> `)}),$("#upload_info").html(`${translateWord("txt_upload_status_error")} <a href="javascript:;" onclick="$('#upload_errors').slideToggle();"><span class="iconify" data-icon="material-symbols:error-outline" data-width="24" height="24" style="color:var(--red);"></span></a>`)):$("#upload_info").text(translateWord("txt_upload_status_success"))}else $("#upload_info").text(translateWord("txt_upload_status_tooBig"));$("#uploadFile").val(null),$("#file_selector").prop("disabled",!1),$("#drop_zone").removeClass("dragFile")}),$("#svg_config").on("keydown",function(e){e.preventDefault()}),$("body").on("click",".line:not(.preview,.not_selectable)",function(e){showConfigBar(e.target.id,e.target.tagName.toLowerCase())}),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",e=>{appProperties.colorScheme=e.matches?"dark":"light",console.log("Color-Scheme-changed: "+appProperties.colorScheme),aceLog.setTheme("ace/theme/"+appProperties.aceEditorTheme[appProperties.colorScheme]),aceCSS.setTheme("ace/theme/"+appProperties.aceEditorTheme[appProperties.colorScheme]),aceOverride.setTheme("ace/theme/"+appProperties.aceEditorTheme[appProperties.colorScheme])}),(aceLog=ace.edit("save_output")).session.setMode("ace/mode/json"),aceLog.setTheme("ace/theme/"+appProperties.aceEditorTheme[appProperties.colorScheme]),aceLog.setReadOnly(!0),(aceOverride=ace.edit("codeEditor")).session.setMode("ace/mode/json"),aceOverride.setTheme("ace/theme/"+appProperties.aceEditorTheme[appProperties.colorScheme]),$(window).on("beforeunload",function(){if(globalConfigChanged)return translateWord("leave_unsaved")}),$("body").on("click",".help",function(){$("#help_section").html($(this).attr("placeholder")).dialog({resizable:!1,maxHeight:"100%",classes:{"ui-dialog":"no-close"},width:400,modal:!1,open:function(e,t){$(this).parent().focus()},close:function(){$(this).dialog("destroy")},buttons:[{text:translateWord("btn_close"),class:"input_button",click:function(){$(this).dialog("close")}}]})}),$("body").on("click",".delete_upload",function(){let e=$(this).parent().parent().attr("id");deleteUserImage(e)}),$("body").on("keyup",".userImages_filter",function(){let e=RegExp($(this).val().trim().toLowerCase()),t=$(this).parent().parent().siblings(".userImages").children(".imgContainer");t.show(),e&&t.each(function(){(this.id||$(this).data("id")).match(e)||$(this).hide()})}),$("#frm-addDataSource").submit(function(e){e.preventDefault();let t=$("#elm_ds_source").val(),a=$("#elm_ds_alias").val()?$("#elm_ds_alias").val():"",o=Number($("#elm_ds_factor").val()),i=checkDuplicateDatasource(t);if(i){let n=$(`#datasource - table tbody tr[data - id= "${i}"`);$("html, body").animate({scrollTop:$(n).offset().top-80},{complete:function(){$(n).addClass("highlight-red")}}),setTimeout(()=>{$(n).removeClass("highlight-red")},4e3),failedMessage(translateWord("failmsg_ds_already_exists"))}else{globalConfigChanged=!0;let s=Object.keys(configuration.datasources).length>0?Math.max(...Object.keys(configuration.datasources).map(e=>e))+1:0;console.debug(`New ID for added datasource: ${s} `),configuration.datasources[s]={source:t,alias:a,factor:o},addDataSourceRow(s,!0),successMessage(translateWord("succ_msg_ds_created")),$(this)[0].reset(),updateDataSources()}}),$("#datasource-table").on("click",".btn-delete",function(){let e=$(this).parents("tr"),t=checkDatasourcesInUse(e.data("id"));if(Object.keys(t).length>0){let a=`< div class="data-table-div" > <table class='used-ds-table config_table'><thead><tr><th>${translateWord("lbl_config_element")}</th><th>${translateWord("lbl_type")}</th><th>${translateWord("lbl_used_as")}</th></thead><tbody>`,o="",i;for(var n in t)o+=`<tr><td>${t[n].id}</td><td>${t[n].type}</td><td>${t[n].reason}</td></tr>`;i=`${a}${o} </tbody></table></div > `,$("#dialog_section").prop("title",translateWord("lbl_ds_delete_section")).html(`< span class='dsInUseInfoTitle' > ${translateWord("failmsg_delete_source")}</span > `).append(i).dialog({resizable:!1,maxHeight:"98%",classes:{"ui-dialog":"no-close"},width:"auto",modal:!0,show:"fade",hide:"fade",beforeClose:function(){$('<div class="ui-widget-overlay-fading" />)').appendTo("body"),$(".ui-widget-overlay-fading").fadeOut("fast",function(){$(this).remove()})},close:function(){$(".ui-dialog").remove()},open:function(e,t){$(".ui-widget-overlay").hide().fadeIn("slow"),$(this).parent().focus()},buttons:[{text:translateWord("btn_close"),class:"input_button",click:function(){$(this).dialog("close")}}]})}else globalConfigChanged=!0,e.fadeOut("fast",function(){$(this).remove(),0==$("#datasource-table tbody tr").length&&$("#datasource-table tbody").append("<tr id='ds_tmp_line' data-id='-1'><td>"+translateWord("no_ds_added")+"</td><td></td><td></td>"),delete configuration.datasources[e.data("id")]})}),$("#datasource-table").on("click",".btn-edit",function(){$("#frm-addDataSource :input, #frm-addDataSource a, .tabbed>input, .ds_buttons.btn-edit, .ds_buttons.btn-delete").prop("disabled",!0),$("#frm-addDataSource a, .tabbed nav label").attr("disabled",!0);let e=$(this).parents("tr"),t=e.data("alias"),a=e.data("source"),o=e.data("factor"),i=`< div class="form_div no_margin" > <input type="text" class="input_text" id="edit_ds_alias" name="edit_ds_alias" autocorrect="off" autocomplete="off" value="${t}"></div>`,n=`< div class="form_div no_margin" > <input type="text" class="input_text icon_in_input_pad datasource_autocomplete" id="edit_ds_source" name="edit_ds_source" autocorrect="off" autocomplete="off" minlength="3" value="${a}" required><div class="icon_wrapper"><a class="frm-datasource icon_in_input"><span class="iconify" data-icon="mdi:database-search" data-height="24"></span></a><div class="ds_search_spinner"><span class="spinner"></span></div></div></div>`,s=`< div class="form_div no_margin" > <select class="input_select elm_config" name="edit_ds_factor" id="edit_ds_factor"><option value="1">${translateWord("opt_ds_factor_1")}</option><option value="1000">${translateWord("opt_ds_factor_1000")}</option></select></div > `;e.find("td:eq(0)").html(i),e.find("td:eq(1)").html(n),e.find("td:eq(2)").html(s),e.find(".btn-update, .btn-cancel").show(),e.find(".btn-delete, .btn-edit").hide(),$("#edit_ds_factor").val(o),configuration.basic.enable_ds_autocomplete&&$("#edit_ds_source").autocomplete(dataSourceAutocompleteOptions)}),$("#datasource-table").on("click",".btn-cancel",function(){$("#frm-addDataSource :input, #frm-addDataSource a, .tabbed>input, .ds_buttons.btn-edit, .ds_buttons.btn-delete").prop("disabled",!1),$("#frm-addDataSource a, .tabbed nav label").attr("disabled",!1);let e=$(this).parents("tr");e.find("td:eq(0)").text(e.data("alias")),e.find("td:eq(1)").text(e.data("source")),e.find("td:eq(2)").text(e.data("factor")),e.find(".btn-edit, .btn-delete").show(),e.find(".btn-cancel, .btn-update").hide()}),$("#datasource-table").on("click",".btn-update",function(){$("#frm-addDataSource :input, #frm-addDataSource a, .tabbed>input, .ds_buttons.btn-edit, .ds_buttons.btn-delete").prop("disabled",!1),$("#frm-addDataSource a, .tabbed nav label").attr("disabled",!1);let e=$(this).parents("tr"),t=$("#edit_ds_alias").val(),a=$("#edit_ds_source").val(),o=Number($("#edit_ds_factor").val());if(a.length>=3){let i=checkDuplicateDatasource(a);void 0!=i&&i!=e.data("id")?($("#edit_ds_source").focus(),failedMessage(translateWord("failmsg_ds_already_exists"))):(configuration.datasources[e.data("id")]={source:a,alias:t,factor:o},console.debug(`Datasource updated: New values: ${JSON.stringify(configuration.datasources[e.data("id")])} `),$("#frm-addDataSource :input, #frm-addDataSource a").prop("disabled",!1),$("#frm-addDataSource a").attr("disabled",!1),globalConfigChanged=!0,e.find("td:eq(0)").text(t),e.find("td:eq(1)").text(a),e.find("td:eq(2)").text(o),e.data({alias:t,source:a,factor:o}),e.find(".btn-edit, .btn-delete").show(),e.find(".btn-cancel, .btn-update").hide(),updateDataSources())}else $("#edit_ds_source").focus(),failedMessage(translateWord("msg_ds_not_empty"))}),$("body").on("click",".frm-datasource",function(){let e=RegExp("{([^)]+)}"),t=$(this).parent("div").parent("div").children("input").attr("id"),a=$("#"+t).val();if("elm_href"==t&&a.length>0){let o=a.match(e);o&&o.length>0&&(a=o[1])}""==a&&!0==configuration.basic.enable_last_id&&(a=globalSelectedId,console.debug("Showing last ID: "+a)),$("#loading").fadeIn("middle"),$(".loading-spinner, #loading_text").hide(),$("#stateExplorerContainer").show(),openStateTree("stateExplorer",a),$("#select_state").off().on("click",function(){let e=$(".state.active").parent().attr("id");"elm_href"==t?$("#"+t).val(`{${e} } `).focus().trigger("change"):$("#"+t).val(e).focus(),globalSelectedId=e,hideStateExplorer(),$(".state").removeClass("active").children(".type").removeClass("file-selected")}),$("#reloadStateExplorer").off().on("click",async function(){$("#select_state").prop("disabled",!0),$("#stateRoot").empty().remove(),$("#stateExplorer_placeholder").show(),iobObjects=await loadIobObjects(),generateStateTree(iobObjects,"stateExplorer"),$(".stateExplorerFilter").trigger("keyup")})}),$("#datasource-table").on("click","th",function(){$(".sort_icon").html("");var e=$(this).parents("table").eq(0),t=e.find("tr:gt(0)").toArray().sort(dataSourceComparer($(this).index()));$(this).find(".sort_icon").html('<span class="iconify" data-icon="mdi:sort-alphabetical-ascending" data-height="18">'),this.asc||(t=t.reverse(),$(this).find(".sort_icon").html('<span class="iconify" data-icon="mdi:sort-alphabetical-descending" data-height="18">'));for(var a=0;a<t.length;a++)e.append(t[a]);this.asc=!this.asc}),$("#image_href_gallery").click(function(){let e=$(this).parent("div").parent("div").children("input").attr("id");$("#userImagesBrowseDialog").prop("title",translateWord("lbl_gallery")).dialog({resizable:!1,maxHeight:500,classes:{"ui-dialog":"no-close"},height:"auto",width:640,modal:!0,show:"fade",hide:"fade",beforeClose:function(){$('<div class="ui-widget-overlay-fading" />)').appendTo("body"),$(".ui-widget-overlay-fading").fadeOut("fast",function(){$(this).remove()})},close:function(){$(".ui-dialog").remove()},create:function(){let e=$("#userImages").children().clone();e.each(function(e,t){$("#userImagesBrowseFilter").val(""),$(t).hasClass("imgContainer")&&($(t).data("id",this.id).attr("id","").show(),$(t).children(".uploads_btn").children().val(translateWord("value_select")).removeClass("delete_upload").addClass("select_upload"))}),$("#userImagesBrowse").empty().append(e)},open:function(t,a){$(".ui-widget-overlay").hide().fadeIn("slow"),$(this).parent().focus(),$(".select_upload").off().on("click",function(){let t=$(this).parent().parent().data("id");$("#"+e).val(t).trigger("change"),$(".ui-dialog-buttonset").children().first().click()})},buttons:[{text:translateWord("btn_close"),class:"input_button",click:function(){$(this).dialog("close")}}]})}),getUserImages()),"Firefox"==appProperties.userAgent&&loadConfig()});