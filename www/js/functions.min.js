const urlParams=new URLSearchParams(window.location.search),instance=urlParams.get("instance")?urlParams.get("instance"):0;let adapterNameNamespace="energiefluss-erweitert."+instance;console.log("Using Instance: "+adapterNameNamespace);let objID=[adapterNameNamespace+".configuration",adapterNameNamespace+".data","system.adapter."+adapterNameNamespace+".alive"],configuration_default={line:{stroke_width:8,stroke:"#000000"},basic:{enable_grid:!0,enable_animation:!1,enable_area_catch:!0,enable_config_icon:!0,enable_last_id:!1,height:600,width:800,styles:"",font:{family:'"Arial", sans-serif',size:20},rect:{height:100,width:100,corners:10},circle:{radius:50},elm:{stroke_width:5},icon:{width:24,height:24}},animation:{stroke:"#ffce4a",stroke_dasharray:"4 12 4 12 4 100",stroke_width:6,animation_duration:2e3,stroke_linecap:"round",animation_timing_function:"linear"},animation_configuration:{dots:4,distance:12,length:6},animations:{},lines:{}},configuration=configuration_default,displayMode=!1,localMode=!1,globalConfigChanged=!1,basicConfig=!1,globalSelectedId,globalLastSteps={},globalAdapterOnline=!1;var url=window.location.pathname;"file:"==window.location.protocol&&(localMode=!0,console.log("Local Mode activated!"));var filename=url.substring(url.lastIndexOf("/")+1);filename.includes("index")||""==filename?displayMode=!0:jscolor.presets.default={format:"rgba",borderColor:"#538EA3",borderRadius:10,controlBorderColor:"#538EA3",previewSize:28,previewPosition:"right",required:!1,palette:["#00b5dd","#61687a","#ffce4a","#a1d343","#c5902e","#f20e40"]};let selectId,iobObjects;var iobPath=location.pathname,iobParts=iobPath.split("/");if(iobParts.splice(-3),location.pathname.match(/^\/admin\//)&&(iobParts=[]),localMode){var t=io.connect("http://192.168.2.19:8082/",{path:"/socket.io",reconnectionDelay:500,reconnectionAttempts:1/0});t.emit("getObjects",function(t,e){iobObjects=e})}else{var t=io.connect("/",{path:iobParts.join("/")+"/socket.io",reconnectionDelay:500,reconnectionAttempts:1/0});t.emit("getObjects",function(t,e){iobObjects=e})}function initSelectId(t){if(selectId)return t(selectId);selectId=$("#dialog-select-member").selectId("init",{noMultiselect:!0,objects:iobObjects,imgPath:"../../lib/css/fancytree/",filter:{type:"state"},name:"scenes-select-state",texts:{select:_("Select"),cancel:_("Cancel"),all:_("All"),id:_("ID"),name:_("Name"),role:_("Role"),room:_("Room"),value:_("Value"),selectid:_("Select ID"),from:_("From"),lc:_("Last changed"),ts:_("Time stamp"),wait:_("Processing..."),ack:_("Acknowledged"),selectAll:_("Select all"),unselectAll:_("Deselect all"),invertSelection:_("Invert selection")},columns:["image","name","role","room"]}),t(selectId)}let max_elm_id=0,restore={};function displayLoading(t){$("#loading_text").text(t),$("#loading, .loading-spinner, #loading_text").show()}function displayListener(){let e=new Date().toLocaleString();localMode||(t.emit("subscribe",objID),console.log("[Socket] subscribed to: "+objID.toString()+" at "+e),t.on("connect",function(){console.log("[Socket] connected! at "+e)}),t.on("reconnect",function(){console.log("[Socket] reconnected at "+e),$("#loading").fadeOut("fast")}),t.on("disconnect",function(){console.log("[Socket] disconnected "+e),displayLoading("Reconnecting to your Energiefluss - erweitert")}),t.on("objectChange",function(t,e){}),t.on("stateChange",function(t,a){setTimeout(function(){if(t==objID[0])try{displayLoading("Applying new configuration to your Energiefluss - erweitert"),configuration=JSON.parse(a.val),setLoadedConfig(!0),console.log("Applied new configuration at "+e)}catch(i){console.log("Error while parsing Config in JSON-Object!")}if(t==objID[1])try{refreshData(JSON.parse(a.val))}catch(o){console.log("Error while parsing Values in JSON-Object!")}if(t==objID[2]){if(!1==a.val)displayLoading("Waiting for instance "+instance+" of Energiefluss - erweitert to come up"),console.log("Adapter instance: "+instance+" is not started! "+e),globalAdapterOnline=!1;else if(a.val!=globalAdapterOnline&&!0==a.val){console.log("Adapter instance: "+instance+" started at "+e),globalAdapterOnline=!0;let r=(Math.random()+1).toString(36).substring(7);window.location.href="?instance="+instance+"&hash="+r}}},0)}),t.on("reauthenticate",function(){console.log("[Socket] reauthenticate "+e)}),t.on("error",function(t){console.error("[Socket] error: "+t+" "+e)}),t.on("connect_error",function(t){console.error("[Socket] connect error: "+t+" "+e)}),t.on("permissionError",function(t){console.error("[Socket] permission error: "+t+" "+e)}))}function addGradient(t,e){""==e&&(e="transparent");let a=document.createElementNS("http://www.w3.org/2000/svg","linearGradient");a.setAttribute("id","gradient_"+t),a.setAttribute("gradientTransform","rotate(90)");let i=document.createElementNS("http://www.w3.org/2000/svg","stop");i.setAttribute("id","gradient_transparent_"+t),i.setAttribute("offset","0%"),i.setAttribute("stop-color","transparent"),a.appendChild(i),(i=document.createElementNS("http://www.w3.org/2000/svg","stop")).setAttribute("id","gradient_color_"+t),i.setAttribute("offset","1%"),i.setAttribute("stop-color",e),a.appendChild(i),$(a).appendTo("#placeholder_defs")}function updateGradient(t,e,a){try{let i=$("#"+t).data("fill_max"),o;switch(a){case"percent":o=100-e;break;case"value":o=100-e/i*100}$("#gradient_transparent_"+t).attr("offset",o+"%"),$("#"+t).css("fill","url(#gradient_"+t+")")}catch(r){console.log("Error while updating gradient for ID: "+t)}}function refreshData(t){Object.entries(t.values).forEach(e=>{let[a,i]=e;$("#"+a).html(i+" "+t.unit[a])}),Object.entries(t.fillValues).forEach(t=>{let[e,a]=t,i=$("#"+e).data("fill_type");-1!=i&&($("#gradient_"+e).length>0||(addGradient(e,$("#"+e).data("fill_value")),console.log("Fill-Gradient added for: "+e)),updateGradient(e,a,i))}),Object.entries(t.animations).forEach(e=>{let[a,i]=e,o="",r="";displayMode&&(t.animationProperties.hasOwnProperty(a)&&("dots"==t.animationProperties[a].type&&(o=t.animationProperties[a].stroke),"duration"==t.animationProperties[a].type&&(r=t.animationProperties[a].duration)),$("#"+a).css({display:i?"inline":"none","stroke-dasharray":o,"animation-duration":r+"ms"}))})}function loadConfig(){if(console.log("Loading config for instance: "+instance),localMode){if(configuration=localTest)console.log("Loading Local Config!"),setLoadedConfig();else{let e;basicConfig=!0,failedMessage(e=displayMode?"The adapter is not yet configured! We are loading a basic configuration!<br>Please use the config wheel below!":"The adapter is not yet configured! We are loading a basic configuration!"),console.log(e)}}else t.emit("getStates",objID,function(t,e){if(t)console.log(t),failedMessage("An error occured, while receiving data!");else if(e){if(null!=e[objID[0]])try{configuration=JSON.parse(e[objID[0]].val),setLoadedConfig()}catch(a){let i;basicConfig=!0,failedMessage(i=displayMode?"The adapter is not yet configured! We are loading a basic configuration!<br>Please use the config wheel below!":"The adapter is not yet configured! We are loading a basic configuration!"),console.log("Applying basic configuration!"),$.getJSON("js/basic_config.json",function(t){(configuration=t)?setLoadedConfig():failedMessage("Failed to load the basic configuration!<br>Adapter may be corrupted!")})}else failedMessage("The Instance <b>"+instance+"</b>, you are trying to access does not exist!");if(null!=e[objID[1]])try{console.log("Loading initial Data."),refreshData(JSON.parse(e[objID[1]].val))}catch(o){console.log(o)}globalAdapterOnline=null!=e[objID[2]]&&e[objID[2]].val}else failedMessage("Could not receive any values! Something is wrong!")})}function getElements(t,e){$("#"+t).empty();let a={},i=[],o=[],r=[],s=[],l=[],n=[],c;$(".added_elements, .anim_element").each(function(){if($(this).hasClass("type_text")&&i.push({id:this.id,text:$(this).text()+" (ID: "+this.id+")"}),$(this).hasClass("type_datasource")){let t=$(this).data("source"),e=$('.data-table tbody tr[data-id="'+t+'"]').find("td:eq(0)",this).text();o.push({id:this.id,text:$(this).text()+" ("+e+")"})}if($(this).hasClass("type_circle")&&r.push({id:this.id,text:"ID "+this.id+" (X: "+$(this).attr("cx")+" Y: "+$(this).attr("cy")+")",y:$(this).attr("cy")}),$(this).hasClass("type_rect")&&s.push({id:this.id,text:"ID "+this.id+" (X: "+$(this).attr("x")+" Y: "+$(this).attr("y")+")",y:$(this).attr("y")}),$(this).hasClass("type_icon")&&l.push({id:this.id,text:"ID "+this.id+" (X: "+$(this).attr("x")+" Y: "+$(this).attr("y")+" - "+$(this).data("icon")+")",y:$(this).attr("y")}),$(this).hasClass("type_animation")){let a=$("#"+this.id.replace("anim_","")).attr("d");a=a.substring(1,a.indexOf(" ")),n.push({id:this.id,text:"ID "+this.id+" (X: "+a+")",y:$(this).attr("y"),d:a})}}),i.sort((t,e)=>t.text<e.text?-1:t.text>e.text?1:0),a={"Circles (from top to bottom)":r.sort((t,e)=>parseFloat(t.y)-parseFloat(e.y)),"Datasources (value or ID - incl. Source)":o.sort((t,e)=>parseFloat(t.id)-parseFloat(e.id)),"Icons (from top to bottom)":l.sort((t,e)=>parseFloat(t.y)-parseFloat(e.y)),"Lines (from left to right)":n.sort((t,e)=>parseFloat(t.d)-parseFloat(e.d)),"Rectangles (from top to bottom)":s.sort((t,e)=>parseFloat(t.y)-parseFloat(e.y)),"Texts (alphabetical)":i},$.each(a,function(a,i){let o=$('<optgroup label="'+a+'" />');$.each(i,function(){(c=new Option(this.text,this.id)).selected=this.id==e,$(o).append(c)}),$("#"+t).append(o)})}function getDataSources(t,e,a=!0){a?$("#"+t).empty().append(new Option("Please choose ...","-1")):$("#"+t).empty();let i;$(".data-table tbody tr").each(function(){if(-1==$(this).data("id"))(i=new Option("There are currently no sources added!","-1")).disabled=!0,i.title="Go to the tab Datasources and add some";else if(i=new Option($("td:eq(0)",this).text()+" ("+$("td:eq(1)",this).text()+")",$(this).data("id")),"object"==typeof e)for(var a in e)e[a]==$(this).data("id")&&(i.selected=!0);else i.selected=$(this).data("id")==e;$("#"+t).append(i)})}function setLoadedConfig(t=!1){if($("#svg_width_slider").val(configuration.basic.width),$("#svg_height_slider").val(configuration.basic.height),$("#svg_width_value").val(configuration.basic.width).trigger("change"),$("#svg_height_value").val(configuration.basic.height).trigger("change"),$("#enable_animation").prop("checked",configuration.basic.enable_animation).trigger("change"),$("#enable_grid").prop("checked",configuration.basic.enable_grid).trigger("change"),$("#enable_area_catch").prop("checked",configuration.basic.enable_area_catch).trigger("change"),$("#enable_config_icon").prop("checked",configuration.basic.enable_config_icon).trigger("change"),$("#enable_last_id").prop("checked",configuration.basic.enable_last_id).trigger("change"),$("#line_size").val(configuration.line.stroke_width),$("#animation_width").val(configuration.animation.stroke_width),$("#animation_duration").val(configuration.animation.animation_duration),$("#animation_type").val(configuration.animation.animation_timing_function),$("#animation_linecap").val(configuration.animation.stroke_linecap),$("#animation_dots").val(configuration.animation_configuration.dots),$("#animation_distance").val(configuration.animation_configuration.distance),$("#animation_length").val(configuration.animation_configuration.length),configuration.basic.rect?($("#basic_rect_height").val(configuration.basic.rect.height),$("#basic_rect_width").val(configuration.basic.rect.width),$("#basic_rect_corners").val(configuration.basic.rect.corners)):($("#basic_rect_height").val(100),$("#basic_rect_width").val(100),$("#basic_rect_corners").val(10),configuration.basic.rect={height:100,width:100,corners:10}),configuration.basic.font?($("#basic_font_family").val(configuration.basic.font.family),$("#basic_font_size").val(configuration.basic.font.size)):($("#basic_font_family").val('"Arial", sans-serif'),$("#basic_font_size").val(20),configuration.basic.font={family:'"Arial", sans-serif',size:20}),configuration.basic.circle?$("#basic_circle_radius").val(configuration.basic.circle.radius):($("#basic_circle_radius").val(50),configuration.basic.circle={radius:50}),configuration.basic.elm?$("#basic_stroke_width").val(configuration.basic.elm.stroke_width):($("#basic_stroke_width").val(5),configuration.basic.elm={stroke_width:5}),configuration.basic.icon?($("#basic_icon_height").val(configuration.basic.icon.height),$("#basic_icon_width").val(configuration.basic.icon.width)):($("#basic_icon_height").val(24),$("#basic_icon_width").val(24),configuration.basic.icon={width:24,height:24}),updateLineAnimation(),$("#style_user").empty().append(configuration.basic.styles),$("#own_css").length>0&&$("#own_css").val(configuration.basic.styles),configuration.hasOwnProperty("elements")){if($(".placeholders").empty(),console.log("Loading User Config ..."),Object.entries(configuration.elements).forEach(t=>{let[e,a]=t,i=a.source>=0?a.source:-1;addElement({format:a.type,subType:a.subType,id:a.id,radius:a.radius,width:a.width,height:a.height,rx:a.rx,stroke:a.stroke,pos_x:a.pos_x,pos_y:a.pos_y,color:a.color,fill:a.fill,icon:a.icon,connPoint1:a.startSlot,connPoint2:a.endSlot,text:a.text,font_size:a.font_size,font_family:a.font_family,unit:a.unit,source:i,source_option:a.source_option||-1,degree:a.degree,shadow:a.shadow,threshold:a.threshold||0,convert:a.convert||!1,calculate_kw:a.calculate_kw||!1,decimal_places:a.decimal_places||0,url:a.url||"",frame:a.frame||"_overlay",fill_value:a.fill_value||"",fill_type:a.fill_type||-1,fill_max:a.fill_max||"",subtract:a.subtract||"[-1]"})}),Object.entries(configuration.defs).forEach(t=>{let[e,a]=t;addElement({format:a.type,id:a.id,connPoint1:a.startSlot,connPoint2:a.endSlot,d:a.d})}),Object.entries(configuration.lines).forEach(t=>{let[e,a]=t;addElement({format:a.type,id:a.id,href:a.href,color:a.color,shadow:a.shadow})}),Object.entries(configuration.animations).forEach(t=>{let[e,a]=t;addElement({format:a.type,id:a.id,href:a.href,color:a.color,source:a.source,animation_properties:a.animation_properties||"positive",threshold:a.threshold||0,dots:a.dots||0,duration:a.duration||0,power:a.power||0,animation_type:a.animation_type||-1})}),configuration.hasOwnProperty("datasources")){for(var e of Object.keys(configuration.datasources)){let a=configuration.datasources[e];a&&addDataSourceRow(e,a.source,a.alias)}$(".data-table th:eq(0)").click()}displayMode&&($("#svg_display").attr({viewBox:"0 0 "+configuration.basic.width+" "+configuration.basic.height}),$(".all_elements").removeClass("draggable draggable-group anim_element no_animation"),$(".type_animation").addClass("animation"),$("#config_link > a").attr("href","configuration.html?instance="+instance),!1==configuration.basic.enable_config_icon?$("#config_link").hide():$("#config_link").show(),$(".type_datasource").html("").attr("title",""),$("#overlay_frame").on("load",function(){""!=$(this).attr("src")&&($(".loading-spinner, #loading_text").fadeOut("fast"),$("#display_container").fadeIn("middle").css("display","block"))}),$(".connector").each(function(){$(this).data("url")&&($(this).css({"pointer-events":"all",cursor:"pointer"}),$(this).click(function(){switch($(this).data("frame")){case"_blank":case"_self":var t=window.open($(this).data("url"),$(this).data("frame"));t?t.focus():failedMessage("You need to allow opening URL's for this Website!");break;case"_overlay":displayLoading("Loading site for element"),$("#overlay_frame").attr("src",$(this).data("url"))}console.log("URL found! "+$(this).data("url")+"Frame: "+$(this).data("frame"))}))}),t?console.log("Applying config without re-adding socket listener!"):displayListener()),basicConfig||displayMode||successMessage("Layout configuration was loaded successfully!"),$("#loading").fadeOut("fast")}else successMessage("Basic configuration was loaded successfully!"),$("#loading").fadeOut("fast")}function updateLineAnimation(){$("#style_animation").empty().append(".line {stroke-width:"+configuration.line.stroke_width+"px; stroke:"+configuration.line.stroke+";}").append(".animation {stroke:"+configuration.animation.stroke+"; stroke-dasharray:"+configuration.animation.stroke_dasharray+";").append("stroke-width:"+configuration.animation.stroke_width+"px; animation-duration:"+configuration.animation.animation_duration+"ms;").append("stroke-linecap:"+configuration.animation.stroke_linecap+"; animation-timing-function:"+configuration.animation.animation_timing_function+";}"),displayMode&&$("#style_animation").append(".type_animation {display: none;}")}function linePreview(t){let e="",a=136,i=parseInt($("#animation_width").val()),o=parseInt($("#animation_dots").val()),r=parseInt($("#animation_distance").val()),s=parseInt($("#animation_length").val()),l=parseInt($("#line_size").val()),n=parseInt($("#animation_duration").val()),c=$("#animation_linecap").val(),d=$("#animation_type").val();for(let h=0;h<o;h++)r>0&&s>0&&(e+=s+" ",h!=o-1&&(e+=r+" ",a-=r),a-=s);o>0&&s>0&&r&&(e+=" "+a),a<0&&$("#"+t).val($("#"+t).val()-1),configuration.animation.stroke_dasharray=e,configuration.animation.stroke_width=i,configuration.animation.animation_duration=n,configuration.animation.stroke_linecap=c,configuration.animation.animation_timing_function=d,configuration.line.stroke_width=l,configuration.animation_configuration.dots=o,configuration.animation_configuration.distance=r,configuration.animation_configuration.length=s,updateLineAnimation()}function successMessage(t){$("#message_success").html(t),$("#message_success").fadeIn("middle").delay(2e3).fadeOut("middle")}function failedMessage(t){$("#message_failed").html(t),$("#message_failed").fadeIn("middle").delay(2e3).fadeOut("middle")}function getRotationDegrees(t){var e=t.css("-webkit-transform")||t.css("-moz-transform")||t.css("-ms-transform")||t.css("-o-transform")||t.css("transform");if("none"!==e)var a=e.split("(")[1].split(")")[0].split(","),i=a[0],o=Math.round(Math.atan2(a[1],i)*(180/Math.PI));else var o=0;return o}function resizeSVG(){$("#svg_config").attr({width:$("#svg_width_value").val(),height:$("#svg_height_value").val(),viewBox:"0 0 "+$("#svg_width_value").val()+" "+$("#svg_height_value").val()})}function getCoords(t){let e,a,i,o,r,s,l,n,c;return i=null!=$(t="#"+t).attr("r")?parseInt($(t).attr("r")):0,e=null!=$(t).attr("x")?parseInt($(t).attr("x")):parseInt($(t).attr("cx"))-i,a=null!=$(t).attr("y")?parseInt($(t).attr("y")):parseInt($(t).attr("cy"))-i,n=null!=$(t).attr("cx")?parseInt($(t).attr("cx")):0,c=null!=$(t).attr("cy")?parseInt($(t).attr("cy")):0,o=null!=$(t).attr("width")?parseInt($(t).attr("width")):2*i,r=null!=$(t).attr("height")?parseInt($(t).attr("height")):2*i,s=parseInt($(t).css("stroke-width")),"text"===$(t).prop("tagName")&&(o=Math.round(document.getElementById(t.replace("#","")).getComputedTextLength()),r=parseInt($(t).css("font-size")),e=Math.round(e-Math.floor(o/2)),a=Math.round(a-Math.floor(r/2))),{x:e,y:a,cx:n,cy:c,width:o,height:r,r:i,stroke:s,slot:l}}function showConnectionPoints(t=!0){t?($("#connection_points").empty(),$(".connector").each(function(){let t=$(this).attr("id"),e={};e[t]={};let a=$(this).prop("tagName"),i,o,r,s,l,n,c;switch(a){case"circle":i=parseInt(2*$(this).attr("r")),o=parseInt(2*$(this).attr("r")),r=parseInt($(this).attr("cx")-o/2),s=parseInt($(this).attr("cy")-i/2),l=parseInt($(this).attr("r")),n=parseInt($(this).attr("cx")),c=parseInt($(this).attr("cy")),e[t].top_left={x:n+l*Math.cos(connectorAngle(340)),y:c+l*Math.sin(connectorAngle(340))},e[t].top_right={x:n+l*Math.cos(connectorAngle(20)),y:c+l*Math.sin(connectorAngle(20))},e[t].right_top={x:n+l*Math.cos(connectorAngle(70)),y:c+l*Math.sin(connectorAngle(70))},e[t].right_bottom={x:n+l*Math.cos(connectorAngle(110)),y:c+l*Math.sin(connectorAngle(110))},e[t].bottom_left={x:n+l*Math.cos(connectorAngle(200)),y:c+l*Math.sin(connectorAngle(200))},e[t].bottom_right={x:n+l*Math.cos(connectorAngle(160)),y:c+l*Math.sin(connectorAngle(160))},e[t].left_bottom={x:n+l*Math.cos(connectorAngle(250)),y:c+l*Math.sin(connectorAngle(250))},e[t].left_top={x:n+l*Math.cos(connectorAngle(290)),y:c+l*Math.sin(connectorAngle(290))};break;case"rect":i=parseInt($(this).attr("height")),o=parseInt($(this).attr("width")),r=parseInt($(this).attr("x")),s=parseInt($(this).attr("y")),e[t].top_left={x:r+o/2-20,y:s},e[t].top_right={x:r+o/2+20,y:s},e[t].left_top={x:r,y:s+i/2-20},e[t].left_bottom={x:r,y:s+i/2+20},e[t].right_top={x:r+o,y:s+i/2-20},e[t].right_bottom={x:r+o,y:s+i/2+20},e[t].bottom_left={x:r+o/2-20,y:s+i},e[t].bottom_right={x:r+o/2+20,y:s+i}}e[t].top={x:r+o/2,y:s},e[t].left={x:r,y:s+i/2},e[t].right={x:r+o,y:s+i/2},e[t].bottom={x:r+o/2,y:s+i},Object.entries(e).forEach(e=>{let[a,i]=e;Object.entries(i).forEach(e=>{let[a,i]=e,o=document.createElementNS("http://www.w3.org/2000/svg","circle");o.setAttribute("class","tmp_conn_points"),o.setAttribute("cx",i.x),o.setAttribute("cy",i.y),o.setAttribute("r",5),o.setAttribute("class","connPoints clickable"),o.setAttribute("data-slot",a),o.setAttribute("data-element",t),$(o).appendTo("#connection_points")})})})):$("#connection_points").empty()}function addAnimation(t){if(0===$("#anim_"+t).length){$("#anim_"+t).remove();let e=document.createElementNS("http://www.w3.org/2000/svg","use"),a="type_animation all_elements anim_element";$("#enable_animation").is(":checked")?a+=" animation":a+=" no_animation",e.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href","#"+t),e.setAttribute("class",a),e.setAttribute("id","anim_"+t),e.setAttribute("data-source","-1"),e.setAttribute("data-animation_properties","positive"),e.setAttribute("data-threshold","0"),e.setAttribute("style","stroke: "+configuration.animation.stroke+";"),$(e).appendTo("#placeholder_animations"),$(".anim_element").off().click(function(t){showConfigBar(t.target.id,t.target.tagName.toLowerCase())})}}function getSlots(t){let e={},a={},i={},o={};return e.x=t.x+Math.floor(t.width/2),e.y=t.y-Math.floor(t.stroke/2),e.direction="vertical",a.x=t.x+t.width+Math.floor(t.stroke/2),a.y=t.y+Math.floor(t.height/2),a.direction="horizontal",i.x=t.x+t.width/2,i.y=t.y+t.height+Math.floor(t.stroke/2),i.direction="vertical",o.x=t.x-Math.floor(t.stroke/2),o.y=t.y+Math.floor(t.height/2),o.direction="horizontal",{top:e,right:a,bottom:i,left:o}}function connectorAngle(t){return(t-90)*Math.PI/180}function getSpecialSlots(t,e){let a=[];return a.top={x:t.x+t.width/2,y:t.y-t.stroke/2,direction:"vertical"},a.left={x:t.x-t.stroke/2,y:t.y+t.height/2,direction:"horizontal"},a.right={x:t.x+t.width+t.stroke/2,y:t.y+t.height/2,direction:"horizontal"},a.bottom={x:t.x+t.width/2,y:t.y+t.height+t.stroke/2,direction:"vertical"},t.r>0?(a.top_left={x:t.cx+t.r*Math.cos(connectorAngle(340)),y:t.cy+t.r*Math.sin(connectorAngle(340))-t.stroke/2,direction:"vertical"},a.top_right={x:t.cx+t.r*Math.cos(connectorAngle(20)),y:t.cy+t.r*Math.sin(connectorAngle(20))-t.stroke/2,direction:"vertical"},a.right_top={x:t.cx+t.r*Math.cos(connectorAngle(70))+t.stroke/2,y:t.cy+t.r*Math.sin(connectorAngle(70)),direction:"horizontal"},a.right_bottom={x:t.cx+t.r*Math.cos(connectorAngle(110))+t.stroke/2,y:t.cy+t.r*Math.sin(connectorAngle(110)),direction:"horizontal"},a.bottom_left={x:t.cx+t.r*Math.cos(connectorAngle(200)),y:t.cy+t.r*Math.sin(connectorAngle(200))+t.stroke/2,direction:"vertical"},a.bottom_right={x:t.cx+t.r*Math.cos(connectorAngle(160)),y:t.cy+t.r*Math.sin(connectorAngle(160))+t.stroke/2,direction:"vertical"},a.left_bottom={x:t.cx+t.r*Math.cos(connectorAngle(250))-t.stroke/2,y:t.cy+t.r*Math.sin(connectorAngle(250)),direction:"horizontal"},a.left_top={x:t.cx+t.r*Math.cos(connectorAngle(290))-t.stroke/2,y:t.cy+t.r*Math.sin(connectorAngle(290)),direction:"horizontal"}):(a.top_left={x:t.x+t.width/2-20,y:t.y-t.stroke/2,direction:"vertical"},a.top_right={x:t.x+t.width/2+20,y:t.y-t.stroke/2,direction:"vertical"},a.right_top={x:t.x+t.width+t.stroke/2,y:t.y+t.height/2-20,direction:"horizontal"},a.right_bottom={x:t.x+t.width+t.stroke/2,y:t.y+t.height/2+20,direction:"horizontal"},a.bottom_left={x:t.x+t.width/2-20,y:t.y+t.height+t.stroke/2,direction:"vertical"},a.bottom_right={x:t.x+t.width/2+20,y:t.y+t.height+t.stroke/2,direction:"vertical"},a.left_top={x:t.x-t.stroke/2,y:t.y+t.height/2-20,direction:"horizontal"},a.left_bottom={x:t.x-t.stroke/2,y:t.y+t.height/2+20,direction:"horizontal"}),{spec:a[e]}}function getDistance(t,e){let a=0,i=0;return a=e.x>t.x?e.x-t.x:t.x-e.x,a*=a,i=e.y>t.y?e.y-t.y:t.y-e.y,Math.sqrt(a+(i*=i))}function connectElements(t,e,a){let i=getCoords(e),o=getCoords(a),r,s,l,n;r=$("#"+t).data("start-slot"),s=$("#"+t).data("end-slot");let c=[],d=[],h=[],f=[],m=[],u=[],g=[];for(var p of(l="undefined"!==r?getSpecialSlots(i,r):getSlots(i),n="undefined"!==s?getSpecialSlots(o,s):getSlots(o),Object.keys(l))){let y=l[p];for(var p of Object.keys(n)){let b=n[p];c.push(getDistance(y,b)),d.push(y.x),f.push(y.y),u.push(y.direction),h.push(b.x),m.push(b.y),g.push(b.direction)}}let v=c[0],x=0;for(var w=1;w<c.length;w++)c[w]<v&&(v=c[w],x=w);let k=d[x],A=f[x],C;drawPath(t,k,A,h[x],m[x],u[x],g[x])}function polarToCartesian(t,e,a,i){var o=(i-90)*Math.PI/180;return{x:t+a*Math.cos(o),y:e+a*Math.sin(o)}}function describeArc(t,e,a,i,o,r){var s=polarToCartesian(t,e,a,o);return polarToCartesian(t,e,a,i),["A",a,a,0,o-i<=180?"0":"1",r,s.x,s.y]}function drawPath(t,e,a,i,o,r,s,l=15){let n={x:0,y:0},c=[],d=e>i?e-i:i-e,h=a>o?a-o:o-a;d<2*l&&(l=Math.floor(d/2)),h<2*l&&(l=Math.floor(h/2));let f=i>e?parseInt(i-e):parseInt(e-i),m=parseInt(o-a);c[0]="M"+e+" "+a,n={x:e,y:a};let u;if(i>e){let g=e+.2*f;c[1]=" H "+g,n.x=g}if(i<e){let p=e-.2*f;c[1]=" H "+p,n.x=p}if(o==a&&(c[1]=" H "+i),i===e&&(c[1]=" V "+o),i!=e&&o!=a){if(o>a&&i>e){u=describeArc(n.x,n.y+l,l,0,90,1);let y=o-l;if(n={x:u[6],y:u[7]},c[2]=u.join(" "),c[3]=" V "+y,n.y=y,u=describeArc(n.x,n.y+l,l,0,90,0),c[4]=u.join(" "),c[5]=" H "+i,"vertical"==r&&"vertical"==s){n={x:e,y:a};let b=a+.2*m;c[1]=" V "+b,n.y=b,u=describeArc(n.x,n.y+l,l,0,90,0),b=i-l,n={x:u[6],y:u[7]},c[2]=u.join(" "),c[3]=" H "+b,n.x=b,n={x:(u=describeArc(n.x,n.y+l,l,0,90,1))[6],y:u[7]},c[4]=u.join(" "),c[5]=" V "+o}if("horizontal"==r&&"vertical"==s){n={x:e,y:a};let v=e+.2*f;c[1]=" H "+v,n.x=v,v=i-l,c[2]="",c[3]=" H "+v,n.x=v,n={x:(u=describeArc(n.x,n.y+l,l,0,90,1))[6],y:u[7]},c[4]=u.join(" "),c[5]=" V "+o}if("vertical"==r&&"horizontal"==s){let x=a+.2*m;n={x:e,y:x},c[1]=" V "+x,x=o-l,n.y=x,c[2]="",c[3]=" V "+x,u=describeArc(n.x,n.y+l,l,0,90,0),c[4]=u.join(" "),c[5]=" H "+i}}if(o>a&&i<e){u=describeArc(n.x,n.y+l,l,180,270,0);let w=o-l;if(n={x:u[6],y:w},c[2]=u.join(" "),c[3]=" V "+w,u=describeArc(n.x,n.y+l,l,180,270,1),c[4]=u.join(" "),c[5]=" H "+i,"vertical"==r&&"vertical"==s){let k=a+.2*m;n={x:e,y:k},c[1]=" V "+k,u=describeArc(n.x-l,n.y,l,90,180,1),n={x:k=i+l,y:u[7]},c[2]=u.join(" "),c[3]=" H "+k,u=describeArc(n.x,n.y+l,l,180,270,0),c[4]=u.join(" "),c[5]=" V "+o}if("vertical"==r&&"horizontal"==s){let A=a+.2*m;n={x:e,y:A},c[1]=" V "+A,A=o-l,n.y=A,c[2]="",c[3]=" V "+A,u=describeArc(n.x,n.y+l,l,180,270,1),c[4]=u.join(" "),c[5]=" H "+i}if("horizontal"==r&&"vertical"==s){n={x:e,y:a};let C=e-.2*f;c[1]=" H "+C,n.x=C,C=i+l,c[2]="",c[3]=" H "+C,n.x=C,n={x:(u=describeArc(n.x,n.y+l,l,180,270,0))[6],y:u[7]},c[4]=u.join(" "),c[5]=" V "+o}}if(o<a&&i>e){u=describeArc(n.x,n.y-l,l,0,90,0);let S=o+l;if(n={x:u[6],y:S},c[2]=u.join(" "),c[3]=" V "+S,u=describeArc(n.x+l,n.y,l,270,360,1),c[4]=u.join(" "),c[5]=" H "+i,"vertical"==r&&"horizontal"==s){let L=a+.2*m;n={x:e,y:L},c[1]=" V "+L,L=o+l,n.y=L,c[2]="",c[3]=" V "+L,u=describeArc(n.x,n.y-l,l,0,90,1),c[4]=u.join(" "),c[5]=" H "+i}if("vertical"==r&&"vertical"==s){let E=a+.2*m;n={x:e,y:E},c[1]=" V "+E,u=describeArc(n.x,n.y-l,l,0,90,1),n={x:E=i-l,y:u[7]},c[2]=u.join(" "),c[3]=" H "+E,u=describeArc(n.x,n.y-l,l,0,90,0),c[4]=u.join(" "),c[5]=" V "+o}if("horizontal"==r&&"vertical"==s){n={x:e,y:a};let j=e+.2*f;c[1]=" H "+j,n.x=j,j=i-l,c[2]="",c[3]=" H "+j,n.x=j,n={x:(u=describeArc(n.x,n.y-l,l,0,90,0))[6],y:u[7]},c[4]=u.join(" "),c[5]=" V "+o}}if(o<a&&i<e){u=describeArc(n.x,n.y-l,l,180,270,1);let z=o+l;if(n={x:u[6],y:z},c[2]=u.join(" "),c[3]=" V "+z,u=describeArc(n.x-2*l,n.y-l,l,0,90,0),c[4]=u.join(" "),c[5]=" H "+i,"vertical"==r&&"horizontal"==s){let D=a+.2*m;n={x:e,y:D},c[1]=" V "+D,c[2]="",D=o+l,n.y=D,u=describeArc(n.x-2*l,n.y-l,l,0,90,0),c[4]=u.join(" "),c[5]=" H "+i}if("vertical"==r&&"vertical"==s){let I=a+.2*m;n={x:e,y:I},c[1]=" V "+I,u=describeArc(n.x-2*l,n.y-l,l,0,90,0),n={x:I=i+l,y:u[7]},c[2]=u.join(" "),c[3]=" H "+I,u=describeArc(n.x,n.y-l,l,180,270,1),c[4]=u.join(" "),c[5]="  V "+o}if("horizontal"==r&&"vertical"==s){n={x:e,y:a};let N=e-.2*f;c[1]=" H "+N,n.x=N,N=i+l,c[2]="",c[3]=" H "+N,n.x=N,n={x:(u=describeArc(n.x,n.y-l,l,180,270,1))[6],y:u[7]},c[4]=u.join(" "),c[5]=" V "+o}}}addAnimation(t),$("#"+t).attr("d",c.join(" "))}function getShadowColor(t){let e=$("#"+t).css("filter").replace("drop-shadow(","").split(" ");return"none"!=e[0]?e[0]+e[1]+e[2]+e[3]:""}function showConfigBar(t,e){$("#tab1_config").prop("checked",!0);let a=$("#"+t).data("type")?$("#"+t).data("type"):"";getElements("elm_select",t),$("#description_elm").text(t),$("#description_type").text(e+" "+a);let i,o=getShadowColor(i="use"==e?t.replace("anim","line"):t);switch($("#elm_shadow").prop("checked",""!=o),$("#elm_calculation").prop("checked",!1),$("#elm_convert").prop("checked",!1),restore={},$(".elm_config").attr("style",""),$(".all_elements").addClass("faded_out"),$("#"+t).removeClass("faded_out"),$(".elm_config").prop("disabled",!1),restore.id=$("#"+t).attr("id"),$(".elm_config_circle, .elm_config_text, .elm_config_rect, .elm_config_use, .elm_config_datasource, .elm_config_svg, .anim_type_duration, .anim_type_dots, .fill_type").hide(),restore.shadow_color=o,$("#elm_shadow_color")[0].jscolor.fromString(restore.shadow_color),restore.color="none"==$("#"+t).css("stroke")?"":$("#"+t).css("stroke"),$("#elm_color")[0].jscolor.fromString(restore.color),e){case"rect":$(".elm_config_rect").show(),restore.width=$("#"+t).attr("width"),$("#elm_width").val(restore.width),restore.height=$("#"+t).attr("height"),$("#elm_height").val(restore.height),restore.pos_x=$("#"+t).attr("x"),$("#elm_pos_x").val(restore.pos_x),restore.pos_y=$("#"+t).attr("y"),$("#elm_pos_y").val(restore.pos_y),restore.rx=$("#"+t).attr("rx"),$("#elm_rx").val(restore.rx),restore.fill="none"==$("#"+t).css("fill")||$("#"+t).css("fill").includes("url")?"":$("#"+t).css("fill"),$("#elm_fill")[0].jscolor.fromString(restore.fill),restore.stroke=$("#"+t).css("stroke-width").replace("px",""),$("#elm_stroke").val(restore.stroke),restore.url=$("#"+t).data("url"),$("#elm_url").val(restore.url),restore.frame=$("#"+t).data("frame"),$("#elm_frame").val(restore.frame),restore.fill_value=""==$("#"+t).data("fill_value")?"":$("#"+t).data("fill_value"),$("#elm_fill_value")[0].jscolor.fromString(restore.fill_value),restore.fill_type=$("#"+t).data("fill_type"),$("#elm_fill_type").val(restore.fill_type),-1!=restore.fill_type&&$(".fill_type").show(),restore.fill_max=$("#"+t).data("fill_max"),$("#elm_fill_max").val(restore.fill_max),restore.source=$("#"+t).data("source"),getDataSources("elm_source",restore.source);break;case"circle":$(".elm_config_circle").show(),restore.radius=$("#"+t).attr("r"),$("#elm_radius").val(restore.radius),restore.pos_x=$("#"+t).attr("cx"),$("#elm_pos_x").val(restore.pos_x),restore.pos_y=$("#"+t).attr("cy"),$("#elm_pos_y").val(restore.pos_y),restore.fill="none"==$("#"+t).css("fill")||$("#"+t).css("fill").includes("url")?"":$("#"+t).css("fill"),$("#elm_fill")[0].jscolor.fromString(restore.fill),restore.stroke=$("#"+t).css("stroke-width").replace("px",""),$("#elm_stroke").val(restore.stroke),restore.url=$("#"+t).data("url"),$("#elm_url").val(restore.url),restore.frame=$("#"+t).data("frame"),$("#elm_frame").val(restore.frame),restore.fill_value=""==$("#"+t).data("fill_value")?"":$("#"+t).data("fill_value"),$("#elm_fill_value")[0].jscolor.fromString(restore.fill_value),restore.fill_type=$("#"+t).data("fill_type"),$("#elm_fill_type").val(restore.fill_type),-1!=restore.fill_type&&$(".fill_type").show(),restore.fill_max=$("#"+t).data("fill_max"),$("#elm_fill_max").val(restore.fill_max),restore.source=$("#"+t).data("source"),getDataSources("elm_source",restore.source,!0);break;case"text":$(".elm_config_text").show(),$(".elm_config_text_not_ds").show(),"datasource"==a&&(restore.unit=$("#"+t).data("unit"),$("#elm_unit").val(restore.unit),restore.source=$("#"+t).data("source"),getDataSources("elm_source",restore.source,!0),restore.source_option=$("#"+t).data("source_option"),$("#elm_source_option").val(restore.source_option),restore.calculate_kw=$("#"+t).data("calculate_kw"),$("#elm_calculation").prop("checked",!0===restore.calculate_kw),restore.convert=$("#"+t).data("convert"),$("#elm_convert").prop("checked",!0===restore.convert),restore.threshold=$("#"+t).data("threshold"),$("#elm_threshold").val(restore.threshold),restore.decimal_places=$("#"+t).data("decimal_places"),$("#elm_decimal_places").val(restore.decimal_places),$(".elm_config_datasource").show(),$(".elm_config_text_not_ds").hide(),restore.subtract=$("#"+t).data("subtract"),getDataSources("elm_subtract",restore.subtract,!1),$("#elm_subtract").multiselect("unload"),$("#elm_subtract").multiselect({columns:1,search:!0,minWidth:250,maxWidth:300,maxPlaceholderOpts:1,texts:{placeholder:"Select Source"}})),restore.pos_x=$("#"+t).attr("x"),$("#elm_pos_x").val(restore.pos_x),restore.pos_y=$("#"+t).attr("y"),$("#elm_pos_y").val(restore.pos_y),restore.fill="none"==$("#"+t).css("fill")?"":$("#"+t).css("fill"),$("#elm_fill")[0].jscolor.fromString(restore.fill),restore.text=$("#"+t).html(),$("#elm_text").val(restore.text),restore.font=$("#"+t).css("font-family"),$("#elm_font").val(restore.font),restore.degree=getRotationDegrees($("#"+t)),restore.font_size=$("#"+t).css("font-size").replace("px",""),$("#elm_font_size").val(restore.font_size);break;case"use":let r=t.replace("anim","line");restore.source=$("#"+t).data("source"),getDataSources("elm_animation",restore.source),restore.animation_properties=$("#"+t).data("animation_properties"),$("#elm_animation_properties").val(restore.animation_properties),restore.threshold=$("#"+t).data("threshold"),$("#elm_threshold").val(restore.threshold),$(".elm_config_use").show(),$("#"+r).removeClass("faded_out"),restore.line_color=$("#"+r).css("stroke"),$("#elm_line_color")[0].jscolor.fromString(restore.line_color),restore.startSlot=$("#"+t.replace("anim_","")).data("start-slot"),restore.endSlot=$("#"+t.replace("anim_","")).data("end-slot"),restore.elm_dots=$("#"+t).data("dots"),$("#elm_dots").val(restore.elm_dots),restore.elm_duration=$("#"+t).data("duration"),$("#elm_duration").val(restore.elm_duration),restore.elm_power=$("#"+t).data("power"),$("#elm_power").val(restore.elm_power),restore.elm_animation_type=$("#"+t).data("animation_type"),$("#elm_animation_type").val(restore.elm_animation_type),$(".anim_type_"+restore.elm_animation_type).show();break;case"svg":$(".elm_config_svg").show(),restore.width=$("#"+t).attr("width"),$("#elm_width").val(restore.width),restore.elm_height=$("#"+t).attr("height"),$("#elm_height").val(restore.elm_height),restore.pos_x=$("#"+t).attr("x"),$("#elm_pos_x").val(restore.pos_x),restore.pos_y=$("#"+t).attr("y"),$("#elm_pos_y").val(restore.pos_y),restore.icon=$("#"+t).data("icon"),$("#elm_icon").val(restore.icon),restore.color=$("#"+t).css("color"),$("#elm_color")[0].jscolor.fromString(restore.color),restore.fill="none"==$("#"+t).css("fill")?"":$("#"+t).css("fill"),$("#elm_fill")[0].jscolor.fromString(restore.fill)}function s(e){let a=document.createElementNS("http://www.w3.org/2000/svg","symbol");a.setAttribute("x",$("#"+t).attr("x")),a.setAttribute("y",$("#"+t).attr("y")),a.setAttribute("data-width",$("#"+t).attr("width")),a.setAttribute("data-height",$("#"+t).attr("height")),a.setAttribute("data-icon",e),a.setAttribute("class","iconify type_icon all_elements added_elements draggable draggable-group"),a.setAttribute("id",restore.id),a.setAttribute("style","color: "+restore.color+";"),$("#"+t).remove(),$(a).appendTo("#placeholder_icons")}$("#config_bar").addClass("show"),$(".elm_config").off().on("input change",function(a){globalConfigChanged=!0;let i=$("#elm_fill").val()?$("#elm_fill").val():"none";"elm_shadow"==a.target.id&&""==$("#elm_shadow_color").val()&&$("#elm_shadow_color")[0].jscolor.fromString("rgba(0, 0, 0, 0.7)"),"elm_shadow_color"==a.target.id&&$("#elm_shadow").prop("checked",!0),"elm_animation_type"==a.target.id&&("dots"==$(this).val()?($(".anim_type_duration").hide(),$(".anim_type_dots").show()):"duration"==$(this).val()?($(".anim_type_dots").hide(),$(".anim_type_duration").show()):$(".anim_type_duration, .anim_type_dots").hide()),"elm_fill_type"==a.target.id&&(-1==$(this).val()?$(".fill_type").hide():$(".fill_type").show());let o="drop-shadow(0px 3px 3px "+$("#elm_shadow_color").val()+")",r=$("path[id*="+restore.id+"]");r.length>0&&r.each(function(t){let e=r[t].id.split("_");connectElements(r[t].id,e[1],e[2])});let s=parseInt($("#svg_config").attr("height")),l=parseInt($("#svg_config").attr("width")),n=parseInt($("#elm_radius").val()),c=parseInt($("#elm_stroke").val())/2,d=parseInt($("#elm_font_size").val()),h,f;switch(e){case"rect":h=l-$("#elm_width").val()-c,f=s-$("#elm_height").val()-c,$("#elm_pos_x").val()-c>=0&&$("#elm_pos_x").val()<=h&&$("#elm_pos_y").val()-c>=0&&$("#elm_pos_y").val()<=f?$("#"+t).attr({width:$("#elm_width").val(),height:$("#elm_height").val(),rx:$("#elm_rx").val(),x:$("#elm_pos_x").val(),y:$("#elm_pos_y").val()}):$(this).val()>c?$("#"+a.target.id).val($(this).val()-1):$("#"+a.target.id).val(c),$("#"+t).data({frame:$("#elm_frame").val(),url:$("#elm_url").val(),fill_value:$("#elm_fill_value").val(),fill_type:$("#elm_fill_type").val(),source:$("#elm_source").val(),fill_max:$("#elm_fill_max").val()}),$("#"+t).css({"stroke-width":$("#elm_stroke").val()+"px",stroke:$("#elm_color").val(),fill:i}),$("#elm_shadow").is(":checked")?$("#"+t).css({filter:o}):$("#"+t).css({filter:""});break;case"circle":h=l-n-c,f=s-n-c,$("#elm_pos_x").val()-c-n>=0&&$("#elm_pos_y").val()-c-n>=0&&$("#elm_pos_x").val()<=h&&$("#elm_pos_y").val()-c>=0&&$("#elm_pos_y").val()<=f?$("#"+t).attr({r:$("#elm_radius").val(),cx:$("#elm_pos_x").val(),cy:$("#elm_pos_y").val()}):$("#elm_pos_x").val()-c-n<0||$("#elm_pos_y").val()-c-n<0?$("#"+a.target.id).val(parseInt($(this).val())+1):$("#"+a.target.id).val(parseInt($(this).val())-1),$("#"+t).data({frame:$("#elm_frame").val(),url:$("#elm_url").val(),fill_value:$("#elm_fill_value").val(),fill_type:$("#elm_fill_type").val(),source:$("#elm_source").val(),fill_max:$("#elm_fill_max").val()}),$("#"+t).css({"stroke-width":$("#elm_stroke").val()+"px",stroke:$("#elm_color").val(),fill:i}),$("#elm_shadow").is(":checked")?$("#"+t).css({filter:o}):$("#"+t).css({filter:""});break;case"text":h=l-$("#elm_font_size").val(),f=s-$("#elm_font_size").val()/2,$("#elm_pos_x").val()-d>=0&&$("#elm_pos_x").val()<=h&&$("#elm_pos_y").val()-d/2>=0&&$("#elm_pos_y").val()<=f?$("#"+t).attr({x:$("#elm_pos_x").val(),y:$("#elm_pos_y").val()}):$("#elm_pos_x").val()-d<0||$("#elm_pos_y").val()-d/2<0?$("#"+a.target.id).val(parseInt($(this).val())+1):$("#"+a.target.id).val(parseInt($(this).val())-1),$("#"+t).html($("#elm_text").val()),$("#"+t).data({unit:$("#elm_unit").val(),source:$("#elm_source").val(),source_option:$("#elm_source_option").val(),threshold:$("#elm_threshold").val(),decimal_places:$("#elm_decimal_places").val(),calculate_kw:$("#elm_calculation").prop("checked"),convert:$("#elm_convert").prop("checked"),subtract:$("#elm_subtract").val()}),$("#"+t).css({"font-family":$("#elm_font").val(),"font-size":$("#elm_font_size").val()+"px",stroke:$("#elm_color").val(),fill:i}),$("#elm_shadow").is(":checked")?$("#"+t).css({filter:o}):$("#"+t).css({filter:""});break;case"use":let m=t.replace("anim","line");$("#"+t).data({threshold:$("#elm_threshold").val(),source:$("#elm_animation").val(),animation_properties:$("#elm_animation_properties").val(),dots:$("#elm_dots").val(),duration:$("#elm_duration").val(),power:$("#elm_power").val(),animation_type:$("#elm_animation_type").val()}),$("#"+t).css({stroke:$("#elm_color").val()}),$("#"+m).css({stroke:$("#elm_line_color").val()}),$("#elm_shadow").is(":checked")?$("#"+m).css({filter:o}):$("#"+m).css({filter:""});break;case"svg":$("#"+t).attr({width:$("#elm_width").val(),height:$("#elm_height").val(),x:$("#elm_pos_x").val(),y:$("#elm_pos_y").val()}),$("#"+t).css("color",$("#elm_color").val()),$("#elm_shadow").is(":checked")?$("#"+t).css({filter:o}):$("#"+t).css({filter:""})}}),$("#elm_icon").on("input",function(){$(this).autocomplete({position:{my:"right top",at:"right bottom"},source:function(t,e){$.ajax({minLength:1,url:"https://api.iconify.design/search?",type:"GET",data:{query:t.term},success:function(t){e($.map(t.icons,function(t){return{label:t}}))}})},select:function(t,e){return s(e.item.value),e.item.value}}).autocomplete("instance")._renderItem=function(t,e){return $("<li class='ui-menu-item'>").append("<div class='ui-menu-item-wrapper'><span class='iconify' data-width='24' data-icon='"+e.label+"'></span><span style='font-weight: normal; padding-left:10px;'>"+e.label+"</span></div>").appendTo(t)}}),$("#restore_element").off().click(function(){if(this.blur(),0===$("#"+t).length){let i=$("#elm_fill").val()?$("#elm_fill").val():"none";addElement({format:e,subType:a,id:restore.id,radius:$("#elm_radius").val(),width:$("#elm_width").val(),height:$("#elm_height").val(),rx:$("#elm_rx").val(),stroke:$("#elm_stroke").val(),pos_x:$("#elm_pos_x").val(),pos_y:$("#elm_pos_y").val(),color:$("#elm_color").val(),fill:i,icon:$("#elm_icon").val(),connPoint1:restore.startSlot,connPoint2:restore.endSlot,text:$("#elm_text").val(),font_size:$("#elm_font_size").val(),font_family:$("#elm_font").val(),unit:$("#elm_unit").val(),source:$("#elm_source").val(),source_option:$("#elm_source_option").val(),degree:restore.degree,shadow:$("#elm_shadow_color").val(),animation:$("#elm_animation").val(),animation_properties:$("#elm_animation_properties"),threshold:$("#elm_threshold").val(),calculate_kw:$("#elm_calculation").prop("checked"),convert:$("#elm_convert").prop("checked"),decimal_places:$("#elm_decimal_places").val(),url:$("#elm_url").val(),frame:$("#elm_frame").val(),fill_value:$("#elm_fill_value").val(),fill_type:$("#elm_fill_type").val(),fill_max:$("#elm_fill_max").val(),dots:$("#elm_dots").val(),duration:$("#elm_duration").val(),power:$("#elm_power").val(),animation_type:$("#elm_animation_type").val(),subtract:$("#elm_subtract").val()}),$("#"+t).length>0?(successMessage("Element restored!"),$(".elm_config").prop("disabled",!1)):(failedMessage("An Error occured, while restoring the Element!"),$(".elm_config").prop("disabled",!0))}else{Object.entries(restore).forEach(t=>{let[e,a]=t;$("#elm_"+e).val(a)});let o=restore.fill?restore.fill:"none",r="";switch(restore.shadow_color?(r="drop-shadow(0px 3px 3px "+restore.shadow_color+")",$("#elm_shadow").prop("checked",!0)):$("#elm_shadow").prop("checked",!1),$("#elm_color")[0].jscolor.fromString(restore.color?restore.color:""),$("#elm_fill")[0].jscolor.fromString(restore.elm_fill?restore.elm_fill:""),$("#elm_fill_value")[0].jscolor.fromString(restore.fill_value?restore.fill_value:""),$("#elm_line_color")[0].jscolor.fromString(restore.line_color?restore.line_color:""),$("#elm_shadow_color")[0].jscolor.fromString(restore.shadow_color?restore.shadow_color:""),e){case"rect":$("#"+t).attr({width:restore.width,height:restore.height,rx:restore.rx,x:restore.pos_x,y:restore.pos_y}),$("#"+t).data({url:restore.url,frame:restore.frame,fill_value:restore.fill_value,fill_type:restore.fill_type,fill_max:restore.fill_max,source:restore.source}),$("#"+restore.id).css({"stroke-width":restore.stroke+"px",stroke:restore.color,fill:o,filter:r});break;case"circle":$("#"+t).attr({r:restore.radius,cx:restore.pos_x,cy:restore.pos_y}),$("#"+t).data({url:restore.url,frame:restore.frame,fill_value:restore.fill_value,fill_type:restore.fill_type,fill_max:restore.fill_max,source:restore.source}),$("#"+restore.id).css({"stroke-width":restore.stroke+"px",stroke:restore.color,fill:o,filter:r});break;case"text":$("#"+t).attr({x:restore.pos_x,y:restore.pos_y}),$("#"+t).html(restore.text),$("#"+t).css({"font-family":restore.font,"font-size":restore.font_size+"px",stroke:restore.color,fill:o,"transform-box":"fill-box",transform:"rotate("+restore.degree+"deg)",filter:r}),"datasource"==a&&($("#elm_calculation").prop("checked",!0===restore.calculate_kw),$("#elm_convert").prop("checked",!0===restore.convert),$("#"+t).data({unit:restore.unit,source:restore.source,source_option:restore.source_option,calculate_kw:restore.calculate_kw,convert:restore.convert,threshold:restore.threshold,decimal_places:restore.decimal_places,subtract:restore.subtract}));break;case"use":let l=t.replace("anim","line");$("#"+t).data({animation:restore.animation,animation_properties:restore.animation_properties,dots:restore.elm_dots,duration:restore.elm_duration,power:restore.elm_power,animation_type:restore.elm_animation_type}),$("#"+t).css({stroke:restore.color}),$("#"+l).css({stroke:restore.line_color,filter:r});break;case"svg":s(restore.icon),$("#"+t).attr({width:restore.width,height:restore.height,x:restore.pos_x,y:restore.pos_y}),$("#"+t).css({color:restore.color,filter:r})}let n=$("path[id*="+restore.id+"]");n.length>0&&n.each(function(t){let e=n[t].id.split("_");connectElements(n[t].id,e[1],e[2])})}}),$("#delete_element").off().click(function(){if(this.blur(),$(".elm_config").prop("disabled",!0),"use"==e)$("#"+t.replace("anim","line")).remove(),$("#"+t.replace("anim_","")).remove(),$("#"+t).remove(),successMessage("Line deleted!");else{let a=$("[id^=line_path"),i=!0;a.each(function(){let t=this.id.split("_");if(restore.id==t[2]||restore.id==t[3])return i=!1,!1}),i?($("#"+t).remove(),successMessage("Element deleted!")):failedMessage("Element can not be deleted! Existing connection!")}}),$("#rotate_cw, #rotate_ccw").off().click(function(e){if($("#"+t).length>0){let a=!0==e.target.id?e.target.id:$(this).closest("a").attr("id"),i=getRotationDegrees($("#"+t));i+="rotate_cw"==a?45:-45,$("#"+t).css({"transform-box":"fill-box",transform:"rotate("+i+"deg)"})}else console.log("Element deleted! No dgree possible!")})}function hideConfigBar(){$(".all_elements").removeClass("faded_out"),$("#config_bar").removeClass("show").scrollTop(0),$(".elm_config").off().val(""),$("#tab1_config").prop("checked",!0),$("#elm_icon").hasClass("ui-autocomplete-input")&&$("#elm_icon").autocomplete("destroy")}function hideIframe(){$("#loading").fadeOut("fast",function(){$("#overlay_frame").attr("src",""),$("#display_container").hide()})}function addElement(t){let e="",a="all_elements added_elements draggable";switch(t.shadow&&(e=" filter: drop-shadow(0px 3px 3px "+t.shadow+");"),t.format){case"rect":let i=document.createElementNS("http://www.w3.org/2000/svg","rect");i.setAttribute("x",t.pos_x),i.setAttribute("y",t.pos_y),i.setAttribute("width",t.width),i.setAttribute("height",t.height),i.setAttribute("rx",t.rx),i.setAttribute("class",a+" type_rect connector"),i.setAttribute("data-url",t.url),i.setAttribute("data-frame",t.frame),i.setAttribute("data-fill_value",t.fill_value),i.setAttribute("data-fill_type",t.fill_type),i.setAttribute("data-fill_max",t.fill_max),i.setAttribute("data-source",t.source),i.setAttribute("id",t.id),i.setAttribute("style","stroke: "+t.color+"; stroke-width: "+t.stroke+"px; fill:"+t.fill+";"+e),$(i).appendTo("#placeholder_elements");break;case"circle":let o=document.createElementNS("http://www.w3.org/2000/svg","circle");o.setAttribute("cx",t.pos_x),o.setAttribute("cy",t.pos_y),o.setAttribute("r",t.radius),o.setAttribute("class",a+" type_circle connector"),o.setAttribute("data-url",t.url),o.setAttribute("data-frame",t.frame),o.setAttribute("data-fill_value",t.fill_value),o.setAttribute("data-fill_type",t.fill_type),o.setAttribute("data-fill_max",t.fill_max),o.setAttribute("data-source",t.source),o.setAttribute("id",t.id),o.setAttribute("style","stroke: "+t.color+"; stroke-width: "+t.stroke+"px; fill:"+t.fill+";"+e),$(o).appendTo("#placeholder_elements");break;case"text":let r=document.createElementNS("http://www.w3.org/2000/svg","text"),s="";t.degree&&(s=" transform-box: fill-box; transform: rotate("+t.degree+"deg)"),r.setAttribute("x",t.pos_x),r.setAttribute("y",t.pos_y),r.setAttribute("id",t.id),r.setAttribute("dominant-baseline","central"),r.setAttribute("style","stroke: "+t.color+"; fill: "+t.fill+"; font-family: "+t.font_family+"; font-size: "+t.font_size+"px;"+s+e),"datasource"==t.subType?(r.setAttribute("data-unit",t.unit),r.setAttribute("data-type","datasource"),r.setAttribute("class",a+" type_datasource"),r.setAttribute("data-source",t.source),r.setAttribute("data-source_option",t.source_option),r.setAttribute("data-threshold",t.threshold),r.setAttribute("data-calculate_kw",t.calculate_kw),r.setAttribute("data-convert",t.convert),r.setAttribute("data-decimal_places",t.decimal_places),r.setAttribute("data-subtract",JSON.stringify(t.subtract))):(r.setAttribute("data-type","text"),r.setAttribute("class",a+" type_text")),r.innerHTML=t.text,$(r).appendTo("#placeholder_text");break;case"svg":case"icon":let l=document.createElementNS("http://www.w3.org/2000/svg","symbol");l.setAttribute("x",t.pos_x),l.setAttribute("y",t.pos_y),l.setAttribute("class",a+" type_icon draggable-group iconify"),l.setAttribute("id",t.id),l.setAttribute("data-icon",t.icon),l.setAttribute("data-width",t.width),l.setAttribute("data-height",t.height),l.setAttribute("data-type","icon"),l.setAttribute("style","color: "+t.color+";"+e),$(l).appendTo("#placeholder_icons");break;case"use":let n=t.id.replace("anim_",""),c=n.split("_"),d=document.createElementNS("http://www.w3.org/2000/svg","path");d.setAttribute("id",n),d.setAttribute("class","type_def"),d.setAttribute("data-start-slot",t.connPoint1),d.setAttribute("data-end-slot",t.connPoint2),$(d).appendTo("#placeholder_defs"),addElement({format:"line",id:"line_"+n,color:configuration.line.stroke,href:"#"+n}),connectElements(n,c[1],c[2]);break;case"def":let h=document.createElementNS("http://www.w3.org/2000/svg","path");h.setAttribute("id",t.id),h.setAttribute("class","type_def"),h.setAttribute("data-start-slot",t.connPoint1),h.setAttribute("data-end-slot",t.connPoint2),h.setAttribute("d",t.d),$(h).appendTo("#placeholder_defs");break;case"line":let f=document.createElementNS("http://www.w3.org/2000/svg","use");f.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",t.href),f.setAttribute("id",t.id),f.setAttribute("class","line type_line all_elements"),f.setAttribute("style","stroke: "+t.color+";"+e),$(f).appendTo("#placeholder_lines");break;case"animation":a="type_animation all_elements anim_element",$("#enable_animation").prop("checked")?a+=" animation":a+=" no_animation";let m=document.createElementNS("http://www.w3.org/2000/svg","use");m.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",t.href),m.setAttribute("id",t.id),m.setAttribute("class",a),m.setAttribute("style","stroke: "+t.color+";"),m.setAttribute("data-source",t.source),m.setAttribute("data-animation_properties",t.animation_properties),m.setAttribute("data-threshold",t.threshold),m.setAttribute("data-dots",t.dots),m.setAttribute("data-duration",t.duration),m.setAttribute("data-power",t.power),m.setAttribute("data-animation_type",t.animation_type),$(m).appendTo("#placeholder_animations"),displayMode||$(".anim_element").off().click(function(t){showConfigBar(t.target.id,t.target.tagName.toLowerCase())})}}function getRandomInt(t){return Math.floor(Math.random()*t)}function getRandomRGBA(){var t=Math.round,e=Math.random;return"rgba("+t(255*e())+","+t(255*e())+","+t(255*e())+",1)"}function addDataSourceRow(t,e,a){$(".btn-cancel").trigger("click");let i=!0;if($(".data-table tbody tr").each(function(){if($("td:eq(1)",this).text().toLowerCase()==e.toLowerCase())return $(this).effect("highlight",{color:"lightgreen"},3e3),i=!1,!1}),i){if(-1==t){console.log("Need new Key!");let o=-1;$(".data-table tbody tr").each(function(){o=Math.max($(this).data("id"),o)}),o++,console.log("Found: "+o),t=o}let r="<tr data-source='"+e+"' data-alias='"+a+"' data-id='"+t+"'><td>"+a+"</td><td>"+e+"</td><td><button class='all_datasource ds_buttons btn-edit'><span class='iconify' data-height='24' data-icon='mdi:pencil'>Edit</span></button><button class='all_datasource ds_buttons btn-delete'><span class='iconify red_icon' data-height='24' data-icon='mdi:delete'>Delete</span></button></td></tr>";$(".data-table tbody").append(r),$(".data-table tbody").find("tr:last-child").hide().fadeIn("slow"),$("#ds_tmp_line").remove()}}function getdataSourceCellValue(t,e){return $(t).children("td").eq(e).text()}function dataSourceComparer(t){return function(e,a){var i=getdataSourceCellValue(e,t),o=getdataSourceCellValue(a,t);return $.isNumeric(i)&&$.isNumeric(o)?i-o:i.toString().localeCompare(o)}}function moveWithKey(t){$(document).off().on("keydown",function(t){switch(t.keyCode){case 39:$("#elm_pos_x").val(parseInt($("#elm_pos_x").val())+1).trigger("change");break;case 37:$("#elm_pos_x").val(parseInt($("#elm_pos_x").val())-1).trigger("change");break;case 38:$("#elm_pos_y").val(parseInt($("#elm_pos_y").val())-1).trigger("change");break;case 40:$("#elm_pos_y").val(parseInt($("#elm_pos_y").val())+1).trigger("change")}})}function makeDraggable(t){var e=t.target;function a(){$("#svg_preview").removeClass("noscroll")}function i(t){var a=e.getScreenCTM();return t.touches&&(t=t.touches[0]),{x:parseInt((t.clientX-a.e)/a.a),y:parseInt((t.clientY-a.f)/a.d)}}e.addEventListener("mousedown",f),e.addEventListener("touchstart",f),e.addEventListener("mousemove",m),e.addEventListener("touchmove",m),e.addEventListener("mouseup",u),e.addEventListener("touchend",u),e.addEventListener("touchleave",u),e.addEventListener("touchcancel",u),e.addEventListener("keydown",function t(e){$(".anim_element").removeClass("animation").addClass("no_animation"),hideConfigBar();let a=!1,i=!1;if(Object.keys(r).length>0)for(var o of(s=!0,globalConfigChanged=!0,$("#svg_preview").addClass("noscroll"),Object.keys(r))){let l=r[o],n=l.id,c=0,d=0;$("#"+n).addClass("dragging");let f={x:0,y:0};switch(e.keyCode){case 39:f.x=1;break;case 37:f.x=-1;break;case 38:f.y=-1;break;case 40:f.y=1}switch(l.type){case"circle":c=parseInt($("#"+n).attr("cx")),d=parseInt($("#"+n).attr("cy")),c+f.x-l.stroke_width>=l.circle_radius&&c+f.x<l.max.x&&!a?$("#"+n).attr("cx",c+f.x):a=!0,d+f.y-l.stroke_width>=l.circle_radius&&d+f.y<l.max.y&&!i?$("#"+n).attr("cy",d+f.y):i=!0;break;case"rect":c=parseInt($("#"+n).attr("x")),d=parseInt($("#"+n).attr("y")),c+f.x-l.stroke_width>=0&&c+f.x<l.max.x&&!a?$("#"+n).attr("x",c+f.x):a=!0,d+f.y-l.stroke_width>=0&&d+f.y<l.max.y&&!i?$("#"+n).attr("y",d+f.y):i=!0;break;case"text":c=parseInt($("#"+n).attr("x")),d=parseInt($("#"+n).attr("y")),c+f.x-l.font_size>0&&c+f.x<l.max.x&&!a?$("#"+n).attr("x",c+f.x):a=!0,d+f.y-l.font_size/2>0&&d+f.y<l.max.y&&!i?$("#"+n).attr("y",d+f.y):i=!0;break;case"svg":c=parseInt($("#"+n).attr("x")),d=parseInt($("#"+n).attr("y")),c+f.x>0&&c+f.x<l.max.x&&!a?$("#"+n).attr("x",c+f.x):a=!0,d+f.y>0&&d+f.y<l.max.y&&!i?$("#"+n).attr("y",d+f.y):i=!0}if(l.reconnect_elements)for(var m of l.reconnect_elements)connectElements(m.path,m.from,m.to)}else $(".draggable-multi, .draggable-multi-group").each(function(){r[this.id]={id:this.id,type:this.tagName}}),h(e,r)}),e.addEventListener("keyup",a);let o={},r={},s=!1,l=!1,n=!1,c=!1,d;function h(t,e){let a={},o=parseInt($("#svg_config").attr("height")),r=parseInt($("#svg_config").attr("width")),s;for(var l of Object.keys(e)){let n=e[l].id;s=$("path[id*="+n+"]");let c=[];s.length>0&&s.each(function(t){let e=s[t].id.split("_");c.push({path:s[t].id,from:e[1],to:e[2]})});let d=parseInt($("#"+n).css("strokeWidth"))/2,h=parseInt($("#"+n).attr("r")),f=$("#"+n).css("font-size").replace("px",""),m=i(t);switch(e[l].type){case"circle":a.x=r-h-d,a.y=o-h-d,m.x-=parseInt($("#"+n).attr("cx")),m.y-=parseInt($("#"+n).attr("cy"));break;case"rect":a.x=r-parseInt($("#"+n).attr("width"))-d,a.y=o-parseInt($("#"+n).attr("height"))-d,m.x-=parseInt($("#"+n).attr("x")),m.y-=parseInt($("#"+n).attr("y"));break;case"text":a.x=r-f,a.y=o-f/2,m.x-=parseInt($("#"+n).attr("x")),m.y-=parseInt($("#"+n).attr("y"));break;case"svg":a.x=r-parseInt($("#"+n).attr("width")),a.y=o-parseInt($("#"+n).attr("height")),m.x-=parseInt($("#"+n).attr("x")),m.y-=parseInt($("#"+n).attr("y"))}e[l].stroke_width=d,e[l].font_size=f,e[l].circle_radius=h,e[l].offset=m,e[l].max=a,e[l].reconnect_elements=c}}function f(t){if(t.target.classList.contains("draggable")&&(o[t.target.id]={id:t.target.id,type:t.target.tagName}),t.target.parentNode.classList.contains("draggable-group")&&(o[t.target.parentNode.id]={id:t.target.parentNode.id,type:t.target.parentNode.tagName}),(t.target.classList.contains("draggable-multi")||t.target.parentNode.classList.contains("draggable-multi-group"))&&$(".draggable-multi, .draggable-multi-group").each(function(){o[this.id]={id:this.id,type:this.tagName}}),t.target.classList.contains("lasso")&&(n=!0,d=i(t),$(".draggable-multi").removeClass("draggable-multi").addClass("draggable"),$(".draggable-multi-group").removeClass("draggable-multi-group").addClass("draggable draggable-group")),Object.keys(o).length>0){var e;s=!1,h(e=t,o)}}function m(t){if(n){o={},r={},l=!0;var e=i(t);if(c)$("#lasso_rect").attr({x:Math.min(d.x,e.x),y:Math.min(d.y,e.y),width:Math.abs(d.x-e.x),height:Math.abs(d.y-e.y)});else{let a=document.createElementNS("http://www.w3.org/2000/svg","rect");a.setAttribute("x",d.x),a.setAttribute("y",d.y),a.setAttribute("width",0),a.setAttribute("height",0),a.setAttribute("rx",0),a.setAttribute("id","lasso_rect"),a.setAttribute("style","stroke: var(--secondary); stroke-width: 2px; fill: var(--secondary); fill-opacity:0.2;"),$(a).appendTo("#placeholder_lasso"),c=!0}}if(Object.keys(o).length>0){$("#svg_preview").addClass("noscroll"),$(".anim_element").removeClass("animation").addClass("no_animation"),hideConfigBar();let h=!1,f=!1;for(var m of(s=!0,globalConfigChanged=!0,Object.keys(o))){let u=o[m],g=u.id;var e=i(t);switch($("#"+g).addClass("dragging"),u.type){case"circle":e.x-u.offset.x-u.stroke_width>=u.circle_radius&&e.x-u.offset.x<=u.max.x&&!h?$("#"+g).attr("cx",e.x-u.offset.x):h=!0,e.y-u.offset.y-u.stroke_width>=u.circle_radius&&e.y-u.offset.y<=u.max.y&&!f?$("#"+g).attr("cy",e.y-u.offset.y):f=!0;break;case"rect":e.x-u.offset.x-u.stroke_width>=0&&e.x-u.offset.x<=u.max.x&&!h?$("#"+g).attr("x",e.x-u.offset.x):h=!0,e.y-u.offset.y-u.stroke_width>=0&&e.y-u.offset.y<=u.max.y&&!f?$("#"+g).attr("y",e.y-u.offset.y):f=!0;break;case"text":e.x-u.offset.x-u.font_size>=0&&e.x-u.offset.x<=u.max.x&&!h?$("#"+g).attr("x",e.x-u.offset.x):h=!0,e.y-u.offset.y-u.font_size/2>=0&&e.y-u.offset.y<=u.max.y&&!f?$("#"+g).attr("y",e.y-u.offset.y):f=!0;break;case"svg":e.x-u.offset.x>=0&&e.x-u.offset.x<=u.max.x&&!h&&$("#"+g).attr("x",e.x-u.offset.x),e.y-u.offset.y>=0&&e.y-u.offset.y<=u.max.y&&!f&&$("#"+g).attr("y",e.y-u.offset.y)}if(console.log(h+f),u.reconnect_elements)for(var p of u.reconnect_elements)connectElements(p.path,p.from,p.to)}}}function u(t){let e=null;if(null!=n){if(n=null,c=!1,d=null,l){let i={start_x:parseInt($("#lasso_rect").attr("x")),start_y:parseInt($("#lasso_rect").attr("y")),end_x:parseInt($("#lasso_rect").attr("x"))+parseInt($("#lasso_rect").attr("width")),end_y:parseInt($("#lasso_rect").attr("y"))+parseInt($("#lasso_rect").attr("height"))};$(".added_elements").each(function(){let t=getCoords(this.id);t.x>i.start_x&&t.x+t.width<i.end_x&&t.y>i.start_y&&t.y+t.height<i.end_y&&($(this).closest("svg").hasClass("draggable-group")?$(this).closest("svg").removeClass("draggable-group draggable").addClass("draggable-multi-group"):$("#"+this.id).removeClass("draggable").addClass("draggable-multi"))}),a()}l=!1,$("#lasso_rect").remove()}if(Object.keys(o).length>0){if($(".added_elements").removeClass("dragging"),a(),e=setTimeout(function(){$("#enable_animation").prop("checked")&&$(".anim_element").removeClass("no_animation").addClass("animation")},1e3),!1===s){$(".draggable-multi").removeClass("draggable-multi").addClass("draggable"),$(".draggable-multi-group").removeClass("draggable-multi-group").addClass("draggable draggable-group");let h=Object.keys(o)[0];showConfigBar(h,o[h].type),$("#svg_config").on("click",".draggable",function(){$(this).attr("id"),setTimeout(function(){})})}r=o,o={}}}}$(function(){$(document).tooltip({position:{my:"center bottom-20",at:"center top",collision:"flipfit"},content:function(){return $(this).attr("title")}}),$("input:radio[name=tabs]").click(function(){hideConfigBar()}),$(".tt-element").click(function(){$(".ui-tooltip").fadeOut()}),$(".line_preview").change(function(){linePreview(this.id)}),$("#elm_select").on("change",function(){console.log("Changed to: "+$(this).val()+" Type: "+$("#"+$(this).val()).prop("tagName")),showConfigBar($(this).val(),$("#"+$(this).val()).prop("tagName"))}),$(".svg_size_value").on("input change",function(t){0>=$(this).val()&&""!=$(this).val()?$(this).val(1):($("#svg_width_slider").val($("#svg_width_value").val()),$("#svg_height_slider").val($("#svg_height_value").val()),resizeSVG())}),$(".svg_size_slider").on("input change",function(){$("#svg_height_value").val($("#svg_height_slider").val()),$("#svg_width_value").val($("#svg_width_slider").val()),resizeSVG()}),$(".align_elements").click(function(t){globalConfigChanged=!0,globalLastSteps={},$(".added_elements").removeClass("alignable").addClass("draggable"),$(".all_elements, .align_elements").removeClass("faded_out");let e=t.target.id,a,i;""==e&&(e=$(this).closest("a").attr("id")),$(".align_elements:not(#"+e+")").addClass("faded_out"),$("#align_elements, #undo_align_elements").show(),$("#all_undo_align_elements").css("display","inline-flex"),$("#connect_elements").prop("disabled",!0),hideConfigBar(),$(".all_elements").addClass("faded_out"),$(".added_elements").removeClass("draggable faded_out").addClass("alignable"),$(".type_icon").removeClass("draggable-group").addClass("alignable"),$("#ex_how_align").html("Now choose the reference element! <img src='img/icon_help.png' style='vertical-align: bottom;' title='You need to select a reference element for aligning. Afterwards, choose each element, which should be aligned the same.'>"),$(".alignable").off().click(function(t){let o=t.target.id;if(null==i)""==(o=t.target.id)&&(o=t.target.parentNode.id),a=getCoords(o),i=getSlots(a),$("#ex_how_align").html("Reference element selected. Choose each element now!");else{let r=t.target.tagName.toLowerCase();switch(""==(o=t.target.id)&&(o=t.target.parentNode.id,r=t.target.parentNode.tagName),globalLastSteps[o]={},e.replace("align_","")){case"center":switch(r){case"circle":globalLastSteps[o].cx=$("#"+o).attr("cx"),$("#"+o).attr("cx",i.top.x);break;case"rect":case"svg":globalLastSteps[o].x=$("#"+o).attr("x"),$("#"+o).attr("x",i.top.x-Math.floor(parseInt($(this).attr("width"))/2));break;case"text":globalLastSteps[o].x=$("#"+o).attr("x"),$("#"+o).attr("x",i.top.x)}break;case"left":switch(r){case"circle":globalLastSteps[o].cx=$("#"+o).attr("cx"),$("#"+o).attr("cx",i.left.x+parseInt($(this).attr("r"))+Math.floor(parseInt($(this).css("stroke-width"))/2));break;case"rect":case"svg":globalLastSteps[o].x=$("#"+o).attr("x"),$("#"+o).attr("x",i.left.x+Math.floor(parseInt($(this).css("stroke-width"))/2));break;case"text":globalLastSteps[o].x=$("#"+o).attr("x"),$("#"+o).attr("x",i.left.x+Math.floor(t.target.getComputedTextLength()/2))}break;case"right":switch(r){case"circle":globalLastSteps[o].cx=$("#"+o).attr("cx"),$("#"+o).attr("cx",i.right.x-parseInt($(this).attr("r"))-Math.floor(parseInt($(this).css("stroke-width"))/2));break;case"rect":case"svg":globalLastSteps[o].x=$("#"+o).attr("x"),$("#"+o).attr("x",i.right.x-Math.floor(parseInt($(this).attr("width")))-Math.floor(parseInt($(this).css("stroke-width"))/2));break;case"text":globalLastSteps[o].x=$("#"+o).attr("x"),$("#"+o).attr("x",i.right.x-Math.floor(t.target.getComputedTextLength()/2))}break;case"vcenter":switch(r){case"circle":globalLastSteps[o].cy=$("#"+o).attr("cy"),$("#"+o).attr("cy",i.right.y);break;case"rect":case"svg":globalLastSteps[o].y=$("#"+o).attr("y"),$("#"+o).attr("y",i.right.y-Math.floor(parseInt($(this).attr("height"))/2));break;case"text":globalLastSteps[o].y=$("#"+o).attr("y"),$("#"+o).attr("y",i.right.y)}break;case"top":switch(r){case"circle":globalLastSteps[o].cy=$("#"+o).attr("cy"),$("#"+o).attr("cy",i.top.y+parseInt($(this).attr("r"))+Math.floor(parseInt($(this).css("stroke-width"))/2));break;case"rect":case"svg":globalLastSteps[o].y=$("#"+o).attr("y"),$("#"+o).attr("y",i.top.y+Math.floor(parseInt($(this).css("stroke-width"))/2));break;case"text":globalLastSteps[o].y=$("#"+o).attr("y"),$("#"+o).attr("y",i.top.y+Math.floor(parseInt($(this).css("font-size"))/2))}break;case"bottom":switch(r){case"circle":globalLastSteps[o].y=$("#"+o).attr("y"),$("#"+o).attr("cy",i.bottom.y-parseInt($(this).attr("r"))-Math.floor(parseInt($(this).css("stroke-width"))/2));break;case"rect":case"svg":globalLastSteps[o].y=$("#"+o).attr("y"),$("#"+o).attr("y",i.bottom.y-Math.floor(parseInt($(this).attr("height")))-Math.floor(parseInt($(this).css("stroke-width"))/2));break;case"text":globalLastSteps[o].y=$("#"+o).attr("y"),$("#"+o).attr("y",i.bottom.y-Math.floor(parseInt($(this).css("font-size"))/2))}}let s=Object.keys(globalLastSteps).length;s>0?($("#undo_align_elements").prop("disabled",!1),$("#undo_steps").text("(Saved Steps: "+s+")")):$("#undo_align_elements").prop("disabled",!0);let l=$("path[id*="+o+"]");l.length>0&&l.each(function(t){let e=l[t].id.split("_");connectElements(l[t].id,e[1],e[2])})}})}),$("#align_elements, #undo_align_elements").click(function(){let t=Object.keys(globalLastSteps).length;if("undo_align_elements"==this.id){let e=Object.keys(globalLastSteps)[t-1];t>0&&Object.entries(globalLastSteps[e]).forEach(a=>{let[i,o]=a;console.log("Restoring Element: "+e+" with "+i+" and Value: "+o),$("#"+e).attr(i,o);let r=$("path[id*="+e+"]");r.length>0&&r.each(function(t){let e=r[t].id.split("_");connectElements(r[t].id,e[1],e[2])}),delete globalLastSteps[e],(t=Object.keys(globalLastSteps).length)>0?$("#undo_steps").text("(Saved Steps: "+t+")"):($("#undo_steps").text("(Saved Steps: -)"),$("#undo_align_elements").prop("disabled",!0))})}else $("#ex_how_align").html("Choose an alignment and select a reference element"),$("#connect_elements").prop("disabled",!1),$("#align_elements, #undo_align_elements").hide(),$("#all_undo_align_elements").css("display","none"),$("#undo_steps").text("(Saved Steps: -)"),$("#undo_align_elements").prop("disabled",!0),$(".alignable").off(),$(".added_elements").removeClass("alignable").addClass("draggable"),$(".type_icon").removeClass("alignable").addClass("draggable-group"),$(".all_elements, .align_elements").removeClass("faded_out")}),$(".add_element").click(function(t){globalConfigChanged=!0,0===$(".added_elements").length?max_elm_id=0:($(".added_elements").each(function(){max_elm_id=Math.max(this.id,max_elm_id)}),max_elm_id++);let e={id:max_elm_id,radius:configuration.basic.circle.radius||50,width:configuration.basic.rect.width||100,height:configuration.basic.rect.height||100,rx:configuration.basic.rect.corners||10,stroke:configuration.basic.elm.stroke_width||5,pos_x:50+getRandomInt(50),pos_y:50+getRandomInt(50),color:getRandomRGBA(),fill:"none",font_size:configuration.basic.font.size||20,font_family:configuration.basic.font.family||'"Arial", sans-serif',unit:"kW"},a=t.target.id;switch(""==a&&(a=$(this).closest("a").attr("id")),a){case"add_circle":e.format="circle",e.frame="_overlay",e.url="",e.fill_value="",e.fill_type=-1,e.fill_max=0,e.source=-1;break;case"add_rect":e.format="rect",e.frame="_overlay",e.url="",e.fill_value="",e.fill_type=-1,e.fill_max=0,e.source=-1;break;case"add_text":e.format="text",e.text="Text";break;case"add_datasource":e.threshold=0,e.calculate_kw=!1,e.convert=!1,e.decimal_places=0,e.format="text",e.subType="datasource",e.text="Datasource "+max_elm_id,e.source=-1,e.source_option=-1,e.subtract="[-1]";break;case"add_icon":e.format="icon",e.width=24,e.height=24,e.icon="mdi:omega"}("text"==e.format||"datasource"==e.format)&&(e.fill=e.color,e.color=""),addElement(e)}),$("#enable_animation").on("click change",function(){$(this).is(":checked")?$(".anim_element").removeClass("no_animation").addClass("animation"):$(".anim_element").removeClass("animation").addClass("no_animation")}),$("#enable_grid").on("click change",function(){$(this).is(":checked")?$("#help_grid").fadeIn("fast"):$("#help_grid").fadeOut("fast")}),$("#enable_last_id").on("click",function(){configuration.basic.enable_last_id=$(this).is(":checked"),console.log("Showing last ID: "+$(this).is(":checked"))}),$("#config_close").click(function(){hideConfigBar()}),$("#iframe_close").click(function(){hideIframe()}),$("#enable_area_catch").on("click change",function(){$(this).is(":checked")?$("#svg_preview").addClass("svg_preview_catch"):$("#svg_preview").removeClass("svg_preview_catch")}),$("#connect_elements").click(function(){globalConfigChanged=!0;let t,e,a,i;"Done"==$(this).val()?($(".clickable").off(),$(".added_elements").removeClass("clickable").addClass("draggable"),$(".all_elements").removeClass("faded_out no_click"),$("#ex_how_connect").html("Click the button above to connect 2 elements."),$(this).val("Connect").removeClass("red"),$(".clickable").off(),showConnectionPoints(!1)):$(".connector").length>=2?(hideConfigBar(),showConnectionPoints(),$("#ex_how_connect").html("Now choose the first element! You can choose the Element or the ConnectionPoints! <img src='img/icon_help.png' style='vertical-align: bottom;' title='<b>Element:</b><br>If you choose the element itself (click in the middle), the line will always use the shortest distance to the element.<br><b>ConnectionPoint:</b><br>If you choose a connectionPoint, the connection will stay at that choosen one.'>"),$(".all_elements").addClass("faded_out no_click"),$(".connector").removeClass("draggable faded_out no_click").addClass("clickable"),$(".clickable").off().click(function(){let o=$(this).attr("id");if(o||(o=$(this).data("element")),null==t)t=o,a=$(this).data("slot"),$("#ex_how_connect").html("First Element selected!<br>Please choose the next one!");else if(t==o)$("#ex_how_connect").html("Do not select the same Element!"),e=null,i=null;else{e=o,i=$(this).data("slot");let r="path_"+t+"_"+e;if($("#"+r).length>0)failedMessage("This connection already exists!");else{let s=document.createElementNS("http://www.w3.org/2000/svg","path");s.setAttribute("id",r),s.setAttribute("class","type_def"),s.setAttribute("data-start-slot",a),s.setAttribute("data-end-slot",i),$(s).appendTo("#placeholder_defs"),addElement({format:"line",id:"line_"+r,color:configuration.line.stroke,href:"#"+r}),connectElements(r,t,e)}showConnectionPoints(!1),t=null,e=null,$("#ex_how_connect").html("Click the button above to connect 2 elements."),$("#connect_elements").val("Connect").removeClass("red"),$(".clickable").off(),$(".added_elements").removeClass("clickable").addClass("draggable"),$(".all_elements").removeClass("faded_out no_click")}}),$(this).val("Done").addClass("red")):failedMessage("There are no connectable elements on the surface!<br>Min. 2 rectangle or circles are required!")}),$("#save_workspace, #save_workspace_exit").click(function(){globalConfigChanged=!1;let e,a={},i={},o={},r={},s={},l={};a={basic:{enable_grid:!!$("#enable_grid").is(":checked"),enable_animation:!!$("#enable_animation").is(":checked"),enable_area_catch:!!$("#enable_area_catch").is(":checked"),enable_config_icon:!!$("#enable_config_icon").is(":checked"),enable_last_id:!!$("#enable_last_id").is(":checked"),height:parseInt($("#svg_config").attr("height")),width:parseInt($("#svg_config").attr("width")),styles:$("#own_css").val(),font:{family:$("#basic_font_family").val(),size:$("#basic_font_size").val()},rect:{height:parseInt($("#basic_rect_height").val()),width:parseInt($("#basic_rect_width").val()),corners:parseInt($("#basic_rect_corners").val())},circle:{radius:parseInt($("#basic_circle_radius").val())},elm:{stroke_width:parseInt($("#basic_stroke_width").val())},icon:{height:parseInt($("#basic_icon_height").val()),width:parseInt($("#basic_icon_width").val())}},animation:{},animation_configuration:{},line:{},elements:{},defs:{},lines:{},animations:{},datasources:{}},$(".added_elements").length>0?($(".type_circle").each(function(){i[e=this.id]={type:"circle",id:parseInt(e),radius:parseInt($(this).attr("r")),pos_x:parseInt($(this).attr("cx")),pos_y:parseInt($(this).attr("cy")),fill:$(this).css("fill"),color:$(this).css("stroke"),stroke:parseInt($(this).css("stroke-width").replace("px","")),shadow:getShadowColor(e),frame:$(this).data("frame"),url:$(this).data("url"),fill_value:$(this).data("fill_value")||null,fill_type:$(this).data("fill_type")||-1,fill_max:$(this).data("fill_max")||null,source:$(this).data("source")||-1}}),$(".type_rect").each(function(){i[e=this.id]={type:"rect",id:parseInt(e),rx:parseInt($(this).attr("rx")),height:parseInt($(this).attr("height")),width:parseInt($(this).attr("width")),pos_x:parseInt($(this).attr("x")),pos_y:parseInt($(this).attr("y")),fill:$(this).css("fill"),color:$(this).css("stroke"),stroke:parseInt($(this).css("stroke-width").replace("px","")),shadow:getShadowColor(e),frame:$(this).data("frame"),url:$(this).data("url"),fill_value:$(this).data("fill_value")||null,fill_type:$(this).data("fill_type")||-1,fill_max:$(this).data("fill_max")||null,source:$(this).data("source")||-1}}),$(".type_text").each(function(){i[e=this.id]={type:"text",id:parseInt(e),pos_x:parseInt($(this).attr("x")),pos_y:parseInt($(this).attr("y")),color:$(this).css("stroke"),fill:$(this).css("fill"),font_family:$(this).css("font-family"),font_size:parseInt($(this).css("font-size").replace("px","")),degree:getRotationDegrees($(this)),text:$(this).html(),shadow:getShadowColor(e)}}),$(".type_datasource").each(function(){e=this.id;let t=[];Array.isArray($(this).data("subtract"))?t=0==$(this).data("subtract").length?[-1]:$(this).data("subtract"):(console.log("No Array"),t=[-1]),t.map(t=>parseInt(t)),i[e]={type:"text",subType:"datasource",id:parseInt(e),pos_x:parseInt($(this).attr("x")),pos_y:parseInt($(this).attr("y")),color:$(this).css("stroke"),fill:$(this).css("fill"),font_family:$(this).css("font-family"),font_size:parseInt($(this).css("font-size").replace("px","")),degree:getRotationDegrees($(this)),text:"ID "+e,unit:$(this).data("unit"),source:$(this).data("source"),source_option:$(this).data("source_option")||-1,shadow:getShadowColor(e),threshold:parseInt($(this).data("threshold"))||0,calculate_kw:$(this).data("calculate_kw")||!1,convert:$(this).data("convert")||!1,decimal_places:parseInt($(this).data("decimal_places"))||0,subtract:t}}),$(".type_icon").each(function(){i[e=this.id]={type:"icon",id:e,icon:$(this).data("icon"),width:$(this).data("width"),height:$(this).data("height"),color:$(this).css("color"),pos_x:$(this).attr("x"),pos_y:$(this).attr("y"),shadow:getShadowColor(e)}}),$(".type_def").each(function(){o[e=this.id]={type:"def",id:e,d:$(this).attr("d"),startSlot:$(this).data("start-slot"),endSlot:$(this).data("end-slot")}}),$(".type_line").each(function(){r[e=this.id]={type:"line",id:e,href:$(this).attr("xlink:href"),color:$(this).css("stroke"),shadow:getShadowColor(e)}}),$(".type_animation").each(function(){s[e=this.id]={type:"animation",id:e,href:$(this).attr("xlink:href"),color:$(this).css("stroke"),source:$(this).data("source"),threshold:$(this).data("threshold"),animation_properties:$(this).data("animation_properties"),dots:-1!=$(this).data("animation_type")?$(this).data("dots"):0,duration:-1!=$(this).data("animation_type")?$(this).data("duration"):0,power:-1!=$(this).data("animation_type")?$(this).data("power"):0,animation_type:$(this).data("animation_type")}}),$(".data-table tbody tr").each(function(){-1!=(e=$(this).data("id"))&&(l[e]={source:$(this).data("source"),alias:$(this).data("alias")})}),a.elements=i,a.animation=configuration.animation,a.animation_configuration=configuration.animation_configuration,a.line=configuration.line,a.defs=o,a.lines=r,a.animations=s,a.datasources=l,$("#save_output").val(JSON.stringify(a,void 0,4)),localMode?(successMessage("Local Output of Config!"),configuration.basic=a.basic):t.emit("setState",objID[0],{val:JSON.stringify(a),ack:!0},function(t){t?(console.log(t),failedMessage("An error occured while saving your workspace!")):(successMessage("Your workspace has been saved successfully"),configuration.basic=a.basic)})):failedMessage("You do not have any elements to save!"),"save_workspace_exit"==this.id&&(console.log("Forwarding to Live-View of instance: "+instance),window.location.replace("index.html?instance="+instance))})}),$(document).ready(function(){$("body").on("click",function(){$(document).off("keydown")}),$(".input_button").on("click touchstart",function(){this.blur()}),$(window).on("beforeunload",function(){if(globalConfigChanged)return"There are unsaved changes. Are you sure to leave now?"}),$("#frm-addDataSource").submit(function(t){t.preventDefault(),globalConfigChanged=!0;let e=$("#elm_ds_source").val(),a=$("#elm_ds_alias").val()?$("#elm_ds_alias").val():"";addDataSourceRow(-1,e,a),$("#elm_ds_source, #elm_ds_alias").val("")}),$(".data-table").on("click",".btn-delete",function(){globalConfigChanged=!0;let t=!0,e=$(this).parents("tr").data("id");$(".all_elements").each(function(){if($(this).data("source")==e)return t=!1,!1}),t?$(this).parents("tr").fadeOut("fast",function(){$(this).remove(),0==$(".data-table tbody tr").length&&$(".data-table tbody").append("<tr id='ds_tmp_line' data-id='-1'><td>There are currently no Datasources added!</td><td></td><td></td>")}):failedMessage("This source cannot be deleted, as it is used by one or more element's")}),$(".data-table").on("click",".btn-edit",function(){let t=$(this).parents("tr").attr("data-alias"),e=$(this).parents("tr").attr("data-source");$(this).parents("tr").find("td:eq(0)").html('<div class="form_div no_margin"><input type="text" class="input_text" id="edit_ds_alias" name="edit_ds_alias" autocorrect="off" autocomplete="off" value="'+t+'"></div>'),$(this).parents("tr").find("td:eq(1)").html('<div class="form_div no_margin"><input type="text" class="input_text icon_in_input_pad" id="edit_ds_source" name="edit_ds_source" autocorrect="off" autocomplete="off" minlength="5" required="" value="'+e+'"><div class="icon_wrapper"><a class="datasource tt-element icon_in_input" title="Select Datasource"><span class="iconify" data-icon="mdi:database-search" data-height="24"></span></a></div></div>'),$(this).parents("tr").find("td:eq(2)").prepend("<button class='all_datasource ds_buttons btn-update'><span class='iconify' data-height='24' data-icon='mdi:check'>Update</span></button><button class='all_datasource ds_buttons btn-cancel'><span class='iconify' data-height='24' data-icon='mdi:close'>Close</span></button>"),$(this).hide()}),$(".data-table").on("click",".btn-cancel",function(){let t=$(this).parents("tr").attr("data-alias"),e=$(this).parents("tr").attr("data-source");$(this).parents("tr").find("td:eq(0)").text(t),$(this).parents("tr").find("td:eq(1)").text(e),$(this).parents("tr").find(".btn-edit").show(),$(this).parents("tr").find(".btn-update").remove(),$(this).parents("tr").find(".btn-cancel").remove()}),$(".data-table").on("click",".btn-update",function(){globalConfigChanged=!0;let t=$("#edit_ds_alias").val(),e=$("#edit_ds_source").val();$(this).parents("tr").find("td:eq(0)").text(t),$(this).parents("tr").find("td:eq(1)").text(e),$(this).parents("tr").attr("data-alias",t),$(this).parents("tr").attr("data-source",e),$(this).parents("tr").find(".btn-edit").show(),$(this).parents("tr").find(".btn-cancel").remove(),$(this).parents("tr").find(".btn-update").remove()}),$("body").on("click",".datasource",function(){let t=$(this).parent("div").parent("div").children("input").attr("id"),e=$("#"+t).val();!0==configuration.basic.enable_last_id&&""==$("#"+t).val()&&(e=globalSelectedId,console.log("Showing last ID: "+e)),initSelectId(function(a){a.selectId("show",e,function(e){e!=$("#"+t).val()&&($("#"+t).val(e).trigger("change"),$("#"+t).focus()),globalSelectedId=e})})}),$(".data-table").on("click","th",function(){$(".sort_icon").html("");var t=$(this).parents("table").eq(0),e=t.find("tr:gt(0)").toArray().sort(dataSourceComparer($(this).index()));this.asc=!this.asc,$(this).children("span").html('<span class="iconify" data-icon="mdi:sort-alphabetical-ascending" data-height="18">'),this.asc||(e=e.reverse(),$(this).children("span").html('<span class="iconify" data-icon="mdi:sort-alphabetical-descending" data-height="18">'));for(var a=0;a<e.length;a++)t.append(e[a])}),loadConfig()});