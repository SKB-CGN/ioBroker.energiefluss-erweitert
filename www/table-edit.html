<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <link rel="stylesheet" href="style/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
    <script src="https://code.iconify.design/1/1.0.7/iconify.min.js"></script>
    <script src="js/jquery-ui.min.js"></script>
</head>

<body>

    <fieldset style="margin-left: 0px;">
        <legend><span class="iconify legend" data-icon="mdi:database-search" data-width="24" data-height="24"></span>
            <span>Datasources</span>
        </legend>
        <form id="frm-addDataSource">
            <table class="config_table">
                <tr>
                    <td>
                        <div class="form_div">
                            <input type="text" class="input_text icon_in_input_pad" name="elm_ds_source"
                                id="elm_ds_source" placeholder="" autocorrect="off" autocomplete="off" minlength="5"
                                required="">
                            <label for="elm_ds_source" class="form_label">Datasource</label>
                            <div class="icon_wrapper">
                                <a class="datasource tt-element icon_in_input" title="Select Datasource">
                                    <span class="iconify" data-icon="mdi:database-search" data-width="24"
                                        data-height="24"></span>
                                </a>
                            </div>
                        </div>
                        <div class="form_div">
                            <input type="text" class="input_text icon_in_input_pad" name="elm_ds_alias"
                                id="elm_ds_alias" placeholder="" autocorrect="off" autocomplete="off">
                            <label for="elm_ds_alias" class="form_label">Alias</label>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>
                        <input type="submit" class="input_button" value="Add">
                    </td>
                </tr>
            </table>
        </form>
    </fieldset>
    <div class="container scrollbar">
        <fieldset style="width: 642px;">
            <legend><span class="iconify legend" data-icon="mdi:database-search" data-width="24"
                    data-height="24"></span>
                <span>Available Datasources</span>
            </legend>
            <table class="data-table config_table">
                <thead>
                    <th>Alias</th>
                    <th>Datasource</th>
                    <th>Action</th>
                </thead>
                <tbody>
                    <tr id="ds_tmp_line" data-id="-1">
                        <td>There are currently no Datasources added!</td>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                    </tr>
                </tbody>
            </table>
        </fieldset>
    </div>


    <script type="text/javascript">
        function addDataSourceRow(key, ds_source, ds_alias) {
            // First, Close all open Edit
            $('.btn-cancel').trigger('click');
            // Check, if it is already there
            let dataOK = true;
            $(".data-table tbody tr").each(function () {
                if ($('td:eq(1)', this).text().toLowerCase() == ds_source.toLowerCase()) {
                    $(this).effect("highlight", {
                        color: "lightgreen"
                    }, 3000);
                    dataOK = false;
                    return false;
                }
                console.log($('td:eq(1)', this).text());
            });
            if (dataOK) {
                if (key == -1) {
                    console.log("Need new Key!");
                    let tmpMaxID = -1;
                    // Generate a new ID
                    $(".data-table tbody tr").each(function () {
                        tmpMaxID = Math.max($(this).data('id'), tmpMaxID);
                    });
                    tmpMaxID++;
                    console.log("Found: " + tmpMaxID);
                    key = tmpMaxID;
                }
                let tableCell =
                    "<tr data-source='" + ds_source + "' data-alias='" + ds_alias + "' data-id='" + key + "'>" +
                    "<td>" + ds_alias + "</td><td>" + ds_source + "</td>" +
                    "<td><button class='all_datasource ds_buttons btn-edit'><span class='iconify' data-height='24' data-icon='mdi:pencil'>Edit</span></button>" +
                    "<button class='all_datasource ds_buttons btn-delete'><span class='iconify red_icon' data-height='24' data-icon='mdi:delete'>Delete</span></button>" +
                    "</td></tr>";
                $(".data-table tbody").append(tableCell);
                $(".data-table tbody").find('tr:last-child').hide().fadeIn('slow');
                $('#ds_tmp_line').remove();
            }
        }

        $(function () {
            $("#frm-addDataSource").submit(function (e) {
                e.preventDefault();
                let ds_source = $("#elm_ds_source").val();
                let ds_alias = $("#elm_ds_alias").val() ? $("#elm_ds_alias").val() : '';

                addDataSourceRow(-1, ds_source, ds_alias);

                $("#elm_ds_source, #elm_ds_alias").val('');
            });


        });

        $(".data-table").on("click", ".btn-delete", function () {
            $(this).parents("tr").fadeOut('slow', function () {
                $(this).remove();
                if ($(".data-table tbody tr").length == 0) {
                    // Reshow the No Datasources row
                    $(".data-table tbody").append("<tr id='ds_tmp_line'><td>There are currently no Datasources added!</td><td></td><td></td>");
                }
            });
        });

        $(".data-table").on("click", ".btn-edit", function () {
            let ds_alias = $(this).parents("tr").attr('data-alias');
            let ds_source = $(this).parents("tr").attr('data-source');

            let tableCell1 =
                '<div class="form_div no_margin"><input type="text" class="input_text" name="edit_ds_alias" autocorrect="off" autocomplete="off" value="' + ds_alias + '"></div>';
            let tableCell2 =
                '<div class="form_div no_margin"><input type="text" class="input_text icon_in_input_pad" name="edit_ds_source" autocorrect="off" autocomplete="off" minlength="5" required="" value="' + ds_source + '">' +
                '<div class="icon_wrapper"><a class="datasource tt-element icon_in_input" title="Select Datasource"><span class="iconify" data-icon="mdi:database-search" data-height="24"></span></a></div></div>';
            let tableCell3 =
                "<button class='all_datasource ds_buttons btn-update'><span class='iconify' data-height='24' data-icon='mdi:check'>Update</span></button>" +
                "<button class='all_datasource ds_buttons btn-cancel'><span class='iconify' data-height='24' data-icon='mdi:close'>Close</span></button>";

            $(this).parents("tr").find("td:eq(0)").html(tableCell1);
            $(this).parents("tr").find("td:eq(1)").html(tableCell2);


            $(this).parents("tr").find("td:eq(2)").prepend(tableCell3)
            $(this).hide();
        });

        $(".data-table").on("click", ".btn-cancel", function () {
            let ds_alias = $(this).parents("tr").attr('data-alias');
            let ds_source = $(this).parents("tr").attr('data-source');

            $(this).parents("tr").find("td:eq(0)").text(ds_alias);
            $(this).parents("tr").find("td:eq(1)").text(ds_source);

            $(this).parents("tr").find(".btn-edit").show();
            $(this).parents("tr").find(".btn-update").remove();
            $(this).parents("tr").find(".btn-cancel").remove();
        });

        $(".data-table").on("click", ".btn-update", function () {
            let ds_alias = $(this).parents("tr").find("input[name='edit_ds_alias']").val();
            let ds_source = $(this).parents("tr").find("input[name='edit_ds_source']").val();

            $(this).parents("tr").find("td:eq(0)").text(ds_alias);
            $(this).parents("tr").find("td:eq(1)").text(ds_source);

            $(this).parents("tr").attr('data-alias', ds_alias);
            $(this).parents("tr").attr('data-source', ds_source);

            $(this).parents("tr").find(".btn-edit").show();
            $(this).parents("tr").find(".btn-cancel").remove();
            $(this).parents("tr").find(".btn-update").remove();
        });

    </script>

</body>

</html>